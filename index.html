<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© Ø§Ù„Ø°ÙƒÙŠ (V58 Pro)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary: #006C35; --gold: #C69C6D; --bg: #F5F7FA; --dark: #1a1a1a; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg); margin: 0; padding-bottom: 80px; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #004d25, #006C35); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 40px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .role-btn { border: 2px solid #eee; padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: space-between; font-weight: bold; }
        .role-btn:hover { border-color: var(--primary); background: #f9fdfa; transform: translateY(-3px); }
        
        /* Ø§Ù„ØªØ®Ø·ÙŠØ· */
        .sidebar { width: 280px; height: 100vh; background: var(--primary); color: white; position: fixed; right: 0; top: 0; z-index: 1000; padding-top: 30px; display: flex; flex-direction: column; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
        .main-content { margin-right: 280px; padding: 30px; transition: 0.3s; }
        @media (max-width: 991px) { 
            .sidebar { transform: translateX(100%); } 
            .sidebar.active { transform: translateX(0); } 
            .main-content { margin-right: 0; padding: 15px; } 
            .mobile-header { display: flex !important; } 
        }
        
        /* Ø§Ù„Ø¹Ù†Ø§ØµØ± */
        .mobile-header { display: none; justify-content: space-between; align-items: center; background: white; padding: 15px; position: sticky; top: 0; z-index: 500; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav-link { padding: 15px 25px; color: rgba(255,255,255,0.85); cursor: pointer; display: flex; align-items: center; border-right: 5px solid transparent; font-size: 1.1rem; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.15); color: white; border-right-color: var(--gold); }
        
        .content-card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); overflow: hidden; margin-bottom: 25px; border: 1px solid #eee; }
        .card-header-custom { padding: 20px; background: #fff; border-bottom: 1px solid #f0f0f0; font-weight: 800; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
        
        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© */
        .monitor-item { background: white; padding: 20px; border-radius: 15px; border-right: 6px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.03); position: relative; transition: 0.3s; }
        .monitor-item.safe { border-right-color: #27ae60; }
        .monitor-item.danger { border-right-color: #c0392b; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(192, 57, 43, 0); } }

        /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
        @media print {
            body { background: white; }
            .no-print, .sidebar, .mobile-header { display: none !important; }
            .main-content { margin: 0; padding: 0; }
            #print-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            .report-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
            .report-footer { margin-top: 50px; display: flex; justify-content: space-between; padding: 0 50px; font-weight: bold; }
        }

        .hidden { display: none !important; }
        #status-dot { width: 12px; height: 12px; background: #ccc; border-radius: 50%; display: inline-block; margin-left: 8px; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="login-card">
            <img src="https://upload.wikimedia.org/wikipedia/ar/b/bb/Logo_of_the_Ministry_of_Education_%28Saudi_Arabia%29.svg" width="120" class="mb-4">
            <h3 class="fw-bold mb-4" style="color: var(--primary)">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</h3>
            
            <div id="role-selection">
                <div class="role-btn" onclick="selectRole('admin')"><span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ù„ÙˆÙƒÙŠÙ„)</span><i class="fas fa-user-tie text-primary"></i></div>
                <div class="role-btn" onclick="selectRole('teacher')"><span>Ø§Ù„Ù…Ø¹Ù„Ù…</span><i class="fas fa-chalkboard-teacher text-success"></i></div>
                <div class="role-btn" onclick="selectRole('guard')"><span>Ø§Ù„Ø­Ø§Ø±Ø³ (Ø§Ù„Ø²ÙˆØ§Ø±)</span><i class="fas fa-shield-alt text-dark"></i></div>
                <div class="role-btn" onclick="selectRole('counselor')"><span>Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</span><i class="fas fa-user-md text-info"></i></div>
            </div>

            <div id="pin-area" class="hidden mt-4">
                <input type="password" id="pin-input" class="form-control form-control-lg text-center fw-bold mb-3" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ" style="letter-spacing: 5px;">
                <div class="d-flex gap-2">
                    <button class="btn btn-success w-100 rounded-pill" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
                    <button class="btn btn-outline-secondary w-100 rounded-pill" onclick="document.getElementById('pin-area').classList.add('hidden'); document.getElementById('role-selection').classList.remove('hidden')">Ø¹ÙˆØ¯Ø©</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-interface" class="hidden">
        
        <div class="mobile-header">
            <div class="d-flex align-items-center">
                <div id="status-dot" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„"></div>
                <h5 class="m-0 fw-bold text-success">Ù†Ø¸Ø§Ù… Ø¥Ø°Ù†</h5>
            </div>
            <button class="btn btn-light" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i class="fas fa-bars"></i></button>
        </div>

        <aside class="sidebar no-print">
            <div class="text-center mb-4 px-3">
                <i class="fas fa-school fa-3x text-warning mb-3"></i>
                <h6 class="fw-bold m-0" id="school-name-disp">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h6>
                <small class="text-white-50" id="user-role-disp">--</small>
            </div>
            <div id="menu-items" class="flex-grow-1"></div>
            
            <div class="p-3">
                <div class="d-flex justify-content-between align-items-center mb-3 bg-white bg-opacity-10 p-2 rounded">
                    <span class="small">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©</span>
                    <div class="form-check form-switch m-0">
                        <input class="form-check-input" type="checkbox" id="mute-switch" onchange="toggleMute()" checked>
                    </div>
                </div>
                <button class="btn btn-outline-light w-100 rounded-pill" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
        </aside>

        <main class="main-content">
            
            <section id="sec-monitor" class="view-sec">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold m-0 text-dark"><i class="fas fa-desktop text-success me-2"></i>Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­ÙŠØ©</h3>
                    <div id="alert-badge" class="badge bg-danger hidden animate__animated animate__flash">ğŸ”” ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯</div>
                </div>
                <div id="live-grid" class="row g-3"></div>
                <div id="no-active" class="text-center py-5 hidden">
                    <i class="fas fa-check-circle fa-5x text-success opacity-25 mb-3"></i>
                    <h4 class="text-muted">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØµÙˆÙ„</h4>
                </div>
            </section>

            <section id="sec-teacher" class="view-sec hidden">
                <div class="d-flex justify-content-center mb-4">
                    <div class="btn-group bg-white p-1 rounded-pill shadow-sm">
                        <button class="btn btn-success rounded-pill px-4" onclick="showTeacherTab('permit')">Ø¥ØµØ¯Ø§Ø± Ø¥Ø°Ù†</button>
                        <button class="btn btn-outline-danger rounded-pill px-4 ms-2" onclick="showTeacherTab('refer')">Ù…Ø®Ø§Ù„ÙØ© Ø³Ù„ÙˆÙƒÙŠØ©</button>
                    </div>
                </div>

                <div id="tea-permit" class="content-card p-4">
                    <h5 class="fw-bold border-bottom pb-3 mb-3">Ø¥Ø°Ù† Ø®Ø±ÙˆØ¬ Ù…Ø¤Ù‚Øª</h5>
                    <form onsubmit="issuePermit(event)">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="fw-bold mb-1">Ø§Ù„ÙØµÙ„</label>
                                <div class="input-group">
                                    <select id="t-class" class="form-select form-select-lg" onchange="loadStudents('t-class','t-stu')" required><option value="">ØªØ­Ù…ÙŠÙ„...</option></select>
                                    <button type="button" class="btn btn-light border" onclick="refreshData()"><i class="fas fa-sync"></i></button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="fw-bold mb-1">Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                                <select id="t-stu" class="form-select form-select-lg" disabled required><option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ Ø£ÙˆÙ„Ø§Ù‹</option></select>
                            </div>
                            <div class="col-md-6">
                                <label class="fw-bold mb-1">Ø§Ù„ÙˆØ¬Ù‡Ø©</label>
                                <select id="t-dest" class="form-select form-select-lg">
                                    <option>Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡</option><option>Ø§Ù„Ù…Ù‚ØµÙ</option><option>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</option><option>Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="fw-bold mb-1">Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)</label>
                                <input type="number" id="t-time" class="form-control form-control-lg" value="5">
                            </div>
                            <div class="col-12 mt-4">
                                <button class="btn btn-success w-100 py-3 fw-bold rounded-pill shadow">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø­Ø§Ø±Ø³</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="tea-refer" class="content-card p-4 hidden border-top border-danger border-5">
                    <h5 class="fw-bold text-danger mb-4">ØªØ­ÙˆÙŠÙ„ Ø·Ø§Ù„Ø¨ (Ù…Ø®Ø§Ù„ÙØ©)</h5>
                    <div class="row g-3">
                        <div class="col-md-6"><select id="r-class" class="form-select" onchange="loadStudents('r-class','r-stu')"><option value="">Ø§Ù„ÙØµÙ„...</option></select></div>
                        <div class="col-md-6"><select id="r-stu" class="form-select" disabled><option>Ø§Ù„Ø·Ø§Ù„Ø¨...</option></select></div>
                        <div class="col-12"><input id="r-type" class="form-control" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© (Ù…Ø«Ù„Ø§Ù‹: ØªØ£Ø®Ø± ØµØ¨Ø§Ø­ÙŠØŒ Ø¹Ø¨Ø«...)"></div>
                        <div class="col-12"><textarea id="r-desc" class="form-control" rows="3" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©..."></textarea></div>
                        <div class="col-12"><button class="btn btn-danger w-100 py-2 rounded-pill" onclick="sendReferral()">Ø±ÙØ¹ Ù„Ù„ÙˆÙƒÙŠÙ„</button></div>
                    </div>
                </div>
            </section>

            <section id="sec-admin" class="view-sec hidden">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="content-card h-100 border-top border-warning border-5">
                            <div class="card-header-custom bg-light">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø± <span class="badge bg-warning text-dark" id="vis-count">0</span></div>
                            <div id="admin-vis-list" class="list-group list-group-flush p-2"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="content-card h-100 border-top border-danger border-5">
                            <div class="card-header-custom bg-light">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ©</div>
                            <div id="admin-ref-list" class="list-group list-group-flush p-2"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="content-card h-100 border-top border-primary border-5">
                            <div class="card-header-custom bg-light">Ø£Ù…Ø± Ø§Ù†ØµØ±Ø§Ù</div>
                            <div class="p-4">
                                <input id="dep-name" class="form-control mb-3" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
                                <input id="dep-reason" class="form-control mb-3" placeholder="Ø§Ù„Ø³Ø¨Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                                <button class="btn btn-primary w-100 fw-bold" onclick="sendDeparture()">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø­Ø§Ø±Ø³</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-guard" class="view-sec hidden">
                <div class="row g-4">
                    <div class="col-md-5">
                        <div class="content-card p-4">
                            <h5 class="fw-bold mb-3">ØªØ³Ø¬ÙŠÙ„ Ø²Ø§Ø¦Ø± Ø¬Ø¯ÙŠØ¯</h5>
                            <input id="g-name" class="form-control mb-2" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
                            <input id="g-id" type="number" class="form-control mb-2" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø³Ø¬Ù„">
                            <input id="g-reason" class="form-control mb-3" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø©">
                            <button class="btn btn-dark w-100 py-2 fw-bold" onclick="regVisitor()">Ø·Ù„Ø¨ Ø¯Ø®ÙˆÙ„ (Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆÙƒÙŠÙ„)</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="content-card mb-3">
                            <div class="card-header-custom">Ø­Ø§Ù„Ø© Ø§Ù„Ø²ÙˆØ§Ø±</div>
                            <div id="guard-vis-list" class="list-group list-group-flush"></div>
                        </div>
                        <div class="content-card border-top border-danger border-5">
                            <div class="card-header-custom text-danger">Ø£ÙˆØ§Ù…Ø± Ø®Ø±ÙˆØ¬ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                            <div id="guard-dep-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-counselor" class="view-sec hidden">
                <div class="content-card">
                    <div class="card-header-custom">Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­ÙˆÙ„Ø© (Ø§Ù„Ø³Ù„ÙˆÙƒ)</div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle text-center mb-0">
                            <thead class="table-light"><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th><th>Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ÙˆÙƒÙŠÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                            <tbody id="counselor-list"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sec-data" class="view-sec hidden">
                <div class="content-card p-4">
                    <ul class="nav nav-tabs mb-4">
                        <li class="nav-item"><button class="nav-link active text-dark" onclick="showDataTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button></li>
                        <li class="nav-item"><button class="nav-link text-dark" onclick="showDataTab('students')">Ø§Ù„Ø·Ù„Ø§Ø¨</button></li>
                        <li class="nav-item"><button class="nav-link text-dark" onclick="showDataTab('teachers')">Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ†</button></li>
                    </ul>

                    <div id="tab-settings">
                        <div class="row g-3">
                            <div class="col-md-6"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input id="set-school" class="form-control"></div>
                            <div class="col-md-6"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±</label><input id="set-manager" class="form-control"></div>
                            <div class="col-md-6"><label>ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø³Ø±ÙŠ</label><input id="set-code" class="form-control"></div>
                            <div class="col-md-6"><label>ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ø±Ø³</label><input id="set-guard" class="form-control"></div>
                            <div class="col-12"><button class="btn btn-primary px-5" onclick="saveSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button></div>
                        </div>
                    </div>

                    <div id="tab-students" class="hidden">
                        <div class="row g-2 mb-3">
                            <div class="col-md-4"><input id="imp-cls" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ (Ù…Ø«Ù„Ø§Ù‹: 1/1)"></div>
                            <div class="col-md-4"><button class="btn btn-success w-100" onclick="document.getElementById('f-excel').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</button><input type="file" id="f-excel" hidden onchange="importData(this)"></div>
                            <div class="col-md-4"><button class="btn btn-outline-danger w-100" onclick="deleteAllStudents()">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</button></div>
                        </div>
                        <div style="max-height:300px; overflow:auto"><table class="table table-sm"><tbody id="data-stu-list"></tbody></table></div>
                    </div>
                    
                    <div id="tab-teachers" class="hidden">
                        <div class="input-group mb-3">
                            <input id="new-tea" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
                            <button class="btn btn-primary" onclick="addTeacher()">Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                        <ul id="data-tea-list" class="list-group"></ul>
                    </div>
                </div>
            </section>

            <section id="sec-reports" class="view-sec hidden no-print">
                <h4 class="fw-bold mb-4">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h4>
                <div class="row g-3 mb-4">
                    <div class="col-md-3"><button class="btn btn-white w-100 py-3 border shadow-sm fw-bold" onclick="generateReport('permits')">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª</button></div>
                    <div class="col-md-3"><button class="btn btn-white w-100 py-3 border shadow-sm fw-bold" onclick="generateReport('visitors')">ğŸ‘¥ Ø³Ø¬Ù„ Ø§Ù„Ø²ÙˆØ§Ø±</button></div>
                    <div class="col-md-3"><button class="btn btn-white w-100 py-3 border shadow-sm fw-bold" onclick="generateReport('stats_out')">ğŸ“‰ Ø§Ù„Ø£ÙƒØ«Ø± Ø®Ø±ÙˆØ¬Ø§Ù‹</button></div>
                    <div class="col-md-3"><button class="btn btn-white w-100 py-3 border shadow-sm fw-bold" onclick="generateReport('referrals')">âš ï¸ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</button></div>
                </div>
                
                <div id="report-container" class="hidden">
                    <div class="content-card p-5" id="print-area">
                        <div class="report-header">
                            <div class="text-end">
                                <strong>Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</strong><br>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…<br><span id="rep-school"></span>
                            </div>
                            <img src="https://upload.wikimedia.org/wikipedia/ar/b/bb/Logo_of_the_Ministry_of_Education_%28Saudi_Arabia%29.svg" width="120">
                            <div class="text-start">
                                <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="rep-date"></span><br>
                                <strong>ØªÙ‚Ø±ÙŠØ± Ù†Ø¸Ø§Ù…ÙŠ</strong>
                            </div>
                        </div>
                        
                        <h3 class="text-center fw-bold my-4" id="rep-title">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
                        
                        <table class="table table-bordered text-center align-middle" style="border:1px solid #000;">
                            <thead class="table-light" id="rep-head"></thead>
                            <tbody id="rep-body"></tbody>
                        </table>

                        <div class="report-footer">
                            <div>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨<br><br>...........................</div>
                            <div>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©<br><span id="rep-manager"></span><br>...........................</div>
                        </div>
                    </div>
                    <button class="btn btn-dark w-100 mt-3 no-print" onclick="window.print()"><i class="fas fa-print me-2"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                </div>
            </section>

        </main>
    </div>

    <audio id="snd" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // ============================================
        // 1. Ø§Ù„ØªÙƒÙˆÙŠÙ† ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© (Config)
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyD0IJONOe7Ef4a0XG8L1Cgbc1qVSSck0xE",
            authDomain: "ethn-63848.firebaseapp.com",
            databaseURL: "https://ethn-63848-default-rtdb.firebaseio.com",
            projectId: "ethn-63848",
            storageBucket: "ethn-63848.appspot.com",
            messagingSenderId: "747489913596",
            appId: "1:747489913596:web:d98d88447e4a25cc808579"
        };
        
        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const db = firebase.database();

        let role = '', muted = false, alertPlaying = false;
        let data = { settings: {school:'Ù…Ø¯Ø±Ø³ØªÙ†Ø§', manager:'', code:'2026', guard:'1111'}, classes:[], students:{}, teachers:{}, permits:{}, visitors:{}, departures:{}, referrals:{} };

        // ============================================
        // 2. Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Sync & Logic)
        // ============================================
        window.onload = () => {
            const dot = document.getElementById('status-dot');
            db.ref('.info/connected').on('value', s => dot.style.background = s.val() ? '#00ff00' : 'red');

            db.ref('/').on('value', snap => {
                const val = snap.val();
                if(val) {
                    data = val;
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© Ø£Ùˆ Ø§Ù„Ù†Ø§Ù‚ØµØ©
                    if(!data.classes) data.classes = [];
                    if(typeof data.classes === 'object') data.classes = Object.values(data.classes);
                    if(!data.settings) data.settings = {school:'Ù…Ø¯Ø±Ø³ØªÙ†Ø§', manager:'', code:'2026', guard:'1111'};
                    
                    refreshUI();
                    checkAlerts();
                }
            });
            setInterval(monitorLoop, 10000); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆÙ‚ÙŠØª ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
        };

        function checkAlerts() {
            let ring = false;
            // Ø¬Ø±Ø³ Ø§Ù„Ø­Ø§Ø±Ø³ (Ø®Ø±ÙˆØ¬ Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ù†ØµØ±Ø§Ù)
            if(role === 'guard') {
                const newPermit = Object.values(data.permits||{}).some(p => p.active && !p.guardSeen);
                const newDep = Object.values(data.departures||{}).some(d => d.status === 'pending');
                if(newPermit || newDep) ring = true;
            }
            // Ø¬Ø±Ø³ Ø§Ù„ÙˆÙƒÙŠÙ„ (Ø²Ø§Ø¦Ø± Ø¬Ø¯ÙŠØ¯)
            if(role === 'admin') {
                const newVis = Object.values(data.visitors||{}).some(v => v.status === 'pending');
                if(newVis) ring = true;
            }

            if(ring) playSound(); else stopSound();
        }

        function playSound() {
            if(!muted && !alertPlaying) {
                document.getElementById('snd').play().catch(()=>{});
                alertPlaying = true;
                document.getElementById('alert-badge').classList.remove('hidden');
            }
        }
        function stopSound() {
            document.getElementById('snd').pause();
            document.getElementById('snd').currentTime = 0;
            alertPlaying = false;
            document.getElementById('alert-badge').classList.add('hidden');
        }
        function toggleMute() { muted = !document.getElementById('mute-switch').checked; if(muted) stopSound(); }

        // ============================================
        // 3. Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ù„Ø¹Ø±Ø¶ (Rendering)
        // ============================================
        function refreshUI() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
            document.getElementById('school-name-disp').innerText = data.settings.school;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
            const selects = ['t-class', 'r-class'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    const cur = el.value;
                    el.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„...</option>';
                    (data.classes||[]).forEach(c => el.innerHTML += `<option value="${c}">${c}</option>`);
                    el.value = cur;
                }
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
            if(role === 'guard') renderGuard();
            if(role === 'admin') renderAdmin();
            if(role === 'counselor') renderCounselor();
            if(role === 'teacher') {/* ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */}
            if(!document.getElementById('sec-monitor').classList.contains('hidden')) renderMonitor();
            if(!document.getElementById('sec-data').classList.contains('hidden')) renderSettings();
        }

        function renderMonitor() {
            const grid = document.getElementById('live-grid');
            const active = Object.entries(data.permits||{}).filter(([k,v]) => v.active);
            
            if(active.length === 0) {
                document.getElementById('no-active').classList.remove('hidden');
                grid.innerHTML = '';
            } else {
                document.getElementById('no-active').classList.add('hidden');
                grid.innerHTML = active.map(([k,p]) => {
                    const mins = Math.floor((new Date() - new Date(p.start)) / 60000);
                    return `<div class="col-md-3"><div class="monitor-item ${mins >= p.limit ? 'danger' : 'safe'}">
                        <h5 class="fw-bold">${p.student}</h5>
                        <div class="d-flex justify-content-between small text-muted mb-2"><span>${p.class}</span><span>${p.dest}</span></div>
                        <h2 class="text-center my-2 ${mins >= p.limit ? 'text-danger' : 'text-success'}">${mins} Ø¯</h2>
                        <button class="btn btn-dark btn-sm w-100 rounded-pill" onclick="db.ref('permits/${k}').update({active:false, end:new Date().toISOString()})">Ø¹ÙˆØ¯Ø© Ù„Ù„ÙØµÙ„</button>
                    </div></div>`;
                }).join('');
            }
        }

        function renderAdmin() {
            document.getElementById('admin-vis-list').innerHTML = Object.entries(data.visitors||{}).filter(([k,v])=>v.status==='pending').map(([k,v])=>`
                <div class="list-group-item">
                    <div class="d-flex justify-content-between"><strong>${v.name}</strong><small>${v.time.split(',')[1]}</small></div>
                    <div class="small text-muted mb-2">${v.reason}</div>
                    <div class="btn-group w-100"><button class="btn btn-success btn-sm" onclick="db.ref('visitors/${k}').update({status:'approved'})">Ù…ÙˆØ§ÙÙ‚Ø©</button><button class="btn btn-danger btn-sm" onclick="db.ref('visitors/${k}').update({status:'rejected'})">Ø±ÙØ¶</button></div>
                </div>`).join('') || '<div class="text-center p-3 text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
            document.getElementById('vis-count').innerText = Object.values(data.visitors||{}).filter(v=>v.status==='pending').length;

            document.getElementById('admin-ref-list').innerHTML = Object.entries(data.referrals||{}).filter(([k,r])=>r.status==='pending_admin').map(([k,r])=>`
                <div class="card p-2 mb-2 border-danger"><small>${r.student} (${r.class})</small><strong>${r.type}</strong><button class="btn btn-outline-danger btn-sm mt-1" onclick="forwardToCounselor('${k}')">ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…ÙˆØ¬Ù‡</button></div>`).join('') || '<div class="text-center p-3 text-muted">Ø³Ø¬Ù„ Ù†Ø¸ÙŠÙ</div>';
        }

        function renderGuard() {
            document.getElementById('guard-dep-list').innerHTML = Object.entries(data.departures||{}).filter(([k,d])=>d.status==='pending').map(([k,d])=>`
                <div class="alert alert-danger d-flex justify-content-between align-items-center">
                    <div><strong>${d.name}</strong><br>${d.reason}</div>
                    <button class="btn btn-success btn-sm" onclick="db.ref('departures/${k}').update({status:'exited'})">ØªØ£ÙƒÙŠØ¯ Ø®Ø±ÙˆØ¬</button>
                </div>`).join('');
            
            document.getElementById('guard-vis-list').innerHTML = Object.entries(data.visitors||{}).reverse().slice(0,5).map(([k,v])=>`
                <div class="list-group-item d-flex justify-content-between">
                    <div>${v.name}</div>
                    <span class="badge ${v.status==='approved'?'bg-success':(v.status==='pending'?'bg-warning text-dark':'bg-danger')}">${v.status==='pending'?'Ø§Ù†ØªØ¸Ø§Ø±':(v.status==='approved'?'Ù…Ø³Ù…ÙˆØ­':'Ù…Ø±ÙÙˆØ¶')}</span>
                </div>`).join('');
        }

        function renderCounselor() {
            document.getElementById('counselor-list').innerHTML = Object.entries(data.referrals||{}).filter(([k,r])=>r.status==='pending_counselor').map(([k,r])=>`
                <tr><td>${r.student}</td><td>${r.type}</td><td>${r.admin_action||'ØªØ­ÙˆÙŠÙ„'}</td><td>${r.date}</td><td><button class="btn btn-success btn-sm" onclick="db.ref('referrals/${k}').update({status:'closed'})">Ø¥ØºÙ„Ø§Ù‚</button></td></tr>`).join('');
        }

        // ============================================
        // 4. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Actions)
        // ============================================
        function selectRole(r) { role = r; document.getElementById('role-selection').classList.add('hidden'); document.getElementById('pin-area').classList.remove('hidden'); }
        function login() {
            const p = document.getElementById('pin-input').value;
            let ok = (role==='admin' && p==='admin') || (role==='teacher' && p==String(data.settings.code)) || (role==='guard' && p==String(data.settings.guard)) || (role==='counselor' && p==='admin');
            if(ok) {
                document.getElementById('auth-overlay').style.display='none';
                document.getElementById('app-interface').classList.remove('hidden');
                document.getElementById('user-role-disp').innerText = {'admin':'Ø§Ù„ÙˆÙƒÙŠÙ„','teacher':'Ø§Ù„Ù…Ø¹Ù„Ù…','guard':'Ø§Ù„Ø­Ø§Ø±Ø³','counselor':'Ø§Ù„Ù…ÙˆØ¬Ù‡'}[role];
                buildMenu(); navigate(role==='guard'?'guard':(role==='counselor'?'counselor':(role==='admin'?'monitor':'teacher')));
            } else Swal.fire('Ø®Ø·Ø£','Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­','error');
        }

        function buildMenu() {
            const m = document.getElementById('menu-items'); m.innerHTML = '';
            let items = [['monitor','Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©','desktop']];
            if(role==='teacher') items.push(['teacher','Ø§Ù„Ø®Ø¯Ù…Ø§Øª','user-edit']);
            if(role==='admin') items.push(['admin','Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©','tasks'], ['reports','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±','file-alt'], ['data','Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','database']);
            if(role==='guard') items = [['guard','Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©','shield-alt']];
            if(role==='counselor') items.push(['counselor','Ø§Ù„ØªÙˆØ¬ÙŠÙ‡','hand-holding-heart']);
            
            items.forEach(i => m.innerHTML += `<div class="nav-link" onclick="navigate('${i[0]}')"><i class="fas fa-${i[2]} ms-2"></i> ${i[1]}</div>`);
        }

        function navigate(id) {
            document.querySelectorAll('.view-sec').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            if(window.innerWidth < 992) document.querySelector('.sidebar').classList.remove('active');
            refreshUI();
        }

        function showTeacherTab(tab) {
            document.getElementById('tea-permit').classList.toggle('hidden', tab!=='permit');
            document.getElementById('tea-refer').classList.toggle('hidden', tab!=='refer');
        }

        // --- Teacher Logic ---
        function loadStudents(clsId, stuId) {
            const cls = document.getElementById(clsId).value;
            const stuSel = document.getElementById(stuId);
            stuSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨...</option>';
            stuSel.disabled = false;
            Object.values(data.students||{}).filter(s => s.class === cls).forEach(s => stuSel.innerHTML += `<option value="${s.name}">${s.name}</option>`);
        }
        function issuePermit(e) {
            e.preventDefault();
            const p = {
                student: document.getElementById('t-stu').value, class: document.getElementById('t-class').value,
                dest: document.getElementById('t-dest').value, limit: parseInt(document.getElementById('t-time').value),
                start: new Date().toISOString(), active: true, guardSeen: false
            };
            if(!p.student) return;
            db.ref('permits').push(p);
            Swal.fire('ØªÙ…','ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„Ø­Ø§Ø±Ø³','success');
            navigate('monitor');
        }
        function sendReferral() {
            const r = {
                student: document.getElementById('r-stu').value, class: document.getElementById('r-class').value,
                type: document.getElementById('r-type').value, desc: document.getElementById('r-desc').value,
                status: 'pending_admin', date: new Date().toLocaleDateString('ar-SA')
            };
            if(!r.student) return;
            db.ref('referrals').push(r);
            Swal.fire('ØªÙ… Ø§Ù„Ø±ÙØ¹ Ù„Ù„ÙˆÙƒÙŠÙ„');
        }

        // --- Admin Logic ---
        function sendDeparture() { const n=document.getElementById('dep-name').value; if(n) db.ref('departures').push({name:n, reason:document.getElementById('dep-reason').value, status:'pending', time:new Date().toLocaleString()}); Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø­Ø§Ø±Ø³'); }
        function forwardToCounselor(k) { db.ref('referrals/'+k).update({status:'pending_counselor', admin_action:'ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…ÙˆØ¬Ù‡'}); }

        // --- Guard Logic ---
        function regVisitor() {
            db.ref('visitors').push({name:document.getElementById('g-name').value, id:document.getElementById('g-id').value, reason:document.getElementById('g-reason').value, status:'pending', time:new Date().toLocaleString()});
            Swal.fire('ØªÙ… Ø¥Ø¨Ù„Ø§Øº Ø§Ù„ÙˆÙƒÙŠÙ„'); document.getElementById('g-name').value='';
        }

        // --- Data & Reports ---
        function showDataTab(t) {
            document.getElementById('tab-settings').classList.add('hidden'); document.getElementById('tab-students').classList.add('hidden'); document.getElementById('tab-teachers').classList.add('hidden');
            document.getElementById('tab-'+t).classList.remove('hidden');
            renderSettings();
        }
        function renderSettings() {
            document.getElementById('s-school').value = data.settings.school;
            document.getElementById('s-manager').value = data.settings.manager;
            document.getElementById('s-code').value = data.settings.code;
            document.getElementById('s-guard').value = data.settings.guard;
            
            document.getElementById('data-stu-list').innerHTML = Object.entries(data.students||{}).reverse().map(([k,s])=>`<tr><td>${s.name}</td><td>${s.class}</td><td><button class="btn btn-sm text-danger" onclick="db.ref('students/${k}').remove()"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        }
        function saveSettings() {
            db.ref('settings').set({school:document.getElementById('s-school').value, manager:document.getElementById('s-manager').value, code:document.getElementById('s-code').value, guard:document.getElementById('s-guard').value});
            Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸');
        }
        function importData(inp) {
            const f=inp.files[0], cls=document.getElementById('imp-cls').value;
            if(!cls) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„','warning');
            const r=new FileReader();
            r.onload=e=>{
                const j=XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:'array'}).Sheets[XLSX.read(e.target.result,{type:'array'}).SheetNames[0]],{header:1});
                j.forEach(row=>{ if(row[0]) db.ref('students').push({name:row[0], class:cls}); });
                let c=data.classes||[]; if(!c.includes(cls)) {c.push(cls); db.ref('classes').set(c);}
                Swal.fire('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
            }; r.readAsArrayBuffer(f);
        }
        function deleteAllStudents() { if(confirm('Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ')) { db.ref('students').remove(); db.ref('classes').remove(); } }

        function generateReport(type) {
            document.getElementById('report-container').classList.remove('hidden');
            const head = document.getElementById('rep-head');
            const body = document.getElementById('rep-body');
            document.getElementById('rep-school').innerText = data.settings.school;
            document.getElementById('rep-manager').innerText = data.settings.manager;
            document.getElementById('rep-date').innerText = new Date().toLocaleDateString('ar-SA');

            if(type==='permits') {
                document.getElementById('rep-title').innerText = 'Ø³Ø¬Ù„ Ø£Ø°ÙˆÙ†Ø§Øª Ø®Ø±ÙˆØ¬ Ø§Ù„Ø·Ù„Ø§Ø¨';
                head.innerHTML = '<tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„ÙˆØ¬Ù‡Ø©</th><th>ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬</th></tr>';
                body.innerHTML = Object.values(data.permits||{}).reverse().map(p=>`<tr><td>${p.student}</td><td>${p.class}</td><td>${p.dest}</td><td>${new Date(p.start).toLocaleTimeString('ar-SA')}</td></tr>`).join('');
            } else if(type==='visitors') {
                document.getElementById('rep-title').innerText = 'Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø²ÙˆØ§Ø±';
                head.innerHTML = '<tr><th>Ø§Ù„Ø²Ø§Ø¦Ø±</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr>';
                body.innerHTML = Object.values(data.visitors||{}).reverse().map(v=>`<tr><td>${v.name}</td><td>${v.reason}</td><td>${v.time}</td><td>${v.status}</td></tr>`).join('');
            }
        }

        function monitorLoop() { if(!document.getElementById('sec-monitor').classList.contains('hidden')) renderMonitor(); }
        function refreshData() { db.ref('/').once('value'); }
    </script>
</body>
</html>