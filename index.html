<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إذن (الإدارة المركزية) - النسخة الماسية</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1e3c72;
            --secondary: #2a5298;
            --accent: #ffb75e;
            --bg-light: #f4f7f6;
            --text-dark: #2c3e50;
            --white: #ffffff;
            --danger: #e74c3c;
            --success: #2ecc71;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- شاشة الدخول --- */
        .login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .login-box {
            background: var(--white);
            padding: 40px;
            border-radius: 20px;
            width: 350px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border-top: 5px solid var(--accent);
        }

        .login-box h2 { color: var(--primary); margin-bottom: 20px; }
        
        .inp-field {
            width: 100%; padding: 12px; margin: 10px 0;
            border: 2px solid #eee; border-radius: 8px;
            box-sizing: border-box; transition: 0.3s;
        }
        .inp-field:focus { border-color: var(--secondary); outline: none; }

        .btn-main {
            width: 100%; padding: 12px; background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white; border: none; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: bold; transition: transform 0.2s;
        }
        .btn-main:hover { transform: scale(1.02); }

        /* --- لوحة التحكم --- */
        .dashboard { display: none; animation: fadeIn 0.5s ease; }

        .header {
            background: var(--white);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        .header .user-info { font-size: 0.9rem; color: #777; }

        /* --- البطاقات الإحصائية (ملونة واحترافية) --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        
        .stat-card.blue { border-left: 5px solid #3498db; }
        .stat-card.green { border-left: 5px solid #2ecc71; }
        .stat-card.red { border-left: 5px solid #e74c3c; }
        .stat-card.purple { border-left: 5px solid #9b59b6; }

        .stat-card h3 { margin: 0 0 10px 0; color: #7f8c8d; font-size: 0.9rem; }
        .stat-card .value { font-size: 2rem; font-weight: bold; color: var(--text-dark); }
        .stat-card i {
            position: absolute; left: 20px; bottom: 20px;
            font-size: 3rem; opacity: 0.1;
        }

        /* --- المحتوى الرئيسي (النموذج والجدول) --- */
        .content-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
        }

        .panel {
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .panel-title {
            margin-top: 0; margin-bottom: 20px;
            padding-bottom: 10px; border-bottom: 2px solid #eee;
            color: var(--primary); display: flex; align-items: center; gap: 10px;
        }

        /* أدوات الجدول (بحث وتصدير) */
        .table-tools {
            display: flex; gap: 10px; margin-bottom: 15px;
        }
        .search-box { flex: 1; position: relative; }
        .search-box input { padding-right: 35px; } /* مسافة للأيقونة */
        .search-box i {
            position: absolute; right: 10px; top: 50%;
            transform: translateY(-50%); color: #aaa;
        }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: right; color: #666; font-size: 0.9rem; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        tr:hover { background: #f1f7ff; }

        .badge {
            padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;
        }
        .bg-grade { background: #e3f2fd; color: #1565c0; }

        .actions-btn {
            background: none; border: none; cursor: pointer; font-size: 1.1rem; margin-left: 5px;
        }
        .btn-del { color: var(--danger); }
        .btn-print { background: var(--primary); color: white; width: auto; display: inline-block; }

        /* --- للطباعة --- */
        @media print {
            .no-print, .login-overlay, .form-panel, .table-tools, .actions-column { display: none !important; }
            .content-grid { display: block; }
            .table-panel { box-shadow: none; }
            body { background: white; }
            table { border: 1px solid #000; }
            th, td { border: 1px solid #000; }
        }

        /* --- تجاوب --- */
        @media (max-width: 900px) {
            .content-grid { grid-template-columns: 1fr; }
        }

        /* أنيميشن */
        @keyframes fadeIn { from { opacity: 0; top: 20px; } to { opacity: 1; top: 0; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="login-overlay" id="loginScreen">
        <div class="login-box">
            <i class="fas fa-school fa-3x" style="color:var(--primary); margin-bottom:15px;"></i>
            <h2>نظام إذن المدرسي</h2>
            <p style="color:#666; font-size:0.9rem;">بوابة الإدارة المركزية</p>
            <input type="password" id="passwordInput" class="inp-field" placeholder="رمز المرور الإداري">
            <button class="btn-main" onclick="login()">دخول آمن <i class="fas fa-arrow-left"></i></button>
            <p id="loginError" style="color:red; display:none; margin-top:10px;">رمز المرور غير صحيح</p>
        </div>
    </div>

    <div class="container dashboard" id="dashboardScreen">
        
        <div class="header no-print">
            <div>
                <h1>لوحة القيادة المدرسية</h1>
                <span class="user-info">نظام رصد ومتابعة التأخر الصباحي</span>
            </div>
            <button onclick="logout()" style="background:var(--danger); color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">
                <i class="fas fa-sign-out-alt"></i> خروج
            </button>
        </div>

        <div class="stats-grid no-print">
            <div class="stat-card blue">
                <h3>حالات اليوم</h3>
                <div class="value" id="statToday">0</div>
                <i class="fas fa-calendar-day" style="color:#3498db"></i>
            </div>
            <div class="stat-card green">
                <h3>إجمالي الأسبوع</h3>
                <div class="value" id="statWeek">0</div>
                <i class="fas fa-chart-line" style="color:#2ecc71"></i>
            </div>
            <div class="stat-card red">
                <h3>الأكثر تأخراً</h3>
                <div class="value" style="font-size:1.2rem" id="statTopStudent">-</div>
                <i class="fas fa-user-clock" style="color:#e74c3c"></i>
            </div>
            <div class="stat-card purple" onclick="window.print()" style="cursor:pointer">
                <h3>طباعة تقرير</h3>
                <div class="value" style="font-size:1.2rem">اضغط هنا</div>
                <i class="fas fa-print" style="color:#9b59b6"></i>
            </div>
        </div>

        <div class="content-grid">
            
            <div class="panel form-panel no-print">
                <h3 class="panel-title"><i class="fas fa-pen-fancy"></i> تسجيل حالة جديدة</h3>
                
                <div class="form-group">
                    <label>الصف الدراسي:</label>
                    <select id="gradeSelect" class="inp-field" onchange="loadSections()">
                        <option value="">-- اختر الصف --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>الشعبة:</label>
                    <select id="sectionSelect" class="inp-field" onchange="loadStudents()" disabled>
                        <option value="">-- اختر الشعبة --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>اسم الطالب:</label>
                    <select id="studentSelect" class="inp-field" disabled>
                        <option value="">-- اختر الطالب --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>وقت الحضور:</label>
                    <input type="time" id="timeInput" class="inp-field">
                </div>

                <div class="form-group">
                    <label>ملاحظات:</label>
                    <input type="text" id="notesInput" class="inp-field" placeholder="سبب التأخر...">
                </div>

                <button class="btn-main" onclick="saveRecord()">
                    <i class="fas fa-save"></i> حفظ البيانات
                </button>
            </div>

            <div class="panel table-panel">
                <h3 class="panel-title">
                    <span><i class="fas fa-list-alt"></i> سجل المتأخرين</span>
                    <span style="font-size:0.8rem; color:#888; margin-right:auto" id="currentDateDisplay"></span>
                </h3>

                <div class="table-tools no-print">
                    <div class="search-box">
                        <input type="text" id="searchInput" class="inp-field" placeholder="بحث باسم الطالب..." onkeyup="filterTable()">
                        <i class="fas fa-search"></i>
                    </div>
                    <button class="btn-main" onclick="exportToExcel()" style="width:auto; background:#27ae60;">
                        <i class="fas fa-file-excel"></i> تصدير إكسل
                    </button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الاسم</th>
                            <th>الصف / الشعبة</th>
                            <th>الوقت</th>
                            <th>التاريخ</th>
                            <th>الملاحظات</th>
                            <th class="actions-column no-print">إجراء</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // 1. قاعدة البيانات (يمكنك وضع مئات الأسماء هنا)
        // ==========================================
        const schoolData = {
            "الأول متوسط": {
                "أ": ["محمد أحمد", "سلطان علي", "فهد ناصر", "يوسف عمر", "إبراهيم خليل"],
                "ب": ["خالد يحيى", "عبدالله عمر", "ياسر حسن", "عمار ياسر", "وليد خالد"],
                "ج": ["مشاري سعيد", "بندر فيصل", "سعود عبدالعزيز"]
            },
            "الثاني متوسط": {
                "أ": ["يحيى سلمان", "نايف محمد", "علي حسين", "فؤاد سالم"],
                "ب": ["سامي وليد", "تركي عبدالله", "ماجد عبدالله"]
            },
            "الثالث متوسط": {
                "أ": ["عمر فاروق", "زياد طارق", "هاني شاكر"],
                "ب": ["أحمد عادل", "فيصل خالد", "معاذ علي"]
            }
        };

        const ADMIN_PASS = "12345"; // كود الدخول

        // ==========================================
        // 2. تشغيل النظام
        // ==========================================
        
        // عند فتح الصفحة
        window.onload = function() {
            if(localStorage.getItem('isLoggedIn') === 'true'){
                showDashboard();
            }
            
            // تعيين الوقت الحالي
            const now = new Date();
            document.getElementById('timeInput').value = now.toTimeString().slice(0,5);
            document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('ar-EG');
        };

        // تسجيل الدخول
        function login() {
            const pass = document.getElementById('passwordInput').value;
            if (pass === ADMIN_PASS) {
                localStorage.setItem('isLoggedIn', 'true');
                document.getElementById('loginError').style.display = 'none';
                showDashboard();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('isLoggedIn');
            location.reload();
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            populateGrades();
            loadRecords();
            updateStats();
        }

        // ==========================================
        // 3. منطق القوائم المنسدلة
        // ==========================================
        function populateGrades() {
            const select = document.getElementById('gradeSelect');
            select.innerHTML = '<option value="">-- اختر الصف --</option>';
            for (let g in schoolData) {
                let opt = document.createElement('option');
                opt.value = g; opt.innerText = g;
                select.appendChild(opt);
            }
        }

        function loadSections() {
            const grade = document.getElementById('gradeSelect').value;
            const secSelect = document.getElementById('sectionSelect');
            const stuSelect = document.getElementById('studentSelect');
            
            secSelect.innerHTML = '<option value="">-- اختر الشعبة --</option>';
            stuSelect.innerHTML = '<option value="">-- اختر الطالب --</option>';
            stuSelect.disabled = true;

            if(grade) {
                secSelect.disabled = false;
                for(let s in schoolData[grade]) {
                    let opt = document.createElement('option');
                    opt.value = s; opt.innerText = s;
                    secSelect.appendChild(opt);
                }
            } else {
                secSelect.disabled = true;
            }
        }

        function loadStudents() {
            const grade = document.getElementById('gradeSelect').value;
            const section = document.getElementById('sectionSelect').value;
            const stuSelect = document.getElementById('studentSelect');

            stuSelect.innerHTML = '<option value="">-- اختر الطالب --</option>';
            
            if(grade && section) {
                stuSelect.disabled = false;
                const students = schoolData[grade][section];
                students.forEach(s => {
                    let opt = document.createElement('option');
                    opt.value = s; opt.innerText = s;
                    stuSelect.appendChild(opt);
                });
            } else {
                stuSelect.disabled = true;
            }
        }

        // ==========================================
        // 4. العمليات (حفظ، حذف، بحث، تصدير)
        // ==========================================

        function saveRecord() {
            const name = document.getElementById('studentSelect').value;
            const grade = document.getElementById('gradeSelect').value;
            const section = document.getElementById('sectionSelect').value;
            const time = document.getElementById('timeInput').value;
            const notes = document.getElementById('notesInput').value;

            if(!name || name === "") {
                alert("يجب اختيار اسم الطالب أولاً");
                return;
            }

            const record = {
                id: Date.now(),
                name, grade, section, time, notes,
                date: new Date().toLocaleDateString('ar-EG')
            };

            let records = JSON.parse(localStorage.getItem('lateRecords') || "[]");
            records.push(record);
            localStorage.setItem('lateRecords', JSON.stringify(records));

            // تفريغ الحقول وإعادة التحميل
            document.getElementById('studentSelect').value = "";
            document.getElementById('notesInput').value = "";
            loadRecords();
            updateStats();
            alert("تم الرصد بنجاح ✅");
        }

        function deleteRecord(id) {
            if(confirm("هل أنت متأكد من حذف هذا السجل؟")) {
                let records = JSON.parse(localStorage.getItem('lateRecords') || "[]");
                records = records.filter(r => r.id !== id);
                localStorage.setItem('lateRecords', JSON.stringify(records));
                loadRecords();
                updateStats();
            }
        }

        function loadRecords(filterText = "") {
            const records = JSON.parse(localStorage.getItem('lateRecords') || "[]");
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";

            // ترتيب عكسي (الأحدث أولاً)
            const sorted = records.reverse();

            sorted.forEach((r, index) => {
                // تصفية البحث
                if(filterText && !r.name.includes(filterText)) return;

                let row = `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${r.name}</strong></td>
                    <td><span class="badge bg-grade">${r.grade} - ${r.section}</span></td>
                    <td style="color:#e67e22; font-weight:bold;">${r.time}</td>
                    <td>${r.date}</td>
                    <td>${r.notes}</td>
                    <td class="actions-column no-print">
                        <button class="actions-btn btn-del" onclick="deleteRecord(${r.id})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function filterTable() {
            const txt = document.getElementById('searchInput').value;
            loadRecords(txt);
        }

        function updateStats() {
            const records = JSON.parse(localStorage.getItem('lateRecords') || "[]");
            const today = new Date().toLocaleDateString('ar-EG');
            
            // حساب اليوم
            const todayCount = records.filter(r => r.date === today).length;
            document.getElementById('statToday').innerText = todayCount;

            // حساب الكل (الأسبوع مجازاً)
            document.getElementById('statWeek').innerText = records.length;

            // حساب الأكثر تكراراً
            if(records.length > 0) {
                const counts = {};
                records.forEach(r => { counts[r.name] = (counts[r.name] || 0) + 1; });
                const topStudent = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
                document.getElementById('statTopStudent').innerText = topStudent + ` (${counts[topStudent]})`;
            } else {
                document.getElementById('statTopStudent').innerText = "-";
            }
        }

        // تصدير إلى Excel (CSV)
        function exportToExcel() {
            const records = JSON.parse(localStorage.getItem('lateRecords') || "[]");
            let csv = "\uFEFFالاسم,الصف,الشعبة,الوقت,التاريخ,الملاحظات\n"; // BOM for Arabic
            
            records.forEach(r => {
                csv += `${r.name},${r.grade},${r.section},${r.time},${r.date},${r.notes}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "تقرير_المتأخرين.csv";
            link.click();
        }
    </script>
</body>
</html>
