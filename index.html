<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام الإدارة المدرسية المتكامل - الإصدار الإمبراطوري</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Tajawal:wght@200;300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* تعريف متغيرات الألوان للنظام (System Color Palette) */
        :root {
            /* الألوان الأساسية */
            --color-primary: #145A32;        /* أخضر ملكي */
            --color-primary-dark: #0B3B24;   /* أخضر غامق جداً */
            --color-primary-light: #1E8449;  /* أخضر فاتح */
            
            /* الألوان الثانوية */
            --color-gold: #D4AC0D;           /* ذهبي */
            --color-gold-light: #F1C40F;     /* أصفر مشرق */
            
            /* ألوان الوظائف */
            --color-visitor: #2980B9;        /* أزرق (للزوار) */
            --color-departure: #E67E22;      /* برتقالي (للانصراف) */
            --color-danger: #C0392B;         /* أحمر (للخطر/الرفض) */
            --color-success: #27AE60;        /* أخضر (للنجاح/القبول) */
            --color-special: #8E44AD;        /* بنفسجي (للحالات الخاصة) */
            
            /* الخلفيات */
            --bg-body: #F3F4F6;
            --bg-card: #FFFFFF;
            --bg-input: #FAFAFA;
            
            /* النصوص */
            --text-main: #1F2937;
            --text-muted: #6B7280;
            
            /* الظلال */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.12);
            --shadow-xl: 0 25px 50px rgba(0,0,0,0.25);
            
            /* التدرجات */
            --gradient-header: linear-gradient(135deg, #145A32 0%, #000000 100%);
            --gradient-card: linear-gradient(to bottom, #ffffff, #f9fafb);
            
            --header-height: 90px;
        }

        /* --- إعادة التعيين والأساسيات (Reset) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 120px;
            line-height: 1.6;
        }

        /* --- نظام التنبيهات (Toast Notifications) --- */
        #toast-wrapper {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100000;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 90%;
            max-width: 450px;
            pointer-events: none;
        }

        .toast-item {
            background: rgba(30, 30, 30, 0.95);
            color: #fff;
            padding: 18px 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 700;
            font-size: 1.05rem;
            animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), fadeOut 0.5s 4s forwards;
            pointer-events: auto;
            border-right: 6px solid transparent;
        }

        .toast-success { border-right-color: var(--color-success); }
        .toast-error { border-right-color: var(--color-danger); }
        .toast-info { border-right-color: var(--color-visitor); }
        .toast-warning { border-right-color: var(--color-departure); }

        @keyframes slideDown { 
            from { transform: translateY(-100%); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

        /* --- شاشة الدخول (Login Interface) --- */
        #login-overlay {
            position: fixed;
            inset: 0;
            background: var(--gradient-header);
            z-index: 20000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(15px);
        }

        .login-box {
            background: rgba(255, 255, 255, 0.98);
            width: 95%;
            max-width: 600px;
            padding: 4rem 3rem;
            border-radius: 3rem;
            text-align: center;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.5);
            border-top: 15px solid var(--color-gold);
            position: relative;
            overflow: hidden;
        }

        .login-logo {
            font-size: 5rem;
            color: var(--color-primary);
            margin-bottom: 1.5rem;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
        }

        .role-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 2rem;
        }

        .role-card {
            border: 2px solid #e5e7eb;
            border-radius: 1.5rem;
            padding: 1.5rem 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            background: #fff;
        }

        .role-card:hover {
            transform: translateY(-8px);
            border-color: var(--color-primary);
            background: #f0fdf4;
            box-shadow: var(--shadow-md);
        }

        .role-card i { font-size: 2.5rem; color: #6b7280; transition: 0.3s; }
        .role-card:hover i { color: var(--color-primary); }
        .role-card h3 { font-size: 1rem; margin: 0; font-weight: 700; color: #374151; }

        /* حقول الدخول */
        .pin-wrapper { display: none; margin-top: 2rem; }
        .pin-input {
            width: 100%;
            padding: 1.25rem;
            font-size: 2.5rem;
            text-align: center;
            letter-spacing: 15px;
            border: 2px solid #d1d5db;
            border-radius: 1.5rem;
            font-family: monospace;
            background: #f9fafb;
            transition: 0.3s;
        }
        .pin-input:focus { border-color: var(--color-primary); background: #fff; box-shadow: 0 0 0 5px rgba(20, 90, 50, 0.1); }

        /* --- الهيدر (Header) --- */
        header {
            background: var(--gradient-header);
            color: white;
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 3%;
            position: sticky;
            top: 0;
            z-index: 5000;
            box-shadow: var(--shadow-lg);
        }

        .brand-area { display: flex; align-items: center; gap: 15px; }
        .brand-area h1 { font-family: 'Amiri'; font-size: 2rem; margin: 0; font-weight: 700; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .brand-area small { opacity: 0.8; font-size: 0.9rem; letter-spacing: 1px; }

        .tools-area { display: flex; align-items: center; gap: 20px; }
        
        .icon-btn {
            width: 45px; height: 45px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 1.2rem;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.25); transform: scale(1.1); }
        .icon-btn.active { background: var(--color-gold); color: #000; border-color: var(--color-gold); }
        .icon-btn.logout { background: rgba(192, 57, 43, 0.8); }

        /* --- شريط التنقل (Navigation) --- */
        .nav-wrapper {
            background: white;
            padding: 15px 0;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: var(--header-height);
            z-index: 4000;
            margin-bottom: 2rem;
        }

        .nav-items {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 0 3%;
            justify-content: center;
            scrollbar-width: none;
        }
        .nav-items::-webkit-scrollbar { display: none; }

        .nav-btn {
            background: #f8f9fa;
            border: none;
            padding: 12px 25px;
            border-radius: 15px;
            font-size: 1.1rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            white-space: nowrap;
        }

        .nav-btn:hover { background: #e6f4ea; color: var(--color-primary); }
        .nav-btn.active { background: var(--color-primary); color: white; box-shadow: var(--shadow-md); transform: translateY(-2px); }

        /* --- المحتوى (Main Content) --- */
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .view-section { display: none; animation: slideUp 0.5s ease-out; }
        .view-section.active { display: block; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--bg-card);
            border-radius: 25px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px dashed #e5e7eb;
        }
        .card-title { font-size: 1.5rem; color: var(--color-primary); font-weight: 800; display: flex; align-items: center; gap: 10px; }

        /* --- العناصر والمدخلات (Inputs & Buttons) --- */
        .form-control {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            font-size: 1.1rem;
            background: var(--bg-input);
            transition: 0.3s;
            color: var(--text-main);
        }
        .form-control:focus { border-color: var(--color-gold); background: white; box-shadow: 0 0 0 4px rgba(212, 172, 13, 0.1); }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 1rem;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-top: 1rem;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--color-primary); color: white; box-shadow: 0 4px 6px rgba(20, 90, 50, 0.2); }
        .btn-secondary { background: var(--color-gold); color: #222; }
        .btn-danger { background: var(--color-danger); color: white; }
        .btn-visitor { background: var(--color-visitor); color: white; }
        .btn-departure { background: var(--color-departure); color: white; }

        /* --- البطاقات والشبكات (Grid & Cards) --- */
        .grid-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }

        .monitor-card {
            background: white; padding: 20px; border-radius: 20px; border-right: 8px solid var(--color-success);
            box-shadow: var(--shadow-sm); position: relative; transition: 0.3s;
        }
        .monitor-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .monitor-card.late { border-right-color: var(--color-danger); background: #fff5f5; }
        .monitor-card.special { border-right-color: var(--color-special); background: #fdf4ff; }

        /* --- الجداول والتقارير (Tables) --- */
        .report-tabs { display: flex; gap: 10px; margin-bottom: 25px; background: #f3f4f6; padding: 5px; border-radius: 15px; }
        .report-tab-btn { flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; border-radius: 12px; font-weight: bold; color: #666; transition: 0.3s; }
        .report-tab-btn.active { background: white; color: var(--color-primary); box-shadow: var(--shadow-sm); }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th { background: #f9fafb; padding: 15px; text-align: right; color: #6b7280; font-weight: 800; border-bottom: 2px solid #e5e7eb; }
        .data-table td { padding: 15px; border-bottom: 1px solid #f3f4f6; }
        .data-table tr:hover { background: #f9fafb; }

        /* --- شارات الحالة (Status Tags) --- */
        .tag { padding: 5px 12px; border-radius: 50px; font-size: 0.85rem; font-weight: bold; }
        .tag-green { background: #d1fae5; color: #065f46; }
        .tag-red { background: #fee2e2; color: #991b1b; }
        .tag-blue { background: #dbeafe; color: #1e40af; }
        .tag-orange { background: #ffedd5; color: #9a3412; }

        /* --- القوائم في الإعدادات --- */
        .list-container { max-height: 350px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 15px; margin-top: 15px; }
        .list-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; border-bottom: 1px solid #f3f4f6; }
        .list-row:hover { background: #f9fafb; }
        .del-icon { width: 35px; height: 35px; border-radius: 50%; background: #fee2e2; color: #ef4444; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .del-icon:hover { background: #ef4444; color: white; }

        /* --- الطباعة (Print Styles) --- */
        .print-template { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 20000; }
        @media print {
            body * { visibility: hidden; }
            .print-template, .print-template * { visibility: visible; }
            .print-template { display: block !important; }
            .cert-print-box { border: 30px double var(--color-gold); height: 100%; padding: 40px; text-align: center; }
            .visitor-log-print { padding: 20px; }
            .no-print { display: none !important; }
        }

        /* --- للجوال --- */
        @media (max-width: 768px) {
            header { height: auto; flex-direction: column; padding: 15px; gap: 15px; }
            .nav-items { justify-content: flex-start; }
            .grid-dashboard { grid-template-columns: 1fr; }
            .role-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <audio id="sound-success" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sound-error" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3"></audio>
    <audio id="sound-alert" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <audio id="sound-doorbell" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>

    <div id="toast-wrapper"></div>

    <div id="login-overlay">
        <div class="login-box" id="step-role">
            <i class="fas fa-school login-logo"></i>
            <h1 style="font-family:'Amiri'; color:var(--color-primary); margin-bottom:10px">متوسطة الإمام النووي</h1>
            <p style="color:#666; margin-bottom:30px; font-weight:700">بوابة الإدارة المدرسية الذكية</p>
            
            <div class="role-grid">
                <div class="role-card" onclick="Auth.selectRole('admin')">
                    <i class="fas fa-user-shield"></i>
                    <h3>الإدارة / الوكيل</h3>
                </div>
                <div class="role-card" onclick="Auth.selectRole('teacher')">
                    <i class="fas fa-chalkboard-user"></i>
                    <h3>المعلم</h3>
                </div>
                <div class="role-card" onclick="Auth.selectRole('guard')">
                    <i class="fas fa-user-lock"></i>
                    <h3>الأمن / الحارس</h3>
                </div>
            </div>
        </div>

        <div class="login-box pin-wrapper" id="step-pin">
            <h2 style="color:var(--color-primary); margin-bottom:20px">التحقق الأمني</h2>
            <p style="margin-bottom:20px; color:#666">أدخل كود الدخول المصرح به لهذه الصلاحية</p>
            
            <input type="password" id="pin-input" class="pin-input" placeholder="••••" maxlength="4">
            
            <div style="display:flex; gap:15px; margin-top:20px">
                <button class="btn btn-primary" onclick="Auth.login()">تأكيد الدخول</button>
                <button class="btn btn-danger" onclick="location.reload()">رجوع</button>
            </div>
        </div>
    </div>

    <div id="app-core" style="display:none">
        
        <header class="no-print">
            <div class="brand-area">
                <i class="fas fa-graduation-cap" style="font-size:3rem; color:var(--color-gold)"></i>
                <div>
                    <h1>إذن الرقمي</h1>
                    <small>Titanium System V6.0</small>
                </div>
            </div>
            
            <div class="tools-area">
                <div class="icon-btn" id="btn-sound" onclick="Sound.toggle()" title="تشغيل/كتم الصوت">
                    <i class="fas fa-volume-up"></i>
                </div>
                
                <div style="background:rgba(255,255,255,0.2); padding:8px 20px; border-radius:50px; font-weight:bold; color:white; border:1px solid rgba(255,255,255,0.3)">
                    <i class="fas fa-walking"></i> <span id="header-live-count">0</span> بالخارج
                </div>
                
                <div class="icon-btn logout" onclick="location.reload()" title="تسجيل خروج">
                    <i class="fas fa-power-off"></i>
                </div>
            </div>
        </header>

        <nav class="nav-wrapper no-print">
            <div class="nav-items" id="nav-container">
                </div>
        </nav>

        <div class="container no-print">

            <div id="view-home" class="view-section">
                <div class="card" style="text-align:center; background:linear-gradient(to bottom, #fff, #f0fdf4)">
                    <h3 style="color:#6b7280; display:flex; align-items:center; justify-content:center; gap:10px">
                        <i class="fas fa-key"></i> كود المعلم المتزامن اليومي
                    </h3>
                    <div id="daily-code-display" style="font-size:6rem; font-weight:900; color:var(--color-primary); margin:20px 0; font-family:monospace; letter-spacing:15px; text-shadow:2px 2px 0 #eee">----</div>
                    <button class="btn btn-secondary" style="width:auto; margin:0 auto; padding:10px 40px" onclick="Ops.generateCode()">
                        <i class="fas fa-sync"></i> تحديث الكود
                    </button>
                </div>

                <div class="grid-dashboard">
                    <div class="card" style="text-align:center; background:#ecfdf5; border-color:#6ee7b7">
                        <i class="fas fa-clipboard-check" style="font-size:3rem; color:var(--color-primary); margin-bottom:10px"></i>
                        <h2 id="stat-permits" style="font-size:3.5rem; margin:0; color:var(--color-primary)">0</h2>
                        <p style="font-weight:bold">أذونات اليوم</p>
                    </div>
                    <div class="card" style="text-align:center; background:#fff7ed; border-color:#fdba74">
                        <i class="fas fa-door-open" style="font-size:3rem; color:var(--color-departure); margin-bottom:10px"></i>
                        <h2 id="stat-departures" style="font-size:3.5rem; margin:0; color:var(--color-departure)">0</h2>
                        <p style="font-weight:bold">حالات انصراف</p>
                    </div>
                    <div class="card" style="text-align:center; background:#eff6ff; border-color:#93c5fd">
                        <i class="fas fa-users" style="font-size:3rem; color:var(--color-visitor); margin-bottom:10px"></i>
                        <h2 id="stat-visitors" style="font-size:3.5rem; margin:0; color:var(--color-visitor)">0</h2>
                        <p style="font-weight:bold">زوار اليوم</p>
                    </div>
                </div>
            </div>

            <div id="view-teacher" class="view-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-file-pen"></i> إصدار إذن خروج (داخلي)</h2>
                    </div>
                    
                    <div style="background:#f9fafb; padding:20px; border-radius:15px; border:1px solid #e5e7eb; margin-bottom:20px">
                        <label class="form-label">المعلم المصدر للإذن:</label>
                        <select id="teacher-select" class="form-control">
                            <option value="">جاري تحميل القائمة...</option>
                        </select>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 2fr; gap:20px; margin-bottom:20px">
                        <div>
                            <label class="form-label">الشعبة / الصف:</label>
                            <select id="class-select" class="form-control" onchange="Data.filterStudents('class-select', 'student-select')">
                                <option value="">اختر الشعبة...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">اسم الطالب:</label>
                            <select id="student-select" class="form-control">
                                <option value="">اختر الطالب...</option>
                            </select>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:2fr 1fr; gap:20px">
                        <div>
                            <label class="form-label">الوجهة:</label>
                            <select id="destination-select" class="form-control">
                                <option>دورة المياه</option>
                                <option>المقصف</option>
                                <option>مكتب الإدارة</option>
                                <option>المرشد الطلابي</option>
                                <option>وكيل شؤون الطلاب</option>
                                <option>المصلى</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">المدة (دقائق):</label>
                            <input type="number" id="duration-input" class="form-control" value="5" min="1" max="60">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="Ops.createPermit()">
                        <i class="fas fa-paper-plane"></i> إصدار وطباعة الإذن
                    </button>
                </div>
            </div>

            <div id="view-wakil" class="view-section">
                <div class="card">
                    <div class="card-header"><h2 class="card-title" style="color:var(--color-departure)"><i class="fas fa-door-open"></i> إصدار كرت انصراف طالب</h2></div>
                    <div style="display:flex; gap:15px; margin-bottom:15px">
                        <select id="wakil-class-select" class="form-control" style="flex:1" onchange="Data.filterStudents('wakil-class-select', 'wakil-student-select')"><option>الشعبة...</option></select>
                        <select id="wakil-student-select" class="form-control" style="flex:2"><option>الطالب...</option></select>
                    </div>
                    <input type="text" id="departure-reason" class="form-control" placeholder="سبب الانصراف / اسم المستلم (ولي الأمر)" style="margin-bottom:15px">
                    <button class="btn btn-departure" onclick="Ops.createDeparture()">
                        <i class="fas fa-check-circle"></i> اعتماد الانصراف وإشعار الحارس
                    </button>
                </div>

                <div class="card">
                    <div class="card-header"><h2 class="card-title" style="color:var(--color-visitor)"><i class="fas fa-users"></i> طلبات الزوار (واردة من الحارس)</h2></div>
                    <div id="wakil-visitor-list">
                        <p style="text-align:center; color:#999; padding:20px">لا توجد طلبات انتظار حالياً</p>
                    </div>
                </div>
            </div>

            <div id="view-guard" class="view-section">
                <div class="card">
                    <div class="card-header"><h2 class="card-title" style="color:var(--color-visitor)"><i class="fas fa-id-card"></i> تسجيل زائر جديد</h2></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px">
                        <input type="text" id="guard-visitor-name" class="form-control" placeholder="اسم الزائر الرباعي">
                        <input type="number" id="guard-visitor-id" class="form-control" placeholder="رقم الهوية / السجل">
                    </div>
                    <input type="text" id="guard-visitor-reason" class="form-control" placeholder="سبب الزيارة (مثال: لمقابلة المدير)" style="margin-bottom:15px">
                    <button class="btn btn-visitor" onclick="Ops.requestVisitor()">
                        <i class="fas fa-paper-plane"></i> إرسال طلب للإدارة
                    </button>
                </div>

                <div class="card" style="background:#fff7ed; border:2px solid var(--color-departure)">
                    <div class="card-header"><h2 class="card-title" style="color:var(--color-departure)"><i class="fas fa-child-reaching"></i> طلاب مصرح لهم بالخروج</h2></div>
                    <div id="guard-departure-list">
                        </div>
                </div>
            </div>

            <div id="view-monitor" class="view-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px">
                    <h2 style="color:var(--color-primary); font-family:'Amiri'">المتابعة الميدانية الحية</h2>
                    <span class="tag tag-green"><i class="fas fa-circle-notch fa-spin"></i> تحديث تلقائي</span>
                </div>
                <div id="monitor-grid" class="grid-dashboard"></div>
            </div>

            <div id="view-reports" class="view-section">
                <div class="card">
                    <div class="card-header"><h2 class="card-title"><i class="fas fa-chart-pie"></i> مركز التقارير والتحليل</h2></div>
                    
                    <div class="report-tabs">
                        <button class="report-tab-btn active" onclick="Reports.switch('students')">تحليل الطلاب</button>
                        <button class="report-tab-btn" onclick="Reports.switch('special')">الحالات الخاصة</button>
                        <button class="report-tab-btn" onclick="Reports.switch('visitors')">سجل الزوار</button>
                    </div>

                    <div id="rep-sec-students">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px">
                            <label style="font-weight:bold">اختر الشهر:</label>
                            <input type="month" id="rep-month-picker" class="form-control" style="width:auto; padding:8px" onchange="Reports.render()">
                        </div>
                        <div style="height:350px"><canvas id="main-chart"></canvas></div>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:30px">
                            <div style="background:#fef2f2; padding:20px; border-radius:15px; border:1px solid #fecaca">
                                <h4 style="color:var(--color-danger); margin-bottom:10px"><i class="fas fa-sort-amount-up"></i> الأكثر استئذاناً</h4>
                                <ul id="list-top-students" style="padding-right:20px"></ul>
                            </div>
                            <div style="background:#ecfdf5; padding:20px; border-radius:15px; border:1px solid #a7f3d0">
                                <h4 style="color:var(--color-success); margin-bottom:10px"><i class="fas fa-sort-amount-down"></i> الأقل استئذاناً</h4>
                                <ul id="list-low-students" style="padding-right:20px"></ul>
                            </div>
                        </div>
                    </div>

                    <div id="rep-sec-special" style="display:none">
                        <div style="background:#fdf4ff; padding:15px; border-radius:10px; border:1px solid #d8b4fe; margin-bottom:15px">
                            <i class="fas fa-info-circle" style="color:var(--color-special)"></i> هذا السجل خاص بالطلاب المسجلين كـ "حالة خاصة/صحية" ولا يظهرون في الإحصائيات العامة.
                        </div>
                        <div style="overflow-x:auto">
                            <table class="data-table">
                                <thead><tr><th>الطالب</th><th>الصف</th><th>الوجهة</th><th>الوقت</th><th>التاريخ</th></tr></thead>
                                <tbody id="table-special-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="rep-sec-visitors" style="display:none">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                            <h4 style="color:var(--color-visitor)">أرشيف الزوار الكامل</h4>
                            <button class="btn btn-secondary" style="width:auto; padding:8px 20px" onclick="window.print()"><i class="fas fa-print"></i> طباعة السجل</button>
                        </div>
                        <div style="overflow-x:auto">
                            <table class="data-table" id="visitor-archive-table">
                                <thead><tr><th>م</th><th>الاسم</th><th>الهوية</th><th>السبب</th><th>وقت الدخول</th><th>الحالة</th></tr></thead>
                                <tbody id="table-visitors-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="view-section">
                <div class="card">
                    <div class="report-tabs">
                        <button class="report-tab-btn active" onclick="Settings.switch('teachers')">المعلمون</button>
                        <button class="report-tab-btn" onclick="Settings.switch('students')">الطلاب والشعب</button>
                        <button class="report-tab-btn" onclick="Settings.switch('system')">النظام</button>
                    </div>

                    <div id="set-sec-teachers">
                        <div style="background:#f9fafb; padding:20px; border-radius:15px; border:1px solid #e5e7eb; margin-bottom:20px">
                            <h4 style="color:var(--color-primary); margin-bottom:15px">إضافة معلم</h4>
                            <div style="display:flex; gap:10px; margin-bottom:20px">
                                <input type="text" id="new-teacher-name" class="form-control" placeholder="اسم المعلم" style="margin:0">
                                <button class="btn btn-primary" style="width:150px; margin:0" onclick="Settings.addTeacher()">حفظ</button>
                            </div>
                            <div style="border:2px dashed #d1d5db; padding:20px; text-align:center; border-radius:15px; cursor:pointer" onclick="document.getElementById('imp-file-teacher').click()">
                                <i class="fas fa-file-excel" style="font-size:2rem; color:var(--color-success)"></i>
                                <p style="margin-top:10px; font-weight:bold">استيراد من Excel</p>
                                <input type="file" id="imp-file-teacher" hidden onchange="Settings.importTeachers(this)">
                            </div>
                        </div>
                        <div id="list-teachers-view" class="list-container"></div>
                    </div>

                    <div id="set-sec-students" style="display:none">
                        <div style="background:#ecfdf5; padding:20px; border-radius:15px; border:2px solid var(--color-primary); margin-bottom:20px">
                            <h4 style="color:var(--color-primary); font-weight:800; margin-bottom:10px">1. حدد الشعبة المستهدفة أولاً:</h4>
                            <div style="display:flex; gap:10px">
                                <input type="text" id="target-class-input" class="form-control" placeholder="مثال: 1/1" style="font-weight:bold; color:var(--color-primary); margin:0">
                                <button class="btn btn-primary" style="width:150px; margin:0" onclick="Settings.saveClass()">تثبيت</button>
                            </div>
                        </div>

                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px">
                            <div style="background:white; padding:15px; border:1px solid #eee; border-radius:15px">
                                <h4 style="color:var(--color-visitor)">أ- إضافة يدوية</h4>
                                <input type="text" id="new-student-name" class="form-control" placeholder="اسم الطالب" style="margin-bottom:10px">
                                <label style="display:flex; align-items:center; gap:10px; cursor:pointer">
                                    <input type="checkbox" id="is-special-case" style="width:20px; height:20px">
                                    <span style="color:var(--color-special); font-weight:bold">حالة خاصة / صحية</span>
                                </label>
                                <button class="btn btn-secondary" onclick="Settings.addStudent()">حفظ في الشعبة أعلاه</button>
                            </div>
                            <div style="background:white; padding:15px; border:1px solid #eee; border-radius:15px">
                                <h4 style="color:var(--color-success)">ب- استيراد Excel</h4>
                                <p style="font-size:0.9rem; color:#666; margin-bottom:10px">ارفع ملف الأسماء فقط. سيتم ربطهم بالشعبة المثبتة.</p>
                                <div style="border:2px dashed #d1d5db; padding:15px; text-align:center; border-radius:10px; cursor:pointer" onclick="Settings.triggerImport()">
                                    <i class="fas fa-cloud-upload-alt"></i> رفع الملف
                                    <input type="file" id="imp-file-student" hidden onchange="Settings.importStudents(this)">
                                </div>
                            </div>
                        </div>
                        <div id="list-classes-view" class="list-container" style="margin-top:20px"></div>
                    </div>

                    <div id="set-sec-system" style="display:none; text-align:center">
                        <div style="padding:40px; background:#fef2f2; border:3px dashed var(--color-danger); border-radius:20px">
                            <h3 style="color:var(--color-danger)">إعادة ضبط المصنع</h3>
                            <p style="margin-bottom:20px">حذف جميع البيانات نهائياً.</p>
                            <button class="btn btn-danger" style="width:auto; padding:10px 40px" onclick="Settings.wipeAll()">تصفير النظام</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-cert" class="view-section">
                <div class="card" style="text-align:center">
                    <i class="fas fa-award" style="font-size:5rem; color:var(--color-gold); margin-bottom:20px; display:inline-block"></i>
                    <h2>إصدار شهادات شكر وتقدير</h2>
                    <div style="max-width:500px; margin:30px auto; text-align:right">
                        <label>1. اختر الشعبة:</label>
                        <select id="cert-class-select" class="form-control" onchange="Data.filterStudents('cert-class-select', 'cert-student-select')">
                            <option>الشعبة...</option>
                        </select>
                        <br>
                        <label>2. اختر الطالب:</label>
                        <select id="cert-student-select" class="form-control" style="margin-bottom:20px">
                            <option>الطالب...</option>
                        </select>
                        
                        <button class="btn btn-secondary" onclick="Ops.printCert()">معاينة وطباعة</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="print-template cert-print-box" id="cert-print-area">
        <h1 style="font-family:'Amiri'; font-size:5rem; color:var(--color-primary); margin-bottom:50px">شهادة شكر وتقدير</h1>
        <h2 style="font-size:2.5rem; margin:40px 0; color:#333">تتقدم إدارة متوسطة الإمام النووي بخالص الشكر والتقدير للطالب:</h2>
        <h1 id="print-student-name" style="font-family:'Amiri'; font-size:4.5rem; color:var(--color-gold); text-decoration:underline; font-weight:bold"></h1>
        <p style="font-size:2rem; margin-top:30px; color:#555">وذلك نظير انضباطه المدرسي المتميز وحسن سلوكه.</p>
        
        <div style="display:flex; justify-content:space-around; margin-top:150px">
            <div style="text-align:center">
                <h3>وكيل شؤون الطلاب</h3>
                <p>....................</p>
            </div>
            <div style="text-align:center">
                <h3>مدير المدرسة</h3>
                <p style="font-family:'Amiri'; font-weight:bold; font-size:2rem; color:var(--color-primary)">إبراهيم بن يحيى جابر اللغبي</p>
            </div>
        </div>
    </div>

    <div class="print-template visitor-log-print" id="visitor-log-print-area">
        <h1 style="text-align:center; font-family:'Amiri'; margin-bottom:20px">سجل الزوار - متوسطة الإمام النووي</h1>
        <table class="data-table" border="1" width="100%" id="print-table-content"></table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, query, orderBy, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp({ projectId: "edin-377b2", authDomain: "edin-377b2.firebaseapp.com" });
        const db = getFirestore(app);

        // State
        let ROLE = null;
        let CACHE = { teachers: [], students: [], classes: [] };
        let PERMS = [], VISITORS = [], DEPARTURES = [];
        let SOUND_ON = true;
        let CHART_INSTANCE = null;

        // --- Sound System ---
        const Sound = {
            play: (type) => {
                if (!SOUND_ON) return;
                const id = type==='success'?'sound-success':(type==='error'?'sound-error':(type==='alert'?'sound-alert':'sound-doorbell'));
                const el = document.getElementById(id);
                if (el) { el.currentTime=0; el.play().catch(()=>{}); }
            },
            toggle: () => {
                SOUND_ON = !SOUND_ON;
                document.getElementById('btn-sound').innerHTML = SOUND_ON ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
                Toast(SOUND_ON?"تم تفعيل الصوت":"تم كتم الصوت", "info");
            }
        };

        // --- Notification System ---
        window.Toast = (msg, type='success') => {
            Sound.play(type);
            const container = document.getElementById('toast-wrapper');
            const el = document.createElement('div');
            el.className = `toast-item toast-${type}`;
            let icon = type==='success'?'check':(type==='error'?'times':(type==='warning'?'exclamation-triangle':'bell'));
            el.innerHTML = `<i class="fas fa-${icon}"></i> ${msg}`;
            container.appendChild(el);
            setTimeout(() => el.remove(), 4000);
        };

        // --- Auth System ---
        const Auth = {
            selectRole: (r) => { ROLE=r; document.getElementById('step-role').style.display='none'; document.querySelector('.pin-wrapper').style.display='block'; document.getElementById('pin-input').focus(); },
            login: async () => {
                const p = document.getElementById('pin-input').value;
                if (ROLE==='admin' && p==='2025') return App.start();
                if (ROLE==='guard' && p==='2020') return App.start();
                
                try {
                    const snap = await getDoc(doc(db,"settings","dailyCode"));
                    const sCode = snap.exists() ? snap.data().value : "1234";
                    if (ROLE==='teacher' && (p===sCode || p==='1234')) return App.start();
                    Toast("الكود غير صحيح","error");
                } catch(e) { 
                    if (ROLE==='teacher' && p==='1234') return App.start();
                    Toast("خطأ اتصال","error");
                }
            }
        };

        // --- Main App Logic ---
        const App = {
            start: () => {
                document.getElementById('login-overlay').style.display='none';
                document.getElementById('app-core').style.display='block';
                App.buildNav();
                Sync.init();
                Toast("تم تسجيل الدخول بنجاح");
            },
            buildNav: () => {
                const n = document.getElementById('nav-container');
                let h = '';
                if(ROLE==='admin') {
                    h += `<button class="nav-btn active" onclick="Nav('view-home',this)"><i class="fas fa-home"></i> الرئيسية</button>
                          <button class="nav-btn" onclick="Nav('view-wakil',this)"><i class="fas fa-user-tie"></i> الوكيل</button>
                          <button class="nav-btn" onclick="Nav('view-monitor',this)"><i class="fas fa-desktop"></i> المتابعة</button>
                          <button class="nav-btn" onclick="Nav('view-reports',this)"><i class="fas fa-chart-pie"></i> التقارير</button>
                          <button class="nav-btn" onclick="Nav('view-settings',this)"><i class="fas fa-cogs"></i> الإعدادات</button>
                          <button class="nav-btn" onclick="Nav('view-cert',this)"><i class="fas fa-award"></i> الشهادات</button>`;
                    Nav('view-home');
                } else if(ROLE==='guard') {
                    h += `<button class="nav-btn active" onclick="Nav('view-guard',this)"><i class="fas fa-shield-alt"></i> بوابة الأمن</button>`;
                    Nav('view-guard');
                } else {
                    h += `<button class="nav-btn active" onclick="Nav('view-teacher',this)"><i class="fas fa-pen-nib"></i> إصدار إذن</button>
                          <button class="nav-btn" onclick="Nav('view-monitor',this)"><i class="fas fa-desktop"></i> المتابعة</button>`;
                    Nav('view-teacher');
                }
                n.innerHTML = h;
            }
        };

        window.Nav = (id, btn) => {
            document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(btn) { document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); }
            if(id==='view-reports') Reports.render();
        };

        // --- Data Sync ---
        const Sync = {
            init: () => {
                // 1. Lists
                onSnapshot(doc(db,"data","schoolLists"), (snap) => {
                    if (snap.exists()) {
                        const d = snap.data();
                        CACHE.teachers = d.teachers || [];
                        CACHE.students = d.students || [];
                        CACHE.classes = d.classes || [];
                        Data.populateAll();
                        Settings.renderLists();
                    }
                });
                
                // 2. Permits
                onSnapshot(query(collection(db,"perms"), orderBy("timestamp","desc")), (snap) => {
                    PERMS = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    UI.renderMonitor();
                    if(document.getElementById('view-reports').classList.contains('active')) Reports.render();
                });

                // 3. Visitors
                onSnapshot(query(collection(db,"visitors"), orderBy("reqTime","desc")), (snap) => {
                    VISITORS = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    UI.renderVisitors();
                });

                // 4. Departures
                onSnapshot(query(collection(db,"departures"), orderBy("time","desc")), (snap) => {
                    DEPARTURES = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    UI.renderDepartures();
                });

                // 5. Code
                onSnapshot(doc(db,"settings","dailyCode"), (s) => {
                    if(s.exists()) document.getElementById('daily-code-display').innerText = s.data().value;
                });
            }
        };

        // --- Data Helpers ---
        const Data = {
            populateAll: () => {
                // Teachers
                const tHTML = '<option value="">اختر المعلم...</option>' + CACHE.teachers.map(x=>`<option>${x}</option>`).join('');
                if(document.getElementById('teacher-select')) document.getElementById('teacher-select').innerHTML = tHTML;
                
                // Classes
                const cHTML = '<option value="">اختر الشعبة...</option>' + CACHE.classes.map(x=>`<option>${x}</option>`).join('');
                ['class-select', 'wakil-class-select', 'cert-class-select'].forEach(id => {
                    if(document.getElementById(id)) document.getElementById(id).innerHTML = cHTML;
                });
            },
            filterStudents: (srcId, destId) => {
                const cls = document.getElementById(srcId).value;
                const filtered = CACHE.students.filter(s => s.class === cls);
                document.getElementById(destId).innerHTML = '<option value="">اختر الطالب...</option>' + filtered.map(s=>`<option value="${s.name}">${s.name}</option>`).join('');
            }
        };

        // --- UI Rendering ---
        const UI = {
            renderMonitor: () => {
                const active = PERMS.filter(p => p.status === 'out');
                document.getElementById('header-live-count').innerText = active.length;
                document.getElementById('stat-permits').innerText = PERMS.filter(p=>p.timestamp && p.timestamp.toDate().toDateString()===new Date().toDateString()).length;
                
                document.getElementById('monitor-grid').innerHTML = active.map(p => {
                    const isSpecial = CACHE.students.find(s=>s.name===p.studentName)?.isSpecial;
                    const mins = Math.floor((new Date() - p.timestamp.toDate())/60000);
                    return `
                    <div class="monitor-card ${mins>p.limit?'late':''} ${isSpecial?'special':''}">
                        <h3 style="color:var(--color-primary); margin-bottom:5px">${p.studentName} ${isSpecial?'<i class="fas fa-star" style="color:var(--color-special)"></i>':''}</h3>
                        <p style="color:#666">${p.className} | ${p.teacherName}</p>
                        <div style="margin-top:10px; font-weight:bold"><i class="fas fa-map-marker-alt"></i> ${p.destination}</div>
                        <div class="tag tag-blue" style="width:fit-content; margin-top:10px">منذ ${mins} دقيقة</div>
                        ${ROLE!=='guard' ? `<button class="btn btn-primary" style="padding:8px; margin-top:10px; font-size:1rem" onclick="Ops.returnStudent('${p.id}')">تأكيد العودة</button>` : ''}
                    </div>`;
                }).join('') || '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#999">لا يوجد طلاب بالخارج</div>';
            },
            renderVisitors: () => {
                // Wakil View (Pending)
                const pending = VISITORS.filter(v => v.status === 'pending');
                const wakilList = document.getElementById('wakil-visitor-list');
                if(wakilList) {
                    wakilList.innerHTML = pending.map(v => `
                        <div class="monitor-card" style="border-right-color:var(--color-visitor)">
                            <h3>${v.name} <small>(${v.idNum})</small></h3>
                            <p>السبب: ${v.reason}</p>
                            <div style="display:flex; gap:10px; margin-top:10px">
                                <button class="btn btn-primary" style="padding:5px" onclick="Ops.visitorAction('${v.id}','approved')">قبول</button>
                                <button class="btn btn-danger" style="padding:5px" onclick="Ops.visitorAction('${v.id}','rejected')">رفض</button>
                            </div>
                        </div>
                    `).join('') || '<p style="text-align:center; color:#999; padding:20px">لا توجد طلبات جديدة</p>';
                    if(pending.length > 0) Sound.play('alert');
                }
                
                // Stats & Reports
                document.getElementById('stat-visitors').innerText = VISITORS.filter(v=>v.reqTime && v.reqTime.toDate().toDateString()===new Date().toDateString()).length;
                
                const reportTable = VISITORS.map((v,i) => `
                    <tr>
                        <td>${i+1}</td><td>${v.name}</td><td>${v.idNum}</td><td>${v.reason}</td>
                        <td>${v.entryTime ? new Date(v.entryTime.toDate()).toLocaleTimeString('ar-SA') : '-'}</td>
                        <td><span class="tag ${v.status==='approved'?'tag-green':(v.status==='rejected'?'tag-red':'tag-blue')}">${v.status==='approved'?'تم الدخول':(v.status==='rejected'?'مرفوض':'انتظار')}</span></td>
                    </tr>
                `).join('');
                if(document.getElementById('table-visitors-body')) document.getElementById('table-visitors-body').innerHTML = reportTable;
                if(document.getElementById('print-table-content')) document.getElementById('print-table-content').innerHTML = reportTable;
            },
            renderDepartures: () => {
                // Guard View (Approved Departures)
                const approved = DEPARTURES.filter(d => d.status === 'approved');
                document.getElementById('stat-departures').innerText = DEPARTURES.filter(d=>d.time && d.time.toDate().toDateString()===new Date().toDateString()).length;
                
                const guardList = document.getElementById('guard-departure-list');
                if(guardList) {
                    guardList.innerHTML = approved.map(d => `
                        <div class="monitor-card" style="border-right-color:var(--color-departure)">
                            <h3>${d.studentName} <small>(${d.className})</small></h3>
                            <p>المستلم: ${d.reason}</p>
                            <button class="btn btn-departure" onclick="Ops.confirmDeparture('${d.id}')" style="margin-top:10px">تسجيل المغادرة</button>
                        </div>
                    `).join('') || '<p style="text-align:center; color:#999; padding:20px">لا يوجد طلاب للانصراف</p>';
                }
            }
        };

        // --- Operations (Action Logic) ---
        const Ops = {
            // 1. Permit
            generateCode: async () => {
                await setDoc(doc(db,"settings","dailyCode"), { value: Math.floor(1000+Math.random()*9000).toString() });
                Toast("تم تحديث الكود");
            },
            createPermit: async () => {
                const s = document.getElementById('student-select').value;
                const c = document.getElementById('class-select').value;
                const t = document.getElementById('teacher-select').value;
                if(!s || s.includes("الطالب") || !c || !t) return Toast("الرجاء إكمال البيانات", "error");
                
                await addDoc(collection(db,"perms"), {
                    studentName: s, className: c, teacherName: t,
                    destination: document.getElementById('destination-select').value,
                    limit: parseInt(document.getElementById('duration-input').value),
                    status: 'out', timestamp: serverTimestamp()
                });
                Toast("تم إصدار الإذن بنجاح");
            },
            returnStudent: async (id) => {
                await updateDoc(doc(db,"perms",id), { status: 'returned', returnTime: serverTimestamp() });
                Toast("تم تسجيل عودة الطالب");
            },
            
            // 2. Visitors
            requestVisitor: async () => {
                const n = document.getElementById('guard-visitor-name').value;
                if(!n) return Toast("اكتب اسم الزائر", "error");
                await addDoc(collection(db,"visitors"), {
                    name: n, idNum: document.getElementById('guard-visitor-id').value,
                    reason: document.getElementById('guard-visitor-reason').value,
                    status: 'pending', reqTime: serverTimestamp()
                });
                Toast("تم إرسال الطلب للوكيل");
                document.getElementById('guard-visitor-name').value='';
            },
            visitorAction: async (id, status) => {
                await updateDoc(doc(db,"visitors",id), { status: status, entryTime: status==='approved'?serverTimestamp():null });
                Toast(status==='approved' ? "تم السماح بالدخول" : "تم الرفض");
            },

            // 3. Departures
            createDeparture: async () => {
                const s = document.getElementById('wakil-student-select').value;
                if(!s || s.includes("الطالب")) return Toast("اختر الطالب", "error");
                await addDoc(collection(db,"departures"), {
                    studentName: s, className: document.getElementById('wakil-class-select').value,
                    reason: document.getElementById('departure-reason').value,
                    status: 'approved', time: serverTimestamp()
                });
                Toast("تم اعتماد الانصراف");
            },
            confirmDeparture: async (id) => {
                await updateDoc(doc(db,"departures",id), { status: 'left', leftTime: serverTimestamp() });
                Toast("تم تسجيل المغادرة");
            },

            // 4. Certificates
            printCert: () => {
                const n = document.getElementById('cert-student-select').value;
                if(!n || n.includes("الطالب")) return Toast("اختر الطالب أولاً", "error");
                document.getElementById('print-student-name').innerText = n;
                window.print();
            }
        };

        // --- Settings (Smart Import & Sync) ---
        const Settings = {
            switch: (tab) => {
                ['teachers','students','system'].forEach(t => document.getElementById('set-sec-'+t).style.display = 'none');
                document.getElementById('set-sec-'+tab).style.display = 'block';
                document.querySelectorAll('.report-tab-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
            },
            // Teachers
            addTeacher: async () => {
                const n = document.getElementById('new-teacher-name').value.trim();
                if(!n) return;
                await setDoc(doc(db,"data","schoolLists"), { teachers: arrayUnion(n) }, { merge: true });
                Toast("تم حفظ المعلم");
            },
            importTeachers: (input) => {
                const r = new FileReader();
                r.onload = async (e) => {
                    const d = XLSX.utils.sheet_to_json(XLSX.read(e.target.result, {type:'array'}).Sheets[XLSX.read(e.target.result, {type:'array'}).SheetNames[0]]);
                    const t = [...new Set(d.map(row => findKey(row, ['اسم','معلم','name','teacher'])))].filter(Boolean);
                    if(t.length) { await setDoc(doc(db,"data","schoolLists"), { teachers: arrayUnion(...t) }, { merge: true }); Toast(`تم استيراد ${t.length} معلم`); }
                };
                r.readAsArrayBuffer(input.files[0]);
            },
            deleteTeacher: async (n) => { if(confirm("حذف؟")) await setDoc(doc(db,"data","schoolLists"), { teachers: arrayRemove(n) }, { merge: true }); },

            // Students & Classes
            saveClass: async () => {
                const c = document.getElementById('target-class-input').value.trim();
                if(!c) return Toast("أدخل اسم الشعبة", "error");
                await setDoc(doc(db,"data","schoolLists"), { classes: arrayUnion(c) }, { merge: true });
                Toast("تم تثبيت الشعبة");
            },
            addStudent: async () => {
                const n = document.getElementById('new-student-name').value.trim();
                const c = document.getElementById('target-class-input').value.trim();
                const sp = document.getElementById('is-special-case').checked;
                if(!c) return Toast("ثبت الشعبة أولاً", "error");
                
                await setDoc(doc(db,"data","schoolLists"), { 
                    students: arrayUnion({ name: n, class: c, isSpecial: sp }),
                    classes: arrayUnion(c)
                }, { merge: true });
                Toast("تم حفظ الطالب");
                document.getElementById('new-student-name').value = '';
            },
            triggerImport: () => {
                if(!document.getElementById('target-class-input').value) return Toast("يجب كتابة الشعبة وتثبيتها أولاً", "error");
                document.getElementById('imp-file-student').click();
            },
            importStudents: (input) => {
                const c = document.getElementById('target-class-input').value.trim();
                const r = new FileReader();
                r.onload = async (e) => {
                    const d = XLSX.utils.sheet_to_json(XLSX.read(e.target.result, {type:'array'}).Sheets[XLSX.read(e.target.result, {type:'array'}).SheetNames[0]]);
                    const s = d.map(row => {
                        const n = findKey(row, ['اسم','طالب','name','student']);
                        return n ? { name: n, class: c, isSpecial: false } : null;
                    }).filter(Boolean);
                    
                    if(s.length) {
                        await setDoc(doc(db,"data","schoolLists"), { students: arrayUnion(...s), classes: arrayUnion(c) }, { merge: true });
                        Toast(`تم ربط ${s.length} طالب بالشعبة ${c}`);
                    } else Toast("لم يتم العثور على عمود الاسم", "error");
                };
                r.readAsArrayBuffer(input.files[0]);
            },
            deleteClass: async (c) => {
                if(confirm("حذف الشعبة وطلابها؟")) {
                    const keep = CACHE.students.filter(s => s.class !== c);
                    await setDoc(doc(db,"data","schoolLists"), { classes: arrayRemove(c), students: keep }, { merge: true });
                    await updateDoc(doc(db,"data","schoolLists"), { students: keep }); // Force Rewrite
                    Toast("تم الحذف");
                }
            },
            renderLists: () => {
                document.getElementById('list-teachers-view').innerHTML = CACHE.teachers.map(t => 
                    `<div class="list-row"><span><i class="fas fa-user-tie"></i> ${t}</span><div class="del-icon" onclick="Settings.deleteTeacher('${t}')"><i class="fas fa-trash"></i></div></div>`
                ).join('');
                document.getElementById('list-classes-view').innerHTML = CACHE.classes.map(c => 
                    `<div class="list-row"><span><i class="fas fa-layer-group"></i> ${c}</span><div class="del-icon" onclick="Settings.deleteClass('${c}')"><i class="fas fa-trash"></i></div></div>`
                ).join('');
            },
            wipeAll: async () => {
                if(confirm("تحذير نهائي: حذف كل شيء؟")) {
                    await setDoc(doc(db,"data","schoolLists"), { teachers:[], students:[], classes:[] });
                    const cols = ['perms', 'visitors', 'departures'];
                    for(const col of cols) {
                        const q = await getDocs(collection(db, col));
                        q.forEach(d => deleteDoc(doc(db, col, d.id)));
                    }
                    Toast("تم تصفير النظام", "success"); setTimeout(()=>location.reload(), 2000);
                }
            }
        };

        // --- Reports ---
        const Reports = {
            switch: (t) => {
                ['students','special','visitors'].forEach(x => document.getElementById('rep-sec-'+x).style.display = 'none');
                document.getElementById('rep-sec-'+t).style.display = 'block';
                document.querySelectorAll('.report-tab-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
            },
            render: () => {
                const m = document.getElementById('rep-month-picker').value;
                if(!m) return;
                
                // فصل البيانات
                const regularPerms = PERMS.filter(p => {
                    const student = CACHE.students.find(s => s.name === p.studentName);
                    return (!student?.isSpecial) && p.timestamp && p.timestamp.toDate().toISOString().startsWith(m);
                });
                
                const specialPerms = PERMS.filter(p => {
                    const student = CACHE.students.find(s => s.name === p.studentName);
                    return (student?.isSpecial) && p.timestamp && p.timestamp.toDate().toISOString().startsWith(m);
                });

                // Chart
                const counts = {}; regularPerms.forEach(p => counts[p.studentName] = (counts[p.studentName]||0)+1);
                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                
                const ctx = document.getElementById('main-chart');
                if(CHART_INSTANCE) CHART_INSTANCE.destroy();
                CHART_INSTANCE = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sorted.slice(0, 10).map(x => x[0]),
                        datasets: [{ label: 'مرات الخروج', data: sorted.slice(0, 10).map(x => x[1]), backgroundColor: '#145A32', borderRadius: 5 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // Lists
                document.getElementById('list-top-students').innerHTML = sorted.slice(0, 5).map(x => `<li>${x[0]} (${x[1]})</li>`).join('');
                document.getElementById('list-low-students').innerHTML = sorted.slice(-5).map(x => `<li>${x[0]} (${x[1]})</li>`).join('');
                
                // Special Table
                document.getElementById('table-special-body').innerHTML = specialPerms.map(p => `
                    <tr><td>${p.studentName}</td><td>${p.className}</td><td>${p.destination}</td><td>-</td><td>${p.timestamp.toDate().toLocaleDateString('ar-SA')}</td></tr>
                `).join('');
            }
        };

        // --- Helper ---
        function findKey(obj, keywords) {
            for (let k of Object.keys(obj)) {
                for (let w of keywords) if (k.toLowerCase().includes(w)) return obj[k];
            }
            return null;
        }

        // --- Init ---
        document.getElementById('rep-month-picker').value = new Date().toISOString().slice(0,7);
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit'}), 1000);

        // Expose to Window
        window.Auth = Auth; window.Ops = Ops; window.Settings = Settings; window.Data = Data; window.Sound = Sound; window.Reports = Reports;

    </script>
</body>
</html>