<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إذن الرقمي - متوسطة الإمام النووي (النسخة الكاملة)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* تعريف متغيرات الألوان للهوية البصرية */
            --primary-color: #145A32;       /* أخضر غامق رسمي */
            --primary-light: #1E8449;       /* أخضر فاتح */
            --secondary-color: #D4AC0D;     /* ذهبي للتكريم */
            --accent-color: #2874A6;        /* أزرق للأزرار */
            --danger-color: #C0392B;        /* أحمر للتنبيهات */
            --success-color: #27AE60;       /* أخضر للنجاح */
            --bg-color: #F4F6F7;            /* خلفية عامة */
            --card-bg: #FFFFFF;             /* خلفية الكروت */
            --text-main: #2C3E50;           /* لون النص الرئيسي */
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.05);
            --shadow-hard: 0 15px 40px rgba(0,0,0,0.1);
            --main-gradient: linear-gradient(135deg, #145A32 0%, #0B3B24 100%);
        }

        /* --- التنسيقات الأساسية --- */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Tajawal', sans-serif; 
            outline: none;
        }

        body { 
            background: var(--bg-color); 
            color: var(--text-main); 
            min-height: 100vh; 
            overflow-x: hidden;
            padding-bottom: 100px; /* مساحة في الأسفل */
        }

        /* --- نظام التنبيهات والإشعارات (Toast Notifications) --- */
        #notification-area {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: none; /* يسمح بالنقر من خلاله */
        }

        .toast-message {
            background: #333;
            color: #fff;
            padding: 16px 40px;
            border-radius: 50px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            animation: slideDownFade 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55), fadeOut 0.5s 3.5s forwards;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 700;
            font-size: 1.1rem;
            min-width: 350px;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .toast-success { background: var(--primary-color); }
        .toast-error { background: var(--danger-color); }
        .toast-info { background: var(--accent-color); }

        @keyframes slideDownFade { 
            from { transform: translateY(-100px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

        /* --- شاشة الدخول (Login Screen) --- */
        #loginOverlay {
            position: fixed; 
            inset: 0; 
            background: var(--main-gradient);
            z-index: 10000; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(15px);
        }

        .login-card {
            background: var(--card-bg); 
            width: 90%; 
            max-width: 550px; 
            padding: 4rem;
            border-radius: 40px; 
            text-align: center; 
            box-shadow: 0 50px 100px rgba(0,0,0,0.5);
            border-top: 12px solid var(--secondary-color);
            animation: zoomEntrance 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes zoomEntrance { 
            from { transform: scale(0.8) translateY(50px); opacity: 0; } 
            to { transform: scale(1) translateY(0); opacity: 1; } 
        }

        .school-logo-icon { 
            font-size: 6rem; 
            color: var(--primary-color); 
            margin-bottom: 25px; 
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); 
        }
        
        /* --- الهيدر العلوي (Top Header) --- */
        header { 
            background: var(--main-gradient); 
            color: white; 
            padding: 1.5rem 3rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 5000; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header-content h1 { 
            font-family: 'Amiri'; 
            font-size: 2.2rem; 
            font-weight: 700; 
            margin: 0; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
        }
        
        .live-counter-badge { 
            background: var(--danger-color); 
            padding: 10px 25px; 
            border-radius: 50px; 
            font-weight: 800; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 1.1rem;
            box-shadow: 0 0 20px rgba(192, 57, 43, 0.6); 
            animation: pulseEffect 2s infinite;
        }

        @keyframes pulseEffect { 
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); } 
            50% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(192, 57, 43, 0); } 
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); } 
        }

        /* --- شريط التنقل (Navigation Bar) --- */
        .nav-container-scroll { 
            display: flex; 
            gap: 20px; 
            overflow-x: auto; 
            padding: 25px; 
            margin: 0 auto; 
            max-width: 1300px; 
            justify-content: center;
            background: transparent;
        }

        .nav-btn {
            background: white; 
            border: none; 
            padding: 18px 40px; 
            border-radius: 25px;
            font-size: 1.2rem; 
            color: #666; 
            cursor: pointer; 
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 8px;
            min-width: 130px;
        }

        .nav-btn:hover { 
            transform: translateY(-5px); 
            color: var(--primary-color); 
            background: #fff;
        }

        .nav-btn.active { 
            background: #e8f5e9; 
            color: var(--primary-color); 
            border-bottom: 5px solid var(--primary-color); 
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(20, 90, 50, 0.15);
        }

        .nav-btn i { font-size: 2rem; margin-bottom: 5px; }

        /* --- الأزرار العامة (Buttons) --- */
        .btn-action {
            width: 100%; 
            padding: 18px; 
            border: none; 
            border-radius: 20px;
            font-size: 1.2rem; 
            font-weight: 800; 
            cursor: pointer; 
            transition: all 0.2s ease;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 12px;
            margin-top: 15px;
            position: relative;
            top: 0;
        }

        .btn-action:active { top: 4px; box-shadow: none !important; }

        .btn-primary { 
            background: var(--primary-color); 
            color: white; 
            box-shadow: 0 6px 0 #0e3e23; 
        }

        .btn-secondary { 
            background: var(--secondary-color); 
            color: #222; 
            box-shadow: 0 6px 0 #9a7d0a; 
        }

        .btn-danger { 
            background: var(--danger-color); 
            color: white; 
            box-shadow: 0 6px 0 #7b241c; 
        }

        /* --- الحاويات والأقسام (Sections) --- */
        .main-container { 
            max-width: 1300px; 
            margin: 0 auto; 
            padding: 0 20px; 
        }

        .view-section { 
            display: none; 
            opacity: 0; 
            transform: translateY(20px); 
            transition: all 0.5s ease-out; 
        }

        .view-section.active { 
            display: block; 
            opacity: 1; 
            transform: translateY(0); 
        }

        .card { 
            background: white; 
            border-radius: 35px; 
            padding: 3rem; 
            margin-bottom: 2.5rem;
            box-shadow: var(--shadow-soft); 
            border: 1px solid #f0f0f0;
            position: relative;
            overflow: hidden;
        }

        .card h2, .card h3, .card h4 { 
            color: var(--primary-color); 
            margin-bottom: 25px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .form-input { 
            width: 100%; 
            padding: 20px; 
            margin-bottom: 20px; 
            border: 2px solid #eee; 
            border-radius: 20px; 
            font-size: 1.2rem; 
            transition: 0.3s; 
            background: #fafafa;
        }

        .form-input:focus { 
            border-color: var(--secondary-color); 
            background: white; 
            box-shadow: 0 0 0 5px rgba(212, 172, 13, 0.1); 
        }

        /* --- شبكة المراقبة (Monitor Grid) --- */
        .monitor-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
            gap: 25px; 
        }

        .student-card {
            background: white; 
            padding: 25px; 
            border-radius: 30px; 
            border-right: 15px solid var(--success-color); 
            box-shadow: var(--shadow-soft);
            transition: 0.3s;
            position: relative;
        }

        .student-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hard); }
        .student-card.late { border-right-color: var(--danger-color); background: #fff8f8; animation: shake 0.5s infinite; }
        
        @keyframes shake { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(5px); } 
            75% { transform: translateX(-5px); } 
        }

        /* --- تبويبات الإعدادات الجديدة (Settings Tabs) --- */
        .settings-tabs { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 30px; 
            border-bottom: 3px solid #eee; 
            padding-bottom: 20px; 
        }

        .tab-btn { 
            flex: 1; 
            padding: 18px; 
            border: none; 
            background: #f8f9fa; 
            cursor: pointer; 
            border-radius: 20px; 
            font-weight: 800; 
            font-size: 1.1rem; 
            transition: 0.3s; 
            color: #777;
        }

        .tab-btn.active { 
            background: var(--primary-color); 
            color: white; 
            transform: scale(1.03); 
            box-shadow: 0 8px 20px rgba(20, 90, 50, 0.25); 
        }

        /* --- قوائم البيانات للحذف (List Items) --- */
        .data-list-container {
            max-height: 350px;
            overflow-y: auto;
            border: 2px solid #f0f0f0;
            border-radius: 20px;
            padding: 10px;
            background: #fff;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f5f5f5;
            transition: 0.2s;
        }

        .list-item:hover { background: #fafafa; }
        
        .del-icon-btn {
            color: var(--danger-color);
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: 0.2s;
            background: #fff0f0;
        }

        .del-icon-btn:hover { background: var(--danger-color); color: white; transform: rotate(90deg); }

        /* --- شهادة التقدير (Certificate) --- */
        .cert-print-wrapper {
            width: 1123px; height: 794px; /* A4 Landscape */
            background: white; 
            padding: 60px; 
            margin: 0 auto;
            border: 40px double var(--secondary-color); 
            text-align: center; 
            display: none;
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            position: fixed; 
            top: 0; 
            left: 0; 
            z-index: 10000;
        }

        .cert-title { font-family: 'Amiri'; font-size: 5.5rem; color: var(--primary-color); margin-bottom: 40px; text-shadow: 2px 2px 0px #eee; }
        .cert-name { font-family: 'Amiri'; font-size: 5rem; color: #b7950b; text-decoration: underline; margin: 50px 0; font-weight: bold; }
        .cert-text { font-size: 2.8rem; line-height: 1.8; margin-bottom: 80px; color: #333; }
        .cert-footer { display: flex; justify-content: space-around; margin-top: 120px; }
        .cert-footer h3 { font-size: 2.2rem; margin-bottom: 15px; color: #555; }
        .cert-footer p { font-size: 2.5rem; font-family: 'Amiri'; font-weight: bold; color: var(--primary-color); }

        /* --- ميديا الطباعة --- */
        @media print {
            body * { visibility: hidden; }
            .cert-print-wrapper, .cert-print-wrapper * { visibility: visible; }
            .cert-print-wrapper { display: block !important; position: absolute; left: 0; top: 0; transform: scale(0.9); }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="notification-area"></div>
    
    <audio id="soundAlert" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="loginOverlay">
        
        <div class="login-card" id="roleSelectionPanel">
            <i class="fas fa-school school-logo-icon"></i>
            <h1 style="font-family:'Amiri'; color:var(--primary-color); font-size:3.5rem; margin-bottom:15px">متوسطة الإمام النووي</h1>
            <p style="color:#666; font-size:1.4rem; margin-bottom:3rem; font-weight:800">نظام إدارة الانضباط المدرسي (الإصدار الشامل)</p>
            
            <button class="btn-action btn-primary" onclick="initiateLogin('admin')">
                <i class="fas fa-user-shield"></i> لوحة الإدارة
            </button>
            <button class="btn-action btn-secondary" onclick="initiateLogin('teacher')">
                <i class="fas fa-chalkboard-user"></i> دخول المعلم
            </button>
        </div>

        <div class="login-card" id="passwordInputPanel" style="display:none">
            <h2 style="color:var(--primary-color); margin-bottom:25px; font-size:2.2rem">التحقق الأمني</h2>
            <p style="margin-bottom:25px; color:#777; font-size:1.1rem">فضلاً أدخل كود المرور للمتابعة</p>
            
            <input type="password" id="accessCodeInput" class="form-input" placeholder="****" style="text-align:center; font-size:3rem; letter-spacing:15px">
            
            <div style="display:flex; gap:15px; margin-top:20px">
                <button class="btn-action btn-primary" onclick="validateLogin()" id="confirmLoginBtn">
                    تأكيد الدخول
                </button>
                <button class="btn-action btn-danger" onclick="location.reload()">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <header class="no-print">
        <div style="display:flex; align-items:center; gap:20px">
            <i class="fas fa-graduation-cap" style="font-size:3.5rem; color:var(--secondary-color)"></i>
            <div>
                <h1 style="font-family:'Amiri'; margin:0">إذن الرقمي</h1>
                <small style="opacity:0.9; font-size:1rem; font-weight:300">نظام المتابعة السحابي 2026</small>
            </div>
        </div>
        
        <div style="display:flex; align-items:center; gap:25px">
            <div class="live-counter-badge">
                <i class="fas fa-circle" style="font-size:0.8rem; color:#fff"></i>
                <span id="activeStudentCount">0</span> طالب بالخارج
            </div>
            <div id="clockDisplay" style="font-family:'Courier New'; font-weight:bold; font-size:1.8rem; letter-spacing:2px">00:00</div>
        </div>
    </header>

    <div id="navigationBar" class="nav-container-scroll no-print" style="display:none"></div>

    <div class="main-container no-print" id="applicationMain" style="display:none">

        <div id="sectionHome" class="view-section">
            <div class="card" style="text-align:center; background: linear-gradient(to bottom, #fff, #f8fcf9)">
                <h3 style="color:#777; justify-content:center"><i class="fas fa-key"></i> كود المعلم المتزامن اليومي</h3>
                <div id="dailyTeacherCode" style="font-size:8rem; font-weight:900; color:var(--primary-color); letter-spacing:25px; margin:30px 0; font-family:monospace; text-shadow: 4px 4px 0 #eee">----</div>
                <button class="btn-action btn-secondary" style="width:auto; margin:0 auto; padding:15px 60px" onclick="refreshDailyCode()">
                    <i class="fas fa-sync fa-spin-hover"></i> تحديث الكود
                </button>
                <p style="margin-top:25px; color:#999; font-size:1rem">هذا الكود يتم تحديثه ومزامنته تلقائياً لجميع المعلمين في المدرسة</p>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px">
                <div class="card" style="text-align:center; background:#e8f8f5; border:none">
                    <i class="fas fa-clipboard-check" style="font-size:4rem; color:var(--primary-color); margin-bottom:15px"></i>
                    <h1 id="statTotalPermits" style="font-size:5rem; margin:10px 0; color:var(--primary-color)">0</h1>
                    <p style="font-size:1.3rem; font-weight:bold; color:#555">إجمالي أذونات اليوم</p>
                </div>
                <div class="card" style="text-align:center; background:#fdedec; border:none">
                    <i class="fas fa-person-walking-dashed-line-arrow-right" style="font-size:4rem; color:var(--danger-color); margin-bottom:15px"></i>
                    <h1 id="statActiveStudents" style="font-size:5rem; margin:10px 0; color:var(--danger-color)">0</h1>
                    <p style="font-size:1.3rem; font-weight:bold; color:#555">طلاب خارج الفصول الآن</p>
                </div>
            </div>
        </div>

        <div id="sectionTeacher" class="view-section">
            <div class="card">
                <h2><i class="fas fa-file-signature"></i> إصدار إذن خروج طالب</h2>
                
                <div style="margin-bottom:30px; background:#f9f9f9; padding:20px; border-radius:20px">
                    <label style="font-size:1.2rem; font-weight:bold; margin-bottom:10px; display:block">اسم المعلم المصدر للإذن:</label>
                    <select id="inputTeacherName" class="form-input" style="margin:0"><option value="">جاري تحميل القائمة...</option></select>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 2fr; gap:25px; margin-bottom:20px">
                    <div>
                        <label style="font-size:1.1rem; font-weight:bold; margin-bottom:8px; display:block">الشعبة / الصف:</label>
                        <select id="inputClassName" class="form-input" onchange="filterStudentsByClass()"><option value="">اختر...</option></select>
                    </div>
                    <div>
                        <label style="font-size:1.1rem; font-weight:bold; margin-bottom:8px; display:block">اسم الطالب:</label>
                        <select id="inputStudentName" class="form-input"><option value="">اختر الطالب...</option></select>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:25px">
                    <div>
                        <label style="font-size:1.1rem; font-weight:bold; margin-bottom:8px; display:block">الوجهة:</label>
                        <select id="inputDestination" class="form-input">
                            <option>دورة المياه</option>
                            <option>المقصف</option>
                            <option>مكتب الإدارة</option>
                            <option>المرشد الطلابي</option>
                            <option>وكيل شؤون الطلاب</option>
                            <option>أخرى</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:1.1rem; font-weight:bold; margin-bottom:8px; display:block">المدة (دقيقة):</label>
                        <input type="number" id="inputDuration" class="form-input" value="5" min="1" max="60">
                    </div>
                </div>

                <button class="btn-action btn-primary" onclick="submitNewPermit()">
                    <i class="fas fa-paper-plane"></i> اعتماد وطباعة الإذن
                </button>
            </div>
        </div>

        <div id="sectionMonitor" class="view-section">
            <h2 style="margin-bottom:30px; color:var(--primary-color); font-size:2.2rem; border-bottom:3px solid #eee; padding-bottom:15px">
                <i class="fas fa-satellite-dish"></i> المتابعة الميدانية الحية
            </h2>
            <div id="liveMonitorGrid" class="monitor-grid">
                </div>
        </div>

        <div id="sectionReports" class="view-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom:1px solid #eee; padding-bottom:20px">
                    <h2><i class="fas fa-chart-pie"></i> التحليل البياني الشهري</h2>
                    <div style="display:flex; align-items:center; gap:10px">
                        <label style="font-weight:bold">اختر الشهر:</label>
                        <input type="month" id="reportMonthFilter" class="form-input" style="width:auto; margin:0; padding:10px" onchange="refreshReports()">
                    </div>
                </div>
                <div style="height:450px">
                    <canvas id="reportChartCanvas"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-list-ol"></i> سجل الحركات التفصيلي للشهر المحدد</h3>
                <div style="max-height:400px; overflow-y:auto; padding:10px; background:#f9f9f9; border-radius:20px">
                    <ul id="reportLogsList" style="list-style:none; padding:0; font-size:1.1rem; line-height:2">
                        </ul>
                </div>
            </div>
        </div>

        <div id="sectionSettings" class="view-section">
            <div class="card">
                <h2><i class="fas fa-cogs"></i> مركز إدارة البيانات والنظام</h2>
                
                <div class="settings-tabs">
                    <button class="tab-btn active" onclick="changeSettingsTab('teachers')">
                        <i class="fas fa-chalkboard-user"></i> إدارة المعلمين
                    </button>
                    <button class="tab-btn" onclick="changeSettingsTab('classes')">
                        <i class="fas fa-users-rectangle"></i> الفصول والطلاب
                    </button>
                    <button class="tab-btn" onclick="changeSettingsTab('system')">
                        <i class="fas fa-server"></i> صيانة النظام
                    </button>
                </div>

                <div id="setting-tab-teachers">
                    <div style="background:#fcfcfc; padding:30px; border-radius:25px; margin-bottom:25px; border:2px solid #f0f0f0;">
                        <h4 style="color:var(--primary-color); margin-bottom:20px"><i class="fas fa-plus-circle"></i> إضافة معلم جديد (يدوي)</h4>
                        <div style="display:flex; gap:15px;">
                            <input type="text" id="manualTeacherInput" class="form-input" placeholder="اكتب اسم المعلم الرباعي" style="margin:0">
                            <button class="btn-action btn-primary" style="width:180px; margin:0" onclick="addTeacherManual()">
                                <i class="fas fa-save"></i> حفظ
                            </button>
                        </div>
                        
                        <div style="display:flex; align-items:center; gap:15px; margin-top:30px; padding-top:20px; border-top:2px dashed #ddd">
                            <i class="fas fa-file-excel" style="font-size:2rem; color:green"></i>
                            <div style="flex:1">
                                <h5 style="margin-bottom:5px">استيراد قائمة معلمين (Excel)</h5>
                                <p style="color:#777; font-size:0.9rem">يجب أن يحتوي الملف على عمود باسم (المعلم) أو (الاسم)</p>
                            </div>
                            <input type="file" id="teacherExcelInput" style="display:none" onchange="processTeacherExcel(this)">
                            <button class="btn-action btn-secondary" style="width:auto; margin:0; padding:12px 30px" onclick="document.getElementById('teacherExcelInput').click()">
                                اختيار ملف ورفع
                            </button>
                        </div>
                    </div>

                    <h4><i class="fas fa-list-ul"></i> قائمة المعلمين المسجلين</h4>
                    <div id="teachersListContainer" class="data-list-container">
                        </div>
                </div>

                <div id="setting-tab-classes" style="display:none">
                    
                    <div style="background:#e8f5e9; padding:30px; border-radius:25px; margin-bottom:30px; border:2px solid var(--primary-color);">
                        <h4 style="color:var(--primary-color); margin-bottom:15px"><i class="fas fa-layer-group"></i> الخطوة الأولى: إنشاء أو تحديد الشعبة</h4>
                        <p style="color:#555; margin-bottom:15px">اكتب اسم الفصل أو الشعبة (مثال: أول متوسط / أ) لإضافته للنظام أولاً.</p>
                        <div style="display:flex; gap:15px;">
                            <input type="text" id="newClassNameInput" class="form-input" placeholder="اكتب اسم الشعبة هنا..." style="margin:0; font-weight:bold; color:var(--primary-color)">
                            <button class="btn-action btn-primary" style="width:200px; margin:0" onclick="addNewClass()">
                                <i class="fas fa-plus"></i> إضافة للقائمة
                            </button>
                        </div>
                    </div>

                    <div style="background:#fff; padding:30px; border-radius:25px; border:2px solid #eee; display:grid; grid-template-columns: 1fr 1fr; gap:40px">
                        
                        <div>
                            <h4 style="color:var(--accent-color); margin-bottom:15px"><i class="fas fa-user-graduate"></i> أ- إضافة طالب يدوياً</h4>
                            <p style="font-size:0.9rem; color:#777; margin-bottom:15px">سيتم ربط الطالب بالشعبة المكتوبة في الأعلى</p>
                            <input type="text" id="newStudentNameInput" class="form-input" placeholder="اسم الطالب" style="margin-bottom:15px">
                            <button class="btn-action btn-secondary" style="width:100%; margin:0" onclick="addStudentManual()">
                                حفظ الطالب
                            </button>
                        </div>

                        <div style="border-right:2px dashed #eee; padding-right:40px">
                            <h4 style="color:green; margin-bottom:15px"><i class="fas fa-file-import"></i> ب- استيراد طلاب من Excel</h4>
                            <p style="font-size:0.9rem; color:#777; margin-bottom:15px">ارفع ملفاً يحتوي أسماء الطلاب فقط، وسيقوم النظام بربطهم بالشعبة أعلاه.</p>
                            <input type="file" id="studentExcelInput" style="display:none" onchange="processStudentExcel(this)">
                            <button class="btn-action" style="width:100%; margin:0; background:#f0fff0; color:green; border:2px solid green" onclick="triggerStudentImport()">
                                <i class="fas fa-upload"></i> اختيار ملف وربط
                            </button>
                        </div>
                    </div>

                    <h4 style="margin-top:40px; margin-bottom:20px"><i class="fas fa-users-viewfinder"></i> الفصول والطلاب المسجلين</h4>
                    <div id="classesListContainer" class="data-list-container">
                        </div>
                </div>

                <div id="setting-tab-system" style="display:none; text-align:center">
                    <div style="padding:60px; border:3px dashed var(--danger-color); border-radius:40px; background:#fff5f5; margin-top:20px">
                        <i class="fas fa-triangle-exclamation" style="font-size:6rem; color:var(--danger-color); margin-bottom:25px"></i>
                        <h3 style="color:var(--danger-color); font-size:2.5rem; margin-bottom:20px">إعادة ضبط المصنع</h3>
                        <p style="margin-bottom:30px; font-size:1.3rem; color:#555; line-height:1.6">
                            تحذير هام: هذا الإجراء لا يمكن التراجع عنه.<br>
                            سيتم مسح كافة سجلات الأذونات، أسماء الطلاب، المعلمين، والفصول نهائياً من قاعدة البيانات.
                        </p>
                        <button class="btn-action btn-danger" style="max-width:450px; margin:0 auto" onclick="performFactoryReset()">
                            <i class="fas fa-trash-can"></i> تصفير النظام بالكامل وحذف البيانات
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="sectionCertificates" class="view-section">
            <div class="card" style="text-align:center">
                <i class="fas fa-award" style="font-size:7rem; color:var(--secondary-color); margin-bottom:30px"></i>
                <h2>إصدار شهادات التقدير والشكر</h2>
                <div style="max-width:600px; margin:40px auto">
                    <label style="display:block; text-align:right; font-weight:bold; margin-bottom:10px">اختر الطالب المكرم:</label>
                    <select id="certStudentSelector" class="form-input"><option>اختر الطالب...</option></select>
                    <button class="btn-action btn-secondary" onclick="generateAndPrintCert()">
                        <i class="fas fa-print"></i> معاينة وطباعة الشهادة
                    </button>
                </div>
            </div>
        </div>

    </div>

    <div id="printCertTemplate" class="cert-print-wrapper">
        <h1 class="cert-title">شهادة شكر وتقدير</h1>
        <p class="cert-text" style="margin-top:60px">
            تتقدم إدارة متوسطة الإمام النووي بخالص الشكر والتقدير للطالب:
        </p>
        <h2 id="printStudentName" class="cert-name">................................</h2>
        <p class="cert-text">
            وذلك نظير انضباطه المدرسي المتميز، ومحافظته على الوقت، وحسن سلوكه داخل أروقة المدرسة.
        </p>
        
        <div class="cert-footer">
            <div>
                <h3>وكيل شؤون الطلاب</h3>
                <p>....................</p>
            </div>
            <div>
                <h3>مدير المدرسة</h3>
                <p>إبراهيم بن يحيى جابر اللغبي</p>
            </div>
        </div>
    </div>

    <script type="module">
        // استيراد مكتبات Firebase الرسمية
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, query, orderBy, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // إعدادات الاتصال بمشروعك
        const firebaseConfig = { projectId: "edin-377b2", authDomain: "edin-377b2.firebaseapp.com" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // متغيرات النظام العامة
        let currentRole = null;
        let cachedStudents = [];
        let cachedTeachers = [];
        let cachedClasses = [];
        let cachedPerms = [];
        let reportChartInstance = null;

        // --- نظام التنبيهات (Toast Notifications) ---
        window.notify = (message, type = 'success') => {
            const container = document.getElementById('notification-area');
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            
            let icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : 
                       type === 'error' ? '<i class="fas fa-circle-xmark"></i>' : 
                       '<i class="fas fa-info-circle"></i>';
            
            toast.innerHTML = `${icon} <span>${message}</span>`;
            container.appendChild(toast);
            
            // إزالة الإشعار تلقائياً
            setTimeout(() => {
                toast.remove();
            }, 3800);
        };

        // --- إدارة تسجيل الدخول (Authentication) ---
        window.initiateLogin = (role) => {
            currentRole = role;
            document.getElementById('roleSelectionPanel').style.display = 'none';
            document.getElementById('passwordInputPanel').style.display = 'block';
        };

        window.validateLogin = async () => {
            const codeInput = document.getElementById('accessCodeInput').value;
            const loginBtn = document.getElementById('confirmLoginBtn');
            
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحقق...';

            // 1. تجاوز المدير (Bypass) لحل مشكلة الاتصال الأولية
            if (currentRole === 'admin' && codeInput === '2025') {
                launchApplication();
                return;
            }

            // 2. التحقق من السحابة للمعلم
            try {
                const docRef = doc(db, "settings", "dailyCode");
                const docSnap = await getDoc(docRef);
                const serverCode = docSnap.exists() ? docSnap.data().value : "1234";

                if (currentRole === 'teacher' && codeInput === serverCode) {
                    launchApplication();
                } else {
                    notify("عذراً، الكود المدخل غير صحيح", "error");
                    loginBtn.innerHTML = 'تأكيد الدخول';
                }
            } catch (error) {
                console.error("Login Error:", error);
                // الدخول الافتراضي في حالة تعذر الاتصال لأول مرة
                if (currentRole === 'teacher' && codeInput === '1234') {
                    launchApplication();
                } else {
                    notify("فشل الاتصال بالسيرفر. تأكد من الإنترنت", "error");
                    loginBtn.innerHTML = 'تأكيد الدخول';
                }
            }
        };

        function launchApplication() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('applicationMain').style.display = 'block';
            document.getElementById('navigationBar').style.display = 'flex';
            
            // ضبط الشهر الحالي للتقارير
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7); // YYYY-MM
            document.getElementById('reportMonthFilter').value = currentMonth;

            buildNavigationMenu();
            startRealtimeListeners();
            notify("تم تسجيل الدخول بنجاح. مرحباً بك!", "success");
        }

        // --- بناء القوائم والتنقل (Navigation) ---
        function buildNavigationMenu() {
            const nav = document.getElementById('navigationBar');
            
            if (currentRole === 'admin') {
                nav.innerHTML = `
                    <button class="nav-btn active" onclick="switchView('sectionHome', this)">
                        <i class="fas fa-home"></i> الرئيسية
                    </button>
                    <button class="nav-btn" onclick="switchView('sectionMonitor', this)">
                        <i class="fas fa-desktop"></i> المتابعة
                    </button>
                    <button class="nav-btn" onclick="switchView('sectionReports', this)">
                        <i class="fas fa-chart-pie"></i> التقارير
                    </button>
                    <button class="nav-btn" onclick="switchView('sectionCertificates', this)">
                        <i class="fas fa-award"></i> الشهادات
                    </button>
                    <button class="nav-btn" onclick="switchView('sectionSettings', this)">
                        <i class="fas fa-cogs"></i> الإعدادات
                    </button>
                `;
                switchView('sectionHome');
            } else {
                nav.innerHTML = `
                    <button class="nav-btn active" onclick="switchView('sectionTeacher', this)">
                        <i class="fas fa-pen-nib"></i> إصدار إذن
                    </button>
                    <button class="nav-btn" onclick="switchView('sectionMonitor', this)">
                        <i class="fas fa-list-check"></i> حالة طلابي
                    </button>
                `;
                switchView('sectionTeacher');
            }
        }

        window.switchView = (sectionId, btnElement) => {
            // إخفاء الكل
            document.querySelectorAll('.view-section').forEach(sec => sec.classList.remove('active'));
            // إظهار المطلوب
            document.getElementById(sectionId).classList.add('active');
            
            // تحديث زر القائمة
            if (btnElement) {
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                btnElement.classList.add('active');
            }

            // إجراءات خاصة عند فتح التقارير
            if (sectionId === 'sectionReports') {
                refreshReports();
            }
        };

        // --- المحرك السحابي (Realtime Sync) ---
        function startRealtimeListeners() {
            // 1. الاستماع لكود المعلم
            onSnapshot(doc(db, "settings", "dailyCode"), (docSnap) => {
                if (docSnap.exists()) {
                    document.getElementById('dailyTeacherCode').innerText = docSnap.data().value;
                }
            });

            // 2. الاستماع لقوائم البيانات (طلاب، معلمين، فصول)
            onSnapshot(doc(db, "data", "schoolLists"), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    cachedTeachers = data.teachers || [];
                    cachedStudents = data.students || [];
                    cachedClasses = data.classes || [];
                    
                    updateDropdownLists();
                    renderManagementLists(); // تحديث قوائم الحذف في الإعدادات
                }
            });

            // 3. الاستماع لسجلات الأذونات (للمراقبة والتقارير)
            const q = query(collection(db, "perms"), orderBy("timestamp", "desc"));
            onSnapshot(q, (querySnapshot) => {
                cachedPerms = [];
                querySnapshot.forEach((doc) => {
                    cachedPerms.push({ id: doc.id, ...doc.data() });
                });
                
                renderMonitorGrid(cachedPerms);
                
                // تحديث التقارير إذا كانت الصفحة مفتوحة
                if (document.getElementById('sectionReports').classList.contains('active')) {
                    refreshReports();
                }
            });
        }

        // --- وظائف المراقبة (Monitor) ---
        function renderMonitorGrid(perms) {
            const activePerms = perms.filter(p => p.status === 'out');
            const gridContainer = document.getElementById('liveMonitorGrid');
            
            // تحديث العدادات العلوية
            document.getElementById('activeStudentCount').innerText = activePerms.length;
            document.getElementById('statActiveStudents').innerText = activePerms.length;
            
            // حساب إجمالي اليوم (بناءً على التاريخ)
            const todayStr = new Date().toDateString();
            const todayTotal = perms.filter(p => p.timestamp && p.timestamp.toDate().toDateString() === todayStr).length;
            document.getElementById('statTotalPermits').innerText = todayTotal;

            // رسم البطاقات
            gridContainer.innerHTML = activePerms.map(p => {
                const now = new Date();
                const outTime = p.timestamp ? p.timestamp.toDate() : new Date();
                const diffMins = Math.floor((now - outTime) / 60000);
                const isLate = diffMins > p.limit;
                
                return `
                    <div class="student-card ${isLate ? 'late' : ''}">
                        <h2 style="color:var(--primary-color)">${p.studentName}</h2>
                        <p style="color:#666; margin-bottom:10px; font-weight:bold">
                            <i class="fas fa-chalkboard"></i> ${p.className} <br>
                            <i class="fas fa-user-tie"></i> المعلم: ${p.teacherName}
                        </p>
                        <div style="background:#f9f9f9; padding:12px; border-radius:15px; display:flex; justify-content:space-between; align-items:center">
                            <span><i class="fas fa-location-dot"></i> ${p.destination}</span>
                            <span style="font-weight:bold; color:${isLate ? 'red' : 'green'}">
                                ${diffMins} دقيقة
                            </span>
                        </div>
                        <button class="btn-action btn-primary" onclick="confirmReturn('${p.id}')" style="margin-top:15px; padding:10px; font-size:1rem">
                            <i class="fas fa-check"></i> تأكيد العودة
                        </button>
                    </div>
                `;
            }).join('') || '<div style="grid-column:1/-1; text-align:center; padding:60px; color:#aaa; font-size:1.2rem"><i class="fas fa-check-circle" style="font-size:3rem; margin-bottom:10px; display:block"></i>لا يوجد طلاب خارج الفصول حالياً</div>';
        }

        // --- وظائف التقارير (Reports Logic) ---
        window.refreshReports = () => {
            const selectedMonth = document.getElementById('reportMonthFilter').value; // YYYY-MM
            if (!selectedMonth) return;

            // فلترة البيانات للشهر المحدد
            const monthlyData = cachedPerms.filter(p => {
                if (!p.timestamp) return false;
                const date = p.timestamp.toDate();
                return date.toISOString().slice(0, 7) === selectedMonth;
            });

            // إعداد بيانات الرسم البياني (عدد الأذونات لكل فصل)
            const classStats = {};
            monthlyData.forEach(p => {
                classStats[p.className] = (classStats[p.className] || 0) + 1;
            });

            // رسم المخطط
            const ctx = document.getElementById('reportChartCanvas');
            if (reportChartInstance) reportChartInstance.destroy();

            reportChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(classStats),
                    datasets: [{
                        label: 'عدد حركات خروج الطلاب',
                        data: Object.values(classStats),
                        backgroundColor: '#145A32',
                        borderColor: '#0B3B24',
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'توزيع الأذونات حسب الفصول والشعب' }
                    }
                }
            });

            // تعبئة السجل النصي
            const logsContainer = document.getElementById('reportLogsList');
            logsContainer.innerHTML = monthlyData.slice(0, 50).map(p => {
                const dateStr = p.timestamp.toDate().toLocaleDateString('ar-SA');
                const timeStr = p.timestamp.toDate().toLocaleTimeString('ar-SA', {hour:'2-digit', minute:'2-digit'});
                return `
                    <li style="border-bottom:1px solid #eee; padding:5px 0">
                        <i class="fas fa-caret-left" style="color:var(--secondary-color)"></i> 
                        الطالب <strong>${p.studentName}</strong> (${p.className}) خرج إلى <strong>${p.destination}</strong> 
                        <span style="color:#888; font-size:0.9rem">(${dateStr} - ${timeStr})</span>
                    </li>
                `;
            }).join('') || '<li style="text-align:center; padding:20px; color:#999">لا توجد سجلات لهذا الشهر</li>';
        };

        // --- وظائف الإعدادات الجديدة (Settings Logic) ---
        window.changeSettingsTab = (tabName) => {
            // إخفاء كل التبويبات
            ['setting-tab-teachers', 'setting-tab-classes', 'setting-tab-system'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            // إظهار المطلوب
            document.getElementById('setting-tab-' + tabName).style.display = 'block';
            
            // تحديث الأزرار
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        };

        // 1. إدارة المعلمين
        window.addTeacherManual = async () => {
            const name = document.getElementById('manualTeacherInput').value.trim();
            if (!name) return notify("الرجاء كتابة اسم المعلم", "error");
            
            await setDoc(doc(db, "data", "schoolLists"), { 
                teachers: arrayUnion(name) 
            }, { merge: true });
            
            notify("تمت إضافة المعلم بنجاح");
            document.getElementById('manualTeacherInput').value = '';
        };

        window.processTeacherExcel = (inputElement) => {
            const file = inputElement.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // البحث عن عمود الاسم
                    const newTeachers = [...new Set(jsonData.map(row => row['المعلم'] || row['الاسم'] || row['Name']))].filter(Boolean);
                    
                    if (newTeachers.length > 0) {
                        await setDoc(doc(db, "data", "schoolLists"), { teachers: arrayUnion(...newTeachers) }, { merge: true });
                        notify(`تم استيراد ${newTeachers.length} معلم بنجاح`);
                    } else {
                        notify("لم يتم العثور على أسماء في الملف. تأكد من عناوين الأعمدة", "error");
                    }
                } catch (err) {
                    console.error(err);
                    notify("حدث خطأ أثناء قراءة الملف", "error");
                }
            };
            reader.readAsArrayBuffer(file);
        };

        window.removeTeacher = async (name) => {
            if (confirm(`هل أنت متأكد من حذف المعلم: ${name}؟`)) {
                await setDoc(doc(db, "data", "schoolLists"), { teachers: arrayRemove(name) }, { merge: true });
                notify("تم الحذف بنجاح");
            }
        };

        // 2. إدارة الفصول والطلاب (Smart Link)
        window.addNewClass = async () => {
            const className = document.getElementById('newClassNameInput').value.trim();
            if (!className) return notify("الرجاء كتابة اسم الشعبة", "error");
            
            await setDoc(doc(db, "data", "schoolLists"), { 
                classes: arrayUnion(className) 
            }, { merge: true });
            
            notify("تمت إضافة الشعبة للقائمة");
            // ننسخ الاسم لحقل "الهدف" ليسهل على المستخدم الخطوة التالية
            document.getElementById('targetClassName').value = className; 
        };

        window.triggerStudentImport = () => {
            const targetClass = document.getElementById('targetClassName').value.trim();
            if (!targetClass) {
                notify("تنبيه: يجب كتابة اسم الشعبة في الحقل الأعلى أولاً لربط الملف بها!", "error");
                document.getElementById('targetClassName').focus();
                return;
            }
            document.getElementById('studentExcelInput').click();
        };

        window.processStudentExcel = (inputElement) => {
            const targetClass = document.getElementById('targetClassName').value.trim();
            const file = inputElement.files[0];
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    // استخراج الأسماء وربطها بالشعبة
                    const newStudents = jsonData.map(row => ({
                        name: row['الاسم'] || row['الطالب'] || row['Student'],
                        class: targetClass
                    })).filter(s => s.name);

                    if (newStudents.length > 0) {
                        // نضيف الطلاب ونضيف الشعبة أيضاً للقائمة (لضمان وجودها)
                        await setDoc(doc(db, "data", "schoolLists"), { 
                            students: arrayUnion(...newStudents),
                            classes: arrayUnion(targetClass)
                        }, { merge: true });
                        notify(`تم ربط ${newStudents.length} طالب بالشعبة: ${targetClass}`);
                    } else {
                        notify("لم يتم العثور على أسماء طلاب في الملف", "error");
                    }
                } catch (err) {
                    console.error(err);
                    notify("ملف غير صالح", "error");
                }
            };
            reader.readAsArrayBuffer(file);
        };

        window.addStudentManual = async () => {
            const name = document.getElementById('newStudentNameInput').value.trim();
            const targetClass = document.getElementById('targetClassName').value.trim();
            
            if (!name || !targetClass) return notify("الرجاء تحديد الشعبة واسم الطالب", "error");

            await setDoc(doc(db, "data", "schoolLists"), { 
                students: arrayUnion({ name: name, class: targetClass }),
                classes: arrayUnion(targetClass)
            }, { merge: true });

            notify("تم حفظ الطالب");
            document.getElementById('newStudentNameInput').value = '';
        };

        window.removeClass = async (className) => {
            if (confirm(`تحذير: سيتم حذف الشعبة "${className}" وجميع الطلاب المرتبطين بها. هل أنت متأكد؟`)) {
                // فلترة الطلاب لحذف التابعين لهذا الفصل
                const studentsToKeep = cachedStudents.filter(s => s.class !== className);
                
                // تحديث القائمتين (الطلاب والفصول) دفعة واحدة
                await setDoc(doc(db, "data", "schoolLists"), { 
                    classes: arrayRemove(className),
                    students: studentsToKeep // نستبدل القائمة بالكامل بالقائمة المفلترة
                }, { merge: true }); // استخدام merge بحذر هنا، الأفضل إعادة كتابة الطلاب
                
                // لتصحيح الحذف الكلي للطلاب، نستخدم طريقة إعادة الكتابة للحقل students
                await updateDoc(doc(db, "data", "schoolLists"), {
                    students: studentsToKeep
                });

                notify("تم حذف الشعبة وطلابها");
            }
        };

        // عرض قوائم الإدارة (الحذف)
        function renderManagementLists() {
            // المعلمون
            const techContainer = document.getElementById('teachersListContainer');
            techContainer.innerHTML = cachedTeachers.map(t => `
                <div class="list-item">
                    <span><i class="fas fa-user-tie" style="color:var(--primary-color)"></i> ${t}</span>
                    <i class="fas fa-trash-alt del-icon-btn" onclick="removeTeacher('${t}')" title="حذف"></i>
                </div>
            `).join('');

            // الفصول (مع عدد الطلاب)
            const classContainer = document.getElementById('classesListContainer');
            classContainer.innerHTML = cachedClasses.map(c => {
                const count = cachedStudents.filter(s => s.class === c).length;
                return `
                    <div class="list-item">
                        <span><i class="fas fa-layer-group" style="color:var(--accent-color)"></i> ${c} <small style="color:#888">(${count} طالب)</small></span>
                        <i class="fas fa-trash-alt del-icon-btn" onclick="removeClass('${c}')" title="حذف الفصل والطلاب"></i>
                    </div>
                `;
            }).join('');
        }

        // --- العمليات اليومية (Permits) ---
        window.refreshDailyCode = async () => {
            const newCode = Math.floor(1000 + Math.random() * 9000).toString();
            await setDoc(doc(db, "settings", "dailyCode"), { value: newCode });
            notify("تم تحديث كود المعلم بنجاح");
        };

        window.submitNewPermit = async () => {
            const studentName = document.getElementById('inputStudentName').value;
            const className = document.getElementById('inputClassName').value;
            const teacherName = document.getElementById('inputTeacherName').value;
            
            if (!studentName || !className || !teacherName) {
                return notify("الرجاء إكمال جميع البيانات المطلوبة", "error");
            }

            try {
                await addDoc(collection(db, "perms"), {
                    studentName: studentName,
                    className: className,
                    teacherName: teacherName,
                    destination: document.getElementById('inputDestination').value,
                    limit: parseInt(document.getElementById('inputDuration').value),
                    status: 'out',
                    timestamp: serverTimestamp()
                });
                notify("تم إصدار الإذن بنجاح ✅");
                // إعادة تعيين حقل الطالب فقط
                document.getElementById('inputStudentName').value = "";
            } catch (err) {
                console.error(err);
                notify("حدث خطأ أثناء الإصدار", "error");
            }
        };

        window.confirmReturn = async (permId) => {
            await updateDoc(doc(db, "perms", permId), { 
                status: 'returned', 
                returnTime: serverTimestamp() 
            });
            notify("تم تسجيل عودة الطالب");
        };

        window.performFactoryReset = async () => {
            if (confirm("تحذير نهائي: هل أنت متأكد تماماً من حذف جميع البيانات؟ لا يمكن التراجع عن هذا الإجراء.")) {
                // حذف الأذونات
                const q = await getDocs(collection(db, "perms"));
                q.forEach(d => deleteDoc(doc(db, "perms", d.id)));
                
                // حذف القوائم
                await setDoc(doc(db, "data", "schoolLists"), { teachers: [], students: [], classes: [] });
                
                notify("تم تصفير النظام وإعادته لضبط المصنع", "success");
                setTimeout(() => location.reload(), 2000);
            }
        };

        // --- المساعدات (Helpers) ---
        function updateDropdownLists() {
            // المعلمين
            const tSelect = document.getElementById('inputTeacherName');
            tSelect.innerHTML = '<option value="">اختر اسمك...</option>' + cachedTeachers.map(t => `<option value="${t}">${t}</option>`).join('');
            
            // الفصول
            const cSelect = document.getElementById('inputClassName');
            cSelect.innerHTML = '<option value="">اختر الشعبة...</option>' + cachedClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            
            // قائمة الطلاب للشهادات
            document.getElementById('certStudentSelector').innerHTML = '<option value="">اختر الطالب...</option>' + cachedStudents.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }

        window.filterStudentsByClass = () => {
            const selectedClass = document.getElementById('inputClassName').value;
            const sSelect = document.getElementById('inputStudentName');
            
            const filtered = cachedStudents.filter(s => s.class === selectedClass);
            sSelect.innerHTML = filtered.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        };

        window.generateAndPrintCert = () => {
            const name = document.getElementById('certStudentSelector').value;
            if (!name || name.includes("اختر")) return notify("الرجاء اختيار طالب أولاً", "error");
            
            document.getElementById('printStudentName').innerText = name;
            window.print();
        };

        // الساعة الرقمية
        setInterval(() => {
            const now = new Date();
            document.getElementById('clockDisplay').innerText = now.toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute:'2-digit'});
        }, 1000);

        // تصدير الدوال للـ HTML
        window.returnStudent = window.confirmReturn; // Alias fix
    </script>
</body>
</html>