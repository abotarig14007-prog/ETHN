<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø°Ù† Ù„Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ - Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÙŠ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #145A32; /* Ø£Ø®Ø¶Ø± Ø¹Ù„Ù…ÙŠ ØºØ§Ù…Ù‚ */
            --primary-light: #1E8449;
            --secondary: #D4AC0D; /* Ø°Ù‡Ø¨ÙŠ */
            --accent: #2874A6; /* Ø£Ø²Ø±Ù‚ */
            --danger: #C0392B;
            --success: #27AE60;
            --light: #F8F9F9;
            --dark: #2C3E50;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --gradient: linear-gradient(135deg, #145A32 0%, #0B3B24 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        body { background: var(--light); color: var(--dark); overflow-x: hidden; min-height: 100vh; }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Login Overlay) --- */
        #loginOverlay {
            position: fixed; inset: 0; background: var(--gradient);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .login-card {
            background: white; width: 90%; max-width: 550px; padding: 3.5rem;
            border-radius: 40px; text-align: center; box-shadow: 0 50px 100px rgba(0,0,0,0.3);
            border-top: 10px solid var(--secondary); animation: floatUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .school-logo { font-size: 6rem; color: var(--primary); margin-bottom: 1.5rem; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); }
        
        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± (Header) --- */
        header { 
            background: var(--gradient); color: white; padding: 1.2rem 2.5rem; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .header-brand { display: flex; align-items: center; gap: 15px; }
        .header-brand h1 { font-family: 'Amiri'; font-size: 2.2rem; font-weight: 700; margin-bottom: 5px; }
        .live-badge { 
            background: var(--danger); color: white; padding: 8px 25px; border-radius: 50px; 
            font-weight: 800; display: flex; align-items: center; gap: 10px; 
            box-shadow: 0 0 15px rgba(192, 57, 43, 0.6); animation: pulse 2s infinite;
        }

        /* --- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ (Navigation) --- */
        .nav-container { 
            background: white; padding: 1rem; margin: 20px auto; max-width: 1250px; 
            border-radius: 25px; display: flex; justify-content: center; gap: 15px; 
            box-shadow: var(--shadow); flex-wrap: wrap;
        }
        .nav-btn {
            background: transparent; border: none; padding: 15px 25px; border-radius: 20px;
            font-size: 1.1rem; font-weight: 700; color: #777; cursor: pointer;
            transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 8px;
            min-width: 120px;
        }
        .nav-btn i { font-size: 2rem; margin-bottom: 5px; transition: 0.3s; }
        .nav-btn:hover { background: #f0f0f0; color: var(--primary); transform: translateY(-3px); }
        .nav-btn.active { background: #eafaf1; color: var(--primary); border-bottom: 4px solid var(--secondary); }
        .nav-btn.active i { transform: scale(1.1); }

        /* --- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Main Content) --- */
        .main-container { max-width: 1250px; margin: 0 auto; padding: 0 15px 80px; }
        .view-section { display: none; opacity: 0; transform: translateY(20px); transition: all 0.5s ease; }
        .view-section.active { display: block; opacity: 1; transform: translateY(0); }

        .card { 
            background: white; border-radius: 35px; padding: 3rem; margin-bottom: 2.5rem;
            box-shadow: var(--shadow); border: 1px solid #eee; position: relative; overflow: hidden;
        }
        .card-header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; 
            border-bottom: 2px dashed #eee; padding-bottom: 1.5rem;
        }
        .card-title { font-size: 1.8rem; color: var(--primary); font-weight: 800; display: flex; align-items: center; gap: 15px; }

        /* --- Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© (Inputs & Buttons) --- */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 700; color: #555; font-size: 1.1rem; }
        .form-input { 
            width: 100%; padding: 18px 25px; border: 2px solid #e0e0e0; border-radius: 20px; 
            font-size: 1.1rem; transition: 0.3s; background: #fafafa;
        }
        .form-input:focus { border-color: var(--secondary); background: white; outline: none; box-shadow: 0 0 0 4px rgba(212, 172, 13, 0.1); }

        .btn-action {
            width: 100%; padding: 18px; border: none; border-radius: 20px; font-size: 1.3rem; 
            font-weight: 800; color: white; cursor: pointer; transition: 0.3s; 
            display: flex; align-items: center; justify-content: center; gap: 15px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.15); margin-top: 10px;
        }
        .btn-action:active { transform: translateY(4px); box-shadow: none; }
        .btn-primary { background: var(--primary); box-shadow: 0 8px 0 #0e3e23; }
        .btn-secondary { background: var(--secondary); color: #333; box-shadow: 0 8px 0 #9a7d0a; }
        .btn-danger { background: var(--danger); box-shadow: 0 8px 0 #922b21; }

        /* --- Ø´Ø¨ÙƒØ© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© (Monitor Grid) --- */
        .monitor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        .student-card {
            background: white; border-radius: 30px; padding: 25px; position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); border-right: 15px solid var(--success);
            transition: 0.3s;
        }
        .student-card.late { border-right-color: var(--danger); background: #fff5f5; animation: shake 0.5s infinite; }
        .timer-badge { 
            background: #eee; padding: 5px 15px; border-radius: 15px; font-weight: bold; 
            font-size: 1.2rem; display: inline-block; margin-top: 10px;
        }

        /* --- Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© (Certificate) --- */
        .cert-container {
            width: 1122px; height: 794px; background: white; padding: 60px; margin: 0 auto;
            border: 30px double var(--secondary); text-align: center; display: none;
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            position: relative; color: var(--primary-dark);
        }
        .cert-title { font-family: 'Amiri'; font-size: 5rem; color: var(--primary); margin-bottom: 20px; }
        .cert-name { font-family: 'Amiri'; font-size: 4.5rem; color: var(--secondary); text-decoration: underline; margin: 30px 0; display: block; font-weight: bold; }
        .cert-text { font-size: 2.2rem; line-height: 1.8; margin-bottom: 50px; }
        .cert-sign { margin-top: 80px; display: flex; justify-content: space-around; }
        .cert-sign h4 { font-size: 1.8rem; margin-bottom: 10px; }
        .cert-sign p { font-size: 2rem; font-family: 'Amiri'; font-weight: bold; }

        /* --- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© --- */
        .charts-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 25px; }
        .stat-box { background: white; padding: 20px; border-radius: 25px; border: 1px solid #eee; }

        /* --- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© --- */
        @keyframes floatUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(5px); } 75% { transform: translateX(-5px); } }

        /* --- Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© --- */
        @media print {
            body * { visibility: hidden; }
            .cert-container, .cert-container * { visibility: visible; }
            .cert-container { position: absolute; left: 0; top: 0; transform: scale(0.9); transform-origin: top left; display: block !important; }
        }
    </style>
</head>
<body>

    <audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <div id="connectionStatus" style="position:fixed; bottom:10px; left:10px; font-size:0.8rem; color:#aaa; z-index:2000">Connected</div>

    <div id="loginOverlay">
        <div class="login-card" id="roleSelector">
            <i class="fas fa-school school-logo"></i>
            <h1 style="font-family:'Amiri'; color:var(--primary); font-size: 3rem; margin-bottom: 1rem">Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÙŠ</h1>
            <p style="color:#666; font-size:1.2rem; margin-bottom:2rem">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ (Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„)</p>
            
            <button class="btn-action btn-primary" onclick="showPassPanel('admin')">
                <i class="fas fa-user-shield"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ…
            </button>
            <button class="btn-action btn-secondary" onclick="showPassPanel('teacher')">
                <i class="fas fa-chalkboard-user"></i> Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
            </button>
        </div>

        <div class="login-card" id="passPanel" style="display:none">
            <h2 style="color:var(--primary); margin-bottom:2rem">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©</h2>
            <input type="password" id="passInput" class="form-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„" style="text-align:center; font-size:2rem; letter-spacing:8px">
            <div style="display:flex; gap:10px; margin-top:20px">
                <button class="btn-action btn-primary" onclick="verifyLogin()">Ø¯Ø®ÙˆÙ„</button>
                <button class="btn-action" style="background:#95a5a6; color:white" onclick="location.reload()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <header class="no-print">
        <div class="header-brand">
            <i class="fas fa-graduation-cap" style="font-size:2.5rem; color:var(--secondary)"></i>
            <div>
                <h1>Ø¥Ø°Ù† Ø§Ù„Ø±Ù‚Ù…ÙŠ</h1>
                <small style="opacity:0.8">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</small>
            </div>
        </div>
        
        <div style="display:flex; align-items:center; gap:20px">
            <div class="live-badge">
                <span id="outCount">0</span>
                <span>Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</span>
                <i class="fas fa-circle" style="font-size:0.6rem; color:#fff"></i>
            </div>
            <div id="clockDisplay" style="font-weight:900; font-size:1.5rem; font-family:'Courier New'">00:00:00</div>
            <button onclick="location.reload()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer"><i class="fas fa-power-off"></i></button>
        </div>
    </header>

    <div id="navBar" class="nav-container no-print" style="display:none">
        </div>

    <div class="main-container no-print">

        <div id="viewHome" class="view-section">
            <div class="card" style="text-align:center; background: linear-gradient(180deg, #fff 0%, #f4f4f4 100%);">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-key"></i> ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…ØªØºÙŠØ±</h3>
                    <button class="btn-3d" style="width:auto; padding:10px 20px; font-size:1rem; background:var(--accent)" onclick="generateNewCode()"><i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ«</button>
                </div>
                <div id="dailyCodeDisplay" style="font-size:7rem; font-weight:900; color:var(--danger); letter-spacing:15px; margin:20px 0; text-shadow: 2px 2px 0px #eee;">----</div>
                <p style="color:#777">ÙŠØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</p>
            </div>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:25px">
                <div class="card" style="text-align:center; background:#fef9e7; border:none">
                    <i class="fas fa-users" style="font-size:3rem; color:var(--secondary); margin-bottom:15px"></i>
                    <h1>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</h1>
                    <p style="font-size:1.2rem; margin-top:10px">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª: <strong id="totalToday">0</strong></p>
                </div>
                <div class="card" style="text-align:center; background:#e8f8f5; border:none">
                    <i class="fas fa-walking" style="font-size:3rem; color:var(--primary); margin-bottom:15px"></i>
                    <h1>Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†</h1>
                    <p style="font-size:1.2rem; margin-top:10px">Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬: <strong id="outNow">0</strong></p>
                </div>
            </div>
        </div>

        <div id="viewTeacher" class="view-section">
            <div class="card">
                <div class="card-header"><h3 class="card-title"><i class="fas fa-file-pen"></i> Ø¥ØµØ¯Ø§Ø± Ø¥Ø°Ù† Ø®Ø±ÙˆØ¬</h3></div>
                
                <div class="form-group">
                    <label class="form-label">Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ØµØ¯Ø±:</label>
                    <select id="teacherSelect" class="form-input"><option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option></select>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 2fr; gap:20px">
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„ØµÙ / Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
                        <select id="classSelect" class="form-input" onchange="loadStudents()"><option value="">Ø§Ø®ØªØ±...</option></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                        <select id="studentSelect" class="form-input"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨...</option></select>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px">
                    <div class="form-group">
                        <label class="form-label">ÙˆØ¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                        <select id="destSelect" class="form-input">
                            <option>Ø¯ÙˆØ±Ø© Ø§Ù„Ù…ÙŠØ§Ù‡</option>
                            <option>Ø§Ù„Ù…Ù‚ØµÙ</option>
                            <option>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</option>
                            <option>Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</option>
                            <option>ØºØ±ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</option>
                            <option>Ø£Ø®Ø±Ù‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚ÙŠÙ‚Ø©):</label>
                        <input type="number" id="timeSelect" class="form-input" value="5" min="1" max="60">
                    </div>
                </div>

                <button class="btn-action btn-primary" onclick="submitPermit()">
                    <i class="fas fa-check-circle"></i> Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø°Ù†
                </button>
            </div>
            
            <div id="myActivePerms"></div>
        </div>

        <div id="viewMonitor" class="view-section">
            <h2 style="margin-bottom:25px; color:var(--primary); display:flex; align-items:center; gap:10px">
                <i class="fas fa-satellite-dish"></i> Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© Ø§Ù„Ø­ÙŠØ©
            </h2>
            <div id="monitorGrid" class="monitor-grid">
                </div>
        </div>

        <div id="viewReports" class="view-section">
            <div class="card">
                <div class="card-header"><h3 class="card-title"><i class="fas fa-chart-pie"></i> Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</h3></div>
                <canvas id="permChart" style="max-height: 400px; width:100%"></canvas>
            </div>
            
            <div class="charts-wrapper">
                <div class="stat-box" style="border-top: 5px solid var(--danger)">
                    <h3 style="color:var(--danger); text-align:center; margin-bottom:15px">âš ï¸ Ø§Ù„Ø£ÙƒØ«Ø± Ø®Ø±ÙˆØ¬Ø§Ù‹</h3>
                    <div id="topStudentsList"></div>
                </div>
                <div class="stat-box" style="border-top: 5px solid var(--success)">
                    <h3 style="color:var(--success); text-align:center; margin-bottom:15px">ğŸŒŸ Ù†Ø¬ÙˆÙ… Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·</h3>
                    <div id="starStudentsList"></div>
                </div>
            </div>
        </div>

        <div id="viewCert" class="view-section">
            <div class="card" style="text-align:center">
                <i class="fas fa-medal" style="font-size:5rem; color:var(--secondary); margin-bottom:20px"></i>
                <h2 style="margin-bottom:30px">Ø¥ØµØ¯Ø§Ø± Ø´Ù‡Ø§Ø¯Ø© Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ±</h2>
                
                <div style="max-width:600px; margin:0 auto; text-align:right">
                    <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…ÙƒØ±Ù…:</label>
                    <div style="display:flex; gap:10px; margin-bottom:20px">
                        <select id="certClassSel" class="form-input" onchange="loadCertStudents()"><option>Ø§Ù„Ø´Ø¹Ø¨Ø©</option></select>
                        <select id="certStudentSel" class="form-input"><option>Ø§Ù„Ø·Ø§Ù„Ø¨</option></select>
                    </div>
                    <button class="btn-action btn-secondary" onclick="printCertificate()">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
                    </button>
                </div>
            </div>
        </div>

        <div id="viewSettings" class="view-section">
            <div class="card">
                <div class="card-header"><h3 class="card-title"><i class="fas fa-database"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3></div>
                
                <div style="background:#eafaf1; padding:20px; border-radius:20px; margin-bottom:20px">
                    <h4><i class="fas fa-file-excel" style="color:green"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel</h4>
                    <p style="margin:10px 0; color:#555; font-size:0.9rem">ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©: <strong>(Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ØµÙØŒ Ø§Ù„Ù…Ø¹Ù„Ù…)</strong></p>
                    <input type="file" id="excelInput" class="form-input" accept=".xlsx, .xls" onchange="handleFileUpload(this)">
                    <button class="btn-action btn-primary" onclick="document.getElementById('excelInput').click()">
                        Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙˆØ±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                </div>

                <div style="background:#fdedec; padding:20px; border-radius:20px;">
                    <h4 style="color:var(--danger)"><i class="fas fa-triangle-exclamation"></i> Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</h4>
                    <p style="margin:10px 0; color:#555">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…ØµÙ†Ø¹ Ù„Ù„Ù†Ø¸Ø§Ù….</p>
                    <button class="btn-action btn-danger" onclick="resetSystem()">ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
                </div>
            </div>
        </div>

    </div>

    <div id="certificateTemplate" class="cert-container">
        <div style="border: 2px solid var(--primary); height:100%; padding:40px; border-radius:20px">
            <h1 class="cert-title">Ø´Ù‡Ø§Ø¯Ø© Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ±</h1>
            <p class="cert-text" style="margin-top:60px">
                ØªØªÙ‚Ø¯Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÙŠ Ø¨Ø®Ø§Ù„Øµ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ± Ù„Ù„Ø·Ø§Ù„Ø¨:
            </p>
            <h2 id="certNameDisplay" class="cert-name">................................</h2>
            <p class="cert-text">
                ÙˆØ°Ù„Ùƒ Ù†Ø¸ÙŠØ± Ø§Ù†Ø¶Ø¨Ø§Ø·Ù‡ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ø§Ù„Ù…ØªÙ…ÙŠØ²ØŒ ÙˆÙ…Ø­Ø§ÙØ¸ØªÙ‡ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚ØªØŒ ÙˆØ­Ø³Ù† Ø³Ù„ÙˆÙƒÙ‡ Ø¯Ø§Ø®Ù„ Ø£Ø±ÙˆÙ‚Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.
                <br>Ù…ØªÙ…Ù†ÙŠÙ† Ù„Ù‡ Ø¯ÙˆØ§Ù… Ø§Ù„ØªÙˆÙÙŠÙ‚ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­.
            </p>
            
            <div class="cert-sign">
                <div>
                    <h4>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</h4>
                    <p>....................</p>
                </div>
                <div>
                    <h4>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h4>
                    <p style="color:var(--primary)">Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¨Ù† ÙŠØ­ÙŠÙ‰ Ø¬Ø§Ø¨Ø± Ø§Ù„Ù„ØºØ¨ÙŠ</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Firebase Ø§Ù„Ø±Ø³Ù…ÙŠØ©
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, query, orderBy, deleteDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        const firebaseConfig = { projectId: "edin-377b2", authDomain: "edin-377b2.firebaseapp.com" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…Ø©
        window.appState = {
            role: null,
            students: [],
            teachers: [],
            activePerms: []
        };

        const toAr = n => String(n).replace(/\d/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]);

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ ---
        window.showPassPanel = (role) => {
            window.appState.role = role;
            document.getElementById('roleSelector').style.display = 'none';
            document.getElementById('passPanel').style.display = 'block';
        };

        window.verifyLogin = async () => {
            const input = document.getElementById('passInput').value;
            const btn = document.querySelector('#passPanel .btn-primary');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
            
            try {
                // Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                const codeDoc = await getDoc(doc(db, "settings", "dailyCode"));
                const validCode = codeDoc.exists() ? codeDoc.data().value : "1234";

                if ((window.appState.role === 'admin' && input === "2025") || 
                    (window.appState.role === 'teacher' && input === validCode)) {
                    
                    document.getElementById('loginOverlay').style.display = 'none';
                    buildNavBar();
                    initRealtimeSync(); // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
                } else {
                    alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­!");
                    btn.innerHTML = 'Ø¯Ø®ÙˆÙ„';
                }
            } catch (e) {
                console.error(e);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
                btn.innerHTML = 'Ø¯Ø®ÙˆÙ„';
            }
        };

        // --- Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„ØªÙ†Ù‚Ù„ ---
        function buildNavBar() {
            const nav = document.getElementById('navBar');
            nav.style.display = 'flex';
            
            if (window.appState.role === 'admin') {
                nav.innerHTML = `
                    <button class="nav-btn active" onclick="switchTab('home', this)"><i class="fas fa-chart-line"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    <button class="nav-btn" onclick="switchTab('monitor', this)"><i class="fas fa-desktop"></i>Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button>
                    <button class="nav-btn" onclick="switchTab('reports', this)"><i class="fas fa-file-contract"></i>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                    <button class="nav-btn" onclick="switchTab('cert', this)"><i class="fas fa-medal"></i>Ø§Ù„ØªÙƒØ±ÙŠÙ…</button>
                    <button class="nav-btn" onclick="switchTab('settings', this)"><i class="fas fa-cogs"></i>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                `;
                switchTab('home');
            } else {
                nav.innerHTML = `
                    <button class="nav-btn active" onclick="switchTab('teacher', this)"><i class="fas fa-pen-nib"></i>Ø¥ØµØ¯Ø§Ø± Ø¥Ø°Ù†</button>
                    <button class="nav-btn" onclick="switchTab('monitor', this)"><i class="fas fa-users-viewfinder"></i>Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button>
                `;
                switchTab('teacher');
            }
        }

        window.switchTab = (tabId, btnElement) => {
            // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            const target = document.getElementById('view' + tabId.charAt(0).toUpperCase() + tabId.slice(1));
            if (target) target.classList.add('active');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            if (btnElement) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btnElement.classList.add('active');
            }

            if (tabId === 'reports') renderCharts();
        };

        // --- Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Firebase Listeners) ---
        function initRealtimeSync() {
            // 1. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø£Ø°ÙˆÙ†Ø§Øª (Permissions)
            const q = query(collection(db, "perms"), orderBy("outTime", "desc"));
            onSnapshot(q, (snapshot) => {
                const logs = [];
                snapshot.forEach(doc => logs.push({ id: doc.id, ...doc.data() }));
                window.appState.activePerms = logs;
                updateMonitorUI(logs);
                updateStats(logs);
            });

            // 2. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ÙƒÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ
            onSnapshot(doc(db, "settings", "dailyCode"), (doc) => {
                if (doc.exists()) document.getElementById('dailyCodeDisplay').innerText = toAr(doc.data().value);
            });

            // 3. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø·Ù„Ø§Ø¨ ÙˆÙ…Ø¹Ù„Ù…ÙŠÙ†)
            onSnapshot(doc(db, "data", "schoolLists"), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    window.appState.students = data.students || [];
                    window.appState.teachers = data.teachers || [];
                    populateDropdowns(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙÙˆØ±Ø§Ù‹
                }
            });
        }

        // --- ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ---
        function updateMonitorUI(logs) {
            const active = logs.filter(l => l.status === "out");
            const grid = document.getElementById('monitorGrid');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ù„ÙˆÙŠ
            document.getElementById('outCount').innerText = toAr(active.length);
            document.getElementById('outNow').innerText = toAr(active.length);

            grid.innerHTML = active.map(l => {
                // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ
                const now = new Date();
                const outTime = l.outTime ? l.outTime.toDate() : new Date();
                const diffMins = Math.floor((now - outTime) / 60000);
                const isLate = diffMins >= l.limit;
                
                // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¥Ø°Ø§ ØªØ£Ø®Ø± ÙˆÙ„Ù… ÙŠØªÙ… ØªÙ†Ø¨ÙŠÙ‡Ù‡ (Ø¨Ø³ÙŠØ·)
                if (isLate && window.appState.role === 'admin') {
                    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù‡Ù†Ø§
                }

                return `
                    <div class="student-card ${isLate ? 'late' : ''}">
                        <h2 style="color:var(--primary); margin-bottom:5px">${l.student}</h2>
                        <div style="color:#666; font-size:0.9rem; margin-bottom:10px">
                            <i class="fas fa-chalkboard-user"></i> ${l.class} 
                            | <i class="fas fa-user-tie"></i> ${l.teacher}
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; padding:10px; border-radius:15px">
                            <div>
                                <div style="font-size:0.8rem; color:#888">Ø§Ù„ÙˆØ¬Ù‡Ø©</div>
                                <strong>${l.dest}</strong>
                            </div>
                            <div style="text-align:left">
                                <div class="timer-badge" style="color:${isLate?'red':'green'}">
                                    ${toAr(diffMins)} Ø¯Ù‚ÙŠÙ‚Ø©
                                </div>
                            </div>
                        </div>
                        <button onclick="returnStudent('${l.id}')" class="btn-action btn-primary" style="padding:10px; font-size:1rem; margin-top:15px">
                            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø©
                        </button>
                    </div>
                `;
            }).join('') || '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#999"><i class="fas fa-check-circle" style="font-size:3rem"></i><br>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ ÙØµÙˆÙ„Ù‡Ù…</div>';
        }

        // --- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Logic) ---
        window.updateStudentsList = () => {
            const cls = document.getElementById('classSelect').value;
            const stuSelect = document.getElementById('studentSelect');
            const filtered = window.appState.students.filter(s => s.class === cls);
            stuSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨...</option>' + filtered.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        };

        window.submitPermit = async () => {
            const data = {
                teacher: document.getElementById('teacherSelect').value,
                class: document.getElementById('classSelect').value,
                student: document.getElementById('studentSelect').value,
                dest: document.getElementById('destSelect').value,
                limit: parseInt(document.getElementById('timeSelect').value),
                outTime: serverTimestamp(),
                status: "out"
            };

            if (!data.teacher || !data.student) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

            // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ Firebase
            try {
                await addDoc(collection(db, "perms"), data);
                alert("ØªÙ… Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¥Ø°Ù† Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('studentSelect').value = "";
            } catch (e) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + e.message);
            }
        };

        window.returnStudent = async (id) => {
            if(confirm("Ù‡Ù„ Ø¹Ø§Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„ÙØµÙ„ØŸ")) {
                await updateDoc(doc(db, "perms", id), { status: "returned", inTime: serverTimestamp() });
            }
        };

        window.generateNewCode = async () => {
            const newCode = Math.floor(1000 + Math.random() * 9000).toString();
            await setDoc(doc(db, "settings", "dailyCode"), { value: newCode });
        };

        // --- Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Excel ---
        window.handleFileUpload = (input) => {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet);

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ù†ØªÙˆÙ‚Ø¹ Ø£Ø¹Ù…Ø¯Ø© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ØµÙØŒ Ø§Ù„Ù…Ø¹Ù„Ù…)
                const teachers = [...new Set(json.map(row => row['Ø§Ù„Ù…Ø¹Ù„Ù…'] || row['teacher']))].filter(Boolean);
                const students = json.map(row => ({
                    name: row['Ø§Ù„Ø§Ø³Ù…'] || row['name'],
                    class: row['Ø§Ù„ØµÙ'] || row['Ø§Ù„Ø´Ø¹Ø¨Ø©'] || row['class']
                })).filter(s => s.name && s.class);

                // Ø­ÙØ¸ ÙÙŠ Firebase
                await setDoc(doc(db, "data", "schoolLists"), { teachers, students });
                alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${students.length} Ø·Ø§Ù„Ø¨ Ùˆ ${teachers.length} Ù…Ø¹Ù„Ù… Ø¨Ù†Ø¬Ø§Ø­!`);
            };
            reader.readAsArrayBuffer(file);
        };

        // --- Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ---
        window.loadCertStudents = () => {
            const cls = document.getElementById('certClassSel').value;
            const stuSelect = document.getElementById('certStudentSel');
            const filtered = window.appState.students.filter(s => s.class === cls);
            stuSelect.innerHTML = filtered.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        };

        window.printCertificate = () => {
            const name = document.getElementById('certStudentSel').value;
            if(!name) return alert("Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");
            document.getElementById('certNameDisplay').innerText = name;
            window.print();
        };

        function populateDropdowns() {
            // Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
            const tSel = document.getElementById('teacherSelect');
            tSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù„Ù…...</option>' + window.appState.teachers.map(t => `<option value="${t}">${t}</option>`).join('');
            
            // Ø§Ù„Ø´Ø¹Ø¨ (Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙØ±ÙŠØ¯ Ù…Ù†Ù‡Ø§)
            const classes = [...new Set(window.appState.students.map(s => s.class))].sort();
            const cOpts = '<option value="">Ø§Ø®ØªØ±...</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
            
            document.getElementById('classSelect').innerHTML = cOpts;
            document.getElementById('certClassSel').innerHTML = cOpts;
        }

        // --- Ø§Ù„Ø³Ø§Ø¹Ø© ---
        setInterval(() => {
            document.getElementById('clockDisplay').innerText = new Date().toLocaleTimeString('en-US', {hour12: false});
        }, 1000);

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ---
        function updateStats(logs) {
            document.getElementById('totalToday').innerText = toAr(logs.length);
            
            // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙƒØ«Ø± Ø®Ø±ÙˆØ¬Ø§Ù‹
            const counts = {};
            logs.forEach(l => { counts[l.student] = (counts[l.student] || 0) + 1; });
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
            
            document.getElementById('topStudentsList').innerHTML = sorted.map(([name, count]) => 
                `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee">
                    <span>${name}</span> <strong>${toAr(count)}</strong>
                </div>`
            ).join('');
        }

        window.resetSystem = async () => {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡!")) {
                const q = await getDocs(collection(db, "perms"));
                q.forEach(async (d) => await deleteDoc(doc(db, "perms", d.id)));
                alert("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù….");
                location.reload();
            }
        };

        // --- Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ---
        function renderCharts() {
            const ctx = document.getElementById('permChart');
            if(!ctx) return;
            
            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø©
            const classCounts = {};
            window.appState.activePerms.forEach(l => {
                classCounts[l.class] = (classCounts[l.class] || 0) + 1;
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(classCounts),
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª',
                        data: Object.values(classCounts),
                        backgroundColor: '#1a5f3f',
                        borderRadius: 5
                    }]
                },
                options: { responsive: true }
            });
        }
    </script>
</body>
</html>