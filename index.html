<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø°Ù† Ù„Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ - Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÙŠ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #1a5f3f; 
            --primary-dark: #0f3d28; 
            --secondary: #d4af37;
            --danger: #c0392b; 
            --success: #27ae60; 
            --bg: #f4f7f6; 
            --white: #ffffff;
            --grad: linear-gradient(135deg, #1a5f3f 0%, #0f3d28 100%);
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        body { background: var(--bg); color: #333; overflow-x: hidden; min-height: 100vh; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #loginOverlay {
            position: fixed; inset: 0; background: var(--grad);
            z-index: 10000; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .login-card {
            background: var(--white); padding: 3.5rem; border-radius: 40px; width: 90%; max-width: 500px;
            text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.25); border-top: 10px solid var(--secondary);
            animation: slideUp 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { 
            background: var(--grad); color: white; padding: 1.2rem 2rem; display: flex; 
            justify-content: space-between; align-items: center; position: sticky; top: 0; 
            z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .header-title { font-family: 'Amiri'; font-size: 2.2rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .live-badge { background: var(--danger); padding: 8px 25px; border-radius: 50px; font-weight: 800; font-size: 1.1rem; box-shadow: 0 0 15px rgba(231, 76, 60, 0.6); animation: pulse 2s infinite; }

        /* Ø£Ø²Ø±Ø§Ø± 3D Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
        .btn-3d { 
            width: 100%; padding: 1.2rem; margin: 12px 0; border: none; border-radius: 20px; 
            font-weight: 800; cursor: pointer; transition: all 0.2s ease; font-size: 1.2rem; 
            display: flex; align-items: center; justify-content: center; gap: 15px; color: white;
            position: relative; top: 0;
        }
        .btn-primary { background: var(--primary); box-shadow: 0 6px 0 #0b2e1e; }
        .btn-primary:active { top: 6px; box-shadow: 0 0 0 #0b2e1e; }
        .btn-secondary { background: var(--secondary); color: var(--primary-dark); box-shadow: 0 6px 0 #9e8223; }
        .btn-secondary:active { top: 6px; box-shadow: 0 0 0 #9e8223; }
        .btn-danger { background: var(--danger); box-shadow: 0 6px 0 #7f241a; }
        .btn-danger:active { top: 6px; box-shadow: 0 0 0 #7f241a; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ */
        .admin-nav { display: flex; gap: 15px; margin: 2rem auto; max-width: 1250px; padding: 0 1rem; overflow-x: auto; padding-bottom: 10px; }
        .nav-item { 
            min-width: 130px; flex: 1; background: white; padding: 1.5rem 1rem; border-radius: 25px; text-align: center; 
            cursor: pointer; transition: 0.3s; box-shadow: var(--shadow); border-bottom: 6px solid #e0e0e0;
            font-weight: 700; color: #666;
        }
        .nav-item:hover { transform: translateY(-5px); }
        .nav-item.active { border-bottom-color: var(--secondary); background: #fffcf5; color: var(--primary); transform: translateY(-8px); }
        .nav-item i { font-size: 2.5rem; margin-bottom: 10px; display: block; }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ÙˆØ§Ù„Ø¹Ø±Ø¶ */
        .container { max-width: 1250px; margin: 0 auto; padding: 0 1rem 6rem; }
        .view-section { display: none; opacity: 0; transform: translateY(20px); transition: 0.4s; }
        .view-section.active { display: block; opacity: 1; transform: translateY(0); }

        .card { background: white; padding: 2.5rem; border-radius: 35px; box-shadow: var(--shadow); margin-bottom: 2.5rem; position: relative; overflow: hidden; border: 1px solid #f0f0f0; }
        .form-input { width: 100%; padding: 18px; margin: 10px 0; border: 2px solid #eee; border-radius: 18px; font-size: 1.1rem; transition: 0.3s; }
        .form-input:focus { border-color: var(--secondary); outline: none; background: #fffef9; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© */
        .monitor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; }
        .monitor-card { 
            background: white; border-right: 20px solid var(--secondary); padding: 2rem; border-radius: 30px;
            box-shadow: var(--shadow); position: relative; transition: 0.3s;
        }
        .monitor-card h2 { color: var(--primary); font-size: 1.8rem; margin-bottom: 10px; }
        .monitor-card p { font-size: 1.2rem; color: #555; font-weight: 500; }
        .monitor-card.late { border-right-color: var(--danger); background: #fff5f5; animation: shake 0.5s infinite; }

        /* Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ± */
        .certificate-frame {
            width: 1100px; height: 750px; padding: 60px; background: white; border: 30px double var(--secondary);
            margin: 0 auto; display: none; text-align: center; color: var(--primary-dark);
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.1);
        }
        .cert-header { font-family: 'Amiri', serif; font-size: 4.5rem; color: var(--primary); margin-bottom: 1rem; }
        .cert-body { font-size: 2.2rem; line-height: 1.8; margin: 40px 0; }
        .student-name-cert { font-family: 'Amiri', serif; font-size: 3.8rem; color: var(--secondary); text-decoration: underline; font-weight: bold; }

        /* Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± */
        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .report-header { padding: 15px; color: white; font-weight: bold; text-align: center; font-size: 1.2rem; }
        .rh-red { background: var(--danger); }
        .rh-green { background: var(--success); }

        /* Ù…Ø¤Ø«Ø±Ø§Øª */
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(5px); } 75% { transform: translateX(-5px); } }

        @media print { 
            .no-print { display: none !important; } 
            body { background: white; }
            .certificate-frame { display: block !important; position: fixed; inset: 0; margin: 0; border: 10px double var(--secondary); transform: scale(0.9); } 
        }
    </style>
</head>
<body>

    <audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="loginOverlay">
        <div class="login-card" id="roleSelector">
            <i class="fas fa-school" style="font-size: 6rem; color: var(--primary); margin-bottom: 1.5rem;"></i>
            <h1 style="font-family:'Amiri'; color:var(--primary); font-size: 2.8rem; margin-bottom: 1rem">Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÙŠ</h1>
            <p style="color:#777; margin-bottom:2rem; font-weight: 700; font-size: 1.2rem;">Ù†Ø¸Ø§Ù… Ø¥Ø°Ù† Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            <button class="btn-3d btn-primary" onclick="pickRole('admin')"><i class="fas fa-user-shield"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ…</button>
            <button class="btn-3d btn-secondary" onclick="pickRole('teacher')"><i class="fas fa-chalkboard-user"></i> Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
        </div>
        <div class="login-card" id="passPanel" style="display:none">
            <h3 style="margin-bottom:2rem; color:var(--primary)">Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù…Ù†ÙŠ</h3>
            <input type="password" id="passInput" class="form-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙˆØ±" style="text-align:center; font-size:2.5rem; letter-spacing: 10px;">
            <button class="btn-3d btn-primary" onclick="verifyLogin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            <button class="btn-3d" style="background:#7f8c8d; box-shadow: 0 6px 0 #566573;" onclick="location.reload()">Ø±Ø¬ÙˆØ¹</button>
        </div>
    </div>

    <header class="no-print">
        <div style="display:flex; align-items:center; gap:20px">
            <i class="fas fa-shield-alt" style="font-size: 3rem;"></i>
            <h1 class="header-title">Ø¥Ø°Ù† Ø§Ù„Ø±Ù‚Ù…ÙŠ</h1>
        </div>
        <div style="display:flex; align-items:center; gap:30px">
            <div id="liveBadge" class="live-badge">Ù  Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</div>
            <div id="clockAr" style="font-weight:900; font-size:1.4rem"></div>
            <button onclick="location.reload()" style="background:transparent; border:1px solid white; color:white; padding:5px 15px; border-radius:10px; cursor:pointer"><i class="fas fa-power-off"></i> Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <div class="admin-nav no-print" id="adminNavBar" style="display:none">
        <div class="nav-item active" id="tabHome" onclick="goTab('home')"><i class="fas fa-home" style="color:#2980b9"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav-item" id="tabMonitor" onclick="goTab('monitor')"><i class="fas fa-desktop" style="color:#e67e22"></i>Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</div>
        <div class="nav-item" id="tabReports" onclick="goTab('reports')"><i class="fas fa-chart-pie" style="color:#27ae60"></i>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
        <div class="nav-item" id="tabCert" onclick="goTab('cert')"><i class="fas fa-award" style="color:#f1c40f"></i>Ø§Ù„ØªÙƒØ±ÙŠÙ…</div>
        <div class="nav-item" id="tabSettings" onclick="goTab('settings')"><i class="fas fa-cogs" style="color:#7f8c8d"></i>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    </div>

    <div class="admin-nav no-print" id="teacherNavBar" style="display:none">
        <div class="nav-item active" id="tabTeacherForm" onclick="goTab('teacherForm')"><i class="fas fa-pen-fancy" style="color:#2980b9"></i>Ø¥ØµØ¯Ø§Ø± Ø¥Ø°Ù†</div>
        <div class="nav-item" onclick="goTab('monitor')"><i class="fas fa-users-viewfinder" style="color:#e67e22"></i>Ø·Ù„Ø§Ø¨ÙŠ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</div>
    </div>

    <div class="container no-print">
        
        <div id="viewHome" class="view-section active">
            <div class="card" style="text-align:center; background: linear-gradient(to bottom, #ffffff, #fdfbf7);">
                <h3 style="color:#7f8c8d; margin-bottom:20px">ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ØªØ²Ø§Ù…Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                <div id="dailyCodeVal" style="font-size:6rem; font-weight:900; color:var(--danger); margin:1rem 0; font-family:'Courier New', monospace; letter-spacing: -5px;">----</div>
                <button class="btn-3d btn-primary" style="max-width:300px; margin:0 auto" onclick="generateNewCode()"><i class="fas fa-sync-alt"></i> ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</button>
            </div>
            
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:25px">
                <div class="card" style="text-align:center; border-bottom: 5px solid var(--danger);">
                    <i class="fas fa-walking" style="font-size:3rem; color:var(--danger); margin-bottom:10px"></i>
                    <h4>Ø®Ø§Ø±Ø¬ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¢Ù†</h4>
                    <p id="statOut" style="font-size:3.5rem; font-weight:800; color:var(--danger)">Ù </p>
                </div>
                <div class="card" style="text-align:center; border-bottom: 5px solid var(--primary);">
                    <i class="fas fa-clipboard-check" style="font-size:3rem; color:var(--primary); margin-bottom:10px"></i>
                    <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h4>
                    <p id="statTotal" style="font-size:3.5rem; font-weight:800; color:var(--primary)">Ù </p>
                </div>
            </div>
        </div>

        <div id="viewTeacherForm" class="view-section">
            <div class="card">
                <h2 style="color:var(--primary); margin-bottom:20px"><i class="fas fa-file-signature"></i> Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø®Ø±ÙˆØ¬ Ø·Ø§Ù„Ø¨</h2>
                <div style="display:grid; grid-template-columns: 1fr; gap:15px">
                    <select id="teacherSel" class="form-input" style="background:#f9f9f9"><option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†...</option></select>
                    
                    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:15px">
                        <select id="classSel" class="form-input" onchange="updateStudentsList()"><option value="">Ø§Ù„Ø´Ø¹Ø¨Ø©</option></select>
                        <select id="studentSel" class="form-input"><option value="">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</option></select>
                    </div>

                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px">
                        <select id="destSel" class="form-input">
                            <option>Ø¯ÙˆØ±Ø© Ø§Ù„Ù…ÙŠØ§Ù‡</option>
                            <option>Ø§Ù„Ù…Ù‚ØµÙ</option>
                            <option>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</option>
                            <option>Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</option>
                            <option>Ø£Ø®Ø±Ù‰</option>
                        </select>
                        <input type="number" id="timeLimit" class="form-input" placeholder="Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚" value="5">
                    </div>
                </div>
                <button class="btn-3d btn-primary" style="margin-top:25px" onclick="issuePerm()"><i class="fas fa-paper-plane"></i> Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø°Ù†</button>
            </div>
        </div>

        <div id="viewMonitor" class="view-section">
            <h2 style="margin-bottom:20px; color:var(--primary)">ğŸ”´ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© Ø§Ù„Ø­ÙŠØ©</h2>
            <div id="monitorGrid" class="monitor-grid"></div>
        </div>

        <div id="viewReports" class="view-section">
            <div class="card">
                <h3 style="margin-bottom:20px"><i class="fas fa-chart-bar"></i> Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·</h3>
                <canvas id="mainChart" style="max-height:400px"></canvas>
            </div>
            <div class="report-grid">
                <div class="card" style="padding:0; overflow:hidden">
                    <div class="report-header rh-red">ğŸš¨ Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ¦Ø°Ø§Ù†Ø§Ù‹ (ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯)</div>
                    <div id="reportRedList" style="padding:20px; max-height:300px; overflow-y:auto"></div>
                </div>
                <div class="card" style="padding:0; overflow:hidden">
                    <div class="report-header rh-green">ğŸŒŸ Ù†Ø¬ÙˆÙ… Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· (Ù„Ù… ÙŠØ®Ø±Ø¬ÙˆØ§)</div>
                    <div id="reportGreenList" style="padding:20px; max-height:300px; overflow-y:auto"></div>
                </div>
            </div>
        </div>

        <div id="viewCert" class="view-section">
            <div class="card" style="text-align:center">
                <i class="fas fa-medal" style="font-size:6rem; color:var(--secondary); margin-bottom:20px"></i>
                <h2>Ø¥ØµØ¯Ø§Ø± Ø´Ù‡Ø§Ø¯Ø© Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ±</h2>
                <div style="max-width:500px; margin:20px auto">
                    <select id="certClass" class="form-input" onchange="updateCertStudentList()"><option>Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option></select>
                    <select id="certStudent" class="form-input"><option>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…ÙƒØ±Ù…</option></select>
                </div>
                <button class="btn-3d btn-secondary" style="max-width:400px; margin:0 auto" onclick="printCert()"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</button>
            </div>
        </div>

        <div id="viewSettings" class="view-section">
            <div class="card">
                <h3><i class="fas fa-database"></i> Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Excel)</h3>
                <div style="background:#fffbe6; padding:15px; border-radius:15px; border:1px solid #ffe58f; margin:15px 0">
                    <i class="fas fa-info-circle"></i> Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©: <strong>(Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø´Ø¹Ø¨Ø©ØŒ Ø§Ù„Ù…Ø¹Ù„Ù…)</strong>.
                </div>
                <input type="file" id="xlIn" class="form-input" style="display:none" onchange="handleExcelUpload(this)">
                <div style="display:flex; gap:15px; margin-top:20px">
                    <button class="btn-3d btn-primary" onclick="document.getElementById('xlIn').click()"><i class="fas fa-file-excel"></i> Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    <button class="btn-3d btn-danger" onclick="factoryReset()"><i class="fas fa-trash-alt"></i> ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</button>
                </div>
            </div>
        </div>
    </div>

    <div id="certificateToPrint" class="certificate-frame">
        <h1 class="cert-header">Ø´Ù‡Ø§Ø¯Ø© Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ±</h1>
        <div class="cert-body">
            ØªØªÙ‚Ø¯Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÙŠ Ø¨Ø®Ø§Ù„Øµ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ± Ù„Ù„Ø·Ø§Ù„Ø¨:
            <br><br>
            <span id="targetCertName" class="student-name-cert"></span>
            <br><br>
            ÙˆØ°Ù„Ùƒ Ù†Ø¸ÙŠØ± Ø§Ù†Ø¶Ø¨Ø§Ø·Ù‡ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ø§Ù„Ù…ØªÙ…ÙŠØ² ÙˆØ­Ø³Ù† Ø³Ù„ÙˆÙƒÙ‡.
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:100px; padding:0 50px">
            <div style="text-align:center">
                <p>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                <strong>....................</strong>
            </div>
            <div style="text-align:center">
                <p>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</p>
                <strong style="font-size:1.8rem; color:var(--primary)">Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¨Ù† ÙŠØ­ÙŠÙ‰ Ø¬Ø§Ø¨Ø± Ø§Ù„Ù„ØºØ¨ÙŠ</strong>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, setDoc, getDoc, query, orderBy, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { projectId: "edin-377b2" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const toAr = n => String(n).replace(/\d/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]);
        window.appData = { students: [], teachers: [] };
        window.currentRole = '';
        let chartInstance = null;

        // 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.pickRole = (r) => { window.currentRole = r; document.getElementById('roleSelector').style.display='none'; document.getElementById('passPanel').style.display='block'; };
        
        window.verifyLogin = async () => {
            const pass = document.getElementById('passInput').value;
            const snap = await getDoc(doc(db, "settings", "dailyCode"));
            const daily = snap.exists() ? snap.data().value : "1234";

            if ((window.currentRole === 'admin' && pass === "2025") || (window.currentRole === 'teacher' && pass === daily)) {
                document.getElementById('loginOverlay').style.display='none';
                const navId = window.currentRole === 'admin' ? 'adminNavBar' : 'teacherNavBar';
                document.getElementById(navId).style.display='flex';
                initSystem();
            } else { alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­"); }
        };

        // 2. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        function initSystem() {
            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ
            onSnapshot(doc(db, "settings", "dailyCode"), (d) => { 
                if(d.exists()) document.getElementById('dailyCodeVal').innerText = toAr(d.data().value); 
            });

            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø·Ù„Ø§Ø¨ ÙˆÙ…Ø¹Ù„Ù…ÙŠÙ†)
            onSnapshot(doc(db, "data", "schoolData"), (d) => {
                if(d.exists()) {
                    window.appData = d.data();
                    populateSelectors();
                }
            });

            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø­ÙŠØ©
            const q = query(collection(db, "perms"), orderBy("outTime", "desc"));
            onSnapshot(q, (snap) => {
                const logs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                updateDashboard(logs);
            });

            // Ø§Ù„Ø³Ø§Ø¹Ø©
            setInterval(() => { document.getElementById('clockAr').innerText = toAr(new Date().toLocaleTimeString('ar-SA')); }, 1000);
            
            // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            if(window.currentRole === 'admin') goTab('home'); else goTab('teacherForm');
        }

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        function updateDashboard(logs) {
            const active = logs.filter(l => l.status === "out");
            document.getElementById('liveBadge').innerText = toAr(active.length) + " Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬";
            document.getElementById('statOut').innerText = toAr(active.length);
            document.getElementById('statTotal').innerText = toAr(logs.filter(l => new Date(l.outTime.toDate()).toDateString() === new Date().toDateString()).length);

            document.getElementById('monitorGrid').innerHTML = active.map(l => {
                const elapsed = Math.floor((new Date() - l.outTime.toDate()) / 60000);
                const isLate = elapsed >= (l.limit || 5);
                if(isLate) document.getElementById('alertSound').play().catch(()=>{}); // ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ
                return `
                    <div class="monitor-card ${isLate ? 'late' : ''}">
                        <h2>${l.student}</h2>
                        <p>${l.class} | ${l.dest}</p>
                        <div style="margin:10px 0; font-weight:bold; color:${isLate?'red':'green'}">Ù…Ù†Ø° ${toAr(elapsed)} Ø¯Ù‚ÙŠÙ‚Ø©</div>
                        <small>Ø§Ù„Ù…Ø¹Ù„Ù…: ${l.teacher}</small>
                        <button class="btn-3d btn-primary" style="margin-top:15px; padding:8px" onclick="confirmReturn('${l.id}')">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
                    </div>
                `;
            }).join('');

            updateReports(logs);
        }

        // 4. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¥ØµØ¯Ø§Ø±ØŒ Ø¹ÙˆØ¯Ø©ØŒ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯)
        window.issuePerm = async () => {
            const s = document.getElementById('studentSel').value;
            const t = document.getElementById('teacherSel').value;
            const c = document.getElementById('classSel').value;
            if(!s || !t || !c) return alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„");

            await addDoc(collection(db, "perms"), {
                student: s, teacher: t, class: c,
                dest: document.getElementById('destSel').value,
                limit: parseInt(document.getElementById('timeLimit').value),
                outTime: new Date(),
                status: "out"
            });
            alert("ØªÙ… Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­");
        };

        window.confirmReturn = async (id) => {
            await updateDoc(doc(db, "perms", id), { status: "returned", inTime: new Date() });
        };

        window.generateNewCode = async () => {
            const code = Math.floor(1000 + Math.random() * 9000).toString();
            await setDoc(doc(db, "settings", "dailyCode"), { value: code });
        };

        // 5. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Excel)
        window.handleExcelUpload = (input) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ ÙˆØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const teachers = [...new Set(json.map(r => r.Ø§Ù„Ù…Ø¹Ù„Ù…))].filter(Boolean);
                const students = json.map(r => ({name: r.Ø§Ù„Ø§Ø³Ù…, class: r.Ø§Ù„Ø´Ø¹Ø¨Ø©})).filter(r => r.name && r.class);

                await setDoc(doc(db, "data", "schoolData"), { teachers, students });
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
            };
            reader.readAsArrayBuffer(input.files[0]);
        };

        window.factoryReset = async () => {
            if(confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                const q = await getDocs(collection(db, "perms"));
                q.forEach(async (d) => await deleteDoc(doc(db, "perms", d.id)));
                alert("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…");
            }
        };

        // 6. Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        function populateSelectors() {
            const tSel = document.getElementById('teacherSel');
            tSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù„Ù…</option>' + (window.appData.teachers || []).map(t => `<option value="${t}">${t}</option>`).join('');
            
            const classes = [...new Set((window.appData.students || []).map(s => s.class))].sort();
            const cOps = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('classSel').innerHTML = cOps;
            document.getElementById('certClass').innerHTML = cOps;
        }

        window.updateStudentsList = () => {
            const cls = document.getElementById('classSel').value;
            const list = window.appData.students.filter(s => s.class === cls);
            document.getElementById('studentSel').innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</option>' + list.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        };

        window.updateCertStudentList = () => {
            const cls = document.getElementById('certClass').value;
            const list = window.appData.students.filter(s => s.class === cls);
            document.getElementById('certStudent').innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</option>' + list.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        };

        function updateReports(logs) {
            const ctx = document.getElementById('mainChart');
            if(ctx) {
                if(chartInstance) chartInstance.destroy();
                const counts = {};
                logs.forEach(l => { counts[l.class] = (counts[l.class] || 0) + 1; });
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: Object.keys(counts), datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª', data: Object.values(counts), backgroundColor: '#1a5f3f' }] }
                });
            }
            
            // Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£ÙƒØ«Ø± ÙˆØ§Ù„Ø£Ù‚Ù„
            const stuCounts = {};
            logs.forEach(l => { stuCounts[l.student] = (stuCounts[l.student] || 0) + 1; });
            const sorted = Object.entries(stuCounts).sort((a,b) => b[1] - a[1]);
            
            document.getElementById('reportRedList').innerHTML = sorted.slice(0, 5).map(([n, c]) => `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee"><span>${n}</span><b>${toAr(c)}</b></div>`).join('');
        }

        window.printCert = () => {
            document.getElementById('targetCertName').innerText = document.getElementById('certStudent').value;
            window.print();
        };

        window.goTab = (t) => {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active');
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø·
            const btnId = window.currentRole === 'admin' ? ('tab' + t.charAt(0).toUpperCase() + t.slice(1)) : (t === 'home' ? 'tabHome' : 'tabTeacherForm'); // ØªØ¨Ø³ÙŠØ·
        };
    </script>
</body>
</html>