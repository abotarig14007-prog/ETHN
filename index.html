<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø°Ù† Ø§Ù„Ø±Ù‚Ù…ÙŠ - Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÙŠ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¨ØµØ±ÙŠØ© Ù„Ù„Ù…Ø¯Ø±Ø³Ø© */
            --primary: #145A32;       /* Ø£Ø®Ø¶Ø± ØºØ§Ù…Ù‚ Ø±Ø³Ù…ÙŠ */
            --primary-light: #1E8449; /* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ */
            --secondary: #D4AC0D;     /* Ø°Ù‡Ø¨ÙŠ Ù„Ù„ØªÙƒØ±ÙŠÙ… */
            --accent: #2874A6;        /* Ø£Ø²Ø±Ù‚ Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
            --danger: #C0392B;        /* Ø£Ø­Ù…Ø± Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
            --success: #27AE60;       /* Ø£Ø®Ø¶Ø± Ù„Ù„Ù†Ø¬Ø§Ø­ */
            --bg-color: #F4F6F7;      /* Ø®Ù„ÙÙŠØ© Ø¹Ø§Ù…Ø© */
            --card-bg: #FFFFFF;       /* Ø®Ù„ÙÙŠØ© Ø§Ù„ÙƒØ±ÙˆØª */
            --text-main: #2C3E50;     /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
            --shadow: 0 10px 30px rgba(0,0,0,0.08); /* Ø¸Ù„ Ù†Ø§Ø¹Ù… */
            --gradient: linear-gradient(135deg, #145A32 0%, #0B3B24 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        body { background: var(--bg-color); color: var(--text-main); min-height: 100vh; overflow-x: hidden; }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ --- */
        #loginOverlay {
            position: fixed; inset: 0; background: var(--gradient);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(8px);
        }
        .login-card {
            background: var(--card-bg); width: 90%; max-width: 600px; padding: 4rem;
            border-radius: 40px; text-align: center; 
            box-shadow: 0 50px 100px rgba(0,0,0,0.4);
            border-top: 15px solid var(--secondary);
            animation: zoomIn 0.6s ease-out;
        }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .logo-icon { font-size: 5rem; color: var(--primary); margin-bottom: 20px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2)); }
        
        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± (Header) --- */
        header { 
            background: var(--gradient); color: white; padding: 1rem 2rem; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .app-title { display: flex; align-items: center; gap: 15px; }
        .app-title h1 { font-family: 'Amiri'; font-size: 2.2rem; font-weight: 700; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        
        .status-bar { display: flex; align-items: center; gap: 20px; }
        .live-badge { 
            background: var(--danger); padding: 8px 20px; border-radius: 50px; 
            font-weight: bold; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 0 15px rgba(192, 57, 43, 0.6); animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± --- */
        .nav-scroll { 
            display: flex; gap: 15px; overflow-x: auto; padding: 20px; margin: 0 auto; max-width: 1200px; 
            scrollbar-width: none; justify-content: center;
        }
        .nav-btn {
            background: white; border: none; padding: 15px 30px; border-radius: 20px;
            font-size: 1.1rem; color: #555; cursor: pointer; transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; gap: 5px;
            min-width: 120px;
        }
        .nav-btn:hover { transform: translateY(-5px); color: var(--primary); }
        .nav-btn.active { background: #e8f5e9; color: var(--primary); border-bottom: 5px solid var(--primary); }
        .nav-btn i { font-size: 1.8rem; margin-bottom: 5px; }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 15px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-top: 10px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 6px 0 #0e3e23; }
        .btn-secondary { background: var(--secondary); color: #222; box-shadow: 0 6px 0 #9a7d0a; }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 6px 0 #7b241c; }

        /* --- Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ÙˆØ§Ù„ÙƒØ±ÙˆØª --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px 80px; }
        .view-section { display: none; opacity: 0; transform: translateY(20px); transition: 0.5s; }
        .view-section.active { display: block; opacity: 1; transform: translateY(0); }

        .card { 
            background: white; border-radius: 30px; padding: 2.5rem; margin-bottom: 2rem;
            box-shadow: var(--shadow); position: relative; overflow: hidden; border: 1px solid #eee;
        }
        .card h2 { color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        .form-input { 
            width: 100%; padding: 18px; margin-bottom: 20px; border: 2px solid #eee; 
            border-radius: 15px; font-size: 1.1rem; transition: 0.3s; background: #fafafa;
        }
        .form-input:focus { border-color: var(--secondary); background: white; outline: none; }

        /* --- Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© --- */
        .monitor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; }
        .student-card {
            background: white; padding: 20px; border-radius: 20px; 
            border-right: 15px solid var(--success); box-shadow: var(--shadow);
            transition: 0.3s; position: relative;
        }
        .student-card.late { border-right-color: var(--danger); background: #fff5f5; animation: shake 0.5s infinite; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(5px); } 75% { transform: translateX(-5px); } }

        /* --- Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© --- */
        .cert-wrapper {
            width: 1123px; height: 794px; /* A4 Landscape */
            background: white; padding: 60px; margin: 0 auto;
            border: 40px double var(--secondary);
            text-align: center; display: none;
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            position: fixed; top: 0; left: 0; z-index: 10000;
        }
        .cert-title { font-family: 'Amiri'; font-size: 5rem; color: var(--primary); margin-bottom: 30px; }
        .cert-name { font-family: 'Amiri'; font-size: 4.5rem; color: #b7950b; text-decoration: underline; margin: 40px 0; font-weight: bold; }
        .cert-text { font-size: 2.5rem; line-height: 1.8; margin-bottom: 60px; color: #333; }
        .cert-sign { display: flex; justify-content: space-around; margin-top: 80px; }
        .cert-sign h3 { font-size: 2rem; margin-bottom: 15px; color: #555; }
        .cert-sign p { font-size: 2.2rem; font-family: 'Amiri'; font-weight: bold; color: var(--primary); }

        /* --- ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© --- */
        @media print {
            body * { visibility: hidden; }
            .cert-wrapper, .cert-wrapper * { visibility: visible; }
            .cert-wrapper { display: block !important; position: absolute; left: 0; top: 0; transform: scale(0.9); }
        }
    </style>
</head>
<body>

    <audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="loginOverlay">
        <div class="login-card" id="roleSelector">
            <i class="fas fa-school logo-icon"></i>
            <h1 style="font-family:'Amiri'; color:var(--primary); font-size:3rem; margin-bottom:10px">Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÙŠ</h1>
            <p style="color:#666; font-size:1.3rem; margin-bottom:3rem">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</p>
            
            <button class="btn btn-primary" onclick="showPassInput('admin')">
                <i class="fas fa-user-shield"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
            </button>
            <button class="btn btn-secondary" onclick="showPassInput('teacher')">
                <i class="fas fa-chalkboard-user"></i> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…
            </button>
        </div>

        <div class="login-card" id="passInputArea" style="display:none">
            <h2 style="color:var(--primary); margin-bottom:20px">Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù…Ù†ÙŠ</h2>
            <p style="margin-bottom:20px; color:#777">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            <input type="password" id="passField" class="form-input" placeholder="****" style="text-align:center; font-size:2rem; letter-spacing:10px">
            <div style="display:flex; gap:10px">
                <button class="btn btn-primary" onclick="verifyCode()" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
                <button class="btn btn-danger" onclick="location.reload()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <header class="no-print">
        <div class="app-title">
            <i class="fas fa-graduation-cap" style="font-size:2.5rem; color:var(--secondary)"></i>
            <div>
                <h1>Ø¥Ø°Ù† Ø§Ù„Ø±Ù‚Ù…ÙŠ</h1>
                <small style="opacity:0.9">Ù†Ø¸Ø§Ù… Ø³Ø­Ø§Ø¨ÙŠ 2026</small>
            </div>
        </div>
        <div class="status-bar">
            <div class="live-badge">
                <i class="fas fa-circle" style="font-size:0.8rem"></i>
                <span id="headerOutCount">0</span> Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬
            </div>
            <div id="digitalClock" style="font-family:'Courier New'; font-weight:bold; font-size:1.5rem">00:00</div>
        </div>
    </header>

    <div id="navContainer" class="nav-scroll no-print" style="display:none">
        </div>

    <div class="container no-print" id="mainApp" style="display:none">

        <div id="viewHome" class="view-section">
            <div class="card" style="text-align:center; background: linear-gradient(to bottom, #fff, #f9f9f9)">
                <h3 style="color:#777"><i class="fas fa-key"></i> ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†</h3>
                <div id="dailyCodeDisplay" style="font-size:6rem; font-weight:900; color:var(--primary); letter-spacing:15px; margin:20px 0; font-family:monospace">----</div>
                <button class="btn btn-secondary" style="width:auto; margin:0 auto; padding:10px 40px" onclick="generateNewCode()">
                    <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯
                </button>
                <p style="margin-top:15px; color:#999; font-size:0.9rem">Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙŠØªÙ… Ù…Ø²Ø§Ù…Ù†ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</p>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                <div class="card" style="text-align:center; background:#e8f8f5">
                    <i class="fas fa-users" style="font-size:3rem; color:var(--primary)"></i>
                    <h1 id="totalPermsCount" style="font-size:4rem; margin:10px 0">0</h1>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>
                </div>
                <div class="card" style="text-align:center; background:#fdedec">
                    <i class="fas fa-walking" style="font-size:3rem; color:var(--danger)"></i>
                    <h1 id="activePermsCount" style="font-size:4rem; margin:10px 0">0</h1>
                    <p>Ø·Ù„Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„ÙØµÙˆÙ„</p>
                </div>
            </div>
        </div>

        <div id="viewTeacher" class="view-section">
            <div class="card">
                <h2><i class="fas fa-file-pen"></i> Ø¥ØµØ¯Ø§Ø± Ø¥Ø°Ù† Ø®Ø±ÙˆØ¬</h2>
                <div style="margin-bottom:20px">
                    <label>Ø§Ù„Ù…Ø¹Ù„Ù…:</label>
                    <select id="tSelect" class="form-input"><option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ...</option></select>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 2fr; gap:20px">
                    <div>
                        <label>Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
                        <select id="cSelect" class="form-input" onchange="filterStudents()"><option value="">Ø§Ù„ØµÙ...</option></select>
                    </div>
                    <div>
                        <label>Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                        <select id="sSelect" class="form-input"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨...</option></select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px">
                    <div>
                        <label>Ø§Ù„ÙˆØ¬Ù‡Ø©:</label>
                        <select id="dSelect" class="form-input">
                            <option>Ø¯ÙˆØ±Ø© Ø§Ù„Ù…ÙŠØ§Ù‡</option>
                            <option>Ø§Ù„Ù…Ù‚ØµÙ</option>
                            <option>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</option>
                            <option>Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</option>
                        </select>
                    </div>
                    <div>
                        <label>Ø§Ù„Ù…Ø¯Ø© (Ø¯):</label>
                        <input type="number" id="timeInput" class="form-input" value="5" min="1" max="60">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="submitPermit()">
                    <i class="fas fa-paper-plane"></i> Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¥Ø°Ù†
                </button>
            </div>
        </div>

        <div id="viewMonitor" class="view-section">
            <h2 style="margin-bottom:20px; color:var(--primary)">ğŸ”´ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­ÙŠØ©</h2>
            <div id="monitorGrid" class="monitor-grid">
                </div>
        </div>

        <div id="viewReports" class="view-section">
            <div class="card">
                <h2><i class="fas fa-chart-pie"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
                <canvas id="mainChart" style="max-height:400px"></canvas>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                <div class="card">
                    <h3 style="color:var(--danger)">Ø§Ù„Ø£ÙƒØ«Ø± Ø®Ø±ÙˆØ¬Ø§Ù‹</h3>
                    <ul id="topList" style="list-style:none; padding:0; margin-top:15px"></ul>
                </div>
                <div class="card">
                    <h3 style="color:var(--success)">Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ù†Ø¶Ø¨Ø§Ø·Ø§Ù‹</h3>
                    <ul id="starList" style="list-style:none; padding:0; margin-top:15px"></ul>
                </div>
            </div>
        </div>

        <div id="viewCert" class="view-section">
            <div class="card" style="text-align:center">
                <i class="fas fa-award" style="font-size:5rem; color:var(--secondary); margin-bottom:20px"></i>
                <h2>Ø¥ØµØ¯Ø§Ø± Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</h2>
                <div style="max-width:500px; margin:20px auto">
                    <select id="certNameInput" class="form-input"><option>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨...</option></select>
                    <button class="btn btn-secondary" onclick="printCertificate()">
                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
                    </button>
                </div>
            </div>
        </div>

        <div id="viewSettings" class="view-section">
            <div class="card">
                <h2><i class="fas fa-cogs"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
                
                <div style="background:#f9f9f9; padding:20px; border-radius:15px; margin-bottom:20px; border:1px dashed #ccc">
                    <h4><i class="fas fa-file-excel" style="color:green"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Excel)</h4>
                    <p style="color:#666; font-size:0.9rem; margin:10px 0">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø£Ø¹Ù…Ø¯Ø©: (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø´Ø¹Ø¨Ø©ØŒ Ø§Ù„Ù…Ø¹Ù„Ù…)</p>
                    <input type="file" id="excelFile" class="form-input" onchange="handleExcel(this)">
                </div>

                <div style="background:#fff5f5; padding:20px; border-radius:15px; border:1px solid #ffcccc">
                    <h4 style="color:red">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</h4>
                    <button class="btn btn-danger" onclick="resetSystem()">ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
                </div>
            </div>
        </div>

    </div>

    <div id="certificateTemplate" class="cert-wrapper">
        <h1 class="cert-title">Ø´Ù‡Ø§Ø¯Ø© Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ±</h1>
        <p class="cert-text">ØªØªÙ‚Ø¯Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÙŠ Ø¨Ø®Ø§Ù„Øµ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ± Ù„Ù„Ø·Ø§Ù„Ø¨:</p>
        <h2 id="certStudentName" class="cert-name">................................</h2>
        <p class="cert-text">ÙˆØ°Ù„Ùƒ Ù†Ø¸ÙŠØ± Ø§Ù†Ø¶Ø¨Ø§Ø·Ù‡ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ø§Ù„Ù…ØªÙ…ÙŠØ² ÙˆØ­Ø³Ù† Ø³Ù„ÙˆÙƒÙ‡.</p>
        
        <div class="cert-sign">
            <div>
                <h3>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                <p>....................</p>
            </div>
            <div>
                <h3>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
                <p>Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¨Ù† ÙŠØ­ÙŠÙ‰ Ø¬Ø§Ø¨Ø± Ø§Ù„Ù„ØºØ¨ÙŠ</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (Config)
        const firebaseConfig = { projectId: "edin-377b2", authDomain: "edin-377b2.firebaseapp.com" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
        let currentUserRole = null;
        let studentsList = [];
        let teachersList = [];
        let chartInstance = null;

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© --- //

        // 1. Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„
        window.showPassInput = (role) => {
            currentUserRole = role;
            document.getElementById('roleSelector').style.display = 'none';
            document.getElementById('passInputArea').style.display = 'block';
        };

        window.verifyCode = async () => {
            const btn = document.getElementById('loginBtn');
            const input = document.getElementById('passField').value;
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";

            // ==============================================
            // ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ù…Ø§ÙŠØ©: Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ø¯ÙŠØ±
            // ==============================================
            if (currentUserRole === 'admin' && input === "2025") {
                launchSystem();
                return;
            }

            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…
                const docSnap = await getDoc(doc(db, "settings", "dailyCode"));
                const serverCode = docSnap.exists() ? docSnap.data().value : "1234";

                if (currentUserRole === 'teacher' && input === serverCode) {
                    launchSystem();
                } else {
                    alert("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­!");
                    btn.innerText = "Ø¯Ø®ÙˆÙ„";
                }
            } catch (e) {
                // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…
                if (currentUserRole === 'teacher' && input === "1234") {
                    launchSystem();
                } else {
                    console.error(e);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.");
                    btn.innerText = "Ø¯Ø®ÙˆÙ„";
                }
            }
        };

        function launchSystem() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('navContainer').style.display = 'flex';
            
            setupNavigation();
            startRealtimeSync(); // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        }

        // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        function setupNavigation() {
            const nav = document.getElementById('navContainer');
            if (currentUserRole === 'admin') {
                nav.innerHTML = `
                    <button class="nav-btn active" onclick="navTo('viewHome', this)"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    <button class="nav-btn" onclick="navTo('viewMonitor', this)"><i class="fas fa-desktop"></i>Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button>
                    <button class="nav-btn" onclick="navTo('viewReports', this)"><i class="fas fa-chart-pie"></i>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                    <button class="nav-btn" onclick="navTo('viewCert', this)"><i class="fas fa-award"></i>Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</button>
                    <button class="nav-btn" onclick="navTo('viewSettings', this)"><i class="fas fa-cogs"></i>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                `;
                navTo('viewHome');
            } else {
                nav.innerHTML = `
                    <button class="nav-btn active" onclick="navTo('viewTeacher', this)"><i class="fas fa-pen-nib"></i>Ø¥ØµØ¯Ø§Ø± Ø¥Ø°Ù†</button>
                    <button class="nav-btn" onclick="navTo('viewMonitor', this)"><i class="fas fa-list-check"></i>Ø­Ø§Ù„Ø© Ø·Ù„Ø§Ø¨ÙŠ</button>
                `;
                navTo('viewTeacher');
            }
        }

        window.navTo = (viewId, btn) => {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            if(btn) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }

            if(viewId === 'viewReports') updateCharts();
        };

        // 3. Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© (Heart of the System)
        function startRealtimeSync() {
            // Ø£. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ
            onSnapshot(doc(db, "settings", "dailyCode"), (d) => {
                if(d.exists()) document.getElementById('dailyCodeDisplay').innerText = d.data().value;
            });

            // Ø¨. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø·Ù„Ø§Ø¨/Ù…Ø¹Ù„Ù…ÙŠÙ†)
            onSnapshot(doc(db, "data", "schoolLists"), (d) => {
                if(d.exists()) {
                    const data = d.data();
                    studentsList = data.students || [];
                    teachersList = data.teachers || [];
                    populateDropdowns();
                }
            });

            // Ø¬. Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø­ÙŠØ©
            const q = query(collection(db, "perms"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snap) => {
                const perms = [];
                snap.forEach(d => perms.push({ id: d.id, ...d.data() }));
                
                updateMonitorGrid(perms);
                updateStats(perms);
            });
        }

        // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        function updateMonitorGrid(perms) {
            const activePerms = perms.filter(p => p.status === 'out');
            const grid = document.getElementById('monitorGrid');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
            document.getElementById('headerOutCount').innerText = activePerms.length;
            document.getElementById('activePermsCount').innerText = activePerms.length;
            document.getElementById('totalPermsCount').innerText = perms.length; // Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø· (ØªØ­ØªØ§Ø¬ ÙÙ„ØªØ± ØªØ§Ø±ÙŠØ®)

            grid.innerHTML = activePerms.map(p => {
                // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª
                const now = new Date();
                const outTime = p.timestamp ? p.timestamp.toDate() : new Date();
                const diff = Math.floor((now - outTime) / 60000);
                const isLate = diff > p.limit;
                
                if(isLate && currentUserRole === 'admin') {
                    // ØªØ´ØºÙŠÙ„ ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹ (ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡)
                }

                return `
                    <div class="student-card ${isLate ? 'late' : ''}">
                        <h2 style="color:var(--primary)">${p.studentName}</h2>
                        <p style="color:#666; margin-bottom:10px">
                            <i class="fas fa-chalkboard"></i> ${p.className} | 
                            <i class="fas fa-user-tie"></i> ${p.teacherName}
                        </p>
                        <div style="background:#f9f9f9; padding:10px; border-radius:10px; display:flex; justify-content:space-between">
                            <span><i class="fas fa-location-dot"></i> ${p.destination}</span>
                            <span style="font-weight:bold; color:${isLate?'red':'green'}">${diff} Ø¯Ù‚ÙŠÙ‚Ø©</span>
                        </div>
                        <button class="btn btn-primary" onclick="returnStudent('${p.id}')" style="margin-top:15px; padding:10px">
                            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø©
                        </button>
                    </div>
                `;
            }).join('') || '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#aaa">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„ÙØµÙˆÙ„</div>';
        }

        // 5. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Logic)
        window.generateNewCode = async () => {
            const code = Math.floor(1000 + Math.random() * 9000).toString();
            await setDoc(doc(db, "settings", "dailyCode"), { value: code });
        };

        window.submitPermit = async () => {
            const s = document.getElementById('sSelect').value;
            const c = document.getElementById('cSelect').value;
            const t = document.getElementById('tSelect').value;
            
            if(!s || !c || !t) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

            await addDoc(collection(db, "perms"), {
                studentName: s,
                className: c,
                teacherName: t,
                destination: document.getElementById('dSelect').value,
                limit: parseInt(document.getElementById('timeInput').value),
                status: 'out',
                timestamp: serverTimestamp()
            });
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø°Ù† Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        };

        window.returnStudent = async (id) => {
            await updateDoc(doc(db, "perms", id), { status: 'returned', returnTime: serverTimestamp() });
        };

        // 6. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Excel)
        window.handleExcel = (input) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                // Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
                const t = [...new Set(json.map(r => r['Ø§Ù„Ù…Ø¹Ù„Ù…']))].filter(Boolean);
                const s = json.map(r => ({ name: r['Ø§Ù„Ø§Ø³Ù…'], class: r['Ø§Ù„Ø´Ø¹Ø¨Ø©'] })).filter(x => x.name && x.class);

                await setDoc(doc(db, "data", "schoolLists"), { teachers: t, students: s });
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
            };
            reader.readAsArrayBuffer(input.files[0]);
        };

        window.resetSystem = async () => {
            if(confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                const q = await getDocs(collection(db, "perms"));
                q.forEach(d => deleteDoc(doc(db, "perms", d.id)));
                alert("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù….");
                location.reload();
            }
        };

        // 7. Ù…Ø³Ø§Ø¹Ø¯Ø§Øª (Helpers)
        function populateDropdowns() {
            // Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
            const tSel = document.getElementById('tSelect');
            tSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ...</option>' + teachersList.map(t => `<option>${t}</option>`).join('');
            
            // Ø§Ù„Ø´Ø¹Ø¨
            const classes = [...new Set(studentsList.map(s => s.class))].sort();
            const cOps = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ...</option>' + classes.map(c => `<option>${c}</option>`).join('');
            document.getElementById('cSelect').innerHTML = cOps;
            
            // Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª (ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨)
            document.getElementById('certNameInput').innerHTML = '<option>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨...</option>' + studentsList.map(s => `<option>${s.name}</option>`).join('');
        }

        window.filterStudents = () => {
            const cls = document.getElementById('cSelect').value;
            const filtered = studentsList.filter(s => s.class === cls);
            document.getElementById('sSelect').innerHTML = filtered.map(s => `<option>${s.name}</option>`).join('');
        };

        // 8. Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        window.printCertificate = () => {
            const name = document.getElementById('certNameInput').value;
            if(!name || name.includes("Ø§Ø®ØªØ±")) return alert("Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹");
            document.getElementById('certStudentName').innerText = name;
            window.print();
        };

        function updateCharts() {
            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (ØªÙ… ØªØ¨Ø³ÙŠØ·Ù‡ Ù„Ù„Ù†Ø³Ø®Ø©)
        }

        function updateStats(perms) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
        }

        // Ø§Ù„Ø³Ø§Ø¹Ø©
        setInterval(() => {
            document.getElementById('digitalClock').innerText = new Date().toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute:'2-digit'});
        }, 1000);

    </script>
</body>
</html>