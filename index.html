<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#006C35">
    <title>نظام الإدارة المدرسية الموحد (V46)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #006C35; /* أخضر العلم */
            --gold: #C69C6D;    /* ذهبي الرؤية */
            --bg-light: #F7F9FC;
            --glass: rgba(255, 255, 255, 0.95);
        }
        
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-light); margin: 0; padding-bottom: 80px; color: #333; }

        /* --- شاشة الدخول الفاخرة --- */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #004d25 0%, #006C35 100%);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
        }
        
        .login-card {
            background: var(--glass); padding: 40px; border-radius: 25px; width: 95%; max-width: 900px;
            box-shadow: 0 30px 70px rgba(0,0,0,0.4); text-align: center; border: 1px solid rgba(255,255,255,0.3);
        }

        .roles-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;
        }

        .role-btn {
            background: white; padding: 25px; border-radius: 15px; cursor: pointer;
            transition: all 0.3s; border: 2px solid transparent; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .role-btn:hover { transform: translateY(-10px); border-color: var(--gold); box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        .role-btn i { font-size: 3rem; color: var(--primary); margin-bottom: 15px; }
        .role-btn h3 { font-size: 1.2rem; font-weight: 800; margin: 0; }

        /* --- التخطيط العام --- */
        .sidebar {
            width: 280px; height: 100vh; background: white; position: fixed; right: 0; top: 0;
            z-index: 1000; box-shadow: -5px 0 20px rgba(0,0,0,0.05); transition: 0.3s;
            display: flex; flex-direction: column;
        }
        .sidebar-header {
            background: var(--primary); color: white; padding: 30px; text-align: center;
            border-bottom-left-radius: 30px; margin-bottom: 20px;
        }
        .main-content { margin-right: 280px; padding: 30px; transition: 0.3s; }

        @media (max-width: 991px) {
            .sidebar { transform: translateX(100%); width: 100%; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; padding: 15px; }
            .mobile-header { display: flex !important; }
        }
        .mobile-header { display: none; justify-content: space-between; align-items: center; background: white; padding: 15px; position: sticky; top: 0; z-index: 500; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* --- القوائم والأزرار --- */
        .nav-link {
            padding: 15px 25px; font-size: 1.1rem; color: #555; cursor: pointer; display: flex; align-items: center;
            transition: 0.2s; border-right: 5px solid transparent; margin-bottom: 5px; font-weight: 600;
        }
        .nav-link:hover, .nav-link.active { background: #f0f9f4; color: var(--primary); border-right-color: var(--gold); }
        .nav-link i { width: 40px; text-align: center; font-size: 1.2rem; }

        /* --- البطاقات --- */
        .content-card {
            background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.03);
            overflow: hidden; margin-bottom: 25px; border: 1px solid #eee;
        }
        .card-header-custom {
            padding: 20px 25px; background: white; border-bottom: 1px solid #f5f5f5;
            font-weight: 800; color: var(--primary); display: flex; justify-content: space-between; align-items: center;
        }
        .card-body-custom { padding: 25px; }

        /* --- بطاقات المتابعة --- */
        .monitor-card {
            background: white; padding: 20px; border-radius: 15px; border-right: 6px solid #ccc;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03); margin-bottom: 15px; position: relative;
        }
        .monitor-card.safe { border-right-color: #27ae60; }
        .monitor-card.danger { border-right-color: #c0392b; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); } }

        /* --- النماذج --- */
        .form-control-lg, .form-select-lg { border-radius: 12px; border: 1px solid #e0e0e0; padding: 12px; font-size: 1rem; background: #fafafa; }
        .form-control-lg:focus { border-color: var(--gold); background: white; box-shadow: 0 0 0 4px rgba(198,168,109,0.1); }

        .hidden { display: none !important; }
        #pin-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="login-card">
            <img src="https://cdn-icons-png.flaticon.com/512/3209/3209265.png" width="100" class="mb-3">
            <h1 style="color: var(--primary); font-weight: 900;">بوابة النظام المدرسية</h1>
            <p style="color: var(--gold); font-weight: bold;">متوسطة الإمام النووي - رؤية 2030</p>
            
            <div class="roles-container">
                <div class="role-btn" onclick="openPin('admin')"><i class="fas fa-user-tie"></i><h3>الإدارة (الوكيل)</h3></div>
                <div class="role-btn" onclick="openPin('teacher')"><i class="fas fa-chalkboard-teacher"></i><h3>المعلم</h3></div>
                <div class="role-btn" onclick="openPin('counselor')"><i class="fas fa-user-md"></i><h3>الموجه الطلابي</h3></div>
                <div class="role-btn" onclick="openPin('guard')"><i class="fas fa-id-card-alt"></i><h3>الزوار (الحارس)</h3></div>
            </div>
        </div>

        <div id="pin-screen" class="hidden">
            <h2 class="mb-4 fw-bold">التحقق الأمني</h2>
            <input type="password" id="pin-input" class="form-control form-control-lg text-center fw-bold" style="width: 250px; font-size: 2rem; letter-spacing: 10px;" inputmode="numeric" placeholder="****">
            <div class="d-flex gap-3 mt-4">
                <button class="btn btn-success btn-lg px-5 rounded-pill" onclick="login()">دخول</button>
                <button class="btn btn-outline-secondary btn-lg px-5 rounded-pill" onclick="closePin()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="app-interface" class="hidden">
        
        <div class="mobile-header">
            <h5 class="m-0 fw-bold text-success">نظام إذن</h5>
            <button class="btn text-dark" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i class="fas fa-bars fa-lg"></i></button>
        </div>

        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-school fa-4x mb-3 text-warning"></i>
                <h5 class="fw-bold m-0">الإمام النووي</h5>
                <small class="text-white-50" id="role-disp">--</small>
            </div>
            <div id="menu-items" class="flex-grow-1"></div>
            <div class="p-4">
                <button class="btn btn-outline-danger w-100 py-2 rounded-pill fw-bold" onclick="location.reload()">
                    <i class="fas fa-sign-out-alt me-2"></i> خروج
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <section id="sec-monitor" class="view-sec">
                <div class="d-flex justify-content-between align-items-center mb-4 no-print">
                    <h2 class="fw-bold m-0 text-dark">المتابعة الحية</h2>
                    <button class="btn btn-white border shadow-sm rounded-circle" id="mute-btn" onclick="toggleMute()"><i class="fas fa-volume-up text-success"></i></button>
                </div>
                <div id="live-grid" class="row g-3"></div>
                <div id="no-active" class="text-center py-5 hidden">
                    <i class="fas fa-shield-alt fa-5x text-success opacity-25 mb-3"></i>
                    <h4>الوضع آمن: جميع الطلاب في الفصول</h4>
                </div>
            </section>

            <section id="sec-teacher" class="view-sec hidden">
                <div class="d-flex justify-content-center mb-4">
                    <div class="btn-group bg-white shadow-sm rounded-pill p-1">
                        <button class="btn btn-light rounded-pill px-4 active" onclick="switchTeacherTab('permit', this)">إصدار إذن</button>
                        <button class="btn btn-light rounded-pill px-4" onclick="switchTeacherTab('refer', this)">تحويل (سلوك)</button>
                    </div>
                </div>

                <div id="tea-permit">
                    <div class="content-card">
                        <div class="card-header-custom">إذن خروج مؤقت</div>
                        <div class="card-body-custom">
                            <form onsubmit="issuePermit(event)">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="fw-bold mb-2">1. الفصل</label>
                                        <select id="p-class" class="form-select form-select-lg" onchange="loadStudents(this.value, 'p-student')" required>
                                            <option value="">اختر الفصل...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="fw-bold mb-2">2. الطالب</label>
                                        <select id="p-student" class="form-select form-select-lg" disabled required>
                                            <option value="">حدد الفصل أولاً</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="fw-bold mb-2">3. الوجهة</label>
                                        <select id="p-dest" class="form-select form-select-lg" required>
                                            <option value="دورة مياه">دورة مياه</option>
                                            <option value="المقصف">المقصف</option>
                                            <option value="الإدارة">الإدارة</option>
                                            <option value="الموجه">الموجه الطلابي</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="fw-bold mb-2">4. المدة (دقيقة)</label>
                                        <input type="number" id="p-time" class="form-control form-control-lg" value="5" required>
                                    </div>
                                    <div class="col-12 mt-3">
                                        <div class="form-check form-switch p-2 bg-light rounded">
                                            <input class="form-check-input ms-2" type="checkbox" id="p-spec">
                                            <label class="form-check-label text-danger fw-bold">حالة طارئة (تجاوز النظام)</label>
                                        </div>
                                    </div>
                                    <div class="col-12 mt-3">
                                        <button class="btn btn-success w-100 py-3 fw-bold rounded-pill shadow-sm">تسجيل خروج</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="tea-refer" class="hidden">
                    <div class="content-card border-top border-danger border-5">
                        <div class="card-header-custom text-danger">تحويل طالب للوكيل (مخالفة)</div>
                        <div class="card-body-custom">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="fw-bold mb-2">الفصل</label>
                                    <select id="r-class" class="form-select form-select-lg" onchange="loadStudents(this.value, 'r-student')">
                                        <option value="">اختر الفصل...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="fw-bold mb-2">الطالب</label>
                                    <select id="r-student" class="form-select form-select-lg" disabled><option value="">حدد الفصل أولاً</option></select>
                                </div>
                                <div class="col-12">
                                    <label class="fw-bold mb-2">نوع المخالفة</label>
                                    <input id="r-vio" class="form-control form-control-lg" placeholder="مثلاً: تأخر، عبث، جوال...">
                                </div>
                                <div class="col-12">
                                    <label class="fw-bold mb-2">التفاصيل</label>
                                    <textarea id="r-reason" class="form-control form-control-lg" rows="3" placeholder="اشرح المشكلة..."></textarea>
                                </div>
                                <div class="col-12">
                                    <button class="btn btn-danger w-100 py-3 fw-bold rounded-pill" onclick="sendReferral()">إرسال للوكيل</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-agent" class="view-sec hidden">
                <h3 class="fw-bold mb-4">لوحة الوكيل</h3>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="content-card h-100 border-top border-warning border-5">
                            <div class="card-header-custom bg-light">طلبات الزوار</div>
                            <div id="agent-vis-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="content-card h-100 border-top border-primary border-5">
                            <div class="card-header-custom bg-light">الإحالات والمخالفات</div>
                            <div id="agent-ref-list" class="list-group list-group-flush p-2"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="content-card h-100 border-top border-danger border-5">
                            <div class="card-header-custom bg-light">أمر انصراف</div>
                            <div class="p-4">
                                <input id="dep-name" class="form-control form-control-lg mb-3" placeholder="اسم الطالب">
                                <input id="dep-reason" class="form-control form-control-lg mb-3" placeholder="السبب">
                                <button class="btn btn-danger w-100 py-2 fw-bold" onclick="sendDeparture()">إرسال للحارس</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-counselor" class="view-sec hidden">
                <div class="content-card">
                    <div class="card-header-custom">ملفات الطلاب المحولة</div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 text-center">
                            <thead class="table-light">
                                <tr><th>الطالب</th><th>المخالفة</th><th>إجراء الوكيل</th><th>التاريخ</th><th>الإجراء</th></tr>
                            </thead>
                            <tbody id="counselor-list"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sec-guard" class="view-sec hidden">
                <div class="row g-4">
                    <div class="col-md-5">
                        <div class="content-card p-4 border-top border-dark border-5">
                            <h4 class="mb-4 fw-bold">تسجيل زائر</h4>
                            <input id="g-name" class="form-control mb-3" placeholder="اسم الزائر" required>
                            <input id="g-id" type="number" class="form-control mb-3" placeholder="رقم الهوية" required>
                            <input id="g-reason" class="form-control mb-3" placeholder="سبب الزيارة" required>
                            <button class="btn btn-dark w-100 py-3 fw-bold" onclick="sendVisitor()">إرسال</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="content-card mb-3">
                            <div class="card-header-custom">حالة الطلبات</div>
                            <div id="guard-vis-list" class="list-group list-group-flush"></div>
                        </div>
                        <div class="content-card border-top border-danger border-5">
                            <div class="card-header-custom text-danger">المغادرة (الانصراف)</div>
                            <div id="guard-dep-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-data" class="view-sec hidden">
                <ul class="nav nav-pills mb-4 gap-3 bg-white p-2 rounded-4 shadow-sm border d-inline-flex">
                    <li class="nav-item"><button class="nav-link text-dark active rounded-pill px-4" onclick="tabData('stu', this)">الطلاب</button></li>
                    <li class="nav-item"><button class="nav-link text-dark rounded-pill px-4" onclick="tabData('tea', this)">المعلمون</button></li>
                    <li class="nav-item"><button class="nav-link text-dark rounded-pill px-4" onclick="tabData('sys', this)">النظام</button></li>
                </ul>

                <div id="tab-stu">
                    <div class="content-card p-4">
                        <div class="row g-3 align-items-end mb-4 bg-light p-3 rounded-4 border">
                            <div class="col-md-4">
                                <label class="fw-bold small mb-1">اسم الفصل (مهم للاستيراد)</label>
                                <input id="imp-cls" class="form-control" placeholder="مثلاً: 1/1">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-success w-100" onclick="document.getElementById('f-stu').click()">
                                    <i class="fas fa-file-excel me-2"></i> استيراد من Excel
                                </button>
                                <input type="file" id="f-stu" hidden onchange="importData(this, 'students')">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" onclick="addStudent()">+ طالب يدوي</button>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <input class="form-control w-50" placeholder="بحث..." onkeyup="filterTable('tbl-stu', this.value)">
                            <button class="btn btn-outline-danger btn-sm" onclick="delAll('students')">حذف الكل</button>
                        </div>
                        <div class="table-responsive" style="max-height:400px">
                            <table class="table align-middle" id="tbl-stu">
                                <thead class="table-light"><tr><th>الاسم</th><th>الفصل</th><th>حذف</th></tr></thead>
                                <tbody id="body-stu"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-tea" class="hidden">
                    <div class="content-card p-4">
                        <div class="d-flex gap-3 mb-4">
                            <button class="btn btn-success flex-grow-1" onclick="document.getElementById('f-tea').click()">استيراد ملف المعلمين</button>
                            <input type="file" id="f-tea" hidden onchange="importData(this, 'teachers')">
                            <button class="btn btn-primary flex-grow-1" onclick="addTeacher()">+ معلم</button>
                        </div>
                        <button class="btn btn-outline-danger btn-sm mb-3" onclick="delAll('teachers')">حذف الكل</button>
                        <table class="table" id="tbl-tea"><tbody id="body-tea"></tbody></table>
                    </div>
                </div>

                <div id="tab-sys" class="hidden">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="content-card text-center p-5 border-warning border-top border-5">
                                <h6 class="text-muted">كود المعلم</h6>
                                <h1 class="text-primary fw-bold my-3" id="sys-code">----</h1>
                                <button class="btn btn-dark rounded-pill" onclick="newCode()">تغيير الكود</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-card text-center p-5 border-dark border-top border-5">
                                <h6 class="text-muted">كلمة الحارس</h6>
                                <h1 class="text-dark fw-bold my-3" id="sys-guard">----</h1>
                                <button class="btn btn-outline-dark rounded-pill" onclick="newGuard()">تغيير الكلمة</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-reports" class="view-sec hidden">
                <div class="d-flex justify-content-between mb-4 no-print">
                    <h3 class="fw-bold">التقارير الشاملة</h3>
                    <button class="btn btn-dark" onclick="window.print()">طباعة</button>
                </div>
                <div class="d-flex gap-2 mb-3 overflow-auto no-print">
                    <button class="btn btn-outline-success active px-4 rounded-pill" onclick="showRep('all',this)">الأذونات</button>
                    <button class="btn btn-outline-success px-4 rounded-pill" onclick="showRep('vis',this)">الزوار</button>
                    <button class="btn btn-outline-success px-4 rounded-pill" onclick="showRep('dep',this)">الانصراف</button>
                    <button class="btn btn-outline-success px-4 rounded-pill" onclick="showRep('ref',this)">المخالفات</button>
                    <button class="btn btn-outline-success px-4 rounded-pill" onclick="showRep('stats',this)">الإحصائيات</button>
                </div>
                <div class="content-card">
                    <div class="table-responsive">
                        <table class="table table-bordered text-center mb-0">
                            <thead class="table-light" id="rep-th"></thead>
                            <tbody id="rep-tb"></tbody>
                        </table>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <audio id="snd" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // ================= CONFIG =================
        const firebaseConfig = {
           apiKey: "AIzaSyDOIJONOe7Ef4a0XG8l1CGbc1qVSSckOxE",
  authDomain: "ethn-63848.firebaseapp.com",
  projectId: "ethn-63848",
  storageBucket: "ethn-63848.firebasestorage.app",
  messagingSenderId: "747489913596",
  appId: "1:747489913596:web:d98d88447e4a25cc808579"
        };
        
        try { if(!firebase.apps.length) firebase.initializeApp(firebaseConfig); } 
        catch(e) { Swal.fire('تنبيه هام','يجب وضع بيانات Firebase في الكود ليعمل النظام','error'); }
        const db = firebase.database();

        // ================= STATE =================
        let role = '', muted = false, lastSound = 0;
        let data = { code:'2026', guard:'1111', classes:[], students:{}, teachers:{}, permits:{}, visitors:{}, departures:{}, referrals:{} };

        // ================= SYNC ENGINE (CORE FIX) =================
        window.onload = () => {
            // الاستماع المباشر للتغييرات
            db.ref('/').on('value', s => {
                if (s.val()) {
                    data = s.val();
                    if (!data.classes) data.classes = [];
                    refreshAll();
                }
            });
            setInterval(monitorLoop, 3000);
        };

        function refreshAll() {
            // 1. ملء قوائم الفصول (في صفحة المعلم والإدارة)
            const dropdowns = ['dl-classes', 'p-class', 'r-class'];
            dropdowns.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (el.tagName === 'DATALIST') {
                        el.innerHTML = '';
                        (data.classes || []).forEach(c => el.innerHTML += `<option value="${c}">`);
                    } else { // Select Element
                        const currentVal = el.value;
                        el.innerHTML = '<option value="">اختر الفصل...</option>';
                        (data.classes || []).forEach(c => el.innerHTML += `<option value="${c}">${c}</option>`);
                        el.value = currentVal;
                    }
                }
            });

            // 2. تحديث النظام
            document.getElementById('sys-code').innerText = data.code;
            document.getElementById('sys-guard').innerText = data.guard;

            // 3. تحديث الشاشات النشطة
            if (role === 'guard') renderGuard();
            if (role === 'admin') {
                renderAgent();
                if (!document.getElementById('sec-data').classList.contains('hidden')) renderData();
            }
            if (role === 'counselor') renderCounselor();
            if (!document.getElementById('sec-monitor').classList.contains('hidden')) renderMonitor();
            if (!document.getElementById('sec-reports').classList.contains('hidden')) showRep('all');
        }

        // ================= AUTH =================
        function openPin(r) { role=r; document.getElementById('pin-screen').classList.remove('hidden'); }
        function closePin() { document.getElementById('pin-screen').classList.add('hidden'); }
        function login() {
            const p = document.getElementById('pin-input').value;
            let ok = (role==='admin' && p==='admin') || (role==='guard' && p==data.guard) || (role==='teacher' && p==data.code) || (role==='counselor' && p==='admin');
            if (ok) {
                document.getElementById('auth-overlay').style.display='none';
                document.getElementById('app-interface').classList.remove('hidden');
                buildMenu(); navigate(role==='guard'?'guard':(role==='counselor'?'counselor':(role==='admin'?'monitor':'teacher')));
            } else Swal.fire('خطأ','الرمز غير صحيح','error');
        }

        function buildMenu() {
            const m = document.getElementById('menu-items'); m.innerHTML='';
            document.getElementById('role-disp').innerText = {'admin':'الوكيل', 'teacher':'المعلم', 'guard':'الزوار', 'counselor':'الموجه'}[role];
            
            const links = role==='teacher' ? [['monitor','المتابعة','desktop'],['teacher','الخدمات','user-cog']] :
                          role==='admin' ? [['monitor','المتابعة','desktop'],['data','البيانات','database'],['agent','الوكيل','user-check'],['reports','التقارير','chart-bar']] :
                          role==='guard' ? [['guard','بوابة الزوار','id-card']] :
                          [['counselor','التوجيه الطلابي','user-md']];
            
            links.forEach(([id,t,i]) => m.innerHTML += `<div class="nav-item" onclick="navigate('${id}')"><i class="fas fa-${i}"></i> ${t}</div>`);
        }
        function navigate(id) {
            document.querySelectorAll('.view-sec').forEach(e => e.classList.add('hidden'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            if (window.innerWidth < 992) document.querySelector('.sidebar').classList.remove('active');
            refreshAll();
        }

        // ================= 1. TEACHER =================
        function switchTeacherTab(t, btn) {
            document.getElementById('tea-permit').classList.add('hidden');
            document.getElementById('tea-refer').classList.add('hidden');
            document.getElementById('tea-'+t).classList.remove('hidden');
            document.querySelectorAll('#sec-teacher .btn').forEach(b => b.classList.remove('active', 'btn-primary'));
            document.querySelectorAll('#sec-teacher .btn').forEach(b => b.classList.add('btn-light'));
            btn.classList.remove('btn-light'); btn.classList.add('btn-primary', 'active');
        }

        function loadStudents(cls, id) {
            const sel = document.getElementById(id); 
            sel.innerHTML = '<option value="">اختر الطالب</option>';
            sel.disabled = false;
            
            const students = Object.values(data.students || {}).filter(s => s.class == cls);
            if (students.length === 0) sel.innerHTML = '<option>لا يوجد طلاب</option>';
            else students.forEach(s => sel.innerHTML += `<option value="${s.name}">${s.name}</option>`);
        }

        function issuePermit(e) {
            e.preventDefault();
            const s=document.getElementById('p-student').value, c=document.getElementById('p-class').value, d=document.getElementById('p-dest').value, t=document.getElementById('p-time').value;
            if(!s || !c) return Swal.fire('نقص','أكمل البيانات','warning');
            
            if(Object.values(data.permits||{}).find(p => p.student === s && p.active)) return Swal.fire('خطأ','الطالب بالخارج','error');
            
            db.ref('permits').push({student:s, class:c, dest:d, limit:parseInt(t), start:new Date().toISOString(), active:true});
            Swal.fire({icon:'success', title:'تم', timer:1000, showConfirmButton:false}); navigate('monitor'); e.target.reset();
        }

        function sendReferral() {
            const s=document.getElementById('r-student').value, c=document.getElementById('r-class').value, v=document.getElementById('r-vio').value, r=document.getElementById('r-reason').value;
            if(!s || !v) return Swal.fire('نقص','أكمل البيانات','warning');
            
            db.ref('referrals').push({student:s, class:c, vio:v, reason:r, status:'pending_agent', date:new Date().toLocaleString()});
            Swal.fire('تم التحويل للوكيل','','success'); document.getElementById('r-student').value='';
        }

        // ================= 2. AGENT (DISCIPLINE) =================
        function renderAgent() {
            // Visitors
            document.getElementById('agent-vis-list').innerHTML = Object.entries(data.visitors||{}).filter(([k,v])=>v.status==='pending').map(([k,v])=>`
                <div class="alert alert-warning mb-2 border-warning border-start border-4">
                    <div class="d-flex justify-content-between"><strong>${v.name}</strong><small>${v.time.split(',')[1]}</small></div>
                    <div class="small text-muted">${v.reason} (ID: ${v.id})</div>
                    <div class="mt-2 d-flex gap-2"><button class="btn btn-success btn-sm w-50" onclick="db.ref('visitors/${k}').update({status:'approved'})">موافقة</button><button class="btn btn-danger btn-sm w-50" onclick="db.ref('visitors/${k}').update({status:'rejected'})">رفض</button></div>
                </div>`).join('') || '<div class="text-center text-muted">لا يوجد طلبات</div>';
            
            // Referrals
            document.getElementById('agent-ref-list').innerHTML = Object.entries(data.referrals||{}).filter(([k,r])=>r.status==='pending_agent').map(([k,r])=>`
                <div class="card p-3 mb-2 border-danger shadow-sm">
                    <h6 class="fw-bold text-danger">${r.student} <span class="text-dark small">(${r.class})</span></h6>
                    <p class="mb-1 text-dark fw-bold">${r.vio}</p>
                    <p class="small text-muted mb-2">${r.reason}</p>
                    <input id="act-${k}" class="form-control form-control-sm mb-2" placeholder="الإجراء المتخذ (إجباري)">
                    <button class="btn btn-primary btn-sm w-100" onclick="referToCounselor('${k}')">تحويل للموجه الطلابي</button>
                </div>`).join('') || '<div class="text-center text-muted">لا يوجد مخالفات</div>';
        }

        function referToCounselor(k) {
            const act = document.getElementById('act-'+k).value;
            if(!act) return Swal.fire('تنبيه','يجب كتابة الإجراء المتخذ','warning');
            db.ref('referrals/'+k).update({status:'pending_counselor', agent_action:act});
            Swal.fire('تم التحويل');
        }

        function sendDeparture() {
            const n=document.getElementById('dep-name').value, r=document.getElementById('dep-reason').value;
            if(n) { db.ref('departures').push({name:n, reason:r, status:'pending', time:new Date().toLocaleString()}); Swal.fire('تم الإرسال للحارس'); document.getElementById('dep-name').value=''; }
        }

        // ================= 3. COUNSELOR =================
        function renderCounselor() {
            document.getElementById('counselor-list').innerHTML = Object.entries(data.referrals||{}).filter(([k,r])=>r.status==='pending_counselor').map(([k,r])=>`
                <tr>
                    <td>${r.student}</td><td>${r.vio}</td><td>${r.agent_action}</td><td>${r.date.split(',')[0]}</td>
                    <td><button class="btn btn-success btn-sm" onclick="db.ref('referrals/${k}').update({status:'closed'})">إغلاق الملف</button></td>
                </tr>`).join('');
        }

        // ================= 4. MONITOR & GUARD =================
        function monitorLoop() { if(!document.getElementById('sec-monitor').classList.contains('hidden')) renderMonitor(); }
        
        function renderMonitor() {
            const g = document.getElementById('live-grid');
            const active = Object.entries(data.permits||{}).filter(([k,v])=>v.active);
            
            if (!active.length) {
                document.getElementById('no-active').classList.remove('hidden'); g.innerHTML=''; return;
            }
            document.getElementById('no-active').classList.add('hidden');
            
            let alert = false;
            g.innerHTML = active.map(([k,p]) => {
                const m = Math.floor((new Date()-new Date(p.start))/60000);
                if (m >= p.limit) alert = true;
                return `<div class="col-md-3"><div class="monitor-card ${m>=p.limit?'danger':'safe'}"><h4>${p.student}</h4><span class="badge bg-light text-dark border">${p.class}</span><br><small class="text-muted">${p.dest}</small><h2 class="my-2 ${m>=p.limit?'text-danger':'text-success'}">${m} د</h2><button class="btn btn-dark w-100 btn-sm" onclick="db.ref('permits/${k}').update({active:false, end:new Date().toISOString()})">عودة</button></div></div>`;
            }).join('');
            
            if (alert && !muted && Date.now()-lastSound > 10000) { document.getElementById('snd').play().catch(()=>{}); lastSound=Date.now(); }
        }

        function sendVisitor() {
            const v={name:document.getElementById('g-name').value, id:document.getElementById('g-id').value, reason:document.getElementById('g-reason').value, status:'pending', time:new Date().toLocaleString()};
            if(v.name) { db.ref('visitors').push(v); Swal.fire('تم الإرسال'); document.querySelectorAll('#sec-guard input').forEach(i=>i.value=''); }
        }

        function renderGuard() {
            // Visitors List
            document.getElementById('guard-vis-list').innerHTML = Object.values(data.visitors||{}).reverse().slice(0,5).map(v => {
                let badge = v.status==='pending' ? '<span class="badge bg-warning text-dark">انتظار</span>' : (v.status==='approved' ? '<span class="badge bg-success">مسموح</span>' : '<span class="badge bg-danger">مرفوض</span>');
                return `<div class="list-group-item d-flex justify-content-between align-items-center"><div><strong>${v.name}</strong><br><small>${v.reason}</small></div>${badge}</div>`;
            }).join('');
            
            // Departures List
            document.getElementById('guard-dep-list').innerHTML = Object.entries(data.departures||{}).filter(([k,d])=>d.status==='pending').map(([k,d])=>`
                <div class="alert alert-danger d-flex justify-content-between align-items-center mb-2">
                    <div><strong>${d.name}</strong><br>${d.reason}</div>
                    <button class="btn btn-success btn-sm" onclick="db.ref('departures/${k}').update({status:'exited'})">تأكيد الخروج</button>
                </div>`).join('') || '<div class="text-muted text-center small">لا توجد أوامر انصراف</div>';
        }

        // ================= 5. DATA MANAGEMENT =================
        function tabData(t, btn) {
            document.getElementById('tab-stu').classList.add('hidden');
            document.getElementById('tab-tea').classList.add('hidden');
            document.getElementById('tab-sys').classList.add('hidden');
            document.getElementById('tab-'+t).classList.remove('hidden');
            if(btn) { document.querySelectorAll('#sec-data .nav-link').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
            renderData();
        }

        function renderData() {
            document.getElementById('body-stu').innerHTML = Object.entries(data.students||{}).reverse().map(([k,s])=>`<tr><td>${s.name}</td><td>${s.class}</td><td><button class="btn btn-sm btn-danger" onclick="db.ref('students/'+k).remove()"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            document.getElementById('body-tea').innerHTML = Object.entries(data.teachers||{}).map(([k,t])=>`<tr><td>${t.name}</td><td><button class="btn btn-sm btn-danger" onclick="db.ref('teachers/'+k).remove()"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        }

        function importData(inp, t) {
            const f = inp.files[0];
            const cls = document.getElementById('imp-cls').value;
            
            if (t === 'students' && !cls) return Swal.fire('تنبيه', 'يجب كتابة اسم الفصل قبل الاستيراد لربط الطلاب به', 'warning');
            
            const r = new FileReader();
            r.onload = e => {
                const wb = XLSX.read(e.target.result, {type: 'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws, {header: 1});
                
                let count = 0;
                json.forEach(row => {
                    if (row[0]) {
                        let obj = {name: row[0]};
                        if (t === 'students') obj.class = cls;
                        db.ref(t).push(obj);
                        count++;
                    }
                });

                if (t === 'students' && count > 0) {
                    // تحديث قائمة الفصول فوراً
                    let n = data.classes || [];
                    if (!n.includes(cls)) { n.push(cls); db.ref('classes').set(n); }
                }
                Swal.fire('تم', `تم إضافة ${count} سجل`, 'success');
            };
            r.readAsArrayBuffer(f);
        }

        function addStudent() {
            const cls = document.getElementById('imp-cls').value;
            if(!cls) return Swal.fire('تنبيه','حدد الفصل','warning');
            Swal.fire({input:'text', title:'اسم الطالب'}).then(r=>{if(r.value){db.ref('students').push({name:r.value, class:cls}); let n=data.classes||[]; if(!n.includes(cls)){n.push(cls); db.ref('classes').set(n);}}});
        }
        function addTeacher() { Swal.fire({input:'text', title:'اسم المعلم'}).then(r=>{if(r.value)db.ref('teachers').push({name:r.value})}); }
        function delAll(p) { if(confirm('هل أنت متأكد؟')) db.ref(p).remove(); }
        function newCode() { db.ref('code').set(Math.floor(1000+Math.random()*9000)); }
        function newGuard() { Swal.fire({input:'text'}).then(r=>{if(r.value)db.ref('guard').set(r.value)}); }
        function toggleMute() { muted=!muted; document.getElementById('mute-btn').classList.toggle('text-danger'); }
        function filterTable(id,v) { document.querySelectorAll(`#${id} tbody tr`).forEach(r=>r.style.display=r.innerText.includes(v)?'':'none'); }

        // ================= REPORTS =================
        function showRep(t, btn) {
            if(btn) { document.querySelectorAll('#sec-reports button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
            const th = document.getElementById('rep-th'), tb = document.getElementById('rep-tb');
            
            if(t==='all') {
                th.innerHTML='<tr><th>الطالب</th><th>الوجهة</th><th>الوقت</th></tr>';
                tb.innerHTML=Object.values(data.permits||{}).reverse().map(p=>`<tr><td>${p.student}</td><td>${p.dest}</td><td>${new Date(p.start).toLocaleTimeString()}</td></tr>`).join('');
            } else if(t==='ref') {
                th.innerHTML='<tr><th>الطالب</th><th>المخالفة</th><th>الحالة</th></tr>';
                tb.innerHTML=Object.values(data.referrals||{}).reverse().map(r=>`<tr><td>${r.student}</td><td>${r.vio}</td><td>${r.status}</td></tr>`).join('');
            } else if(t==='vis') {
                th.innerHTML='<tr><th>الزائر</th><th>السبب</th><th>الحالة</th></tr>';
                tb.innerHTML=Object.values(data.visitors||{}).reverse().map(v=>`<tr><td>${v.name}</td><td>${v.reason}</td><td>${v.status}</td></tr>`).join('');
            } else if(t==='dep') {
                th.innerHTML='<tr><th>الطالب</th><th>السبب</th><th>الوقت</th></tr>';
                tb.innerHTML=Object.values(data.departures||{}).reverse().map(d=>`<tr><td>${d.name}</td><td>${d.reason}</td><td>${d.time}</td></tr>`).join('');
            } else if(t==='stats') {
                const c={}; Object.values(data.permits||{}).forEach(p=>{c[p.student]=(c[p.student]||0)+1});
                th.innerHTML='<tr><th>الطالب</th><th>عدد مرات الخروج</th></tr>';
                tb.innerHTML=Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,20).map(([n,k])=>`<tr><td>${n}</td><td>${k}</td></tr>`).join('');
            }
        }
    </script>
</body>
</html>