<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#004D25">
    <title>بوابة إذن الذكية (V43)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --vision-green: #004D25;
            --vision-gold: #cfa86e;
            --vision-bg: #f3f4f6;
            --glass: rgba(255, 255, 255, 0.95);
        }
        
        body { font-family: 'Tajawal', sans-serif; background-color: var(--vision-bg); margin: 0; overflow-x: hidden; color: #333; }

        /* --- LOGIN SCREEN (Vision Style) --- */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--vision-green) 0%, #002b15 100%);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
        }
        
        .portal-card {
            background: var(--glass); padding: 40px; border-radius: 30px; width: 90%; max-width: 900px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }

        .portal-title { color: var(--vision-green); font-weight: 900; font-size: 2.5rem; margin-bottom: 5px; }
        .portal-sub { color: var(--vision-gold); font-size: 1.2rem; font-weight: bold; margin-bottom: 40px; letter-spacing: 1px; }

        .roles-container { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        
        .role-box {
            background: white; width: 220px; padding: 30px 20px; border-radius: 20px; cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: all 0.3s ease; border: 2px solid transparent;
        }
        .role-box:hover { transform: translateY(-10px); border-color: var(--vision-gold); box-shadow: 0 15px 40px rgba(198,168,109,0.2); }
        .role-box i { font-size: 3rem; color: var(--vision-green); margin-bottom: 15px; }
        .role-box h3 { font-size: 1.4rem; font-weight: 800; margin: 0; color: #333; }
        .role-box p { font-size: 0.9rem; color: #777; margin-top: 5px; }

        /* --- DASHBOARD LAYOUT --- */
        .sidebar {
            width: 270px; height: 100vh; background: white; position: fixed; right: 0; top: 0;
            z-index: 1000; box-shadow: -5px 0 30px rgba(0,0,0,0.05); transition: 0.3s;
            display: flex; flex-direction: column;
        }
        
        .logo-area {
            background: var(--vision-green); color: white; padding: 40px 20px; text-align: center;
            border-bottom-left-radius: 30px; margin-bottom: 20px;
        }
        
        .nav-item {
            padding: 15px 30px; font-size: 1.1rem; color: #555; cursor: pointer; display: flex; align-items: center;
            transition: 0.2s; border-right: 5px solid transparent; margin-bottom: 5px; font-weight: 600;
        }
        .nav-item:hover, .nav-item.active { background: #f0fdf4; color: var(--vision-green); border-right-color: var(--vision-green); }
        .nav-item i { width: 35px; }

        .main-content { margin-right: 270px; padding: 30px; transition: 0.3s; min-height: 100vh; }

        /* --- MOBILE --- */
        @media (max-width: 991px) {
            .sidebar { transform: translateX(100%); width: 100%; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; padding: 15px; }
            .roles-container { flex-direction: column; align-items: center; }
            .role-box { width: 100%; }
            .mobile-header { display: flex !important; }
        }
        .mobile-header { display: none; justify-content: space-between; align-items: center; background: white; padding: 15px; margin: -15px -15px 20px -15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); border-radius: 0 0 20px 20px; position: sticky; top: 0; z-index: 500; }

        /* --- COMPONENTS --- */
        .page-card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); overflow: hidden; margin-bottom: 20px; border: 1px solid #eee; }
        .card-head { padding: 20px 30px; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; }
        .card-head h4 { margin: 0; font-weight: 800; color: var(--vision-green); }
        
        .monitor-card { background: white; border-radius: 15px; padding: 20px; border-right: 5px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.02); margin-bottom: 15px; }
        .monitor-card.safe { border-right-color: #2ecc71; }
        .monitor-card.danger { border-right-color: #e74c3c; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } }

        /* Custom Inputs */
        .form-control-lg { border-radius: 12px; padding: 15px; font-size: 1rem; border: 1px solid #eee; background: #fafafa; }
        .form-control-lg:focus { border-color: var(--vision-gold); box-shadow: 0 0 0 4px rgba(198, 168, 109, 0.1); background: white; }

        .hidden { display: none !important; }
        #pin-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="portal-card">
            <img src="https://cdn-icons-png.flaticon.com/512/3209/3209265.png" width="100" class="mb-3">
            <div class="portal-title">نظام إذن الذكي</div>
            <div class="portal-sub">بوابة متوسطة الإمام النووي - رؤية 2030</div>

            <div class="roles-container">
                <div class="role-box" onclick="openPin('admin')">
                    <i class="fas fa-user-tie"></i>
                    <h3>الإدارة</h3>
                    <p>التحكم والتقارير</p>
                </div>
                <div class="role-box" onclick="openPin('teacher')">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <h3>المعلم</h3>
                    <p>إصدار الأذونات</p>
                </div>
                <div class="role-box" onclick="openPin('guard')">
                    <i class="fas fa-id-card-alt"></i>
                    <h3>الزوار</h3>
                    <p>بوابة الدخول</p>
                </div>
            </div>
        </div>

        <div id="pin-screen" class="hidden">
            <h3 class="mb-4 fw-bold text-dark">التحقق الأمني</h3>
            <input type="password" id="pin-input" class="form-control form-control-lg text-center fw-bold" style="width: 250px; font-size: 2rem; letter-spacing: 10px;" inputmode="numeric" placeholder="****">
            <div class="d-flex gap-3 mt-4">
                <button class="btn btn-success btn-lg px-5 rounded-pill" onclick="login()">دخول</button>
                <button class="btn btn-outline-secondary btn-lg px-5 rounded-pill" onclick="closePin()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="app-interface" class="hidden">
        
        <div class="mobile-header">
            <h5 class="m-0 fw-bold text-success">نظام إذن</h5>
            <button class="btn text-dark" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i class="fas fa-bars fa-lg"></i></button>
        </div>

        <aside class="sidebar">
            <div class="logo-area">
                <i class="fas fa-school fa-3x mb-3 text-warning"></i>
                <h5 class="fw-bold m-0">الإمام النووي</h5>
                <small class="text-white-50" id="role-disp">--</small>
            </div>
            <div id="menu-items" class="flex-grow-1"></div>
            <div class="p-4">
                <button class="btn btn-outline-danger w-100 py-2 rounded-pill fw-bold" onclick="location.reload()">
                    <i class="fas fa-sign-out-alt me-2"></i> خروج
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <section id="sec-monitor" class="view-sec">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold m-0 text-dark">المتابعة الحية</h2>
                    <button class="btn btn-white border shadow-sm rounded-circle" id="mute-btn" onclick="toggleMute()"><i class="fas fa-volume-up text-success"></i></button>
                </div>
                <div id="live-grid" class="row g-3"></div>
                <div id="no-active" class="text-center py-5 hidden">
                    <i class="fas fa-check-circle fa-5x text-success opacity-25 mb-3"></i>
                    <h4>جميع الطلاب في الفصول</h4>
                </div>
            </section>

            <section id="sec-data" class="view-sec hidden">
                <ul class="nav nav-pills mb-4 gap-3 bg-white p-2 rounded-4 shadow-sm d-inline-flex border">
                    <li class="nav-item"><button class="nav-link text-dark active rounded-pill px-4" onclick="tabData('stu', this)">الطلاب</button></li>
                    <li class="nav-item"><button class="nav-link text-dark rounded-pill px-4" onclick="tabData('tea', this)">المعلمون</button></li>
                    <li class="nav-item"><button class="nav-link text-dark rounded-pill px-4" onclick="tabData('sys', this)">النظام</button></li>
                </ul>

                <div id="tab-stu">
                    <div class="page-card">
                        <div class="card-head"><h4>إدارة الطلاب</h4></div>
                        <div class="p-4">
                            <div class="row g-3 align-items-end mb-4 bg-light p-3 rounded-4 border">
                                <div class="col-md-4">
                                    <label class="fw-bold small mb-2">1. اختر الفصل (إجباري للاستيراد)</label>
                                    <input list="dl-classes" id="imp-cls" class="form-control form-control-lg" placeholder="اكتب اسم الفصل">
                                    <datalist id="dl-classes"></datalist>
                                </div>
                                <div class="col-md-4">
                                    <label class="fw-bold small mb-2">2. استيراد (Excel)</label>
                                    <button class="btn btn-success w-100 py-2" onclick="document.getElementById('f-stu').click()">
                                        <i class="fas fa-file-excel me-2"></i> رفع الملف
                                    </button>
                                    <input type="file" id="f-stu" hidden onchange="importData(this, 'students')">
                                </div>
                                <div class="col-md-4">
                                    <label class="fw-bold small mb-2">إضافة يدوية</label>
                                    <button class="btn btn-primary w-100 py-2" onclick="addStudent()">+ طالب فردي</button>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-3">
                                <input class="form-control w-50 rounded-pill" placeholder="بحث عن طالب..." onkeyup="filterTable('tbl-stu', this.value)">
                                <button class="btn btn-sm btn-outline-danger" onclick="delAll('students')">حذف جميع الطلاب</button>
                            </div>

                            <div class="table-responsive" style="max-height: 500px;">
                                <table class="table table-hover align-middle" id="tbl-stu">
                                    <thead class="table-light"><tr><th>الاسم</th><th>الفصل</th><th>حذف</th></tr></thead>
                                    <tbody id="body-stu"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-tea" class="hidden">
                    <div class="page-card">
                        <div class="card-head"><h4>إدارة المعلمين</h4></div>
                        <div class="p-4">
                            <div class="d-flex gap-3 mb-4">
                                <button class="btn btn-success flex-grow-1 py-3" onclick="document.getElementById('f-tea').click()">
                                    <i class="fas fa-file-excel me-2"></i> استيراد ملف المعلمين
                                </button>
                                <input type="file" id="f-tea" hidden onchange="importData(this, 'teachers')">
                                <button class="btn btn-primary flex-grow-1 py-3" onclick="addTeacher()">+ إضافة معلم</button>
                            </div>
                            <button class="btn btn-outline-danger btn-sm mb-3" onclick="delAll('teachers')">حذف جميع المعلمين</button>
                            <table class="table table-hover align-middle" id="tbl-tea"><tbody id="body-tea"></tbody></table>
                        </div>
                    </div>
                </div>

                <div id="tab-sys" class="hidden">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="page-card text-center p-5 border-warning border-top border-5">
                                <h6 class="text-muted">كود المعلم الحالي</h6>
                                <h1 class="display-3 fw-bold text-primary my-3" id="sys-code">----</h1>
                                <button class="btn btn-dark rounded-pill px-4" onclick="newCode()">تغيير الكود</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="page-card text-center p-5 border-dark border-top border-5">
                                <h6 class="text-muted">كلمة مرور الزوار</h6>
                                <h1 class="display-3 fw-bold text-dark my-3" id="sys-guard">----</h1>
                                <button class="btn btn-outline-dark rounded-pill px-4" onclick="newGuard()">تغيير الكلمة</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-reports" class="view-sec hidden">
                <div class="d-flex justify-content-between mb-4 no-print">
                    <h2 class="fw-bold">التقارير</h2>
                    <button class="btn btn-dark rounded-pill px-4" onclick="window.print()">طباعة</button>
                </div>
                <div class="d-flex gap-2 mb-4 overflow-auto no-print">
                    <button class="btn btn-outline-success active rounded-pill px-4" onclick="showRep('all', this)">الأذونات</button>
                    <button class="btn btn-outline-success rounded-pill px-4" onclick="showRep('vis', this)">الزوار</button>
                    <button class="btn btn-outline-success rounded-pill px-4" onclick="showRep('dep', this)">الانصراف</button>
                </div>
                <div class="page-card">
                    <div class="table-responsive">
                        <table class="table table-bordered text-center mb-0">
                            <thead class="table-light" id="rep-th"></thead>
                            <tbody id="rep-tb"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sec-permit" class="view-sec hidden">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="page-card">
                            <div class="card-head"><h4>إصدار إذن خروج</h4></div>
                            <div class="p-5">
                                <form onsubmit="issuePermit(event)">
                                    <div class="mb-4">
                                        <label class="fw-bold mb-2">1. الفصل</label>
                                        <input list="dl-classes" id="p-class" class="form-control form-control-lg" onchange="filterStudents(this.value)" placeholder="ابحث عن الفصل..." required>
                                    </div>
                                    <div class="mb-4">
                                        <label class="fw-bold mb-2">2. الطالب (اكتب للبحث)</label>
                                        <input list="dl-students" id="p-student" class="form-control form-control-lg" placeholder="اكتب اسم الطالب..." disabled required>
                                        <datalist id="dl-students"></datalist>
                                    </div>
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-6">
                                            <label class="fw-bold mb-2">3. الوجهة</label>
                                            <select id="p-dest" class="form-select form-select-lg" required>
                                                <option value="">اختر...</option>
                                                <option>دورة مياه</option><option>المقصف</option><option>الإدارة</option><option>الموجه</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="fw-bold mb-2">4. المدة (دقيقة)</label>
                                            <input type="number" id="p-time" class="form-control form-control-lg" value="5" required>
                                        </div>
                                    </div>
                                    <div class="form-check form-switch mb-4 bg-light p-3 rounded-4">
                                        <input class="form-check-input ms-2" type="checkbox" id="p-spec">
                                        <label class="form-check-label text-danger fw-bold">حالة طارئة (تجاوز النظام)</label>
                                    </div>
                                    <button class="btn btn-success w-100 py-3 fw-bold fs-5 rounded-pill shadow-sm">تسجيل خروج الطالب</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-guard" class="view-sec hidden">
                <div class="row g-4">
                    <div class="col-md-5">
                        <div class="page-card border-top border-warning border-5">
                            <div class="p-4">
                                <h4 class="mb-4 fw-bold text-dark">تسجيل زائر جديد</h4>
                                <input id="g-name" class="form-control form-control-lg mb-3" placeholder="اسم الزائر" required>
                                <input id="g-id" type="number" class="form-control form-control-lg mb-3" placeholder="رقم الهوية" required>
                                <input id="g-reason" class="form-control form-control-lg mb-3" placeholder="سبب الزيارة" required>
                                <button class="btn btn-warning w-100 py-3 fw-bold fs-5" onclick="sendVisitor()">إرسال للوكيل</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="page-card h-100">
                            <div class="card-head"><h4>حالة الطلبات (مباشر)</h4></div>
                            <div id="guard-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                </div>
                <div class="page-card mt-4 border-top border-danger border-5">
                    <div class="card-head text-danger"><h4>أوامر الانصراف (من الوكيل)</h4></div>
                    <div id="guard-dep-list" class="list-group list-group-flush p-2"></div>
                </div>
            </section>

            <section id="sec-agent" class="view-sec hidden">
                <h2 class="mb-4 fw-bold">لوحة الوكيل</h2>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="page-card h-100 border-top border-warning border-5">
                            <div class="card-head bg-light"><h4>طلبات الزوار المعلقة</h4></div>
                            <div id="agent-vis-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="page-card h-100 border-top border-danger border-5">
                            <div class="card-head bg-light"><h4>إصدار أمر انصراف</h4></div>
                            <div class="p-4">
                                <input id="dep-name" class="form-control form-control-lg mb-3" placeholder="اسم الطالب">
                                <input id="dep-reason" class="form-control form-control-lg mb-3" placeholder="سبب الانصراف">
                                <button class="btn btn-danger w-100 py-3 fw-bold" onclick="sendDeparture()">إرسال للحارس</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <audio id="snd" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // ================= FIREBASE CONFIG (هام جداً: ضع بياناتك هنا) =================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        
        // Safety Check
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        } catch (e) {
            Swal.fire({icon:'error', title:'تنبيه هام', text:'يجب وضع بيانات Firebase في الكود ليعمل النظام!'});
        }
        const db = firebase.database();

        // ================= STATE =================
        let role = '', muted = false, lastSound = 0;
        let dbData = { classes: [], code: '2026', guard: '1111', visitors: {}, departures: {}, students: {}, permits: {} };

        // ================= SYNC ENGINE (Real-Time) =================
        window.onload = () => {
            db.ref('/').on('value', (snap) => {
                const val = snap.val();
                if (val) {
                    dbData = val;
                    if (!dbData.classes) dbData.classes = [];
                    refreshUI(); // تحديث الواجهة فوراً عند أي تغيير
                }
            });
            setInterval(checkMonitorSound, 5000);
        };

        function refreshUI() {
            // تحديث قوائم الفصول
            const dl = document.getElementById('dl-classes');
            if (dl) { dl.innerHTML = ''; (dbData.classes || []).forEach(c => dl.innerHTML += `<option value="${c}">`); }

            document.getElementById('sys-code').innerText = dbData.code;
            document.getElementById('sys-guard').innerText = dbData.guard;

            // تحديث الشاشة النشطة حالياً
            if (role === 'guard') renderGuardScreen();
            if (role === 'admin') { renderAgentScreen(); if(!document.getElementById('sec-data').classList.contains('hidden')) renderManage(); }
            if (!document.getElementById('sec-monitor').classList.contains('hidden')) renderMonitor();
        }

        // ================= DATA LOGIC (Import Fixed) =================
        function importData(inp, t) {
            const f = inp.files[0];
            const cls = document.getElementById('imp-cls').value;
            
            if (t === 'students' && !cls) return Swal.fire('تنبيه', 'يجب كتابة اسم الفصل قبل اختيار الملف', 'warning');
            
            const r = new FileReader();
            r.onload = e => {
                const wb = XLSX.read(e.target.result, {type: 'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws, {header: 1}); // Read as array of arrays
                
                let count = 0;
                json.forEach(row => {
                    if (row[0]) { // يفترض أن الاسم في العمود الأول A
                        let obj = {name: row[0]};
                        if (t === 'students') obj.class = cls;
                        db.ref(t).push(obj);
                        count++;
                    }
                });

                if (t === 'students' && count > 0) {
                    // إضافة الفصل للقائمة إذا لم يكن موجوداً
                    let currentClasses = dbData.classes || [];
                    if (!currentClasses.includes(cls)) {
                        currentClasses.push(cls);
                        db.ref('classes').set(currentClasses);
                    }
                }
                
                Swal.fire('تم بنجاح', `تم استيراد ${count} سجل`, 'success');
            };
            r.readAsArrayBuffer(f);
        }

        // ================= TEACHER LOGIC (Searchable List) =================
        function filterStudents(cls) {
            const list = document.getElementById('dl-students'); 
            const inp = document.getElementById('p-student');
            list.innerHTML = ''; inp.value = '';
            
            if(!cls) { inp.disabled=true; return; }
            inp.disabled = false;

            const students = Object.values(dbData.students || {}).filter(s => s.class === cls);
            if(students.length === 0) {
                Swal.fire('تنبيه', 'لا يوجد طلاب مسجلين في هذا الفصل', 'info');
            } else {
                students.forEach(s => list.innerHTML += `<option value="${s.name}">`);
            }
        }

        function issuePermit(e) {
            e.preventDefault();
            const s=document.getElementById('p-student').value, c=document.getElementById('p-class').value, d=document.getElementById('p-dest').value, t=document.getElementById('p-time').value;
            
            if(!s || !c || !d || !t) return Swal.fire('نقص','أكمل البيانات','warning');
            
            const active = Object.values(dbData.permits || {}).find(p => p.student === s && p.active);
            if(active) return Swal.fire('خطأ', `الطالب ${s} خارج الفصل حالياً`, 'error');

            db.ref('permits').push({student:s, class:c, dest:d, limit:parseInt(t), start:new Date().toISOString(), active:true});
            Swal.fire({icon:'success', title:'تم الخروج', timer:1000, showConfirmButton:false});
            navigate('monitor'); e.target.reset();
        }

        // ================= MONITOR =================
        function renderMonitor() {
            const g = document.getElementById('live-grid');
            const active = Object.entries(dbData.permits||{}).filter(([k,v])=>v.active);
            
            if(active.length === 0) {
                document.getElementById('no-active').classList.remove('hidden');
                g.innerHTML='';
            } else {
                document.getElementById('no-active').classList.add('hidden');
                let alert = false;
                g.innerHTML = active.map(([k,p]) => {
                    const m = Math.floor((new Date()-new Date(p.start))/60000);
                    if(m >= p.limit) alert = true;
                    return `<div class="col-md-3"><div class="monitor-card ${m>=p.limit?'danger':'safe'}"><h4>${p.student}</h4><span class="badge bg-light text-dark border">${p.class}</span><br><small class="text-muted">${p.dest}</small><h2 class="my-2 ${m>=p.limit?'text-danger':'text-success'}">${m} د</h2><button class="btn btn-dark w-100 btn-sm" onclick="db.ref('permits/${k}').update({active:false, end:new Date().toISOString()})">عودة</button></div></div>`;
                }).join('');
                if(alert && !muted && Date.now()-lastSound > 10000) { document.getElementById('snd').play().catch(()=>{}); lastSound=Date.now(); }
            }
        }
        function checkMonitorSound() { if(!document.getElementById('sec-monitor').classList.contains('hidden')) renderMonitor(); }
        function toggleMute() { muted=!muted; document.getElementById('mute-btn').classList.toggle('text-danger'); }

        // ================= GUARD & AGENT (SYNC FIXED) =================
        function sendVisitor() {
            const v={name:document.getElementById('g-name').value, id:document.getElementById('g-id').value, reason:document.getElementById('g-reason').value, status:'pending', time:new Date().toLocaleString()}; // status unified as 'pending'
            if(!v.name) return;
            db.ref('visitors').push(v);
            Swal.fire('تم الإرسال للوكيل'); document.querySelectorAll('#sec-guard input').forEach(i=>i.value='');
        }

        function renderGuardScreen() {
            // Visitors
            document.getElementById('guard-list').innerHTML = Object.values(dbData.visitors||{}).reverse().slice(0,5).map(v=>`
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div><strong>${v.name}</strong><br><small>${v.reason}</small></div>
                    <span class="badge ${v.status==='approved'?'bg-success':(v.status==='rejected'?'bg-danger':'bg-warning text-dark')}">${v.status==='pending'?'انتظار':(v.status==='approved'?'مقبول':'مرفوض')}</span>
                </div>`).join('');
            
            // Departures (To Confirm Exit)
            document.getElementById('guard-dep-list').innerHTML = Object.entries(dbData.departures||{}).filter(([k,d])=>d.status==='pending').map(([k,d])=>`
                <div class="alert alert-danger d-flex justify-content-between align-items-center mb-2">
                    <div><strong>${d.name}</strong><br>السبب: ${d.reason}</div>
                    <button class="btn btn-success btn-sm" onclick="db.ref('departures/${k}').update({status:'exited'})">تأكيد خروج</button>
                </div>`).join('') || '<div class="text-center text-muted small">لا توجد أوامر انصراف</div>';
        }

        function renderAgentScreen() {
            // Pending Visitors
            document.getElementById('agent-vis-list').innerHTML = Object.entries(dbData.visitors||{}).filter(([k,v])=>v.status==='pending').map(([k,v])=>`
                <div class="list-group-item">
                    <div class="d-flex justify-content-between fw-bold"><span>${v.name}</span><small>${v.time.split(',')[1]}</small></div>
                    <small class="text-muted">${v.reason}</small>
                    <div class="mt-2 d-flex gap-2"><button class="btn btn-success btn-sm w-50" onclick="db.ref('visitors/${k}').update({status:'approved'})">موافقة</button><button class="btn btn-danger btn-sm w-50" onclick="db.ref('visitors/${k}').update({status:'rejected'})">رفض</button></div>
                </div>`).join('') || '<div class="text-center text-muted p-3">لا توجد طلبات جديدة</div>';
        }

        function sendDeparture() {
            const d={name:document.getElementById('dep-name').value, reason:document.getElementById('dep-reason').value, status:'pending', time:new Date().toLocaleString()};
            if(!d.name) return;
            db.ref('departures').push(d);
            Swal.fire('تم الإرسال للحارس'); document.getElementById('dep-name').value='';
        }

        // ================= AUTH & NAV =================
        function openPin(r) { role=r; document.getElementById('pin-screen').classList.remove('hidden'); }
        function closePin() { document.getElementById('pin-screen').classList.add('hidden'); }
        function login() {
            const p = document.getElementById('pin-input').value;
            let ok = (role==='admin' && p==='admin') || (role==='guard' && p==dbData.guard) || (role==='teacher' && p==dbData.code);
            if(ok) {
                document.getElementById('auth-overlay').style.display='none';
                document.getElementById('app-interface').classList.remove('hidden');
                buildMenu(); navigate(role==='guard'?'guard':(role==='admin'?'monitor':'permit'));
            } else Swal.fire('خطأ','الرمز غير صحيح','error');
        }
        function buildMenu() {
            const m = document.getElementById('menu-items'); m.innerHTML='';
            document.getElementById('role-disp').innerText = role==='admin'?'الإدارة':(role==='teacher'?'المعلم':'الزوار');
            const items = role==='teacher' ? [['monitor','المتابعة','desktop'],['permit','إصدار إذن','file-signature']] :
                          role==='admin' ? [['monitor','المتابعة','desktop'],['data','البيانات','database'],['agent','الوكيل','user-check'],['reports','التقارير','chart-bar']] :
                          [['guard','بوابة الزوار','id-card']];
            items.forEach(([id,t,i]) => m.innerHTML+=`<div class="nav-item" onclick="navigate('${id}')"><i class="fas fa-${i}"></i> ${t}</div>`);
        }
        function navigate(id) {
            document.querySelectorAll('.view-sec').forEach(e=>e.classList.add('hidden'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            if(window.innerWidth < 992) document.querySelector('.sidebar').classList.remove('active');
            refreshUI();
        }

        // ================= DATA & SYS =================
        function tabData(t, btn) {
            document.getElementById('tab-stu').classList.add('hidden');
            document.getElementById('tab-tea').classList.add('hidden');
            document.getElementById('tab-sys').classList.add('hidden');
            document.getElementById('tab-'+t).classList.remove('hidden');
            if(btn) { document.querySelectorAll('.nav-pills .nav-link').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
            renderManage();
        }
        function renderManage() {
            document.getElementById('body-stu').innerHTML = Object.entries(dbData.students||{}).reverse().map(([k,s])=>`<tr><td>${s.name}</td><td>${s.class}</td><td><button class="btn btn-sm btn-danger" onclick="db.ref('students/'+k).remove()"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            document.getElementById('body-tea').innerHTML = Object.entries(dbData.teachers||{}).map(([k,t])=>`<tr><td>${t.name}</td><td><button class="btn btn-sm btn-danger" onclick="db.ref('teachers/'+k).remove()"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        }
        function addStudent() {
            const cls = document.getElementById('imp-cls').value;
            if(!cls) return Swal.fire('تنبيه','حدد الفصل أولاً','warning');
            Swal.fire({input:'text', title:'اسم الطالب'}).then(r=>{if(r.value){db.ref('students').push({name:r.value, class:cls}); let n=dbData.classes||[]; if(!n.includes(cls)){n.push(cls); db.ref('classes').set(n);}}});
        }
        function addTeacher() { Swal.fire({input:'text', title:'اسم المعلم'}).then(r=>{if(r.value)db.ref('teachers').push({name:r.value})}); }
        function delAll(p) { Swal.fire({title:'حذف الكل؟', showCancelButton:true}).then(r=>{if(r.isConfirmed)db.ref(p).remove()}); }
        function newCode() { db.ref('code').set(Math.floor(1000+Math.random()*9000)); }
        function newGuard() { Swal.fire({input:'text'}).then(r=>{if(r.value)db.ref('guard').set(r.value)}); }
        function filterTable(id,v) { document.querySelectorAll(`#${id} tbody tr`).forEach(r=>r.style.display=r.innerText.includes(v)?'':'none'); }

        // ================= REPORTS =================
        function showRep(t, btn) {
            if(btn) { document.querySelectorAll('#sec-reports button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
            const th=document.getElementById('rep-th'), tb=document.getElementById('rep-tb');
            if(t==='all') {
                th.innerHTML='<tr><th>الطالب</th><th>الوجهة</th><th>الوقت</th></tr>';
                tb.innerHTML=Object.values(dbData.permits||{}).reverse().map(p=>`<tr><td>${p.student}</td><td>${p.dest}</td><td>${new Date(p.start).toLocaleTimeString()}</td></tr>`).join('');
            } else if(t==='vis') {
                th.innerHTML='<tr><th>الزائر</th><th>السبب</th><th>الحالة</th></tr>';
                tb.innerHTML=Object.values(dbData.visitors||{}).reverse().map(v=>`<tr><td>${v.name}</td><td>${v.reason}</td><td>${v.status}</td></tr>`).join('');
            } else if(t==='dep') {
                th.innerHTML='<tr><th>الطالب</th><th>السبب</th><th>الوقت</th></tr>';
                tb.innerHTML=Object.values(dbData.departures||{}).reverse().map(d=>`<tr><td>${d.name}</td><td>${d.reason}</td><td>${d.time}</td></tr>`).join('');
            }
        }
    </script>
</body>
</html>