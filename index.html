<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إذن الرقمي - متوسطة الإمام النووي (النسخة الذهبية)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* ألوان الهوية البصرية للمدرسة */
            --primary: #145A32;       /* أخضر غامق رسمي */
            --primary-light: #1E8449; /* أخضر فاتح */
            --secondary: #D4AC0D;     /* ذهبي للتكريم */
            --accent: #2874A6;        /* أزرق للأزرار */
            --danger: #C0392B;        /* أحمر للتنبيهات */
            --success: #27AE60;       /* أخضر للنجاح */
            --bg-color: #F4F6F7;      /* خلفية عامة */
            --card-bg: #FFFFFF;       /* خلفية الكروت */
            --text-main: #2C3E50;     /* لون النص الرئيسي */
            --shadow: 0 15px 40px rgba(0,0,0,0.1); /* ظل قوي */
            --gradient: linear-gradient(135deg, #145A32 0%, #0B3B24 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        body { background: var(--bg-color); color: var(--text-main); min-height: 100vh; overflow-x: hidden; }

        /* --- شاشة التحميل والدخول --- */
        #loginOverlay {
            position: fixed; inset: 0; background: var(--gradient);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .login-card {
            background: var(--card-bg); width: 90%; max-width: 600px; padding: 4rem;
            border-radius: 50px; text-align: center; 
            box-shadow: 0 50px 100px rgba(0,0,0,0.5);
            border-top: 15px solid var(--secondary);
            animation: zoomIn 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .logo-icon { font-size: 6rem; color: var(--primary); margin-bottom: 25px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2)); }
        
        /* --- الهيدر (Header) --- */
        header { 
            background: var(--gradient); color: white; padding: 1.2rem 3rem; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 5px 25px rgba(0,0,0,0.3);
        }
        .app-title { display: flex; align-items: center; gap: 20px; }
        .app-title h1 { font-family: 'Amiri'; font-size: 2.5rem; font-weight: 700; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        
        .status-bar { display: flex; align-items: center; gap: 25px; }
        .live-badge { 
            background: var(--danger); padding: 10px 25px; border-radius: 50px; 
            font-weight: bold; display: flex; align-items: center; gap: 10px; font-size: 1.1rem;
            box-shadow: 0 0 20px rgba(192, 57, 43, 0.8); animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- القوائم والأزرار --- */
        .nav-scroll { 
            display: flex; gap: 20px; overflow-x: auto; padding: 25px; margin: 0 auto; max-width: 1300px; 
            scrollbar-width: none; justify-content: center;
        }
        .nav-btn {
            background: white; border: none; padding: 18px 35px; border-radius: 25px;
            font-size: 1.2rem; color: #555; cursor: pointer; transition: 0.3s;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06); display: flex; flex-direction: column; align-items: center; gap: 8px;
            min-width: 140px;
        }
        .nav-btn:hover { transform: translateY(-8px); color: var(--primary); }
        .nav-btn.active { background: #e8f5e9; color: var(--primary); border-bottom: 6px solid var(--primary); }
        .nav-btn i { font-size: 2rem; margin-bottom: 5px; }

        .btn {
            width: 100%; padding: 18px; border: none; border-radius: 20px;
            font-size: 1.3rem; font-weight: bold; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            margin-top: 15px;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 8px 0 #0e3e23; }
        .btn-secondary { background: var(--secondary); color: #222; box-shadow: 0 8px 0 #9a7d0a; }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 8px 0 #7b241c; }

        /* --- الحاويات والكروت --- */
        .container { max-width: 1300px; margin: 0 auto; padding: 0 20px 100px; }
        .view-section { display: none; opacity: 0; transform: translateY(30px); transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1); }
        .view-section.active { display: block; opacity: 1; transform: translateY(0); }

        .card { 
            background: white; border-radius: 35px; padding: 3rem; margin-bottom: 2.5rem;
            box-shadow: var(--shadow); position: relative; overflow: hidden; border: 1px solid #f0f0f0;
        }
        .card h2, .card h3 { color: var(--primary); margin-bottom: 25px; display: flex; align-items: center; gap: 15px; }
        
        .form-input { 
            width: 100%; padding: 20px; margin-bottom: 20px; border: 2px solid #eee; 
            border-radius: 18px; font-size: 1.2rem; transition: 0.3s; background: #fafafa;
        }
        .form-input:focus { border-color: var(--secondary); background: white; outline: none; box-shadow: 0 0 0 5px rgba(212, 172, 13, 0.1); }

        /* --- شبكة المراقبة --- */
        .monitor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; }
        .student-card {
            background: white; padding: 25px; border-radius: 30px; 
            border-right: 20px solid var(--success); box-shadow: var(--shadow);
            transition: 0.3s; position: relative;
        }
        .student-card:hover { transform: translateY(-5px); }
        .student-card.late { border-right-color: var(--danger); background: #fff8f8; animation: shake 0.5s infinite; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(5px); } 75% { transform: translateX(-5px); } }

        /* --- تبويبات الإعدادات الجديدة --- */
        .settings-tabs { display: flex; gap: 15px; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: #f0f0f0; cursor: pointer; border-radius: 15px; font-weight: bold; font-size: 1.1rem; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; transform: scale(1.05); box-shadow: 0 5px 15px rgba(20, 90, 50, 0.3); }

        /* --- الشهادة --- */
        .cert-wrapper {
            width: 1123px; height: 794px; /* A4 Landscape */
            background: white; padding: 60px; margin: 0 auto;
            border: 40px double var(--secondary);
            text-align: center; display: none;
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            position: fixed; top: 0; left: 0; z-index: 10000;
        }
        .cert-title { font-family: 'Amiri'; font-size: 5.5rem; color: var(--primary); margin-bottom: 30px; text-shadow: 2px 2px 0px #eee; }
        .cert-name { font-family: 'Amiri'; font-size: 5rem; color: #b7950b; text-decoration: underline; margin: 40px 0; font-weight: bold; }
        .cert-text { font-size: 2.8rem; line-height: 1.8; margin-bottom: 60px; color: #333; }
        .cert-sign { display: flex; justify-content: space-around; margin-top: 100px; }
        .cert-sign h3 { font-size: 2.2rem; margin-bottom: 15px; color: #555; }
        .cert-sign p { font-size: 2.5rem; font-family: 'Amiri'; font-weight: bold; color: var(--primary); }

        /* --- وضع الطباعة --- */
        @media print {
            body * { visibility: hidden; }
            .cert-wrapper, .cert-wrapper * { visibility: visible; }
            .cert-wrapper { display: block !important; position: absolute; left: 0; top: 0; transform: scale(0.9); }
        }
    </style>
</head>
<body>

    <audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="loginOverlay">
        <div class="login-card" id="roleSelector">
            <i class="fas fa-school logo-icon"></i>
            <h1 style="font-family:'Amiri'; color:var(--primary); font-size:3.5rem; margin-bottom:15px">متوسطة الإمام النووي</h1>
            <p style="color:#666; font-size:1.4rem; margin-bottom:3rem; font-weight:bold">نظام إدارة الانضباط المدرسي المتكامل</p>
            
            <button class="btn btn-primary" onclick="showPassInput('admin')">
                <i class="fas fa-user-shield"></i> لوحة الإدارة
            </button>
            <button class="btn btn-secondary" onclick="showPassInput('teacher')">
                <i class="fas fa-chalkboard-user"></i> دخول المعلم
            </button>
        </div>

        <div class="login-card" id="passInputArea" style="display:none">
            <h2 style="color:var(--primary); margin-bottom:20px; font-size:2rem">التحقق الأمني</h2>
            <p style="margin-bottom:20px; color:#777">أدخل كود الدخول للمتابعة</p>
            <input type="password" id="passField" class="form-input" placeholder="****" style="text-align:center; font-size:2.5rem; letter-spacing:15px">
            <div style="display:flex; gap:15px">
                <button class="btn btn-primary" onclick="verifyCode()" id="loginBtn">دخول</button>
                <button class="btn btn-danger" onclick="location.reload()">إلغاء</button>
            </div>
        </div>
    </div>

    <header class="no-print">
        <div class="app-title">
            <i class="fas fa-graduation-cap" style="font-size:3rem; color:var(--secondary)"></i>
            <div>
                <h1>إذن الرقمي</h1>
                <small style="opacity:0.9; font-size:1rem">نظام سحابي 2026</small>
            </div>
        </div>
        <div class="status-bar">
            <div class="live-badge">
                <i class="fas fa-circle" style="font-size:0.8rem"></i>
                <span id="headerOutCount">0</span> بالخارج
            </div>
            <div id="digitalClock" style="font-family:'Courier New'; font-weight:bold; font-size:1.8rem">00:00</div>
        </div>
    </header>

    <div id="navContainer" class="nav-scroll no-print" style="display:none">
        </div>

    <div class="container no-print" id="mainApp" style="display:none">

        <div id="viewHome" class="view-section">
            <div class="card" style="text-align:center; background: linear-gradient(to bottom, #fff, #f9f9f9)">
                <h3 style="color:#777"><i class="fas fa-key"></i> كود المعلم المتزامن</h3>
                <div id="dailyCodeDisplay" style="font-size:7rem; font-weight:900; color:var(--primary); letter-spacing:20px; margin:25px 0; font-family:monospace; text-shadow: 4px 4px 0 #eee">----</div>
                <button class="btn btn-secondary" style="width:auto; margin:0 auto; padding:15px 50px" onclick="generateNewCode()">
                    <i class="fas fa-sync"></i> تحديث الكود
                </button>
                <p style="margin-top:20px; color:#999; font-size:1rem">هذا الكود يتم مزامنته تلقائياً لجميع المعلمين</p>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px">
                <div class="card" style="text-align:center; background:#e8f8f5">
                    <i class="fas fa-users" style="font-size:4rem; color:var(--primary)"></i>
                    <h1 id="totalPermsCount" style="font-size:5rem; margin:15px 0">0</h1>
                    <p style="font-size:1.2rem; font-weight:bold">إجمالي أذونات اليوم</p>
                </div>
                <div class="card" style="text-align:center; background:#fdedec">
                    <i class="fas fa-walking" style="font-size:4rem; color:var(--danger)"></i>
                    <h1 id="activePermsCount" style="font-size:5rem; margin:15px 0">0</h1>
                    <p style="font-size:1.2rem; font-weight:bold">طلاب خارج الفصول</p>
                </div>
            </div>
        </div>

        <div id="viewTeacher" class="view-section">
            <div class="card">
                <h2><i class="fas fa-file-pen"></i> إصدار إذن خروج</h2>
                <div style="margin-bottom:25px">
                    <label style="font-size:1.2rem; font-weight:bold; margin-bottom:10px; display:block">المعلم:</label>
                    <select id="tSelect" class="form-input"><option value="">اختر اسمك...</option></select>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 2fr; gap:25px">
                    <div>
                        <label style="font-size:1.2rem; font-weight:bold; margin-bottom:10px; display:block">الشعبة:</label>
                        <select id="cSelect" class="form-input" onchange="filterStudents()"><option value="">الصف...</option></select>
                    </div>
                    <div>
                        <label style="font-size:1.2rem; font-weight:bold; margin-bottom:10px; display:block">الطالب:</label>
                        <select id="sSelect" class="form-input"><option value="">اختر الطالب...</option></select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:25px">
                    <div>
                        <label style="font-size:1.2rem; font-weight:bold; margin-bottom:10px; display:block">الوجهة:</label>
                        <select id="dSelect" class="form-input">
                            <option>دورة المياه</option>
                            <option>المقصف</option>
                            <option>الإدارة</option>
                            <option>المرشد الطلابي</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:1.2rem; font-weight:bold; margin-bottom:10px; display:block">المدة (د):</label>
                        <input type="number" id="timeInput" class="form-input" value="5" min="1" max="60">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="submitPermit()">
                    <i class="fas fa-paper-plane"></i> اعتماد وطباعة الإذن
                </button>
            </div>
        </div>

        <div id="viewMonitor" class="view-section">
            <h2 style="margin-bottom:25px; color:var(--primary); font-size:2rem"><i class="fas fa-desktop"></i> المتابعة الميدانية الحية</h2>
            <div id="monitorGrid" class="monitor-grid">
                </div>
        </div>

        <div id="viewReports" class="view-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px">
                    <h2><i class="fas fa-chart-pie"></i> تحليل البيانات الشهري</h2>
                    <input type="month" id="reportMonthSelector" class="form-input" style="width:auto; margin:0" onchange="updateReportsGraph()">
                </div>
                <div style="height:400px">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-list"></i> سجل الحركات لهذا الشهر</h3>
                <ul id="monthLogs" style="list-style:none; padding:0; margin-top:20px; font-size:1.1rem; line-height:1.8">
                    </ul>
            </div>
        </div>

        <div id="viewCert" class="view-section">
            <div class="card" style="text-align:center">
                <i class="fas fa-award" style="font-size:6rem; color:var(--secondary); margin-bottom:25px"></i>
                <h2>إصدار شهادات التقدير</h2>
                <div style="max-width:600px; margin:30px auto">
                    <select id="certNameInput" class="form-input"><option>اختر الطالب...</option></select>
                    <button class="btn btn-secondary" onclick="printCertificate()">
                        <i class="fas fa-print"></i> طباعة الشهادة
                    </button>
                </div>
            </div>
        </div>

        <div id="viewSettings" class="view-section">
            <div class="card">
                <h2><i class="fas fa-cogs"></i> إدارة النظام والبيانات</h2>
                
                <div class="settings-tabs">
                    <button class="tab-btn active" onclick="switchSettingsTab('manual')">الإدخال اليدوي</button>
                    <button class="tab-btn" onclick="switchSettingsTab('excel')">الاستيراد (Excel)</button>
                </div>

                <div id="tab-manual">
                    <div style="background:#f9f9f9; padding:25px; border-radius:20px; margin-bottom:25px">
                        <h4><i class="fas fa-user-plus"></i> إضافة معلم جديد</h4>
                        <div style="display:flex; gap:15px; margin-top:15px">
                            <input type="text" id="manualTeacherName" class="form-input" placeholder="اسم المعلم" style="margin:0">
                            <button class="btn btn-primary" style="width:150px; margin:0" onclick="addTeacherManual()">إضافة</button>
                        </div>
                    </div>

                    <div style="background:#f0f8ff; padding:25px; border-radius:20px;">
                        <h4><i class="fas fa-graduation-cap"></i> إضافة طالب جديد</h4>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 150px; gap:15px; margin-top:15px">
                            <input type="text" id="manualStudentName" class="form-input" placeholder="اسم الطالب" style="margin:0">
                            <input type="text" id="manualStudentClass" class="form-input" placeholder="الشعبة (مثال: 2/3)" style="margin:0">
                            <button class="btn btn-primary" style="width:100%; margin:0" onclick="addStudentManual()">إضافة</button>
                        </div>
                    </div>
                </div>

                <div id="tab-excel" style="display:none">
                    <div style="background:#e8f5e9; padding:30px; border-radius:20px; text-align:center">
                        <i class="fas fa-file-excel" style="font-size:3rem; color:green; margin-bottom:15px"></i>
                        <h4>استيراد البيانات من Excel</h4>
                        <p style="color:#666; font-size:1rem; margin:15px 0">يجب أن يحتوي الملف على أعمدة: (الاسم، الشعبة، المعلم)</p>
                        <input type="file" id="excelFile" class="form-input" onchange="handleExcel(this)">
                    </div>
                </div>

                <div style="margin-top:50px; border-top:3px dashed #eee; padding-top:30px">
                    <h4 style="color:red; margin-bottom:15px"><i class="fas fa-triangle-exclamation"></i> منطقة الخطر</h4>
                    <button class="btn btn-danger" onclick="resetSystem()">تصفير النظام بالكامل (حذف جميع البيانات)</button>
                </div>
            </div>
        </div>

    </div>

    <div id="certificateTemplate" class="cert-wrapper">
        <h1 class="cert-title">شهادة شكر وتقدير</h1>
        <p class="cert-text">تتقدم إدارة متوسطة الإمام النووي بخالص الشكر والتقدير للطالب:</p>
        <h2 id="certStudentName" class="cert-name">................................</h2>
        <p class="cert-text">وذلك نظير انضباطه المدرسي المتميز وحسن سلوكه.</p>
        
        <div class="cert-sign">
            <div>
                <h3>وكيل شؤون الطلاب</h3>
                <p>....................</p>
            </div>
            <div>
                <h3>مدير المدرسة</h3>
                <p>إبراهيم بن يحيى جابر اللغبي</p>
            </div>
        </div>
    </div>

    <script type="module">
        // استيراد مكتبات Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, query, orderBy, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // إعدادات الاتصال (Config)
        const firebaseConfig = { projectId: "edin-377b2", authDomain: "edin-377b2.firebaseapp.com" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // متغيرات الحالة
        let currentUserRole = null;
        let studentsList = [];
        let teachersList = [];
        let allPermsData = []; // لتخزين كل الأذونات للتقارير
        let chartInstance = null;

        // --- وظائف النظام الأساسية --- //

        // 1. التوجيه والدخول
        window.showPassInput = (role) => {
            currentUserRole = role;
            document.getElementById('roleSelector').style.display = 'none';
            document.getElementById('passInputArea').style.display = 'block';
        };

        window.verifyCode = async () => {
            const btn = document.getElementById('loginBtn');
            const input = document.getElementById('passField').value;
            btn.innerText = "جاري التحقق...";

            // تجاوز الحماية: الدخول المباشر للمدير
            if (currentUserRole === 'admin' && input === "2025") {
                launchSystem();
                return;
            }

            try {
                // محاولة الدخول العادي للمعلم
                const docSnap = await getDoc(doc(db, "settings", "dailyCode"));
                const serverCode = docSnap.exists() ? docSnap.data().value : "1234";

                if (currentUserRole === 'teacher' && input === serverCode) {
                    launchSystem();
                } else {
                    alert("الكود غير صحيح!");
                    btn.innerText = "دخول";
                }
            } catch (e) {
                // الدخول الافتراضي في حالة الخطأ
                if (currentUserRole === 'teacher' && input === "1234") {
                    launchSystem();
                } else {
                    alert("حدث خطأ في الاتصال بالسيرفر.");
                    btn.innerText = "دخول";
                }
            }
        };

        function launchSystem() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('navContainer').style.display = 'flex';
            
            // تعيين الشهر الحالي
            const now = new Date();
            const monthStr = now.toISOString().slice(0, 7); // YYYY-MM
            document.getElementById('reportMonthSelector').value = monthStr;

            setupNavigation();
            startRealtimeSync(); // بدء المزامنة
        }

        // 2. إعداد القوائم حسب الصلاحية
        function setupNavigation() {
            const nav = document.getElementById('navContainer');
            if (currentUserRole === 'admin') {
                nav.innerHTML = `
                    <button class="nav-btn active" onclick="navTo('viewHome', this)"><i class="fas fa-home"></i>الرئيسية</button>
                    <button class="nav-btn" onclick="navTo('viewMonitor', this)"><i class="fas fa-desktop"></i>المتابعة</button>
                    <button class="nav-btn" onclick="navTo('viewReports', this)"><i class="fas fa-chart-pie"></i>التقارير</button>
                    <button class="nav-btn" onclick="navTo('viewCert', this)"><i class="fas fa-award"></i>الشهادات</button>
                    <button class="nav-btn" onclick="navTo('viewSettings', this)"><i class="fas fa-cogs"></i>الإعدادات</button>
                `;
                navTo('viewHome');
            } else {
                nav.innerHTML = `
                    <button class="nav-btn active" onclick="navTo('viewTeacher', this)"><i class="fas fa-pen-nib"></i>إصدار إذن</button>
                    <button class="nav-btn" onclick="navTo('viewMonitor', this)"><i class="fas fa-list-check"></i>حالة طلابي</button>
                `;
                navTo('viewTeacher');
            }
        }

        window.navTo = (viewId, btn) => {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            if(btn) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }

            if(viewId === 'viewReports') window.updateReportsGraph();
        };

        // 3. المزامنة اللحظية (Heart of the System)
        function startRealtimeSync() {
            onSnapshot(doc(db, "settings", "dailyCode"), (d) => {
                if(d.exists()) document.getElementById('dailyCodeDisplay').innerText = d.data().value;
            });

            onSnapshot(doc(db, "data", "schoolLists"), (d) => {
                if(d.exists()) {
                    const data = d.data();
                    studentsList = data.students || [];
                    teachersList = data.teachers || [];
                    populateDropdowns();
                }
            });

            const q = query(collection(db, "perms"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snap) => {
                allPermsData = [];
                snap.forEach(d => allPermsData.push({ id: d.id, ...d.data() }));
                
                updateMonitorGrid(allPermsData);
                if(document.getElementById('viewReports').classList.contains('active')) {
                    window.updateReportsGraph();
                }
            });
        }

        // 4. تحديث الواجهة
        function updateMonitorGrid(perms) {
            const activePerms = perms.filter(p => p.status === 'out');
            const grid = document.getElementById('monitorGrid');
            
            document.getElementById('headerOutCount').innerText = activePerms.length;
            document.getElementById('activePermsCount').innerText = activePerms.length;
            document.getElementById('totalPermsCount').innerText = perms.length; // تعديل: يمكن جعلها لليوم فقط

            grid.innerHTML = activePerms.map(p => {
                const now = new Date();
                const outTime = p.timestamp ? p.timestamp.toDate() : new Date();
                const diff = Math.floor((now - outTime) / 60000);
                const isLate = diff > p.limit;
                
                return `
                    <div class="student-card ${isLate ? 'late' : ''}">
                        <h2 style="color:var(--primary)">${p.studentName}</h2>
                        <p style="color:#666; margin-bottom:10px">
                            <i class="fas fa-chalkboard"></i> ${p.className} | 
                            <i class="fas fa-user-tie"></i> ${p.teacherName}
                        </p>
                        <div style="background:#f9f9f9; padding:10px; border-radius:10px; display:flex; justify-content:space-between">
                            <span><i class="fas fa-location-dot"></i> ${p.destination}</span>
                            <span style="font-weight:bold; color:${isLate?'red':'green'}">${diff} دقيقة</span>
                        </div>
                        <button class="btn btn-primary" onclick="returnStudent('${p.id}')" style="margin-top:15px; padding:10px">
                            تأكيد العودة
                        </button>
                    </div>
                `;
            }).join('') || '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#aaa">لا يوجد طلاب خارج الفصول</div>';
        }

        // 5. العمليات والتقارير الشهرية
        window.updateReportsGraph = () => {
            const selectedMonth = document.getElementById('reportMonthSelector').value; // YYYY-MM
            if(!selectedMonth) return;

            // فلترة البيانات حسب الشهر
            const monthlyData = allPermsData.filter(p => {
                if(!p.timestamp) return false;
                const date = p.timestamp.toDate();
                const monthStr = date.toISOString().slice(0, 7);
                return monthStr === selectedMonth;
            });

            // إعداد بيانات الرسم البياني (حسب الشعبة)
            const classCounts = {};
            monthlyData.forEach(p => {
                classCounts[p.className] = (classCounts[p.className] || 0) + 1;
            });

            // رسم الجدول
            const ctx = document.getElementById('mainChart');
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(classCounts),
                    datasets: [{
                        label: 'عدد الأذونات خلال الشهر',
                        data: Object.values(classCounts),
                        backgroundColor: '#145A32',
                        borderRadius: 10
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // تعبئة سجل الحركات
            const logsList = document.getElementById('monthLogs');
            logsList.innerHTML = monthlyData.slice(0, 50).map(p => 
                `<li>- الطالب <strong>${p.studentName}</strong> (${p.className}) خرج إلى <strong>${p.destination}</strong> بتاريخ ${p.timestamp.toDate().toLocaleDateString('ar-SA')}</li>`
            ).join('');
        };

        // 6. الإعدادات والإضافة اليدوية
        window.switchSettingsTab = (tab) => {
            document.getElementById('tab-manual').style.display = tab === 'manual' ? 'block' : 'none';
            document.getElementById('tab-excel').style.display = tab === 'excel' ? 'block' : 'none';
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        };

        window.addTeacherManual = async () => {
            const name = document.getElementById('manualTeacherName').value;
            if(!name) return alert("اكتب اسم المعلم");
            
            await setDoc(doc(db, "data", "schoolLists"), { 
                teachers: arrayUnion(name) 
            }, { merge: true });
            
            alert("تم إضافة المعلم بنجاح");
            document.getElementById('manualTeacherName').value = '';
        };

        window.addStudentManual = async () => {
            const name = document.getElementById('manualStudentName').value;
            const cls = document.getElementById('manualStudentClass').value;
            if(!name || !cls) return alert("اكمل البيانات");

            await setDoc(doc(db, "data", "schoolLists"), { 
                students: arrayUnion({ name: name, class: cls }) 
            }, { merge: true });

            alert("تم إضافة الطالب بنجاح");
            document.getElementById('manualStudentName').value = '';
            document.getElementById('manualStudentClass').value = '';
        };

        // 7. الوظائف الأساسية
        window.generateNewCode = async () => {
            const code = Math.floor(1000 + Math.random() * 9000).toString();
            await setDoc(doc(db, "settings", "dailyCode"), { value: code });
        };

        window.submitPermit = async () => {
            const s = document.getElementById('sSelect').value;
            const c = document.getElementById('cSelect').value;
            const t = document.getElementById('tSelect').value;
            
            if(!s || !c || !t) return alert("الرجاء إكمال البيانات");

            await addDoc(collection(db, "perms"), {
                studentName: s,
                className: c,
                teacherName: t,
                destination: document.getElementById('dSelect').value,
                limit: parseInt(document.getElementById('timeInput').value),
                status: 'out',
                timestamp: serverTimestamp()
            });
            alert("تم إرسال الإذن بنجاح ✅");
        };

        window.returnStudent = async (id) => {
            await updateDoc(doc(db, "perms", id), { status: 'returned', returnTime: serverTimestamp() });
        };

        window.handleExcel = (input) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                const t = [...new Set(json.map(r => r['المعلم']))].filter(Boolean);
                const s = json.map(r => ({ name: r['الاسم'], class: r['الشعبة'] })).filter(x => x.name && x.class);

                await setDoc(doc(db, "data", "schoolLists"), { teachers: t, students: s });
                alert("تم تحديث قاعدة البيانات السحابية بنجاح!");
            };
            reader.readAsArrayBuffer(input.files[0]);
        };

        window.resetSystem = async () => {
            if(confirm("تحذير: سيتم حذف جميع السجلات! هل أنت متأكد؟")) {
                const q = await getDocs(collection(db, "perms"));
                q.forEach(d => deleteDoc(doc(db, "perms", d.id)));
                await setDoc(doc(db, "data", "schoolLists"), { teachers: [], students: [] }); // تصفير الأسماء أيضاً
                alert("تم تصفير النظام.");
                location.reload();
            }
        };

        function populateDropdowns() {
            const tSel = document.getElementById('tSelect');
            tSel.innerHTML = '<option value="">اختر اسمك...</option>' + teachersList.map(t => `<option>${t}</option>`).join('');
            
            const classes = [...new Set(studentsList.map(s => s.class))].sort();
            const cOps = '<option value="">اختر الصف...</option>' + classes.map(c => `<option>${c}</option>`).join('');
            document.getElementById('cSelect').innerHTML = cOps;
            
            document.getElementById('certNameInput').innerHTML = '<option>اختر الطالب...</option>' + studentsList.map(s => `<option>${s.name}</option>`).join('');
        }

        window.filterStudents = () => {
            const cls = document.getElementById('cSelect').value;
            const filtered = studentsList.filter(s => s.class === cls);
            document.getElementById('sSelect').innerHTML = filtered.map(s => `<option>${s.name}</option>`).join('');
        };

        window.printCertificate = () => {
            const name = document.getElementById('certNameInput').value;
            if(!name || name.includes("اختر")) return alert("اختر طالباً");
            document.getElementById('certStudentName').innerText = name;
            window.print();
        };

        setInterval(() => {
            document.getElementById('digitalClock').innerText = new Date().toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute:'2-digit'});
        }, 1000);

    </script>
</body>
</html>