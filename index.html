<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <title>نظام إذن (V39 Stable)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary: #0f4c3a; --gold: #d4af37; --bg: #f8f9fa; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg); margin: 0; padding-bottom: 60px; overflow-x: hidden; }

        /* --- Login --- */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 99999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .role-card { width: 90%; max-width: 350px; padding: 20px; margin: 10px; border: 2px solid #eee; border-radius: 15px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: space-between; background: #fff; }
        .role-card:active, .role-card:hover { border-color: var(--primary); background: #f0fdf4; transform: scale(1.02); }
        
        #pin-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100000; }
        .pin-input { font-size: 2.5rem; text-align: center; width: 200px; letter-spacing: 10px; border: none; border-bottom: 3px solid var(--primary); margin: 20px 0; outline: none; }

        /* --- Layout Fixes (حل مشاكل الجوال) --- */
        .sidebar {
            width: 260px; height: 100vh; background: var(--primary); color: white;
            position: fixed; right: 0; top: 0; z-index: 5000; 
            transition: transform 0.3s ease; box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .main-content { margin-right: 260px; padding: 20px; transition: 0.3s; position: relative; z-index: 1; }

        /* Mobile & Landscape Mode */
        @media (max-width: 991px) {
            .sidebar { transform: translateX(100%); } /* إخفاء كامل */
            .sidebar.active { transform: translateX(0); } /* إظهار عند التفعيل */
            .main-content { margin-right: 0; padding: 15px; width: 100%; }
            .mobile-header { display: flex !important; }
            
            /* تظليل الخلفية عند فتح القائمة */
            .sidebar-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 4000; display: none;
            }
            .sidebar-overlay.active { display: block; }
        }

        .mobile-header {
            display: none; justify-content: space-between; align-items: center;
            background: var(--primary); color: white; padding: 15px;
            margin: -20px -20px 20px -20px; position: sticky; top: 0; z-index: 3000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* --- Components --- */
        .nav-link { color: rgba(255,255,255,0.8); padding: 15px; font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .nav-link:active { background: rgba(0,0,0,0.2); }
        
        .card-custom { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; border: 1px solid #f0f0f0; }
        .card-head { padding: 15px 20px; background: #fff; border-bottom: 1px solid #eee; font-weight: bold; color: var(--primary); }
        .card-body { padding: 20px; }

        .monitor-card { background: #fff; padding: 15px; border-radius: 12px; border-right: 5px solid #ccc; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px; }
        .monitor-card.safe { border-right-color: #198754; }
        .monitor-card.danger { border-right-color: #dc3545; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <img src="https://cdn-icons-png.flaticon.com/512/3209/3209265.png" width="80" class="mb-4">
        <h2 class="mb-4 fw-bold">بوابة النظام</h2>
        
        <div class="role-card" onclick="openPin('admin')">
            <div><h4 class="m-0 fw-bold">الإدارة</h4><small class="text-muted">التحكم الكامل</small></div>
            <i class="fas fa-user-tie fa-2x text-primary"></i>
        </div>
        <div class="role-card" onclick="openPin('teacher')">
            <div><h4 class="m-0 fw-bold">المعلم</h4><small class="text-muted">إصدار الأذونات</small></div>
            <i class="fas fa-chalkboard-teacher fa-2x text-warning"></i>
        </div>
        <div class="role-card" onclick="openPin('guard')">
            <div><h4 class="m-0 fw-bold">الزوار</h4><small class="text-muted">بوابة الدخول</small></div>
            <i class="fas fa-id-card-alt fa-2x text-secondary"></i>
        </div>

        <div id="pin-screen" class="hidden">
            <h3>أدخل الرمز</h3>
            <input type="password" id="pin-input" class="pin-input" inputmode="numeric">
            <div class="d-flex gap-3">
                <button class="btn btn-success px-4" onclick="login()">دخول</button>
                <button class="btn btn-light px-4" onclick="closePin()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="app-interface" class="hidden">
        
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <div class="mobile-header">
            <h5 class="m-0 fw-bold">نظام إذن</h5>
            <button class="btn text-white" onclick="toggleSidebar()"><i class="fas fa-bars fa-lg"></i></button>
        </div>

        <aside class="sidebar" id="sidebar">
            <div class="text-center p-4 mb-2">
                <i class="fas fa-school fa-3x text-warning mb-2"></i>
                <h5 class="text-white fw-bold m-0">الإمام النووي</h5>
            </div>
            <nav id="menu-items"></nav>
            <div class="p-3 mt-auto">
                <button class="btn btn-outline-danger w-100 text-white border-white" onclick="location.reload()">خروج</button>
            </div>
        </aside>

        <main class="main-content">
            
            <section id="sec-monitor" class="view-sec">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="fw-bold m-0">المتابعة</h3>
                    <button class="btn btn-sm btn-dark" onclick="forceUpdate()">تحديث</button>
                </div>
                <div id="live-grid" class="row g-2"></div>
                <div id="no-active" class="text-center py-5 hidden">
                    <i class="fas fa-check-circle fa-3x text-success opacity-25 mb-2"></i>
                    <h5>الجميع في الفصول</h5>
                </div>
            </section>

            <section id="sec-permit" class="view-sec hidden">
                <div class="card-custom">
                    <div class="card-head">إصدار إذن جديد</div>
                    <div class="card-body">
                        <form onsubmit="issuePermit(event)">
                            <label class="fw-bold mb-1">الفصل</label>
                            <input list="dl-classes" id="p-class" class="form-control mb-3" onchange="loadStudents(this.value)" placeholder="ابحث عن الفصل" required>
                            <datalist id="dl-classes"></datalist>

                            <label class="fw-bold mb-1">الطالب</label>
                            <select id="p-student" class="form-select mb-3" required disabled>
                                <option value="">اختر الفصل أولاً</option>
                            </select>

                            <label class="fw-bold mb-1">الوجهة</label>
                            <select id="p-dest" class="form-select mb-3" required>
                                <option value="">-- اختر الوجهة --</option>
                                <option value="دورة مياه">دورة مياه</option>
                                <option value="المقصف">المقصف</option>
                                <option value="الإدارة">الإدارة</option>
                                <option value="الموجه">الموجه الطلابي</option>
                            </select>

                            <label class="fw-bold mb-1">المدة (دقائق)</label>
                            <input type="number" id="p-time" class="form-control mb-3" value="5" required min="1">

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="p-spec">
                                <label class="form-check-label text-danger fw-bold">حالة طارئة (تجاوز النظام)</label>
                            </div>

                            <button type="submit" class="btn btn-success w-100 py-3 fw-bold">تسجيل خروج</button>
                        </form>
                    </div>
                </div>
            </section>

            <section id="sec-data" class="view-sec hidden">
                <div class="card-custom">
                    <div class="card-head">
                        <ul class="nav nav-pills card-header-pills">
                            <li class="nav-item"><a class="nav-link text-dark active" onclick="tabData('stu', this)">الطلاب</a></li>
                            <li class="nav-item"><a class="nav-link text-dark" onclick="tabData('tea', this)">المعلمون</a></li>
                            <li class="nav-item"><a class="nav-link text-dark" onclick="tabData('sys', this)">النظام</a></li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div id="tab-stu">
                            <div class="row g-2 mb-3">
                                <div class="col-6"><input id="imp-cls" class="form-control" placeholder="الفصل (مهم للاستيراد)"></div>
                                <div class="col-6"><button class="btn btn-success w-100" onclick="document.getElementById('f-stu').click()">استيراد Excel</button></div>
                                <input type="file" id="f-stu" hidden onchange="importData(this, 'students')">
                            </div>
                            <div class="d-flex gap-2 mb-3">
                                <button class="btn btn-primary flex-grow-1" onclick="addStudent()">+ طالب</button>
                                <button class="btn btn-outline-danger" onclick="delAll('students')">حذف الكل</button>
                            </div>
                            <input class="form-control mb-2" placeholder="بحث..." onkeyup="filterTable('tbl-stu', this.value)">
                            <div class="table-responsive" style="max-height: 400px;">
                                <table class="table table-sm" id="tbl-stu"><tbody id="body-stu"></tbody></table>
                            </div>
                        </div>
                        
                        <div id="tab-tea" class="hidden">
                            <div class="d-flex gap-2 mb-3">
                                <button class="btn btn-success flex-grow-1" onclick="document.getElementById('f-tea').click()">استيراد Excel</button>
                                <button class="btn btn-primary flex-grow-1" onclick="addTeacher()">+ معلم</button>
                                <input type="file" id="f-tea" hidden onchange="importData(this, 'teachers')">
                            </div>
                            <button class="btn btn-outline-danger w-100 mb-2" onclick="delAll('teachers')">حذف الكل</button>
                            <table class="table table-sm"><tbody id="body-tea"></tbody></table>
                        </div>

                        <div id="tab-sys" class="hidden text-center">
                            <h6 class="text-muted">كود المعلم</h6>
                            <h2 class="text-primary fw-bold" id="code-disp">----</h2>
                            <button class="btn btn-sm btn-dark mb-4" onclick="newCode()">تحديث</button>
                            <hr>
                            <h6 class="text-muted">كلمة الحارس</h6>
                            <h2 class="text-dark fw-bold" id="guard-disp">----</h2>
                            <button class="btn btn-sm btn-outline-dark" onclick="newGuard()">تغيير</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-reports" class="view-sec hidden">
                <div class="d-flex gap-2 mb-3 overflow-auto pb-2">
                    <button class="btn btn-outline-dark btn-sm active" onclick="repView('all', this)">الأذونات</button>
                    <button class="btn btn-outline-dark btn-sm" onclick="repView('stats', this)">الإحصاء</button>
                    <button class="btn btn-outline-dark btn-sm" onclick="repView('vis', this)">الزوار</button>
                    <button class="btn btn-outline-dark btn-sm" onclick="repView('dep', this)">الانصراف</button>
                </div>
                <div class="card-custom">
                    <div class="table-responsive">
                        <table class="table table-bordered text-center mb-0 table-sm">
                            <thead class="table-light" id="rep-th"></thead>
                            <tbody id="rep-tb"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sec-guard" class="view-sec hidden">
                <div class="card-custom mb-3">
                    <div class="card-body p-3">
                        <h6 class="fw-bold">تسجيل زائر</h6>
                        <input id="g-name" class="form-control mb-2" placeholder="الاسم">
                        <input id="g-id" type="number" class="form-control mb-2" placeholder="الهوية">
                        <input id="g-reason" class="form-control mb-2" placeholder="السبب">
                        <button class="btn btn-dark w-100" onclick="sendVisitor()">إرسال</button>
                    </div>
                </div>
                <h6 class="fw-bold">الحالة:</h6>
                <div id="g-list" class="list-group"></div>
            </section>

            <section id="sec-agent" class="view-sec hidden">
                <h4 class="mb-3">الوكيل</h4>
                <div class="card-custom mb-3">
                    <div class="card-head bg-warning bg-opacity-10">طلبات الزوار</div>
                    <div id="ag-list" class="list-group list-group-flush"></div>
                </div>
                <div class="card-custom">
                    <div class="card-head bg-danger text-white">أمر انصراف</div>
                    <div class="card-body">
                        <input id="dep-n" class="form-control mb-2" placeholder="الطالب">
                        <input id="dep-r" class="form-control mb-2" placeholder="السبب">
                        <button class="btn btn-danger w-100" onclick="sendDep()">سماح</button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <audio id="snd" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // ================= FIREBASE (هام: ضع بياناتك) =================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ================= STATE =================
        let role = '', data = { code:'2026', guard:'1111', students:{}, teachers:{}, permits:{}, visitors:{}, departures:{}, classes:[] };

        // ================= INIT =================
        window.onload = () => {
            db.ref('/').on('value', snap => {
                if(snap.val()) {
                    data = snap.val();
                    if(!data.classes) data.classes = [];
                    render();
                }
            });
            setInterval(() => {
                if(!document.getElementById('sec-monitor').classList.contains('hidden')) renderMonitor();
            }, 2000);
        };

        function render() {
            // Update UI elements based on data
            const dl = document.getElementById('dl-classes'); dl.innerHTML='';
            (data.classes||[]).forEach(c=>dl.innerHTML+=`<option value="${c}">`);
            
            document.getElementById('code-disp').innerText = data.code;
            document.getElementById('guard-disp').innerText = data.guard;

            // Refresh active tab
            if(!document.getElementById('sec-data').classList.contains('hidden')) renderData();
            if(!document.getElementById('sec-agent').classList.contains('hidden')) renderAgent();
            if(!document.getElementById('sec-guard').classList.contains('hidden')) renderGuard();
        }

        // ================= AUTH =================
        function openPin(r) { role=r; document.getElementById('pin-screen').classList.remove('hidden'); }
        function closePin() { document.getElementById('pin-screen').classList.add('hidden'); }
        function login() {
            const p = document.getElementById('pin-input').value;
            let ok = (role==='admin' && p==='admin') || (role==='guard' && p==data.guard) || (role==='teacher' && p==data.code);
            if(ok) {
                document.getElementById('auth-overlay').style.display='none';
                document.getElementById('app-interface').classList.remove('hidden');
                buildMenu(); navigate(role==='guard'?'guard':(role==='admin'?'monitor':'permit'));
            } else Swal.fire('خطأ','الرمز غير صحيح','error');
        }

        // ================= NAVIGATION =================
        function buildMenu() {
            const m = document.getElementById('menu-items'); m.innerHTML='';
            const items = role==='teacher' ? [['monitor','المتابعة','desktop'],['permit','إصدار إذن','file-signature']] :
                          role==='admin' ? [['monitor','المتابعة','desktop'],['data','البيانات','database'],['agent','الوكيل','user-check'],['reports','التقارير','chart-bar']] :
                          [['guard','بوابة الزوار','id-card']];
            items.forEach(([id,t,i]) => m.innerHTML+=`<div class="nav-link" onclick="navigate('${id}')"><i class="fas fa-${i} ms-2"></i> ${t}</div>`);
        }
        function navigate(id) {
            document.querySelectorAll('.view-sec').forEach(e=>e.classList.add('hidden'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            if(window.innerWidth < 992) document.getElementById('sidebar').classList.remove('active');
            if(id==='reports') repView('all');
        }
        function toggleSidebar() { 
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        // ================= 1. TEACHER (Strict Validation) =================
        function loadStudents(cls) {
            const sel = document.getElementById('p-student'); sel.innerHTML='<option value="">-- اختر --</option>'; sel.disabled=false;
            Object.values(data.students||{}).filter(s=>s.class===cls).forEach(s=>sel.innerHTML+=`<option value="${s.name}">${s.name}</option>`);
        }
        function issuePermit(e) {
            e.preventDefault();
            const s=document.getElementById('p-student').value, c=document.getElementById('p-class').value, d=document.getElementById('p-dest').value, t=document.getElementById('p-time').value;
            
            // Validation
            if(!s || !c || !d || !t) return Swal.fire('بيانات ناقصة','يرجى تعبئة جميع الحقول','warning');
            
            // Check Active
            if(Object.values(data.permits||{}).find(p=>p.student===s && p.active)) return Swal.fire('خطأ','الطالب خارج الفصل حالياً','error');

            db.ref('permits').push({student:s, class:c, dest:d, limit:parseInt(t), start:new Date().toISOString(), active:true});
            Swal.fire({icon:'success', title:'تم الخروج', timer:1000, showConfirmButton:false});
            navigate('monitor'); e.target.reset();
        }

        // ================= 2. MONITOR =================
        function renderMonitor() {
            const g = document.getElementById('live-grid'), active=Object.entries(data.permits||{}).filter(([k,v])=>v.active);
            if(!active.length) { document.getElementById('no-active').classList.remove('hidden'); g.innerHTML=''; return; }
            document.getElementById('no-active').classList.add('hidden');
            
            let alert=false;
            g.innerHTML = active.map(([k,p]) => {
                const m = Math.floor((new Date()-new Date(p.start))/60000);
                if(m >= p.limit) alert=true;
                return `<div class="col-6 col-md-4 col-lg-3"><div class="monitor-card ${m>=p.limit?'danger':'safe'}"><strong>${p.student}</strong><br><small>${p.class}</small><h2 class="my-2">${m}</h2><small>دقيقة</small><button class="btn btn-dark btn-sm w-100 mt-2" onclick="endPermit('${k}')">عودة</button></div></div>`;
            }).join('');
            if(alert) document.getElementById('snd').play().catch(()=>{});
        }
        function endPermit(k) { db.ref('permits/'+k).update({active:false, end:new Date().toISOString()}); }
        function forceUpdate() { renderMonitor(); }

        // ================= 3. DATA =================
        function tabData(t, btn) {
            document.querySelectorAll('.data-tab').forEach(e=>e.classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            if(btn) { document.querySelectorAll('.nav-pills .nav-link').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
            renderData();
        }
        function renderData() {
            document.getElementById('body-stu').innerHTML = Object.entries(data.students||{}).reverse().map(([k,s])=>`<tr><td>${s.name}</td><td>${s.class}</td><td><button class="btn btn-sm btn-danger" onclick="del('students/${k}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            document.getElementById('body-tea').innerHTML = Object.entries(data.teachers||{}).map(([k,t])=>`<tr><td>${t.name}</td><td><button class="btn btn-sm btn-danger" onclick="del('teachers/${k}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        }
        function addStudent() {
            const cls = document.getElementById('imp-cls').value;
            if(!cls) return Swal.fire('تنبيه','اكتب الفصل بجوار زر الاستيراد','warning');
            Swal.fire({input:'text', title:'اسم الطالب'}).then(r=>{if(r.value){db.ref('students').push({name:r.value, class:cls}); checkCls(cls);}});
        }
        function addTeacher() { Swal.fire({input:'text', title:'اسم المعلم'}).then(r=>{if(r.value)db.ref('teachers').push({name:r.value})}); }
        function del(p) { Swal.fire({title:'حذف؟', showCancelButton:true}).then(r=>{if(r.isConfirmed)db.ref(p).remove()}); }
        function delAll(p) { Swal.fire({title:'حذف الكل؟', showCancelButton:true}).then(r=>{if(r.isConfirmed)db.ref(p).remove()}); }
        function checkCls(c) { if(!data.classes.includes(c)) { let n=data.classes; n.push(c); db.ref('classes').set(n); } }
        
        function importData(inp, t) {
            const f=inp.files[0], cls=document.getElementById('imp-cls').value;
            if(t==='students' && !cls) return Swal.fire('تنبيه','حدد الفصل','warning');
            const r=new FileReader();
            r.onload=e=>{
                const w=XLSX.read(e.target.result,{type:'array'});
                const j=XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]],{header:1});
                j.forEach(r=>{if(r[0]) db.ref(t).push({name:r[0], class:cls||''})});
                if(t==='students') checkCls(cls);
                Swal.fire('تم الاستيراد');
            }; r.readAsArrayBuffer(f);
        }
        function filterTable(id,v) { document.querySelectorAll(`#${id} tbody tr`).forEach(r=>r.style.display=r.innerText.includes(v)?'':'none'); }
        function newCode() { db.ref('code').set(Math.floor(1000+Math.random()*9000)); }
        function newGuard() { Swal.fire({input:'text'}).then(r=>{if(r.value)db.ref('guard').set(r.value)}); }

        // ================= 4. GUARD & AGENT =================
        function sendVisitor() {
            const v={name:document.getElementById('g-name').value, id:document.getElementById('g-id').value, reason:document.getElementById('g-reason').value, status:'wait', time:new Date().toLocaleString()};
            if(v.name) { db.ref('visitors').push(v); Swal.fire('تم الإرسال'); document.querySelectorAll('#sec-guard input').forEach(i=>i.value=''); }
        }
        function renderGuard() {
            document.getElementById('g-list').innerHTML = Object.values(data.visitors||{}).slice(-5).reverse().map(v=>`<div class="list-group-item d-flex justify-content-between"><span>${v.name}</span><span class="badge ${v.status==='ok'?'bg-success':(v.status==='no'?'bg-danger':'bg-warning')}">${v.status==='wait'?'انتظار':v.status}</span></div>`).join('');
        }
        function renderAgent() {
            const l=document.getElementById('ag-list'), p=Object.entries(data.visitors||{}).filter(([k,v])=>v.status==='wait');
            l.innerHTML = p.map(([k,v])=>`<div class="list-group-item"><div><strong>${v.name}</strong><br>${v.reason}</div><div class="mt-2"><button class="btn btn-success btn-sm" onclick="db.ref('visitors/${k}').update({status:'ok'})">موافقة</button> <button class="btn btn-danger btn-sm" onclick="db.ref('visitors/${k}').update({status:'no'})">رفض</button></div></div>`).join('');
        }
        function sendDep() {
            const n=document.getElementById('dep-n').value, r=document.getElementById('dep-r').value;
            if(n) { db.ref('departures').push({name:n, reason:r, time:new Date().toLocaleString()}); Swal.fire('تم'); document.getElementById('dep-n').value=''; }
        }

        // ================= 5. REPORTS =================
        function repView(t, btn) {
            if(btn) { document.querySelectorAll('#sec-reports button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
            const th=document.getElementById('rep-th'), tb=document.getElementById('rep-tb');
            if(t==='all') {
                th.innerHTML='<tr><th>الطالب</th><th>الوجهة</th><th>الوقت</th></tr>';
                tb.innerHTML=Object.values(data.permits||{}).map(p=>`<tr><td>${p.student}</td><td>${p.dest}</td><td>${new Date(p.start).toLocaleTimeString()}</td></tr>`).reverse().join('');
            } else if(t==='vis') {
                th.innerHTML='<tr><th>الزائر</th><th>السبب</th><th>الحالة</th></tr>';
                tb.innerHTML=Object.values(data.visitors||{}).map(v=>`<tr><td>${v.name}</td><td>${v.reason}</td><td>${v.status}</td></tr>`).reverse().join('');
            } else if(t==='dep') {
                th.innerHTML='<tr><th>الطالب</th><th>السبب</th><th>الوقت</th></tr>';
                tb.innerHTML=Object.values(data.departures||{}).map(d=>`<tr><td>${d.name}</td><td>${d.reason}</td><td>${d.time}</td></tr>`).reverse().join('');
            } else {
                th.innerHTML='<tr><th>الطالب</th><th>العدد</th></tr>';
                const c={}; Object.values(data.permits||{}).forEach(p=>{c[p.student]=(c[p.student]||0)+1});
                tb.innerHTML=Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,20).map(([n,k])=>`<tr><td>${n}</td><td>${k}</td></tr>`).join('');
            }
        }
    </script>
</body>
</html>