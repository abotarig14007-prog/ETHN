<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#006C35">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø°Ù† (V103.0 Dynamic Elite)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* =========================================
           1. Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª (Core Styles)
        ========================================== */
        :root { 
            --primary: #006C35; --gold: #C69C6D; --bg: #F8FAFC; --card: #ffffff; 
            --text: #1E293B; --border: #E2E8F0; --transition: all 0.3s ease;
        }
        [data-theme="dark"] { 
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --border: #334155; 
        }
        body { 
            font-family: 'Tajawal', sans-serif; background-color: var(--bg); 
            color: var(--text); transition: var(--transition); overflow-x: hidden; 
            visibility: hidden; padding-bottom: 80px; 
        }

        /* Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© */
        .gradient-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(-45deg, #f8fafc, #e2e8f0, #ffffff);
            background-size: 400% 400%; animation: bgAnim 20s infinite alternate; z-index: -2;
        }
        [data-theme="dark"] .gradient-bg { background: linear-gradient(-45deg, #0f172a, #1e293b, #020617); }
        @keyframes bgAnim { 0% {background-position: 0% 50%} 100% {background-position: 100% 50%} }

        /* =========================================
           2. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ± (Layout)
        ========================================== */
        .sidebar { 
            width: 280px; height: 100vh; background: var(--primary); color: white; 
            position: fixed; right: 0; top: 0; z-index: 1000; box-shadow: -5px 0 20px rgba(0,0,0,0.1); 
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .main-content { 
            margin-right: 280px; padding: 30px; padding-top: 110px; min-height: 100vh; 
            transition: var(--transition); 
        }
        @media (max-width: 991px) { 
            .sidebar { transform: translateX(100%); } 
            .sidebar.active { transform: translateX(0); } 
            .main-content { margin-right: 0; padding: 20px; padding-top: 90px; } 
        }

        .nav-link { 
            padding: 15px 25px; margin: 5px 15px; color: rgba(255,255,255,0.85); 
            cursor: pointer; border-radius: 12px; font-weight: 700; transition: 0.2s; 
            display: flex; align-items: center;
        }
        .nav-link:hover, .nav-link.active { 
            background: rgba(255,255,255,0.2); color: white; transform: translateX(-5px); 
        }
        .nav-link.active { border-right: 5px solid var(--gold); }

        .page-card { 
            background: var(--card); border-radius: 20px; border: 1px solid var(--border); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; 
            overflow: hidden; transition: var(--transition); 
        }
        .page-card:hover { transform: translateY(-3px); }

        .card-header-custom { 
            padding: 15px 25px; background: rgba(var(--primary), 0.05); 
            border-bottom: 1px solid var(--border); font-weight: 800; color: var(--primary); 
            display: flex; justify-content: space-between; align-items: center;
        }

        .stat-box { 
            background: var(--card); padding: 25px; border-radius: 20px; text-align: center; 
            border-bottom: 5px solid #ccc; box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
        }
        .stat-box h2 { font-size: 2.5rem; font-weight: 800; margin: 10px 0; }
        .stat-box.blue { border-color: #0d6efd; }
        .stat-box.green { border-color: #198754; }
        .stat-box.red { border-color: #dc3545; }

        .report-grid-item { 
            background: var(--card); border-radius: 20px; padding: 30px 20px; 
            text-align: center; cursor: pointer; border: 1px solid var(--border); transition: 0.3s; 
        }
        .report-grid-item:hover { 
            transform: translateY(-5px); border-color: var(--primary); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
        }
        .report-grid-item i { font-size: 3rem; margin-bottom: 15px; color: var(--primary); }

        /* =========================================
           3. Ø´Ø§Ø´Ø© Ø§Ù„ØªØªÙˆÙŠØ¬ (Hall of Fame) - Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        ========================================== */
        #hall-of-fame-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            /* Ø®Ù„ÙÙŠØ© Ø²Ø±Ù‚Ø§Ø¡ Ø¯Ø§ÙƒÙ†Ø© Ø¬Ø¯Ø§Ù‹ (Dark Royal Navy) */
            background: radial-gradient(circle at center, #001529 0%, #000000 100%);
            z-index: 10000; display: none; overflow: hidden;
            color: white; font-family: 'Tajawal', sans-serif;
        }
        
        .hof-container {
            height: 100%; display: flex; flex-direction: column; 
            align-items: center; padding-top: 30px;
        }

        .hof-title {
            font-size: 3rem; font-weight: 900; color: #FFD700; margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); letter-spacing: 2px;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…ØªØµØ¯Ø± (Ø§Ù„Ù…Ø±ÙƒØ²) */
        .champion-area {
            text-align: center; margin-bottom: 40px; 
            width: 100%; /* Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ØªÙˆØ³ÙŠØ· */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            animation: float 4s ease-in-out infinite;
        }
        .champion-avatar {
            width: 220px; height: 220px; background: #fff; border-radius: 50%;
            border: 8px solid #FFD700; display: flex; align-items: center; justify-content: center;
            font-size: 5rem; color: #333; margin: 0 auto 20px;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.6);
        }
        
        /* Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù„ÙˆÙ† */
        .champion-name { 
            font-size: 3.5rem; font-weight: 900; margin: 0; 
            text-align: center; /* ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Øµ */
            width: 100%;
            animation: colorCycle 5s infinite; /* ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ */
        }
        @keyframes colorCycle {
            0% { color: #ffffff; text-shadow: 0 0 20px #FFD700; }
            33% { color: #FFD700; text-shadow: 0 0 20px #ffffff; }
            66% { color: #00ffff; text-shadow: 0 0 20px #0000ff; }
            100% { color: #ffffff; text-shadow: 0 0 20px #FFD700; }
        }

        .champion-desc { font-size: 1.8rem; color: #FFD700; font-weight: bold; margin-top: 10px; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† */
        #challengers-slider {
            width: 90%; max-width: 1400px; display: flex; justify-content: center; 
            gap: 30px; perspective: 1000px; min-height: 300px;
        }
        
        .challenger-card {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 25px;
            padding: 30px; text-align: center; width: 350px;
            animation: slideUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        
        .challenger-rank {
            background: #FFD700; color: #000; width: 60px; height: 60px;
            border-radius: 50%; font-size: 1.8rem; font-weight: 900;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 15px; border: 4px solid #fff;
        }
        
        .challenger-name { font-size: 2.2rem; font-weight: 800; color: #fff; margin-bottom: 10px; line-height: 1.2; }
        .challenger-class { font-size: 1.5rem; color: #ddd; background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 15px; margin-bottom: 10px; }
        .challenger-stars { font-size: 1.8rem; color: #FFD700; font-weight: bold; }

        @keyframes float { 0%,100% {transform: translateY(0);} 50% {transform: translateY(-20px);} }
        @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           4. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
        ========================================== */
        #auth-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #003319, #006C35); 
            z-index: 9999; display: flex; align-items: center; justify-content: center; 
        }
        .login-card { background: var(--card); padding: 40px; border-radius: 30px; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.5); }

        .custom-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 11000; background: var(--primary); color: white; padding: 12px 40px; border-radius: 50px; display: none; font-weight: bold; }
        
        #top-bar { 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); 
            padding: 10px 30px; display: flex; justify-content: space-between; 
            align-items: center; position: fixed; top: 0; left:0; width: 100%; 
            z-index: 900; height: 80px; border-bottom: 1px solid var(--border); 
        }
        [data-theme="dark"] #top-bar { background: rgba(30, 41, 59, 0.9); }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.6s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        #final-print-container { display: none; }
        @media print {
            body > * { display: none !important; }
            #final-print-container { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: white; z-index: 999999; padding: 20px; }
            #final-print-container * { visibility: visible; }
            .no-print { display: none !important; }
            @page { size: A4; margin: 5mm; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        
        #cert-template { width: 800px; height: 600px; background: #fff; padding: 40px; border: 15px double var(--primary); display: none; text-align: center; position: relative; color: #000; }
        .cert-inner { border: 5px solid var(--gold); height: 100%; padding: 40px; background-image: url('https://www.transparenttextures.com/patterns/white-diamond.png'); }
    </style>
</head>
<body>
    <div class="gradient-bg"></div>
    <div class="custom-toast" id="system-toast">ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯!</div>

    <div id="hall-of-fame-overlay">
        <button class="btn btn-outline-light position-absolute top-0 end-0 m-4 rounded-pill px-4 fw-bold" style="z-index:10001;" onclick="closeHallOfFame()">
            <i class="fas fa-times me-2"></i> Ø¥ØºÙ„Ø§Ù‚
        </button>
        <div class="hof-container">
            <h1 class="hof-title">ğŸ’ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù ÙˆØ§Ù„Ù…ØªÙ…ÙŠØ²ÙŠÙ† ğŸ’</h1>
            <div id="hof-content" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
        </div>
    </div>

    <div id="top-bar" class="fixed-top bg-white border-bottom shadow-sm px-4 py-2 d-flex justify-content-between align-items-center no-print" style="height: 70px; z-index: 900;">
        <div class="d-flex align-items-center">
            <div style="width:12px; height:12px; background:red; border-radius:50%; margin-left:10px;" id="status-dot"></div>
            <h5 class="m-0 fw-bold text-dark">Ù†Ø¸Ø§Ù… Ø¥Ø°Ù† <span class="text-success">Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</span></h5>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div id="best-class-badge" class="badge bg-warning text-dark p-2 rounded-pill d-none animate__animated animate__bounceIn"><i class="fas fa-trophy me-1"></i> Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ: <span id="best-class-txt"></span></div>
            <button class="btn btn-light rounded-circle border" onclick="toggleMute()" id="mute-btn"><i class="fas fa-volume-up"></i></button>
            <button class="btn btn-outline-dark d-lg-none" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i class="fas fa-bars"></i></button>
        </div>
    </div>

    <div id="auth-overlay">
        <div class="login-card fade-in">
            <i class="fas fa-school fa-5x text-success mb-3"></i>
            <h3 class="fw-bold mb-1">Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÙŠ</h3>
            <p class="text-muted small mb-4">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¶Ø¨Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ø§Ù„Ø°ÙƒÙŠ - V103.0</p>
            
            <div id="role-selection">
                <div class="role-btn btn border w-100 p-3 mb-2 rounded-4 d-flex justify-content-between align-items-center fw-bold bg-light" onclick="selectRole('admin', 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©')"><span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span><i class="fas fa-user-tie text-primary fa-lg"></i></div>
                <div class="role-btn btn border w-100 p-3 mb-2 rounded-4 d-flex justify-content-between align-items-center fw-bold bg-light" onclick="selectRole('teacher', 'Ø§Ù„Ù…Ø¹Ù„Ù…')"><span>Ø§Ù„Ù…Ø¹Ù„Ù…</span><i class="fas fa-chalkboard-teacher text-success fa-lg"></i></div>
                <div class="role-btn btn border w-100 p-3 mb-2 rounded-4 d-flex justify-content-between align-items-center fw-bold bg-light" onclick="selectRole('guard', 'Ø§Ù„Ø­Ø§Ø±Ø³')"><span>Ø§Ù„Ø­Ø§Ø±Ø³</span><i class="fas fa-shield-alt text-dark fa-lg"></i></div>
                <div class="role-btn btn border w-100 p-3 mb-2 rounded-4 d-flex justify-content-between align-items-center fw-bold bg-light" onclick="selectRole('counselor', 'Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ')"><span>Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</span><i class="fas fa-user-md text-info fa-lg"></i></div>
            </div>

            <div id="pin-area" class="hidden">
                <h5 id="role-label" class="fw-bold text-primary mb-3"></h5>
                <div class="input-group mb-3">
                    <input type="password" id="pin-input" class="form-control form-control-lg text-center fw-bold fs-2" placeholder="****" maxlength="4" inputmode="numeric">
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePinVisibility()"><i class="fas fa-eye"></i></button>
                </div>
                <button class="btn btn-success w-100 btn-lg rounded-pill fw-bold mb-2" onclick="doLogin()">Ø¯Ø®ÙˆÙ„</button>
                <button class="btn btn-outline-secondary w-100 rounded-pill" onclick="backToRoles()">Ø±Ø¬ÙˆØ¹</button>
            </div>
        </div>
    </div>

    <div id="app-body" class="d-none">
        <aside class="sidebar no-print">
            <div class="text-center py-5 px-3">
                <div class="bg-white p-3 rounded-circle d-inline-block shadow mb-3"><i class="fas fa-mosque fa-3x text-success"></i></div>
                <h5 class="fw-bold text-white mt-2" id="disp-school">...</h5>
            </div>
            <div id="nav-items" class="flex-grow-1 px-2"></div>
            <div class="p-4"><button class="btn btn-outline-light w-100 rounded-pill fw-bold" onclick="logOut()">Ø®Ø±ÙˆØ¬ Ø¢Ù…Ù†</button></div>
        </aside>

        <main class="main-content">
            
            <section id="sec-admin" class="view-section d-none fade-in">
                <div class="page-card p-4 border-top border-warning border-5 mb-4 bg-white">
                    <h5 class="fw-bold mb-3 text-dark"><i class="fas fa-user-clock text-warning me-2"></i> Ø±ØµØ¯ Ø§Ù„ØªØ£Ø®Ø± Ø§Ù„ØµØ¨Ø§Ø­ÙŠ</h5>
                    <div class="row g-2">
                        <div class="col-md-4"><label>Ø§Ù„ÙØµÙ„ <span class="req-star">*</span></label><select id="late-class" class="form-select" onchange="loadStudentsForRole(this.value, 'late-stu')"><option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„...</option></select></div>
                        <div class="col-md-5"><label>Ø§Ù„Ø·Ø§Ù„Ø¨ <span class="req-star">*</span></label><select id="late-stu" class="form-select" disabled><option>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨...</option></select></div>
                        <div class="col-md-3 d-flex align-items-end"><button class="btn btn-warning w-100 fw-bold" onclick="registerLate()">ØªØ³Ø¬ÙŠÙ„</button></div>
                    </div>
                </div>

                <div class="row g-3 mb-4 text-center">
                    <div class="col-md-4"><div class="p-3 bg-white rounded shadow-sm border-bottom border-primary border-4"><h2 class="fw-bold" id="stat-out">0</h2><small>Ø·Ù„Ø§Ø¨ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</small></div></div>
                    <div class="col-md-4"><div class="p-3 bg-white rounded shadow-sm border-bottom border-success border-4"><h2 class="fw-bold" id="stat-vis">0</h2><small>Ø²ÙˆØ§Ø± Ø§Ù„ÙŠÙˆÙ…</small></div></div>
                    <div class="col-md-4"><div class="p-3 bg-white rounded shadow-sm border-bottom border-danger border-4"><h2 class="fw-bold" id="stat-vio">0</h2><small>Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</small></div></div>
                </div>

                <button class="btn btn-lg w-100 text-white fw-bold shadow mb-4 py-3" style="background: linear-gradient(45deg, #001f3f, #000000); border: 2px solid #FFD700; border-radius: 15px;" onclick="openHallOfFame()">
                    <i class="fas fa-crown me-2 text-warning fa-lg"></i> Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØªÙˆÙŠØ¬ (Hall of Fame)
                </button>

                <div class="row g-4">
                    <div class="col-md-4"><div class="page-card h-100"><div class="card-header-custom">Ø§Ù„Ø²ÙˆØ§Ø±</div><div id="adm-vis-list" class="list-group list-group-flush p-2"></div></div></div>
                    <div class="col-md-4"><div class="page-card h-100"><div class="card-header-custom">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</div><div id="adm-vio-list" class="p-3"></div></div></div>
                    <div class="col-md-4"><div class="page-card h-100"><div class="card-header-custom">Ø§Ù†ØµØ±Ø§Ù Ù†Ù‡Ø§Ø¦ÙŠ</div><div class="p-4"><label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ <span class="req-star">*</span></label><input id="adm-dep-name" class="form-control mb-3"><button class="btn btn-primary w-100 rounded-pill" onclick="sendDeparture()">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø­Ø§Ø±Ø³</button></div></div></div>
                </div>
            </section>

            <section id="sec-monitor" class="view-section fade-in">
                <div class="d-flex justify-content-between mb-4"><h4 class="fw-bold">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­ÙŠØ©</h4><button class="btn btn-dark rounded-pill" onclick="toggleFullScreen()">Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©</button></div>
                <div id="monitor-grid" class="row g-4"></div>
                <div id="no-students" class="text-center py-5 d-none"><i class="fas fa-check-circle fa-5x text-success opacity-25"></i><h4>Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¨Ø§Ù„ÙØµÙˆÙ„</h4></div>
            </section>

            <section id="sec-reports" class="view-section d-none fade-in">
                <div class="d-flex justify-content-between align-items-center mb-4"><h4 class="fw-bold">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h4><input type="month" id="report-month" class="form-control" style="width:200px"></div>
                <div class="row g-3">
                    <div class="col-md-4"><div class="report-grid-item" onclick="showReportModal('permits')"><i class="fas fa-file-invoice"></i><h6>Ø³Ø¬Ù„ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª</h6></div></div>
                    <div class="col-md-4"><div class="report-grid-item" onclick="showReportModal('visitors')"><i class="fas fa-user-shield"></i><h6>Ø³Ø¬Ù„ Ø§Ù„Ø²ÙˆØ§Ø±</h6></div></div>
                    <div class="col-md-4"><div class="report-grid-item" onclick="showReportModal('violations')"><i class="fas fa-exclamation-triangle"></i><h6>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h6></div></div>
                    <div class="col-md-4"><div class="report-grid-item" onclick="showReportModal('attendance')"><i class="fas fa-calendar-check"></i><h6>Ø§Ù„ØºÙŠØ§Ø¨ (ÙŠÙˆÙ…ÙŠ/Ø­ØµØµ)</h6></div></div>
                    <div class="col-md-4"><div class="report-grid-item" onclick="showReportModal('stars')"><i class="fas fa-trophy"></i><h6>Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</h6></div></div>
                    <div class="col-md-4"><div class="report-grid-item" onclick="showReportModal('late')"><i class="fas fa-user-clock"></i><h6>ØªØ£Ø®Ø± Ø§Ù„ØµØ¨Ø§Ø­</h6></div></div>
                    <div class="col-12"><div class="report-grid-item d-flex align-items-center justify-content-center gap-3" onclick="showReportModal('top_class')"><i class="fas fa-medal text-warning m-0"></i><h5 class="m-0">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ</h5></div></div>
                </div>
            </section>

            <section id="sec-teacher" class="view-section d-none fade-in">
                <div class="btn-group bg-white p-2 rounded-pill shadow-sm mb-4 w-100 justify-content-center">
                    <button class="btn btn-success rounded-pill px-4 mx-1" onclick="tabTeacher('permit')">Ø¥Ø°Ù† Ø®Ø±ÙˆØ¬</button>
                    <button class="btn btn-outline-primary rounded-pill px-4 mx-1" onclick="tabTeacher('attendance')">Ø§Ù„ØªØ­Ø¶ÙŠØ±</button>
                    <button class="btn btn-outline-warning rounded-pill px-4 mx-1" onclick="tabTeacher('behavior')">ØªÙ…ÙŠØ² â­ï¸</button>
                    <button class="btn btn-outline-danger rounded-pill px-4 mx-1" onclick="tabTeacher('violation')">Ù…Ø®Ø§Ù„ÙØ©</button>
                </div>
                
                <div id="t-permit-box" class="page-card p-4">
                    <h5 class="fw-bold mb-4 text-success border-bottom pb-3">Ø¥ØµØ¯Ø§Ø± Ø¥Ø°Ù† Ø®Ø±ÙˆØ¬</h5>
                    <div class="mb-3"><label>Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ØµØ¯Ø± <span class="req-star">*</span></label><select id="t-name-sender" class="form-select form-select-lg" onchange="rememberTeacher(this.value)"></select></div>
                    <div class="row g-3">
                        <div class="col-md-6"><label>Ø§Ù„ÙØµÙ„ <span class="req-star">*</span></label><select id="t-class" class="form-select form-select-lg" onchange="loadStudentsForRole(this.value, 't-stu')"></select></div>
                        <div class="col-md-6"><label>Ø§Ù„Ø·Ø§Ù„Ø¨ <span class="req-star">*</span></label><select id="t-stu" class="form-select form-select-lg" disabled></select></div>
                        <div class="col-md-6"><label>Ø§Ù„ÙˆØ¬Ù‡Ø© <span class="req-star">*</span></label><select id="t-dest" class="form-select form-select-lg"><option value="Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡">Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡</option><option value="Ø§Ù„ÙˆÙƒÙŠÙ„">Ø§Ù„ÙˆÙƒÙŠÙ„</option><option value="Ø§Ù„Ù…Ù‚ØµÙ">Ø§Ù„Ù…Ù‚ØµÙ</option><option value="Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ">Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</option><option value="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</option></select></div>
                        <div class="col-md-3"><label>Ø§Ù„Ù…Ø¯Ø© (Ø¯) <span class="req-star">*</span></label><input type="number" id="t-time" class="form-control form-control-lg" value="5"></div>
                        <div class="col-md-3 d-flex align-items-end"><div class="form-check border p-3 rounded w-100"><input class="form-check-input ms-2" type="checkbox" id="t-special"><label>Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©</label></div></div>
                        <div class="col-12"><button class="btn btn-success w-100 py-3 fw-bold rounded-pill" onclick="sendPermit()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button></div>
                    </div>
                </div>

                <div id="t-attendance-box" class="page-card p-4 d-none">
                    <h5 class="fw-bold mb-4 text-primary">Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h5>
                    <div class="d-flex justify-content-center mb-4 bg-light p-2 rounded-pill" style="max-width: 400px; margin: 0 auto 20px;">
                        <button class="btn btn-primary w-50 rounded-pill" id="btn-mode-period" onclick="setAttMode('period')">Ø¨Ø§Ù„Ø­ØµØ©</button>
                        <button class="btn btn-outline-primary w-50 rounded-pill" id="btn-mode-day" onclick="setAttMode('day')">ÙŠÙˆÙ… ÙƒØ§Ù…Ù„</button>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4"><label>Ø§Ù„ÙØµÙ„ <span class="req-star">*</span></label><select id="att-class" class="form-select" onchange="loadAttendanceList()"></select></div>
                        <div class="col-md-4" id="div-att-period"><label>Ø§Ù„Ø­ØµØ© <span class="req-star">*</span></label><select id="att-period" class="form-select" onchange="loadAttendanceList()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option></select></div>
                        <div class="col-md-4 d-flex align-items-end"><button class="btn btn-primary w-100" onclick="loadAttendanceList()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button></div>
                    </div>
                    <div class="table-responsive"><table class="table table-bordered text-center align-middle"><thead class="table-light"><tr><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="att-list-body"></tbody></table></div>
                </div>

                <div id="t-behavior-box" class="page-card p-4 d-none">
                    <h5 class="fw-bold mb-4 text-warning">Ù…Ù†Ø­ Ù†Ø¬ÙˆÙ… Ø§Ù„ØªÙ…ÙŠØ² â­ï¸</h5>
                    <div class="row g-3">
                        <div class="col-6"><label>Ø§Ù„ÙØµÙ„ <span class="req-star">*</span></label><select id="b-class" class="form-select" onchange="loadStudentsForRole(this.value, 'b-stu')"></select></div>
                        <div class="col-6"><label>Ø§Ù„Ø·Ø§Ù„Ø¨ <span class="req-star">*</span></label><select id="b-stu" class="form-select" disabled></select></div>
                        <div class="col-12"><label>Ø§Ù„Ø³Ø¨Ø¨ <span class="req-star">*</span></label><select id="b-reason" class="form-select"><option>Ù…Ø´Ø§Ø±ÙƒØ© Ù…ØªÙ…ÙŠØ²Ø©</option><option>ÙˆØ§Ø¬Ø¨Ø§Øª Ù…Ù†Ø²Ù„ÙŠØ©</option><option>Ø§Ù†Ø¶Ø¨Ø§Ø· ÙˆØ³Ù„ÙˆÙƒ</option><option>Ù†Ø¸Ø§ÙØ© ÙˆØªØ±ØªÙŠØ¨</option><option>Ù…Ø¨Ø§Ø¯Ø±Ø© Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©</option><option>Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù†</option></select></div>
                        <div class="col-12"><button class="btn btn-warning w-100 fw-bold rounded-pill" onclick="sendStar()">Ù…Ù†Ø­ Ù†Ø¬Ù…Ø©</button></div>
                    </div>
                </div>

                <div id="t-violation-box" class="page-card p-4 d-none">
                    <h5 class="fw-bold mb-3 text-danger">Ù…Ø®Ø§Ù„ÙØ©</h5>
                    <div class="row g-3">
                        <div class="col-6"><label>Ø§Ù„ÙØµÙ„ <span class="req-star">*</span></label><select id="v-class" class="form-select" onchange="loadStudentsForRole(this.value, 'v-stu')"></select></div>
                        <div class="col-6"><label>Ø§Ù„Ø·Ø§Ù„Ø¨ <span class="req-star">*</span></label><select id="v-stu" class="form-select" disabled></select></div>
                        <div class="col-12"><label>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© <span class="req-star">*</span></label><input id="v-type" class="form-control" placeholder="ØªØ£Ø®Ø±ØŒ Ù…Ø´Ø§ØºØ¨Ø©..."></div>
                        <div class="col-12"><label>Ø§Ù„ØªÙØ§ØµÙŠÙ„ <span class="req-star">*</span></label><textarea id="v-desc" class="form-control" rows="2"></textarea></div>
                        <div class="col-12"><button class="btn btn-danger w-100 fw-bold rounded-pill" onclick="sendViolation()">Ø±ÙØ¹ Ù„Ù„ÙˆÙƒÙŠÙ„</button></div>
                    </div>
                </div>
            </section>

            <section id="sec-guard" class="view-section d-none fade-in">
                <div class="row g-4">
                    <div class="col-md-6"><div class="page-card p-4 border-top border-dark border-5 h-100"><h5 class="fw-bold mb-4 text-center">ØªØ³Ø¬ÙŠÙ„ Ø²Ø§Ø¦Ø±</h5><input id="g-v-name" class="form-control mb-3" placeholder="Ø§Ù„Ø§Ø³Ù… *"><input id="g-v-id" class="form-control mb-3" placeholder="Ø§Ù„Ù‡ÙˆÙŠØ© *"><input id="g-v-reason" class="form-control mb-3" placeholder="Ø§Ù„Ø³Ø¨Ø¨ *"><button class="btn btn-dark w-100 py-3" onclick="sendVisitorReq()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨</button></div></div>
                    <div class="col-md-6"><div class="page-card h-100 border-danger border-top border-5"><div class="card-header-custom bg-danger text-white">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø®Ø±ÙˆØ¬</div><div id="g-dep-list" class="p-3"></div></div></div>
                </div>
            </section>

            <section id="sec-counselor" class="view-section d-none fade-in">
                <div class="row g-3">
                    <div class="col-md-8"><div class="page-card"><div class="card-header-custom bg-info text-white">Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø§Ù„Ø©</div><div class="table-responsive"><table class="table table-hover text-center align-middle mb-0"><thead class="table-light"><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th><th>Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ÙˆÙƒÙŠÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="counselor-list"></tbody></table><div id="counselor-empty" class="text-center p-5 text-muted d-none"><h5>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</h5><p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù…ÙˆØ± Ù…Ø³ØªÙ‚Ø±Ø©</p></div></div></div></div>
                    <div class="col-md-4">
                        <div class="page-card p-4 border-top border-success border-5 mb-3"><h6 class="fw-bold mb-3">Ø¨Ø­Ø« ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨</h6><input type="text" id="stu-search-name" class="form-control mb-3" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..."><button class="btn btn-success w-100 mb-3" onclick="searchStudentHistory()">Ø¨Ø­Ø«</button><div id="stu-history-res" class="d-none bg-light p-2 rounded small"></div></div>
                    </div>
                </div>
            </section>

            <section id="sec-data" class="view-section d-none fade-in">
                <div class="page-card p-4">
                    <h5 class="fw-bold mb-4 text-primary">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø£Ù…Ø§Ù†</h5>
                    <div class="row g-3 mb-4 p-3 bg-white border rounded">
                        <div class="col-md-6"><label class="fw-bold mb-2">Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ²Ø§Ø±Ø© / Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input type="file" id="logo-upload" class="form-control" accept="image/*" onchange="uploadLogo()"></div>
                        <div class="col-md-6 text-center"><img id="logo-preview" src="" style="max-height: 80px; display: none; margin: 0 auto;"></div>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4"><label>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input id="s-school" class="form-control" onchange="saveSettings()"></div>
                        <div class="col-md-4"><label>Ø§Ù„Ù…Ø¯ÙŠØ±</label><input id="s-manager" class="form-control" onchange="saveSettings()"></div>
                        <div class="col-md-4"><label>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</label><input id="s-deputy" class="form-control" onchange="saveSettings()"></div>
                        <div class="col-md-12"><label class="text-danger fw-bold">Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ (Ù…Ø®ÙÙŠ)</label><div class="input-group"><input type="password" id="s-email" class="form-control" placeholder="example@gmail.com" onchange="saveSettings()"><button class="btn btn-outline-secondary" onclick="toggleVisibility('s-email')"><i class="fas fa-eye"></i></button></div></div>
                    </div>
                    <div class="row g-3 mb-4 border p-4 rounded-4 bg-light">
                        <h6 class="fw-bold text-dark"><i class="fas fa-key me-2"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…ÙˆØ² (PIN) - Ø¢Ù…Ù†</h6>
                        <div class="col-md-3"><label class="small fw-bold">Ø§Ù„Ù…Ø¯ÙŠØ±</label><div class="input-group"><input type="password" id="pin-admin" class="form-control"><button class="btn btn-outline-secondary px-2" onclick="toggleVisibility('pin-admin')"><i class="fas fa-eye"></i></button></div></div>
                        <div class="col-md-3"><label class="small fw-bold">Ø§Ù„Ù…Ø¹Ù„Ù…</label><div class="input-group"><input type="password" id="pin-teacher" class="form-control"><button class="btn btn-outline-secondary px-2" onclick="toggleVisibility('pin-teacher')"><i class="fas fa-eye"></i></button></div></div>
                        <div class="col-md-3"><label class="small fw-bold">Ø§Ù„Ø­Ø§Ø±Ø³</label><div class="input-group"><input type="password" id="pin-guard" class="form-control"><button class="btn btn-outline-secondary px-2" onclick="toggleVisibility('pin-guard')"><i class="fas fa-eye"></i></button></div></div>
                        <div class="col-md-3"><label class="small fw-bold">Ø§Ù„Ù…ÙˆØ¬Ù‡</label><div class="input-group"><input type="password" id="pin-counselor" class="form-control"><button class="btn btn-outline-secondary px-2" onclick="toggleVisibility('pin-counselor')"><i class="fas fa-eye"></i></button></div></div>
                        <div class="col-12 text-end"><button class="btn btn-dark px-5 mt-3" onclick="savePasswords()">Ø­ÙØ¸ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</button></div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4"><button class="btn btn-outline-dark w-100" onclick="exportData()">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button></div>
                        <div class="col-md-4"><button class="btn btn-outline-warning w-100" onclick="secureReset('reports')">ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ø¢Ù…Ù†)</button></div>
                        <div class="col-md-4"><button class="btn btn-outline-danger w-100" onclick="secureReset('factory')">ØªØµÙÙŠØ± Ø§Ù„Ù…ØµÙ†Ø¹ (Ø¢Ù…Ù†)</button></div>
                    </div>
                    <hr>
                    <div class="row g-3">
                        <div class="col-md-6"><button class="btn btn-success w-100" onclick="document.getElementById('f-tea-excel').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø¹Ù„Ù…ÙŠÙ†</button><input type="file" id="f-tea-excel" hidden onchange="importTeachers(this)"></div>
                        <div class="col-md-6"><button class="btn btn-outline-primary w-100" onclick="toggleTeachers()">Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button></div>
                    </div>
                    <div id="teachers-list-container" class="d-none"><div class="table-responsive border rounded p-2" style="max-height: 300px;"><table class="table table-sm table-striped"><thead class="table-light"><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="data-tea-body"></tbody></table></div></div>
                    <hr>
                    <div class="row g-3 mt-3">
                        <div class="col-md-4"><input id="imp-cls-name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØµÙ„"></div>
                        <div class="col-md-4"><button class="btn btn-primary w-100" onclick="document.getElementById('f-excel').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø·Ù„Ø§Ø¨</button><input type="file" id="f-excel" hidden onchange="importData(this)"></div>
                        <div class="col-md-4"><button class="btn btn-outline-primary w-100" onclick="toggleStudents()">Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button></div>
                    </div>
                    <div id="students-list-container" class="d-none p-3 bg-white border rounded shadow-sm"><div class="mb-3"><label class="fw-bold text-primary">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨:</label><select id="view-class-select" class="form-select" onchange="renderStudentTable(this.value)"><option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„...</option></select></div><div class="table-responsive" style="max-height: 400px;"><table class="table table-sm table-bordered table-hover"><thead class="table-light"><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="data-stu-body"></tbody></table></div></div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal fade" id="printModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body bg-white" id="modal-print-content"></div><div class="modal-footer"><button type="button" class="btn btn-primary w-100 fw-bold" onclick="executePrint()">Ø·Ø¨Ø§Ø¹Ø©</button></div></div></div></div>
    <div id="final-print-container"></div>
    <div class="fab-theme" onclick="toggleTheme()"><i class="fas fa-moon"></i></div>

    <div id="cert-template">
        <div class="cert-inner">
            <h1 style="color:var(--primary); font-weight:800; font-size:3rem; margin-bottom:40px;">Ø´Ù‡Ø§Ø¯Ø© Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ±</h1>
            <p style="font-size:1.5rem; margin-top:20px;">ØªØªÙ‚Ø¯Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ø§Ù„Ø´ÙƒØ± Ø§Ù„Ø¬Ø²ÙŠÙ„ Ù„Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…ØªÙ…ÙŠØ²:</p>
            <h2 id="cert-student-name" style="color:var(--gold); border-bottom:2px solid; display:inline-block; padding:10px 50px; margin: 30px 0;">...</h2>
            <p style="font-size:1.3rem; margin-top:20px; line-height: 1.8;">ÙˆØ°Ù„Ùƒ Ù†Ø¸ÙŠØ± Ø§Ù†Ø¶Ø¨Ø§Ø·Ù‡ Ø§Ù„Ø³Ù„ÙˆÙƒÙŠ ÙˆØ­ØµÙˆÙ„Ù‡ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· ØªÙ…ÙŠØ² Ø¹Ø§Ù„ÙŠØ©.<br>Ù…ØªÙ…Ù†ÙŠÙ† Ù„Ù‡ Ø¯ÙˆØ§Ù… Ø§Ù„ØªÙˆÙÙŠÙ‚ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­.</p>
            <div style="margin-top:80px; display:flex; justify-content:space-around; align-items: flex-end;">
                <div style="text-align: center;"><strong>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</strong><br><span id="cert-deputy">...</span></div>
                <div style="text-align: center;"><strong>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</strong><br><span id="cert-manager">...</span></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyD0IJONOe7Ef4a0XG8L1Cgbc1qVSSck0xE", authDomain: "ethn-63848.firebaseapp.com", databaseURL: "https://ethn-63848-default-rtdb.firebaseio.com", projectId: "ethn-63848", storageBucket: "ethn-63848.appspot.com", messagingSenderId: "747489913596", appId: "1:747489913596:web:d98d88447e4a25cc808579" };
        firebase.initializeApp(firebaseConfig); const db = firebase.database();
        let userRole='', isMuted=true, attMode='period', hofInterval; 
        let data = { settings: {school:'Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÙŠ', manager:'', deputy:'', admin_pin:'2026', teacher_pin:'2026', guard_pin:'1111', counselor_pin:'2026', logo:'', admin_email:''}, classes:[], students:{}, teachers:{}, permits:{}, visitors:{}, departures:{}, violations:{}, attendance:{}, stars:{}, tardiness:{} };

        window.onload = () => {
            const savedTheme = localStorage.getItem('theme') || 'light'; document.documentElement.setAttribute('data-theme', savedTheme);
            db.ref('/').on('value', snap => {
                const val = snap.val();
                if(val) {
                    data = { ...data, ...val };
                    document.getElementById('disp-school').innerText = data.settings.school;
                    document.body.style.visibility = 'visible';
                    calculateBestClass(); refreshScreens(); updateDashboardStats(); checkSecurityAlerts();
                }
            });
            setInterval(monitorLoop, 10000);
        };

        function selectRole(r, t) { userRole=r; document.getElementById('role-selection').classList.add('hidden'); document.getElementById('pin-area').classList.remove('hidden'); document.getElementById('role-label').innerText='Ø¯Ø®ÙˆÙ„: '+t; document.getElementById('pin-input').value=''; }
        function backToRoles() { document.getElementById('pin-area').classList.add('hidden'); document.getElementById('role-selection').classList.remove('hidden'); userRole=''; }
        function togglePinVisibility() { const p=document.getElementById('pin-input'); p.type=p.type==='password'?'text':'password'; }
        function doLogin() { const p = document.getElementById('pin-input').value; if(p === String(data.settings[`${userRole}_pin`])) { document.getElementById('auth-overlay').style.display='none'; document.getElementById('app-body').classList.remove('d-none'); buildMenu(); navigate(userRole==='guard'?'guard':(userRole==='admin'?'monitor':'teacher')); } else { Swal.fire('Ø®Ø·Ø£','Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­','error'); } }
        function buildMenu() { const m = document.getElementById('nav-items'); let links = [['monitor','Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©','desktop']]; if(userRole==='teacher') links.push(['teacher','Ø§Ù„Ù…Ø¹Ù„Ù…','user-edit']); if(userRole==='admin') links.push(['admin','Ø§Ù„ØªØ­ÙƒÙ…','tasks'], ['reports','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±','file-alt'], ['data','Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª','cogs']); if(userRole==='guard') links = [['guard','Ø§Ù„Ø­Ø§Ø±Ø³','shield-alt']]; if(userRole==='counselor') links.push(['counselor','Ø§Ù„Ù…ÙˆØ¬Ù‡','user-graduate']); m.innerHTML = links.map(l => `<div class="nav-link" id="nav-${l[0]}" onclick="navigate('${l[0]}')"><i class="fas fa-${l[2]} me-2"></i> ${l[1]}</div>`).join(''); }
        function navigate(id) { document.querySelectorAll('.view-section').forEach(s => s.classList.add('d-none')); document.getElementById('sec-'+id).classList.remove('d-none'); document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active')); if(document.getElementById('nav-'+id)) document.getElementById('nav-'+id).classList.add('active'); refreshScreens(); }
        function toggleTheme() { const n = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'; document.documentElement.setAttribute('data-theme', n); localStorage.setItem('theme', n); }
        function showToast(m) { const t=document.getElementById('system-toast'); t.innerHTML=`<i class="fas fa-check-circle me-2"></i> ${m}`; t.style.display='block'; setTimeout(()=>{t.style.display='none'},3000); }
        function toggleVisibility(id) { const e=document.getElementById(id); e.type=e.type==='password'?'text':'password'; }

        // --- Core Functions ---
        function calculateBestClass() { let s = {}; (data.classes||[]).forEach(c=>s[c]=0); Object.values(data.stars||{}).forEach(st=>{ let o=Object.values(data.students).find(x=>x.name===st.student); if(o) s[o.class]++; }); Object.values(data.violations||{}).forEach(v=>{ let o=Object.values(data.students).find(x=>x.name===v.student); if(o) s[o.class]--; }); let best = Object.entries(s).sort((a,b)=>b[1]-a[1])[0]; if(best && best[1]>0) { document.getElementById('best-class-badge').classList.remove('d-none'); document.getElementById('best-class-txt').innerText=best[0]; } }
        function refreshScreens() {
            ['t-class','v-class','b-class','att-class','late-class'].forEach(id=>{ const e=document.getElementById(id); if(e && e.options.length<=1) e.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>'+(data.classes||[]).map(c=>`<option>${c}</option>`).join(''); });
            const te = document.getElementById('t-name-sender'); if(te && te.options.length<=1) te.innerHTML='<option value="">Ø§Ù„Ù…Ø¹Ù„Ù…</option>'+Object.values(data.teachers||{}).map(t=>`<option>${t.name}</option>`).join('');
            if(userRole==='admin') renderAdmin(); if(userRole==='guard') renderGuard();
            if(!document.getElementById('sec-data').classList.contains('d-none')) {
                const s = document.getElementById('view-class-select'); s.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>'+(data.classes||[]).map(c=>`<option>${c}</option>`).join('');
                document.getElementById('s-school').value=data.settings.school; document.getElementById('s-manager').value=data.settings.manager; document.getElementById('s-deputy').value=data.settings.deputy; document.getElementById('s-email').value=data.settings.admin_email;
                if(data.settings.logo) { document.getElementById('logo-preview').style.display='block'; document.getElementById('logo-preview').src=data.settings.logo; }
            }
        }
        function updateDashboardStats() { const s = document.querySelectorAll('.stat-box h2'); if(s.length && userRole==='admin') { s[0].innerText = Object.values(data.permits||{}).filter(p=>p.active).length; s[1].innerText = Object.values(data.visitors||{}).filter(v=>v.status==='pending').length; s[2].innerText = Object.values(data.violations||{}).filter(v=>v.status==='pending_admin').length; } }
        function renderMonitor() { const g = document.getElementById('monitor-grid'); const l = Object.entries(data.permits||{}).filter(x=>x[1].active); document.getElementById('no-students').classList.toggle('d-none', l.length>0); g.innerHTML = l.map(([k,p])=>{ const m = Math.floor((new Date()-new Date(p.start))/60000); return `<div class="col-md-3"><div class="monitor-card ${m>=p.limit?'danger':'safe'}"><h5>${p.student}</h5><small class="text-muted d-block">${p.class} | ${p.dest}</small><h2 class="text-center my-3">${m} Ø¯</h2><button class="btn btn-dark btn-sm w-100 rounded-pill" onclick="db.ref('permits/${k}').update({active:false})">Ø¹ÙˆØ¯Ø©</button></div></div>`; }).join(''); }
        function renderAdmin() { document.getElementById('adm-vis-list').innerHTML = Object.entries(data.visitors||{}).filter(x=>x[1].status==='pending').map(([k,v])=>`<div class="list-group-item d-flex justify-content-between align-items-center"><span>${v.name}</span><div class="btn-group"><button class="btn btn-success btn-sm" onclick="approveVisitor('${k}')">Ù…ÙˆØ§ÙÙ‚Ø©</button><button class="btn btn-danger btn-sm" onclick="db.ref('visitors/${k}').update({status:'rejected'})">Ø±ÙØ¶</button></div></div>`).join(''); document.getElementById('adm-vio-list').innerHTML = Object.entries(data.violations||{}).filter(x=>x[1].status==='pending_admin').map(([k,v])=>`<div class="alert alert-danger p-2 small mb-2"><strong>${v.student}</strong><br>${v.type}<button class="btn btn-dark btn-sm w-100 mt-2" onclick="referToCounselor('${k}')">ØªØ­ÙˆÙŠÙ„</button></div>`).join(''); }
        function approveVisitor(k) { db.ref(`visitors/${k}`).update({status:'approved'}); showToast('ØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø²Ø§Ø¦Ø± Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„'); }
        function renderGuard() { document.getElementById('g-dep-list').innerHTML = Object.entries(data.departures||{}).filter(x=>x[1].status==='pending').map(([k,d])=>`<div class="alert alert-danger d-flex justify-content-between"><strong>${d.name}</strong><button class="btn btn-success btn-sm" onclick="db.ref('departures/${k}').update({status:'exited'})">Ø®Ø±ÙˆØ¬</button></div>`).join(''); }
        function renderStudentTable(c) { const b = document.getElementById('data-stu-body'); if (!c) { b.innerHTML = ''; return; } const f = Object.entries(data.students||{}).filter(([k, s]) => s.class === c); b.innerHTML = f.map(([k, s]) => `<tr><td>${s.name}</td><td>${s.class}</td><td><button class="btn btn-sm text-danger" onclick="db.ref('students/${k}').remove()">X</button></td></tr>`).join(''); }
        
        // --- Logic ---
        function validate(ids) { for(let id of ids) { const e=document.getElementById(id); if(!e.value) { Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (*)', 'warning'); e.focus(); return false; } } return true; }
        function sendPermit() { if(!validate(['t-stu','t-name-sender','t-class','t-dest','t-time'])) return; const stu = document.getElementById('t-stu').value; db.ref('permits').push({student:stu, teacher:document.getElementById('t-name-sender').value, class:document.getElementById('t-class').value, dest:document.getElementById('t-dest').value, limit:parseInt(document.getElementById('t-time').value), start:new Date().toISOString(), active:true}); Swal.fire('ØªÙ…','Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª','success'); navigate('monitor'); }
        function sendStar() { if(validate(['b-stu','b-reason'])) { db.ref('stars').push({student:document.getElementById('b-stu').value, reason:document.getElementById('b-reason').value, teacher:document.getElementById('t-name-sender').value, date:new Date().toISOString()}); Swal.fire('ØªÙ…'); } }
        function sendViolation() { if(validate(['v-stu','v-type','v-desc'])) { db.ref('violations').push({student:document.getElementById('v-stu').value, type:document.getElementById('v-type').value, desc:document.getElementById('v-desc').value, status:'pending_admin', date:new Date().toLocaleDateString('ar-SA')}); Swal.fire('ØªÙ…'); } }
        function sendVisitorReq() { if(validate(['g-v-name','g-v-id','g-v-reason'])) { db.ref('visitors').push({name:document.getElementById('g-v-name').value, id:document.getElementById('g-v-id').value, reason:document.getElementById('g-v-reason').value, status:'pending', time:new Date().toISOString()}); document.getElementById('g-v-name').value=''; showToast('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); } }
        function sendDeparture() { if(validate(['adm-dep-name'])) { db.ref('departures').push({name:document.getElementById('adm-dep-name').value, status:'pending'}); document.getElementById('adm-dep-name').value=''; showToast('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); } }
        function registerLate() { if(validate(['late-stu'])) { db.ref('tardiness').push({student:document.getElementById('late-stu').value, date:new Date().toISOString()}); showToast('ØªÙ… Ø§Ù„Ø±ØµØ¯'); } }
        function loadStudentsForRole(c, id) { const l=Object.values(data.students||{}).filter(s=>s.class===c); const e=document.getElementById(id); e.innerHTML='<option value="">Ø§Ù„Ø·Ø§Ù„Ø¨</option>'; e.disabled=false; l.forEach(s=>e.innerHTML+=`<option value="${s.name}">${s.name}</option>`); }
        function setAttMode(mode) { attMode = mode; document.getElementById('btn-mode-period').className = mode === 'period' ? 'btn btn-primary w-50 rounded-pill' : 'btn btn-outline-primary w-50 rounded-pill'; document.getElementById('btn-mode-day').className = mode === 'day' ? 'btn btn-primary w-50 rounded-pill' : 'btn btn-outline-primary w-50 rounded-pill'; document.getElementById('div-att-period').style.visibility = mode === 'period' ? 'visible' : 'hidden'; loadAttendanceList(); }
        function loadAttendanceList() { const cls = document.getElementById('att-class').value; const period = document.getElementById('att-period').value; const body = document.getElementById('att-list-body'); if(!cls) { body.innerHTML = '<tr><td colspan="2">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ Ø£ÙˆÙ„Ø§Ù‹</td></tr>'; return; } const today = new Date().toLocaleDateString('en-CA'); const students = Object.values(data.students || {}).filter(s => s.class === cls); body.innerHTML = students.map(s => { let isAbsent = false; if (attMode === 'day') { isAbsent = data.attendance && data.attendance[today] && data.attendance[today]['full_day'] && data.attendance[today]['full_day'][s.name] === true; } else { isAbsent = data.attendance && data.attendance[today] && data.attendance[today]['periods'] && data.attendance[today]['periods'][period] && data.attendance[today]['periods'][period][s.name] === 'absent'; } return `<tr><td>${s.name}</td><td><button class="btn btn-sm ${isAbsent ? 'btn-danger' : 'btn-success'} w-50 rounded-pill" onclick="toggleAtt('${today}', '${s.name}', ${isAbsent})">${isAbsent ? 'ØºØ§Ø¦Ø¨' : 'Ø­Ø§Ø¶Ø±'}</button></td></tr>`; }).join(''); }
        function toggleAtt(date, name, currentlyAbsent) { const period = document.getElementById('att-period').value; const newState = !currentlyAbsent; if (attMode === 'day') { if (newState) { db.ref(`attendance/${date}/full_day/${name}`).set(true); } else { db.ref(`attendance/${date}/full_day/${name}`).remove(); } } else { if (newState) { db.ref(`attendance/${date}/periods/${period}/${name}`).set('absent'); } else { db.ref(`attendance/${date}/periods/${period}/${name}`).remove(); } } setTimeout(() => loadAttendanceList(), 100); }
        function saveSettings() { db.ref('settings').update({school:document.getElementById('s-school').value, manager:document.getElementById('s-manager').value, deputy:document.getElementById('s-deputy').value, admin_email:document.getElementById('s-email').value}); }
        function savePasswords() { db.ref('settings').update({admin_pin:document.getElementById('pin-admin').value, teacher_pin:document.getElementById('pin-teacher').value, guard_pin:document.getElementById('pin-guard').value, counselor_pin:document.getElementById('pin-counselor').value}); Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸'); }
        function uploadLogo() { const f=document.getElementById('logo-upload').files[0]; if(f){const r=new FileReader(); r.onload=e=>{db.ref('settings/logo').set(e.target.result); location.reload();}; r.readAsDataURL(f);} }
        function importData(inp) { const c=document.getElementById('imp-cls-name').value; if(!c) return alert('Ø§Ù„ÙØµÙ„ØŸ'); const r=new FileReader(); r.onload=e=>{ const j=XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:'array'}).Sheets[XLSX.read(e.target.result,{type:'array'}).SheetNames[0]],{header:1}); j.forEach(r=>{if(r[0]) db.ref('students').push({name:r[0],class:c})}); let cl=data.classes||[]; if(!cl.includes(c)) {cl.push(c); db.ref('classes').set(cl);} Swal.fire('ØªÙ…'); }; r.readAsArrayBuffer(inp.files[0]); }
        function importTeachers(inp) { const r=new FileReader(); r.onload=e=>{ const j=XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:'array'}).Sheets[XLSX.read(e.target.result,{type:'array'}).SheetNames[0]],{header:1}); j.forEach(r=>{if(r[0]) db.ref('teachers').push({name:r[0]})}); Swal.fire('ØªÙ…'); }; r.readAsArrayBuffer(inp.files[0]); }
        function exportData() { const blob = new Blob([JSON.stringify(data)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "backup.json"; a.click(); }
        function secureReset(type) { const email = data.settings.admin_email || 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³Ø¬Ù„'; const pin = data.settings.admin_pin; Swal.fire({ title: 'ğŸ”’ ØªØ­Ù‚Ù‚ Ø£Ù…Ù†ÙŠ', text: `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ ${email}. (Ù„Ù„ØªØ¬Ø±Ø¨Ø©: ${pin})`, input: 'password', showCancelButton: true, confirmButtonText: 'ØªØ£ÙƒÙŠØ¯' }).then((r) => { if (r.value == pin) { if (type === 'reports') { ['permits','visitors','violations','departures','attendance','stars','tardiness'].forEach(p=>db.ref(p).remove()); Swal.fire('ØªÙ… Ø§Ù„ØªØµÙÙŠØ±'); } else if (type === 'factory') { db.ref('/').remove(); location.reload(); } } else if (r.isConfirmed) Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­', 'error'); }); }
        function checkSecurityAlerts() { if((userRole==='guard' && Object.values(data.departures||{}).some(d=>d.status==='pending')) || (userRole==='admin' && Object.values(data.visitors||{}).some(v=>v.status==='pending'))) { if(!isMuted) document.getElementById('bell').play().catch(()=>{}); } }
        function monitorLoop() { if(!document.getElementById('sec-monitor').classList.contains('d-none')) renderMonitor(); }
        function logOut() { sessionStorage.clear(); location.reload(); }
        function toggleMute() { isMuted=!isMuted; document.getElementById('mute-btn').innerHTML=isMuted?'<i class="fas fa-volume-mute"></i>':'<i class="fas fa-volume-up"></i>'; }
        function toggleFullScreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
        function tabTeacher(t) { document.querySelectorAll('#sec-teacher > .page-card').forEach(c=>c.classList.add('d-none')); document.getElementById(`t-${t}-box`).classList.remove('d-none'); }
        function rememberTeacher(v) { localStorage.setItem('teacher', v); }
        function referToCounselor(k) { Swal.fire({title:'Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ÙˆÙƒÙŠÙ„', input:'text', showCancelButton:true}).then(r=>{if(r.value) db.ref('violations/'+k).update({status:'pending_counselor', admin_action:r.value})}); }
        function closeCase(k) { Swal.fire({title:'Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¬Ù‡', input:'text', showCancelButton:true}).then(r=>{if(r.value) db.ref('violations/'+k).update({status:'closed', counselor_action:r.value})}); }
        function renderCounselor() { document.getElementById('counselor-list').innerHTML = Object.entries(data.violations||{}).filter(x=>x[1].status==='pending_counselor').map(([k,v])=>`<tr><td>${v.student}</td><td>${v.type}</td><td>${v.admin_action}</td><td>${v.date}</td><td><button class="btn btn-success btn-sm" onclick="closeCase('${k}')">Ø¥ØºÙ„Ø§Ù‚</button></td></tr>`).join(''); }
        function searchStudentHistory() { const n = document.getElementById('stu-search-name').value; const r = Object.values(data.violations||{}).filter(v=>v.student.includes(n)); document.getElementById('stu-history-res').innerHTML = r.length ? `<ul>${r.map(v=>`<li>${v.date}: ${v.type}</li>`).join('')}</ul>` : 'Ø³Ø¬Ù„ Ù†Ø¸ÙŠÙ'; document.getElementById('stu-history-res').classList.remove('d-none'); }
        function toggleTeachers() { const c = document.getElementById('teachers-list-container'); c.classList.toggle('d-none'); if(!c.classList.contains('d-none')) { let h=''; Object.entries(data.teachers||{}).forEach(([k,t])=>h+=`<tr><td>${t.name}</td><td><button class="btn btn-sm text-danger" onclick="db.ref('teachers/${k}').remove()">X</button></td></tr>`); document.getElementById('data-tea-body').innerHTML=h||'<tr><td colspan="2" class="text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'; } }
        function toggleStudents() { document.getElementById('students-list-container').classList.toggle('d-none'); }

        /* Hall of Fame (Cinema Mode - Centered) */
        function openHallOfFame() {
            const scores = {}; Object.values(data.stars||{}).forEach(s => scores[s.student] = (scores[s.student]||0)+1);
            const sorted = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
            if(sorted.length===0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©', 'info');
            
            const champ = sorted[0];
            const champObj = Object.values(data.students||{}).find(s=>s.name===champ[0]);
            
            // Ø§Ù„Ù…ØªØµØ¯Ø± ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ ØªÙ…Ø§Ù…Ø§Ù‹
            let html = `<div class="champion-area">
                            <div class="champion-avatar"><i class="fas fa-user-graduate"></i></div>
                            <h2 class="champion-name">${champ[0]}</h2>
                            <h3 class="champion-desc">${champ[1]} Ù†Ø¬Ù…Ø© ğŸŒŸ</h3>
                            <h4 class="text-white-50">${champObj?champObj.class:''}</h4>
                        </div>
                        <div id="challengers-slider"></div>`;
            document.getElementById('hof-content').innerHTML = html;
            
            const others = sorted.slice(1);
            let currentIndex = 0;
            
            if(others.length > 0) {
                const slider = document.getElementById('challengers-slider');
                const showBatch = () => {
                    slider.innerHTML = '';
                    for(let i=0; i<3; i++) {
                        const idx = (currentIndex + i) % others.length;
                        const s = others[idx];
                        const sObj = Object.values(data.students||{}).find(x=>x.name===s[0]);
                        slider.innerHTML += `<div class="challenger-card"><div class="challenger-rank">${idx+2}</div><h2 class="challenger-name">${s[0]}</h2><h3 class="challenger-class">${sObj?sObj.class:''}</h3><div class="challenger-stars">${s[1]} Ù†Ø¬Ù…Ø©</div></div>`;
                    }
                    currentIndex = (currentIndex + 3) % others.length;
                };
                showBatch();
                if(others.length > 3) hofInterval = setInterval(showBatch, 5000);
            }
            
            document.getElementById('hall-of-fame-overlay').style.display='block';
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
        }
        function closeHallOfFame() { document.getElementById('hall-of-fame-overlay').style.display='none'; clearInterval(hofInterval); if(document.exitFullscreen) document.exitFullscreen(); }

        function generateCert(name) {
            document.getElementById('cert-student-name').innerText = name;
            document.getElementById('cert-manager').innerText = data.settings.manager;
            document.getElementById('cert-deputy').innerText = data.settings.deputy;
            const content = document.getElementById('cert-template').innerHTML;
            const win = window.open('', '', 'width=900,height=700');
            win.document.write(`<html dir="rtl"><head><title>Ø´Ù‡Ø§Ø¯Ø©</title></head><body style="text-align:center; padding:20px; font-family:sans-serif;">${content}</body></html>`);
            win.document.close(); setTimeout(() => { win.print(); }, 500);
        }

        function showReportModal(type) {
            const modal = new bootstrap.Modal(document.getElementById('printModal')); const logo = data.settings.logo || ""; const titles = {'permits':'Ø³Ø¬Ù„ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª','visitors':'Ø³Ø¬Ù„ Ø§Ù„Ø²ÙˆØ§Ø±','violations':'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª','attendance':'Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ','stars':'Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù','late':'ØªØ£Ø®Ø± Ø§Ù„ØµØ¨Ø§Ø­','top_class':'Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ'};
            let h = `<div style="display:flex; justify-content:space-between; border-bottom:3px double #000; padding-bottom:10px; margin-bottom:20px;"><div style="text-align:center; width:30%; line-height:1.6"><strong>Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</strong><br>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…<br>Ø¥Ø¯Ø§Ø±Ø© Ø¬Ø§Ø²Ø§Ù†<br>${data.settings.school}</div><div style="text-align:center; width:30%"><img src="${logo}" style="max-height:100px; max-width:100%"></div><div style="text-align:center; width:30%; line-height:1.6"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}</strong><br><h4 style="margin-top:10px; text-decoration:underline">${titles[type]}</h4></div></div>`;
            
            if(type==='attendance') {
                const t = new Date().toLocaleDateString('en-CA');
                h += `<table class="table table-bordered text-center table-striped"><thead><tr class="table-dark"><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ÙØµÙ„</th><th>Ù†ÙˆØ¹ Ø§Ù„ØºÙŠØ§Ø¨</th></tr></thead><tbody>`;
                Object.values(data.students||{}).forEach(s => {
                    if (data.attendance?.[t]?.['full_day']?.[s.name]) { h += `<tr><td>${s.name}</td><td>${s.class}</td><td class="bg-danger text-white">ØºØ§Ø¦Ø¨ ÙŠÙˆÙ… ÙƒØ§Ù…Ù„</td></tr>`; } 
                    else {
                        let absentPeriods = []; for(let p=1; p<=7; p++) { if (data.attendance?.[t]?.['periods']?.[p]?.[s.name] === 'absent') absentPeriods.push(p); }
                        if(absentPeriods.length > 0) { h += `<tr><td>${s.name}</td><td>${s.class}</td><td>Ø­ØµØµ: ${absentPeriods.join(', ')}</td></tr>`; }
                    }
                });
                h += `</tbody></table>`;
            } else if(type==='permits') {
                h += `<table class="table table-bordered text-center"><thead><tr class="table-dark"><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ÙˆØ¬Ù‡Ø©</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead><tbody>${Object.values(data.permits||{}).reverse().map(p=>{ const sObj=Object.values(data.students).find(s=>s.name===p.student); return `<tr><td>${p.student}</td><td>${sObj?sObj.class:'-'}</td><td>${p.teacher}</td><td>${p.dest}</td><td>${new Date(p.start).toLocaleTimeString('ar-SA')}</td></tr>`; }).join('')}</tbody></table>`;
            } else if(type==='visitors') {
                h += `<table class="table table-bordered text-center"><thead><tr class="table-dark"><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead><tbody>${Object.values(data.visitors||{}).reverse().map(v=>`<tr><td>${v.name}</td><td>${v.reason}</td><td>${v.status}</td><td>${new Date(v.time).toLocaleString('ar-SA')}</td></tr>`).join('')}</tbody></table>`;
            } else if(type==='violations') {
                h += `<table class="table table-bordered text-center"><thead><tr class="table-dark"><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>${Object.values(data.violations||{}).reverse().map(v=>{ const sObj=Object.values(data.students).find(s=>s.name===v.student); return `<tr><td>${v.student}</td><td>${sObj?sObj.class:'-'}</td><td>${v.type}</td><td>${v.status}</td></tr>`; }).join('')}</tbody></table>`;
            } else if(type==='stars') { 
                let s = {}; Object.values(data.stars||{}).forEach(st=>{ s[st.student] = (s[st.student]||0)+1; });
                h+=`<table class="table table-bordered text-center"><thead><tr class="table-dark"><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„Ù†Ø¬ÙˆÙ…</th><th>Ø´Ù‡Ø§Ø¯Ø©</th></tr></thead><tbody>`;
                Object.entries(s).sort((a,b)=>b[1]-a[1]).forEach(x=> { const sObj=Object.values(data.students).find(s=>s.name===x[0]); h+=`<tr><td>${x[0]}</td><td>${sObj?sObj.class:'-'}</td><td>${x[1]}</td><td><button class="btn btn-sm btn-warning" onclick="generateCert('${x[0]}')">Ø·Ø¨Ø§Ø¹Ø©</button></td></tr>`; });
                h+=`</tbody></table>`;
            } else if(type==='late') {
                h += `<table class="table table-bordered text-center"><thead><tr class="table-dark"><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody>${Object.values(data.tardiness||{}).reverse().map(t=>{ const sObj=Object.values(data.students).find(s=>s.name===t.student); return `<tr><td>${t.student}</td><td>${sObj?sObj.class:'-'}</td><td>${new Date(t.date).toLocaleDateString('ar-SA')}</td></tr>`; }).join('')}</tbody></table>`;
            } else if(type==='top_class') {
                let sc={}; (data.classes||[]).forEach(c=>sc[c]=0); Object.values(data.stars||{}).forEach(s=>{ let st=Object.values(data.students).find(x=>x.name===s.student); if(st) sc[st.class]++;}); 
                h+=`<table class="table table-bordered text-center"><thead><tr class="table-dark"><th>Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead><tbody>${Object.entries(sc).sort((a,b)=>b[1]-a[1]).map(x=>`<tr><td>${x[0]}</td><td>${x[1]}</td></tr>`).join('')}</tbody></table>`;
            }
            h+=`<div style="display:flex; justify-content:space-between; margin-top:50px; padding:0 40px;"><div style="text-align:center"><strong>ÙˆÙƒÙŠÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</strong><br><br>${data.settings.deputy}</div><div style="text-align:center"><strong>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</strong><br><br>${data.settings.manager}</div></div>`;
            document.getElementById('modal-print-content').innerHTML = h; modal.show();
        }
        function executePrint() { document.getElementById('final-print-container').innerHTML = document.getElementById('modal-print-content').innerHTML; setTimeout(()=>window.print(), 500); }
    </script>
</body>
</html>
