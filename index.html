<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#006C35">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø°Ù† (V88.0 Pro Elite Edition)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root { 
            --primary: #006C35; --gold: #C69C6D; --bg: #F8FAFC; --card: #ffffff;
            --text: #1E293B; --border: #E2E8F0; --shadow: rgba(0,0,0,0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --border: #334155; --shadow: rgba(0,0,0,0.3);
        }

        body { 
            font-family: 'Tajawal', sans-serif; background-color: var(--bg); 
            color: var(--text); transition: var(--transition); overflow-x: hidden;
            visibility: hidden; /* ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
        }

        /* Animated Background */
        .gradient-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(-45deg, #f8fafc, #e2e8f0, #f1f5f9, #ffffff);
            background-size: 400% 400%; animation: moveGradient 15s ease infinite; z-index: -1;
        }
        [data-theme="dark"] .gradient-bg {
            background: linear-gradient(-45deg, #0f172a, #1e293b, #020617, #1e293b);
        }
        @keyframes moveGradient { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }

        /* Sidebar & Navigation */
        .sidebar { width: 280px; height: 100vh; background: var(--primary); color: white; position: fixed; right: 0; top: 0; z-index: 1000; transition: var(--transition); box-shadow: -5px 0 20px rgba(0,0,0,0.1); }
        .main-content { margin-right: 280px; padding: 40px; transition: var(--transition); padding-top: 100px; min-height: 100vh; }
        @media (max-width: 991px) { .sidebar { transform: translateX(100%); } .sidebar.active { transform: translateX(0); } .main-content { margin-right: 0; padding: 20px; padding-top: 90px; } }

        .nav-link { padding: 14px 25px; margin: 5px 15px; color: rgba(255,255,255,0.7); cursor: pointer; border-radius: 12px; display: flex; align-items: center; font-weight: 600; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.15); color: white; }
        .nav-link.active { border-right: 4px solid var(--gold); }

        /* Professional Cards & Glassmorphism */
        .page-card { background: var(--card); border-radius: 24px; border: 1px solid var(--border); box-shadow: 0 10px 15px -3px var(--shadow); margin-bottom: 30px; overflow: hidden; transition: var(--transition); }
        .card-header-custom { padding: 20px 25px; background: rgba(0,0,0,0.02); border-bottom: 1px solid var(--border); font-weight: 800; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }

        /* Monitoring Cards */
        .monitor-card { background: var(--card); padding: 20px; border-radius: 20px; border-right: 6px solid #CBD5E1; box-shadow: 0 4px 6px var(--shadow); position: relative; transition: var(--transition); }
        .monitor-card.safe { border-right-color: #22C55E; }
        .monitor-card.danger { border-right-color: #EF4444; animation: pulseRed 1.5s infinite; background: rgba(239, 68, 68, 0.05); }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* Stats */
        .stat-box { background: var(--card); padding: 25px; border-radius: 20px; text-align: center; border-bottom: 5px solid #CBD5E1; transition: var(--transition); }
        .stat-box h2 { font-size: 2.8rem; font-weight: 800; margin: 0; }
        .stat-box.blue { border-color: #3B82F6; color: #3B82F6; }
        .stat-box.green { border-color: #10B981; color: #10B981; }
        .stat-box.red { border-color: #EF4444; color: #EF4444; }

        /* Report Buttons */
        .report-grid-item { background: var(--card); border-radius: 24px; padding: 30px; text-align: center; cursor: pointer; transition: var(--transition); border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .report-grid-item:hover { transform: translateY(-10px); box-shadow: 0 20px 25px -5px var(--shadow); border-color: var(--primary); }
        .report-grid-item i { font-size: 3rem; margin-bottom: 15px; }

        /* UI Elements */
        #top-bar { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left:0; width: 100%; z-index: 900; height: 80px; border-bottom: 1px solid var(--border); }
        [data-theme="dark"] #top-bar { background: rgba(15, 23, 42, 0.8); }
        #status-dot { width: 12px; height: 12px; border-radius: 50%; margin-left: 10px; background: #EF4444; box-shadow: 0 0 10px #EF4444; }

        /* Auth Screen */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #064E3B, #006C35); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: var(--card); padding: 40px; border-radius: 30px; width: 95%; max-width: 420px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }

        /* Floating Actions */
        .fab-theme { position: fixed; bottom: 30px; left: 30px; z-index: 1001; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.2); font-size: 1.5rem; transition: 0.3s; }
        .fab-theme:hover { transform: rotate(30deg) scale(1.1); }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Certificate Print */
        @media print {
            .no-print { display: none !important; }
            #final-print-container { display: block !important; }
        }
    </style>
</head>
<body>
    <div class="gradient-bg"></div>

    <div id="top-bar" class="no-print">
        <div class="d-flex align-items-center">
            <div id="status-dot"></div>
            <h5 class="m-0 fw-bold"><i class="fas fa-fingerprint text-success me-2"></i> Ù†Ø¸Ø§Ù… <span class="text-success">Ø¥Ø°Ù†</span> Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</h5>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div id="best-class-badge" class="badge bg-warning text-dark p-2 rounded-pill d-none animate__animated animate__bounceIn">ğŸ† Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ: <span id="best-class-txt"></span></div>
            <button class="btn btn-light rounded-circle shadow-sm" onclick="toggleMute()" id="mute-btn"><i class="fas fa-volume-up text-primary"></i></button>
            <button class="btn btn-outline-dark d-lg-none" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i class="fas fa-bars"></i></button>
        </div>
    </div>

    <div id="auth-overlay">
        <div class="login-card fade-in">
            <i class="fas fa-school fa-4x text-success mb-3"></i>
            <h3 class="fw-bold mb-1">Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ù†ÙˆÙˆÙŠ</h3>
            <p class="text-muted small mb-4">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¶Ø¨Ø· Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ø§Ù„Ø°ÙƒÙŠ - V88.0</p>
            <div id="role-selection">
                <div class="role-btn btn border w-100 p-3 mb-2 rounded-4 d-flex justify-content-between align-items-center fw-bold" onclick="selectRole('admin', 'Ø§Ù„ÙˆÙƒÙŠÙ„ / Ø§Ù„Ù…Ø¯ÙŠØ±')"><span>Ø§Ù„ÙˆÙƒÙŠÙ„ / Ø§Ù„Ù…Ø¯ÙŠØ±</span><i class="fas fa-user-tie text-primary"></i></div>
                <div class="role-btn btn border w-100 p-3 mb-2 rounded-4 d-flex justify-content-between align-items-center fw-bold" onclick="selectRole('teacher', 'Ø§Ù„Ù…Ø¹Ù„Ù…')"><span>Ø§Ù„Ù…Ø¹Ù„Ù…</span><i class="fas fa-chalkboard-teacher text-success"></i></div>
                <div class="role-btn btn border w-100 p-3 mb-2 rounded-4 d-flex justify-content-between align-items-center fw-bold" onclick="selectRole('guard', 'Ø§Ù„Ø­Ø§Ø±Ø³')"><span>Ø§Ù„Ø­Ø§Ø±Ø³</span><i class="fas fa-shield-alt text-dark"></i></div>
                <div class="role-btn btn border w-100 p-3 mb-2 rounded-4 d-flex justify-content-between align-items-center fw-bold" onclick="selectRole('counselor', 'Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ')"><span>Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</span><i class="fas fa-user-md text-info"></i></div>
            </div>
            <div id="pin-area" class="hidden">
                <h6 id="role-label" class="fw-bold text-primary mb-3"></h6>
                <input type="password" id="pin-input" class="form-control form-control-lg text-center fw-bold mb-4 fs-1" placeholder="****" maxlength="4" inputmode="numeric">
                <div class="d-grid gap-2">
                    <button class="btn btn-success btn-lg rounded-pill fw-bold" onclick="doLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
                    <button class="btn btn-outline-secondary rounded-pill" onclick="backToRoles()">Ø±Ø¬ÙˆØ¹</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-body" class="d-none">
        <aside class="sidebar no-print">
            <div class="text-center py-5">
                <div class="bg-white p-3 rounded-circle d-inline-block shadow-sm mb-3"><i class="fas fa-mosque fa-3x text-success"></i></div>
                <h6 class="fw-bold text-white px-2" id="disp-school">...</h6>
            </div>
            <div id="nav-items" class="flex-grow-1"></div>
            <div class="p-4"><button class="btn btn-outline-light w-100 rounded-pill" onclick="logOut()">Ø®Ø±ÙˆØ¬ Ø¢Ù…Ù†</button></div>
        </aside>

        <main class="main-content">
            <section id="sec-admin" class="view-section d-none fade-in">
                <div class="page-card p-4 border-top border-warning border-5 mb-4">
                    <h5 class="fw-bold mb-3"><i class="fas fa-user-clock text-warning me-2"></i> Ø±ØµØ¯ Ø§Ù„ØªØ£Ø®Ø± Ø§Ù„ØµØ¨Ø§Ø­ÙŠ</h5>
                    <div class="row g-3">
                        <div class="col-md-4"><select id="late-class" class="form-select form-select-lg" onchange="loadStudentsForRole(this.value, 'late-stu')"><option value="">Ø§Ù„ÙØµÙ„</option></select></div>
                        <div class="col-md-5"><select id="late-stu" class="form-select form-select-lg" disabled><option>Ø§Ù„Ø·Ø§Ù„Ø¨</option></select></div>
                        <div class="col-md-3"><button class="btn btn-warning btn-lg w-100 fw-bold" onclick="registerLate()">Ø±ØµØ¯ Ø§Ù„ØªØ£Ø®Ø±</button></div>
                    </div>
                </div>

                <div class="row g-4 mb-4 text-center">
                    <div class="col-md-4"><div class="stat-box blue shadow-sm"><h2>0</h2><small class="fw-bold">Ø·Ù„Ø§Ø¨ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</small></div></div>
                    <div class="col-md-4"><div class="stat-box green shadow-sm"><h2>0</h2><small class="fw-bold">Ø²ÙˆØ§Ø± Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</small></div></div>
                    <div class="col-md-4"><div class="stat-box red shadow-sm"><h2>0</h2><small class="fw-bold">Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</small></div></div>
                </div>

                <div class="row g-4">
                    <div class="col-md-4"><div class="page-card h-100"><div class="card-header-custom">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø¬Ø¯Ø¯</div><div id="adm-vis-list" class="list-group list-group-flush"></div></div></div>
                    <div class="col-md-4"><div class="page-card h-100"><div class="card-header-custom">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div><div id="adm-vio-list" class="p-3"></div></div></div>
                    <div class="col-md-4"><div class="page-card h-100"><div class="card-header-custom">Ø£Ù…Ø± Ø§Ù†ØµØ±Ø§Ù Ù†Ù‡Ø§Ø¦ÙŠ</div><div class="p-4"><input id="adm-dep-name" class="form-control mb-3" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø±Ø¨Ø§Ø¹ÙŠ"><button class="btn btn-primary w-100 py-3 fw-bold" onclick="sendDeparture()">Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø®Ø±ÙˆØ¬ Ù„Ù„Ø­Ø§Ø±Ø³</button></div></div></div>
                </div>
            </section>

            <section id="sec-monitor" class="view-section fade-in">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold m-0"><i class="fas fa-desktop text-success me-2"></i> Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­ÙŠØ© Ù„Ù„Ø£Ø°ÙˆÙ†Ø§Øª</h4>
                    <button class="btn btn-dark rounded-pill px-4" onclick="toggleFullScreen()">Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©</button>
                </div>
                <div id="monitor-grid" class="row g-4"></div>
                <div id="no-students" class="text-center py-5 d-none"><i class="fas fa-check-circle fa-5x text-success opacity-25 mb-3"></i><h4>Ø§Ù„Ø¬Ù…ÙŠØ¹ Ù…Ù†Ø¶Ø¨Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØµÙˆÙ„</h4></div>
            </section>

            <section id="sec-reports" class="view-section d-none fade-in">
                <h4 class="fw-bold mb-4">Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ­Ø¯</h4>
                <div class="row g-4">
                    <div class="col-md-4"><div class="report-grid-item" onclick="showReportModal('permits')"><i class="fas fa-file-invoice text-primary"></i><h6 class="text-primary">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª</h6></div></div>
                    <div class="col-md-4"><div class="report-grid-item" onclick="showReportModal('visitors')"><i class="fas fa-user-shield text-success"></i><h6 class="text-success">Ø³Ø¬Ù„ Ø§Ù„Ø²ÙˆØ§Ø±</h6></div></div>
                    <div class="col-md-4"><div class="report-grid-item" onclick="showReportModal('violations')"><i class="fas fa-exclamation-triangle text-danger"></i><h6 class="text-danger">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h6></div></div>
                    <div class="col-md-4"><div class="report-grid-item" onclick="showReportModal('attendance')"><i class="fas fa-calendar-check text-info"></i><h6 class="text-info">Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ø§Ù„Ø­ØµØ©</h6></div></div>
                    <div class="col-md-4"><div class="report-grid-item" onclick="showReportModal('stars')"><i class="fas fa-trophy text-warning"></i><h6 class="text-warning">Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</h6></div></div>
                    <div class="col-md-4"><div class="report-grid-item" onclick="showReportModal('late')"><i class="fas fa-user-clock text-dark"></i><h6 class="text-dark">ØªØ£Ø®Ø± Ø§Ù„ØµØ¨Ø§Ø­</h6></div></div>
                </div>
            </section>

            <section id="sec-teacher" class="view-section d-none fade-in">
                <div class="btn-group bg-white p-2 rounded-pill shadow-sm mb-4 w-100 justify-content-center">
                    <button class="btn btn-success rounded-pill px-4" onclick="tabTeacher('permit')">Ø¥Ø°Ù† Ø®Ø±ÙˆØ¬</button>
                    <button class="btn btn-outline-primary rounded-pill px-4 ms-2" onclick="tabTeacher('attendance')">Ø§Ù„ØªØ­Ø¶ÙŠØ±</button>
                    <button class="btn btn-outline-warning rounded-pill px-4 ms-2" onclick="tabTeacher('behavior')">ØªÙ…ÙŠØ² â­ï¸</button>
                    <button class="btn btn-outline-danger rounded-pill px-4 ms-2" onclick="tabTeacher('violation')">Ù…Ø®Ø§Ù„ÙØ©</button>
                </div>
                
                <div id="t-permit-box" class="page-card p-4">
                    <h5 class="fw-bold mb-4 text-success border-bottom pb-3">Ø¥ØµØ¯Ø§Ø± Ø¥Ø°Ù† Ø®Ø±ÙˆØ¬ Ø·Ø§Ù„Ø¨</h5>
                    <div class="mb-3"><label class="fw-bold">Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ØµØ¯Ø± Ù„Ù„Ø¥Ø°Ù†:</label><select id="t-name-sender" class="form-select form-select-lg" onchange="rememberTeacher(this.value)"></select></div>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="fw-bold">Ø§Ù„ÙØµÙ„</label><select id="t-class" class="form-select form-select-lg" onchange="loadStudentsForRole(this.value, 't-stu')"></select></div>
                        <div class="col-md-6"><label class="fw-bold">Ø§Ù„Ø·Ø§Ù„Ø¨</label><select id="t-stu" class="form-select form-select-lg" disabled><option>Ø­Ø¯Ø¯ Ø§Ù„ÙØµÙ„</option></select></div>
                        <div class="col-md-6"><label class="fw-bold">Ø§Ù„ÙˆØ¬Ù‡Ø©</label><select id="t-dest" class="form-select form-select-lg"><option>Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡</option><option>Ø§Ù„Ù…Ù‚ØµÙ</option><option>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</option><option>Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</option></select></div>
                        <div class="col-md-3"><label class="fw-bold">Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)</label><input type="number" id="t-time" class="form-control form-control-lg" value="5"></div>
                        <div class="col-md-3 d-flex align-items-end"><div class="form-check p-2 border rounded w-100 bg-light"><input class="form-check-input float-end ms-2" type="checkbox" id="t-special"><label class="form-check-label fw-bold text-danger me-4" for="t-special">Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©</label></div></div>
                        <div class="col-12 mt-4"><button class="btn btn-success w-100 py-3 fw-bold rounded-pill shadow" onclick="sendPermit()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ (Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª)</button></div>
                    </div>
                </div>

                <div id="t-attendance-box" class="page-card p-4 d-none">
                    <h5 class="fw-bold mb-4 text-primary">ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø¨Ø§Ù„Ø­ØµØ©)</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4"><label class="fw-bold">Ø§Ù„ÙØµÙ„</label><select id="att-class" class="form-select" onchange="loadAttendanceList()"></select></div>
                        <div class="col-md-4"><label class="fw-bold">Ø±Ù‚Ù… Ø§Ù„Ø­ØµØ©</label><select id="att-period" class="form-select" onchange="loadAttendanceList()"><option value="1">Ø§Ù„Ø­ØµØ© 1</option><option value="2">Ø§Ù„Ø­ØµØ© 2</option><option value="3">Ø§Ù„Ø­ØµØ© 3</option><option value="4">Ø§Ù„Ø­ØµØ© 4</option><option value="5">Ø§Ù„Ø­ØµØ© 5</option><option value="6">Ø§Ù„Ø­ØµØ© 6</option><option value="7">Ø§Ù„Ø­ØµØ© 7</option></select></div>
                        <div class="col-md-4 d-flex align-items-end"><button class="btn btn-primary w-100" onclick="loadAttendanceList()">ØªØ­Ø¯ÙŠØ«</button></div>
                    </div>
                    <div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="att-list-body"></tbody></table></div>
                </div>

                <div id="t-behavior-box" class="page-card p-4 d-none">
                    <h5 class="fw-bold mb-4 text-warning">Ù…Ù†Ø­ Ù†Ø¬ÙˆÙ… Ø§Ù„ØªÙ…ÙŠØ² â­ï¸</h5>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="fw-bold">Ø§Ù„ÙØµÙ„</label><select id="b-class" class="form-select form-select-lg" onchange="loadStudentsForRole(this.value, 'b-stu')"></select></div>
                        <div class="col-md-6"><label class="fw-bold">Ø§Ù„Ø·Ø§Ù„Ø¨</label><select id="b-stu" class="form-select form-select-lg" disabled></select></div>
                        <div class="col-12"><label class="fw-bold">Ø§Ù„Ø³Ø¨Ø¨</label><select id="b-reason" class="form-select"><option>Ù…Ø´Ø§Ø±ÙƒØ© Ù…ØªÙ…ÙŠØ²Ø©</option><option>ÙˆØ§Ø¬Ø¨Ø§Øª Ù…Ù†Ø²Ù„ÙŠØ©</option><option>Ø§Ù†Ø¶Ø¨Ø§Ø· ÙˆØ³Ù„ÙˆÙƒ</option><option>Ù†Ø¸Ø§ÙØ© ÙˆØªØ±ØªÙŠØ¨</option></select></div>
                        <div class="col-12 mt-4"><button class="btn btn-warning w-100 py-3 fw-bold rounded-pill" onclick="sendStar()">Ù…Ù†Ø­ Ù†Ø¬Ù…Ø©</button></div>
                    </div>
                </div>

                <div id="t-violation-box" class="page-card p-4 d-none">
                    <h5 class="fw-bold mb-4 text-danger">ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ© Ø³Ù„ÙˆÙƒÙŠØ©</h5>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="fw-bold">Ø§Ù„ÙØµÙ„</label><select id="v-class" class="form-select form-select-lg" onchange="loadStudentsForRole(this.value, 'v-stu')"></select></div>
                        <div class="col-md-6"><label class="fw-bold">Ø§Ù„Ø·Ø§Ù„Ø¨</label><select id="v-stu" class="form-select form-select-lg" disabled></select></div>
                        <div class="col-md-6"><label class="fw-bold">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</label><input id="v-type" class="form-control" placeholder="Ù…Ø´Ø§ØºØ¨Ø©ØŒ ØªØ£Ø®Ø±..."></div>
                        <div class="col-12"><label class="fw-bold">Ø§Ù„ØªÙØ§ØµÙŠÙ„</label><textarea id="v-desc" class="form-control" rows="3"></textarea></div>
                        <div class="col-12 mt-4"><button class="btn btn-danger w-100 py-3 fw-bold rounded-pill" onclick="sendViolation()">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ÙˆÙƒÙŠÙ„</button></div>
                    </div>
                </div>
            </section>

            <section id="sec-guard" class="view-section d-none fade-in">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="page-card p-4 border-top border-dark border-5 h-100">
                            <h5 class="fw-bold mb-4 text-center">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø²ÙˆØ§Ø±</h5>
                            <div class="mb-3"><label class="fw-bold">Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±</label><input id="g-v-name" class="form-control" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ"></div>
                            <div class="mb-3"><label class="fw-bold">Ø§Ù„Ø³Ø¨Ø¨</label><input id="g-v-reason" class="form-control" placeholder="Ø²ÙŠØ§Ø±Ø© Ø§Ù„ÙˆÙƒÙŠÙ„ØŒ Ø§Ø³ØªÙ„Ø§Ù… Ø·Ø§Ù„Ø¨..."></div>
                            <button class="btn btn-dark w-100 py-3 fw-bold mb-4" onclick="sendVisitorReq()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                            <hr>
                            <h6 class="fw-bold mb-3">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©:</h6>
                            <div id="g-vis-list" class="list-group list-group-flush small"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="page-card h-100 border-top border-danger border-5">
                            <div class="card-header-custom bg-danger text-white">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)</div>
                            <div id="g-dep-list" class="list-group list-group-flush p-3"></div>
                            <div id="g-dep-empty" class="text-center py-5 text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø± Ø®Ø±ÙˆØ¬ Ø­Ø§Ù„ÙŠØ§Ù‹</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-data" class="view-section d-none fade-in">
                <div class="page-card p-4">
                    <h5 class="fw-bold mb-4 text-primary">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input id="s-school" class="form-control" onchange="saveSettings()"></div>
                        <div class="col-md-4"><label>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input id="s-manager" class="form-control" onchange="saveSettings()"></div>
                        <div class="col-md-4"><label>ÙˆÙƒÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</label><input id="s-deputy" class="form-control" onchange="saveSettings()"></div>
                    </div>
                    <div class="row g-3 mb-4 border p-3 rounded-4 bg-light">
                        <h6 class="fw-bold text-dark"><i class="fas fa-key me-2"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…ÙˆØ² (PIN)</h6>
                        <div class="col-md-3"><label class="small">Ø§Ù„Ù…Ø¯ÙŠØ±</label><input type="number" id="pin-admin" class="form-control"></div>
                        <div class="col-md-3"><label class="small">Ø§Ù„Ù…Ø¹Ù„Ù…</label><input type="number" id="pin-teacher" class="form-control"></div>
                        <div class="col-md-3"><label class="small">Ø§Ù„Ø­Ø§Ø±Ø³</label><input type="number" id="pin-guard" class="form-control"></div>
                        <div class="col-md-3 d-flex align-items-end"><button class="btn btn-dark w-100" onclick="savePasswords()">Ø­ÙØ¸ Ø§Ù„Ø±Ù…ÙˆØ²</button></div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4"><button class="btn btn-outline-dark w-100" onclick="exportData()">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button></div>
                        <div class="col-md-4"><button class="btn btn-outline-warning w-100" onclick="resetReports()">ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙ‚Ø·</button></div>
                        <div class="col-md-4"><button class="btn btn-outline-danger w-100" onclick="factoryReset()">ØªØµÙÙŠØ± Ø§Ù„Ù…ØµÙ†Ø¹ ÙƒØ§Ù…Ù„Ø§Ù‹</button></div>
                    </div>
                    <hr class="my-5">
                    <h5 class="fw-bold mb-3">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4"><button class="btn btn-success w-100" onclick="document.getElementById('f-tea-excel').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø¹Ù„Ù…ÙŠÙ†</button><input type="file" id="f-tea-excel" hidden onchange="importTeachers(this)"></div>
                        <div class="col-md-4"><input id="imp-cls-name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØµÙ„"></div>
                        <div class="col-md-4"><button class="btn btn-primary w-100" onclick="document.getElementById('f-excel').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø·Ù„Ø§Ø¨</button><input type="file" id="f-excel" hidden onchange="importData(this)"></div>
                    </div>
                    <div class="table-responsive" style="max-height: 400px;"><table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙØ¦Ø©/Ø§Ù„ÙØµÙ„</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="data-body"></tbody></table></div>
                </div>
            </section>
        </main>
    </div>

    <div class="fab-theme" onclick="toggleTheme()"><i class="fas fa-moon"></i></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyD0IJONOe7Ef4a0XG8L1Cgbc1qVSSck0xE", authDomain: "ethn-63848.firebaseapp.com", databaseURL: "https://ethn-63848-default-rtdb.firebaseio.com", projectId: "ethn-63848", storageBucket: "ethn-63848.appspot.com", messagingSenderId: "747489913596", appId: "1:747489913596:web:d98d88447e4a25cc808579" };
        firebase.initializeApp(firebaseConfig); const db = firebase.database();
        let userRole='', isMuted=true; 
        let data = { settings: {school:'Ù†Ø¸Ø§Ù… Ø¥Ø°Ù†', manager:'', deputy:'', admin_pin:'2026', teacher_pin:'2026', guard_pin:'1111', counselor_pin:'2026'}, classes:[], students:{}, teachers:{}, permits:{}, visitors:{}, departures:{}, violations:{}, attendance:{}, stars:{}, tardiness:{} };

        // Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        window.onload = () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const savedRole = sessionStorage.getItem('currentRole');
            const savedView = sessionStorage.getItem('currentView');

            db.ref('/').on('value', snap => {
                const val = snap.val();
                if(val) {
                    data = { ...data, ...val };
                    document.getElementById('disp-school').innerText = data.settings.school;
                    
                    if(savedRole && !userRole) {
                        userRole = savedRole;
                        document.getElementById('auth-overlay').style.display='none'; 
                        document.getElementById('app-body').classList.remove('d-none'); 
                        buildMenu(); navigate(savedView || 'monitor');
                    }
                    document.body.style.visibility = 'visible';
                    calculateBestClass(); refreshScreens(); updateDashboardStats(); checkSecurityAlerts();
                }
            });
            setInterval(monitorLoop, 10000);
        };

        function selectRole(r, t) { userRole=r; document.getElementById('role-selection').classList.add('hidden'); document.getElementById('pin-area').classList.remove('hidden'); document.getElementById('role-label').innerText='Ø¯Ø®ÙˆÙ„: '+t; document.getElementById('pin-input').value=''; }
        function backToRoles() { document.getElementById('pin-area').classList.add('hidden'); document.getElementById('role-selection').classList.remove('hidden'); userRole=''; }
        
        function doLogin() {
            const pin = document.getElementById('pin-input').value;
            const correctPin = data.settings[`${userRole}_pin`];
            if(pin === String(correctPin)) { 
                sessionStorage.setItem('currentRole', userRole);
                document.getElementById('auth-overlay').style.display='none'; 
                document.getElementById('app-body').classList.remove('d-none'); 
                buildMenu(); navigate(userRole==='guard'?'guard':(userRole==='admin'?'monitor':'teacher')); 
            } else { Swal.fire('Ø®Ø·Ø£','Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­','error'); document.getElementById('pin-input').value=''; }
        }

        function buildMenu() {
            const m = document.getElementById('nav-items'); let links = [['monitor','Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­ÙŠØ©','desktop']];
            if(userRole==='teacher') links.push(['teacher','Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø¹Ù„Ù…','user-edit']);
            if(userRole==='admin') links.push(['admin','Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…','tasks'], ['reports','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±','file-alt'], ['data','Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª','cogs']);
            if(userRole==='guard') links = [['guard','Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø­Ø§Ø±Ø³','shield-alt']];
            if(userRole==='counselor') links.push(['counselor','Ø§Ù„ØªÙˆØ¬ÙŠÙ‡','user-graduate'], ['reports','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±','file-contract']);
            m.innerHTML = links.map(l => `<div class="nav-link" id="nav-${l[0]}" onclick="navigate('${l[0]}')"><i class="fas fa-${l[2]} me-2"></i> ${l[1]}</div>`).join('');
        }

        function navigate(id) { 
            sessionStorage.setItem('currentView', id);
            document.querySelectorAll('.view-section').forEach(s => s.classList.add('d-none')); 
            document.getElementById('sec-'+id).classList.remove('d-none'); 
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            if(document.getElementById('nav-'+id)) document.getElementById('nav-'+id).classList.add('active');
            refreshScreens(); 
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            document.querySelector('.fab-theme i').className = next === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        function calculateBestClass() {
            let s = {}; (data.classes||[]).forEach(c=>s[c]=0);
            Object.values(data.stars||{}).forEach(st=>{ let obj=Object.values(data.students).find(x=>x.name===st.student); if(obj) s[obj.class]++; });
            Object.values(data.violations||{}).forEach(v=>{ let obj=Object.values(data.students).find(x=>x.name===v.student); if(obj) s[obj.class]--; });
            let best = Object.entries(s).sort((a,b)=>b[1]-a[1])[0];
            if(best && best[1]>0) { document.getElementById('best-class-badge').classList.remove('d-none'); document.getElementById('best-class-txt').innerText=best[0]; }
        }

        function refreshScreens() {
            ['t-class','v-class','b-class','att-class','late-class'].forEach(id=>{ const e=document.getElementById(id); if(e && e.options.length<=1) e.innerHTML='<option value="">Ø§Ù„ÙØµÙ„</option>'+(data.classes||[]).map(c=>`<option>${c}</option>`).join(''); });
            const te = document.getElementById('t-name-sender'); if(te && te.options.length<=1) te.innerHTML='<option value="">Ø§Ù„Ù…Ø¹Ù„Ù…</option>'+Object.values(data.teachers||{}).map(t=>`<option>${t.name}</option>`).join('');
            
            if(!document.getElementById('sec-monitor').classList.contains('d-none')) renderMonitor();
            if(userRole==='admin') renderAdmin();
            if(userRole==='guard') renderGuard();
            if(!document.getElementById('sec-data').classList.contains('d-none')) renderDataTables();
        }

        function updateDashboardStats() {
            const stats = document.querySelectorAll('.stat-box h2');
            if(stats.length && userRole==='admin') {
                stats[0].innerText = Object.values(data.permits||{}).filter(p=>p.active).length;
                stats[1].innerText = Object.values(data.visitors||{}).filter(v=>v.status==='pending').length;
                stats[2].innerText = Object.values(data.violations||{}).filter(v=>v.status==='pending_admin').length;
            }
        }

        function renderMonitor() {
            const g = document.getElementById('monitor-grid'); const list = Object.entries(data.permits||{}).filter(x=>x[1].active);
            document.getElementById('no-students').classList.toggle('d-none', list.length>0);
            g.innerHTML = list.map(([k,p])=>{
                const m = Math.floor((new Date()-new Date(p.start))/60000);
                return `<div class="col-md-3"><div class="monitor-card ${m>=p.limit?'danger':'safe'}"><h5>${p.student}</h5><small class="text-muted d-block">${p.class} | ${p.dest}</small><h2 class="text-center my-3">${m} Ø¯</h2><button class="btn btn-dark btn-sm w-100 rounded-pill" onclick="db.ref('permits/${k}').update({active:false})">Ø¹ÙˆØ¯Ø©</button></div></div>`;
            }).join('');
        }

        function renderAdmin() {
            document.getElementById('adm-vis-list').innerHTML = Object.entries(data.visitors||{}).filter(x=>x[1].status==='pending').map(([k,v])=>`<div class="list-group-item d-flex justify-content-between align-items-center"><span>${v.name}</span><div class="btn-group"><button class="btn btn-success btn-sm" onclick="db.ref('visitors/${k}').update({status:'approved'})">Ù…ÙˆØ§ÙÙ‚Ø©</button><button class="btn btn-danger btn-sm" onclick="db.ref('visitors/${k}').update({status:'rejected'})">Ø±ÙØ¶</button></div></div>`).join('');
            document.getElementById('adm-vio-list').innerHTML = Object.entries(data.violations||{}).filter(x=>x[1].status==='pending_admin').map(([k,v])=>`<div class="alert alert-danger p-2 small mb-2"><strong>${v.student}</strong><br>${v.type}<button class="btn btn-dark btn-sm w-100 mt-2" onclick="db.ref('violations/${k}').update({status:'pending_counselor'})">Ø¥Ø­Ø§Ù„Ø© Ù„Ù„Ù…ÙˆØ¬Ù‡</button></div>`).join('');
        }

        function renderGuard() {
            const deps = Object.entries(data.departures||{}).filter(x=>x[1].status==='pending');
            document.getElementById('g-dep-empty').classList.toggle('d-none', deps.length > 0);
            document.getElementById('g-dep-list').innerHTML = deps.map(([k,d])=>`<div class="alert alert-danger d-flex justify-content-between align-items-center"><strong>${d.name}</strong><button class="btn btn-success" onclick="db.ref('departures/${k}').update({status:'exited'})">Ø®Ø±ÙˆØ¬</button></div>`).join('');
            document.getElementById('g-vis-list').innerHTML = Object.entries(data.visitors||{}).reverse().slice(0,5).map(([k,v])=>`<div class="list-group-item d-flex justify-content-between small"><span>${v.name}</span><span class="badge ${v.status==='approved'?'bg-success':(v.status==='rejected'?'bg-danger':'bg-warning')}">${v.status}</span></div>`).join('');
        }

        function renderDataTables() {
            let h = '';
            Object.entries(data.teachers||{}).forEach(([k,t])=> h+=`<tr><td>${t.name}</td><td>Ù…Ø¹Ù„Ù…</td><td><button class="btn btn-sm text-danger" onclick="db.ref('teachers/${k}').remove()">X</button></td></tr>`);
            Object.entries(data.students||{}).reverse().slice(0,100).forEach(([k,s])=> h+=`<tr><td>${s.name}</td><td>${s.class}</td><td><button class="btn btn-sm text-danger" onclick="db.ref('students/${k}').remove()">X</button></td></tr>`);
            document.getElementById('data-body').innerHTML = h;
            document.getElementById('pin-admin').value = data.settings.admin_pin;
            document.getElementById('pin-teacher').value = data.settings.teacher_pin;
            document.getElementById('pin-guard').value = data.settings.guard_pin;
        }

        function sendPermit() {
            const stu = document.getElementById('t-stu').value; const tN = document.getElementById('t-name-sender').value;
            if(!stu || !tN) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','warning');
            db.ref('permits').push({student:stu, teacher:tN, class:document.getElementById('t-class').value, dest:document.getElementById('t-dest').value, limit:parseInt(document.getElementById('t-time').value), start:new Date().toISOString(), active:true});
            Swal.fire('ØªÙ…','Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª','success'); navigate('monitor');
        }

        function sendStar() { const stu=document.getElementById('b-stu').value; if(stu) db.ref('stars').push({student:stu, date:new Date().toISOString()}); Swal.fire('Ù†Ø¬ÙˆÙ… Ù…Ø¶Ø§ÙØ©'); }
        function sendViolation() { const v={student:document.getElementById('v-stu').value, type:document.getElementById('v-type').value, desc:document.getElementById('v-desc').value, status:'pending_admin', date:new Date().toLocaleDateString('ar-SA')}; if(v.student) db.ref('violations').push(v); Swal.fire('ØªÙ… Ø§Ù„Ø±ÙØ¹'); }
        function sendVisitorReq() { const n=document.getElementById('g-v-name').value; if(n) db.ref('visitors').push({name:n, reason:document.getElementById('g-v-reason').value, status:'pending', time:new Date().toISOString()}); document.getElementById('g-v-name').value=''; Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); }
        function sendDeparture() { const n=document.getElementById('adm-dep-name').value; if(n) db.ref('departures').push({name:n, status:'pending'}); document.getElementById('adm-dep-name').value=''; Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø­Ø§Ø±Ø³'); }
        function registerLate() { const s=document.getElementById('late-stu').value; if(s) db.ref('tardiness').push({student:s, date:new Date().toISOString()}); Swal.fire('ØªÙ… Ø§Ù„Ø±ØµØ¯'); }

        function loadStudentsForRole(cls, id) { const l=Object.values(data.students||{}).filter(s=>s.class===cls); const e=document.getElementById(id); e.innerHTML='<option value="">Ø§Ù„Ø·Ø§Ù„Ø¨</option>'; e.disabled=false; l.forEach(s=>e.innerHTML+=`<option>${s.name}</option>`); }
        function loadAttendanceList() {
            const cls = document.getElementById('att-class').value; const period = document.getElementById('att-period').value;
            const body = document.getElementById('att-list-body'); if(!cls) return;
            const today = new Date().toLocaleDateString('en-CA'); const att = (data.attendance && data.attendance[today] && data.attendance[today][period]) ? data.attendance[today][period] : {};
            body.innerHTML = Object.values(data.students).filter(s=>s.class===cls).map(s=>{
                const isAbs = att[s.name]==='absent';
                return `<tr><td>${s.name}</td><td><button class="btn btn-sm ${isAbs?'btn-danger':'btn-success'} px-4 rounded-pill" onclick="db.ref('attendance/${today}/${period}/${s.name}').set('${isAbs?'present':'absent'}')">${isAbs?'ØºØ§Ø¦Ø¨':'Ø­Ø§Ø¶Ø±'}</button></td></tr>`;
            }).join('');
        }

        function saveSettings() { db.ref('settings').update({school:document.getElementById('s-school').value, manager:document.getElementById('s-manager').value, deputy:document.getElementById('s-deputy').value}); }
        function savePasswords() { db.ref('settings').update({admin_pin:document.getElementById('pin-admin').value, teacher_pin:document.getElementById('pin-teacher').value, guard_pin:document.getElementById('pin-guard').value}); Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸'); }
        function importData(inp) { const cls=document.getElementById('imp-cls-name').value; if(!cls) return alert('Ø§Ù„ÙØµÙ„ØŸ'); const r=new FileReader(); r.onload=e=>{ const j=XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:'array'}).Sheets[XLSX.read(e.target.result,{type:'array'}).SheetNames[0]],{header:1}); j.forEach(row=>{if(row[0]) db.ref('students').push({name:row[0], class:cls})}); let c=data.classes||[]; if(!c.includes(cls)) {c.push(cls); db.ref('classes').set(c);} }; r.readAsArrayBuffer(inp.files[0]); }
        function importTeachers(inp) { const r=new FileReader(); r.onload=e=>{ const j=XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:'array'}).Sheets[XLSX.read(e.target.result,{type:'array'}).SheetNames[0]],{header:1}); j.forEach(row=>{if(row[0]) db.ref('teachers').push({name:row[0]})}); }; r.readAsArrayBuffer(inp.files[0]); }
        function resetReports() { if(confirm('ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŸ')) { ['permits','visitors','violations','departures','attendance','stars','tardiness'].forEach(p=>db.ref(p).remove()); } }
        function factoryReset() { if(confirm('Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ØŸ')) { db.ref('/').remove(); location.reload(); } }

        function checkSecurityAlerts() {
            let ring = (userRole==='guard' && Object.values(data.departures||{}).some(d=>d.status==='pending')) || (userRole==='admin' && Object.values(data.visitors||{}).some(v=>v.status==='pending'));
            if(ring && !isMuted) document.getElementById('bell').play().catch(()=>{}); else document.getElementById('bell').pause();
        }
        function monitorLoop() { if(!document.getElementById('sec-monitor').classList.contains('d-none')) renderMonitor(); }
        function logOut() { sessionStorage.clear(); location.reload(); }
        function toggleMute() { isMuted=!isMuted; document.getElementById('mute-btn').innerHTML=isMuted?'<i class="fas fa-volume-mute"></i>':'<i class="fas fa-volume-up"></i>'; }
        function toggleFullScreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
        function tabTeacher(t) { document.querySelectorAll('#sec-teacher > .page-card').forEach(c=>c.classList.add('d-none')); document.getElementById(`t-${t}-box`).classList.remove('d-none'); }
        function showReportModal(t) { Swal.fire('Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±','Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©','info'); }
    </script>
</body>
</html>
