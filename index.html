<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#006C35">
    <title>نظام إذن (رؤية 2030)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            /* ألوان هوية رؤية 2030 */
            --vision-green: #006C35; 
            --vision-light-green: #009A4E;
            --vision-gold: #C69C6D;
            --vision-bg: #F7F9FC;
            --text-main: #2A2A2A;
        }
        
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: var(--vision-bg); 
            color: var(--text-main); 
            margin: 0; 
            overflow-x: hidden; 
        }

        /* --- شاشة الدخول (تصميم الرؤية) --- */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #ffffff 0%, #f0f7f4 100%);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .portal-logo { width: 140px; margin-bottom: 20px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .portal-title { color: var(--vision-green); font-weight: 800; font-size: 2.2rem; margin-bottom: 10px; }
        .portal-sub { color: var(--vision-gold); font-size: 1.1rem; margin-bottom: 40px; font-weight: bold; }

        .roles-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; width: 90%; max-width: 1000px; padding: 10px;
        }

        .role-card {
            background: white; border: 1px solid #eee; border-radius: 20px;
            padding: 30px 20px; text-align: center; cursor: pointer;
            transition: all 0.3s ease; position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,108,53,0.05);
        }
        
        .role-card::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 5px;
            background: var(--vision-green); transform: scaleX(0); transition: 0.3s;
        }

        .role-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,108,53,0.15); }
        .role-card:hover::after { transform: scaleX(1); }
        .role-card:active { transform: scale(0.98); } /* تأثير ضغط الزر */

        .role-icon { font-size: 3.5rem; color: var(--vision-green); margin-bottom: 15px; }
        .role-title { font-weight: 800; font-size: 1.5rem; color: #333; margin: 0; }
        .role-desc { font-size: 0.9rem; color: #777; margin-top: 5px; }

        /* شاشة الرمز السري */
        #pin-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); backdrop-filter: blur(5px);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000;
        }
        .pin-input {
            font-size: 3rem; text-align: center; width: 280px; letter-spacing: 15px;
            border: none; border-bottom: 4px solid var(--vision-gold);
            background: transparent; outline: none; margin: 30px 0; color: var(--vision-green); font-weight: bold;
        }

        /* --- التطبيق الداخلي --- */
        .sidebar {
            width: 260px; height: 100vh; background: var(--vision-green); color: white;
            position: fixed; right: 0; top: 0; z-index: 1000; overflow-y: auto;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1); transition: 0.3s;
        }
        .main-content { margin-right: 260px; padding: 30px; transition: 0.3s; min-height: 100vh; }

        /* Mobile Adjustments */
        @media (max-width: 991px) {
            .sidebar { transform: translateX(100%); width: 100%; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; padding: 15px; }
            .mobile-header { display: flex !important; }
            .roles-grid { grid-template-columns: 1fr; } /* بطاقات فوق بعض في الجوال */
        }

        .mobile-header {
            display: none; justify-content: space-between; align-items: center;
            background: var(--vision-green); color: white; padding: 15px;
            margin: -15px -15px 20px -15px; position: sticky; top: 0; z-index: 500;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* --- العناصر والبطاقات --- */
        .card-custom { border: none; border-radius: 15px; background: white; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 25px; overflow: hidden; border: 1px solid #eee; }
        .card-head { padding: 15px 20px; background: white; border-bottom: 1px solid #f0f0f0; font-weight: 800; color: var(--vision-green); display: flex; justify-content: space-between; align-items: center; }
        
        .nav-link { color: rgba(255,255,255,0.85); padding: 15px 25px; border-right: 4px solid transparent; font-size: 1.1rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.15); color: white; border-right-color: var(--vision-gold); }
        .nav-link i { margin-left: 15px; width: 25px; }

        .monitor-card { background: white; padding: 20px; border-radius: 15px; border-right: 6px solid #ddd; box-shadow: 0 4px 10px rgba(0,0,0,0.03); position: relative; }
        .monitor-card.safe { border-right-color: #27ae60; }
        .monitor-card.danger { border-right-color: #e74c3c; animation: pulse 2s infinite; }
        
        .action-btn { width: 35px; height: 35px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: 0.2s; margin: 0 3px; }
        .action-btn:hover { transform: scale(1.1); }
        .btn-del { background: #fee2e2; color: #e74c3c; }
        .btn-edit { background: #e0f2fe; color: #3498db; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231,76,60,0.4); } 70% { box-shadow: 0 0 0 10px rgba(231,76,60,0); } }
        .hidden { display: none !important; }
        @media print { .no-print, .sidebar { display: none !important; } .main-content { margin: 0; } }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <img src="https://cdn-icons-png.flaticon.com/512/3209/3209265.png" class="portal-logo">
        <div class="portal-title">نظام إذن الذكي</div>
        <div class="portal-sub">متوسطة الإمام النووي - رؤية 2030</div>

        <div class="roles-grid">
            <div class="role-card" onclick="openPin('admin')">
                <i class="fas fa-user-tie role-icon"></i>
                <h3 class="role-title">الإدارة</h3>
                <p class="role-desc">التحكم والتقارير</p>
            </div>
            <div class="role-card" onclick="openPin('teacher')">
                <i class="fas fa-chalkboard-teacher role-icon"></i>
                <h3 class="role-title">المعلم</h3>
                <p class="role-desc">إصدار الأذونات</p>
            </div>
            <div class="role-card" onclick="openPin('guard')">
                <i class="fas fa-id-card-alt role-icon"></i>
                <h3 class="role-title">الزوار</h3>
                <p class="role-desc">بوابة الدخول</p>
            </div>
        </div>

        <div id="pin-screen" class="hidden">
            <h2 class="mb-3 text-dark fw-bold" id="pin-title">الرمز السري</h2>
            <input type="password" id="pin-input" class="pin-input" inputmode="numeric" placeholder="****">
            <div class="d-flex gap-3 mt-4">
                <button class="btn btn-success btn-lg px-5 rounded-pill fw-bold" onclick="login()">دخول</button>
                <button class="btn btn-outline-secondary btn-lg px-5 rounded-pill" onclick="closePin()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="app-interface" class="hidden">
        
        <div class="mobile-header">
            <h5 class="m-0 fw-bold">نظام إذن</h5>
            <button class="btn text-white" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i class="fas fa-bars fa-lg"></i></button>
        </div>

        <aside class="sidebar">
            <div class="text-center p-4 border-bottom border-white border-opacity-10 mb-2">
                <i class="fas fa-school fa-4x mb-3 text-warning"></i>
                <h5 class="fw-bold m-0">الإمام النووي</h5>
                <small class="text-white-50" id="role-disp">--</small>
            </div>
            <nav id="menu-items"></nav>
            <div class="p-3 mt-auto">
                <button class="btn btn-outline-light w-100 py-2 rounded-pill" onclick="location.reload()">
                    <i class="fas fa-sign-out-alt me-2"></i> خروج
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <section id="sec-monitor" class="view-sec">
                <div class="d-flex justify-content-between align-items-center mb-4 no-print">
                    <h2 class="fw-bold text-dark m-0"><i class="fas fa-desktop text-warning me-2"></i>المتابعة</h2>
                    <button class="btn btn-white border shadow-sm rounded-circle" id="mute-btn" onclick="toggleMute()"><i class="fas fa-volume-up text-success"></i></button>
                </div>
                <div id="live-grid" class="row g-3"></div>
                <div id="no-active" class="text-center py-5 hidden text-muted">
                    <i class="fas fa-check-circle fa-5x mb-3 text-success opacity-50"></i>
                    <h3>الوضع مستقر</h3>
                    <p>جميع الطلاب داخل الفصول الدراسية</p>
                </div>
            </section>

            <section id="sec-data" class="view-sec hidden">
                <ul class="nav nav-pills mb-4 gap-2 bg-white p-2 rounded-4 shadow-sm d-inline-flex">
                    <li class="nav-item"><button class="nav-link text-dark active rounded-pill" onclick="tabData('stu', this)">الطلاب</button></li>
                    <li class="nav-item"><button class="nav-link text-dark rounded-pill" onclick="tabData('tea', this)">المعلمون</button></li>
                    <li class="nav-item"><button class="nav-link text-dark rounded-pill" onclick="tabData('sys', this)">النظام</button></li>
                </ul>

                <div id="tab-stu">
                    <div class="card-custom p-4">
                        <div class="row g-3 align-items-end mb-4">
                            <div class="col-md-3">
                                <label class="fw-bold small mb-1">الفصل (مهم للاستيراد)</label>
                                <input list="dl-classes" id="imp-cls" class="form-control" placeholder="اكتب الفصل">
                                <datalist id="dl-classes"></datalist>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-success w-100" onclick="document.getElementById('f-stu').click()">استيراد Excel</button>
                                <input type="file" id="f-stu" hidden onchange="importData(this, 'students')">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100" onclick="addStudent()">+ طالب فردي</button>
                            </div>
                            <div class="col-md-3">
                                <input class="form-control" placeholder="بحث..." onkeyup="filterTable('tbl-stu', this.value)">
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-hover align-middle" id="tbl-stu">
                                <thead class="table-light"><tr><th>الاسم</th><th>الفصل</th><th>إجراءات</th></tr></thead>
                                <tbody id="body-stu"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-tea" class="hidden">
                    <div class="card-custom p-4">
                        <div class="d-flex gap-3 mb-4">
                            <button class="btn btn-success" onclick="document.getElementById('f-tea').click()">استيراد Excel</button>
                            <input type="file" id="f-tea" hidden onchange="importData(this, 'teachers')">
                            <button class="btn btn-primary" onclick="addTeacher()">+ معلم</button>
                        </div>
                        <button class="btn btn-outline-danger btn-sm mb-3" onclick="delAll('teachers')">حذف الكل</button>
                        <table class="table table-hover" id="tbl-tea"><tbody id="body-tea"></tbody></table>
                    </div>
                </div>

                <div id="tab-sys" class="hidden">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card-custom p-5 text-center bg-warning bg-opacity-10">
                                <h5>كود المعلم</h5>
                                <h1 class="display-4 fw-bold text-primary my-3" id="sys-code">----</h1>
                                <button class="btn btn-dark" onclick="newCode()">تحديث</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card-custom p-5 text-center bg-dark text-white">
                                <h5>كلمة مرور الزوار</h5>
                                <h1 class="display-4 fw-bold text-warning my-3" id="sys-guard">----</h1>
                                <button class="btn btn-outline-light" onclick="newGuard()">تغيير</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-reports" class="view-sec hidden">
                <div class="d-flex justify-content-between mb-4 no-print">
                    <h2 class="fw-bold m-0">التقارير</h2>
                    <button class="btn btn-dark" onclick="window.print()">طباعة</button>
                </div>
                <div class="d-flex gap-2 mb-4 overflow-auto no-print">
                    <button class="btn btn-outline-success active rounded-pill px-4" onclick="repView('all', this)">الأذونات</button>
                    <button class="btn btn-outline-success rounded-pill px-4" onclick="repView('stats', this)">الإحصائيات</button>
                    <button class="btn btn-outline-success rounded-pill px-4" onclick="repView('vis', this)">الزوار</button>
                    <button class="btn btn-outline-success rounded-pill px-4" onclick="repView('dep', this)">الانصراف</button>
                </div>
                <div class="card-custom">
                    <div class="card-head"><h5 id="rep-title" class="m-0">البيانات</h5></div>
                    <div class="table-responsive">
                        <table class="table table-bordered text-center mb-0">
                            <thead class="table-light" id="rep-th"></thead>
                            <tbody id="rep-tb"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sec-permit" class="view-sec hidden">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card-custom">
                            <div class="card-head">إصدار إذن جديد</div>
                            <div class="card-body p-5">
                                <form onsubmit="issuePermit(event)">
                                    <label class="fw-bold mb-2">1. اختر الفصل</label>
                                    <input list="dl-classes" id="p-class" class="form-control form-control-lg mb-4" onchange="loadStudents(this.value)" placeholder="ابحث..." required>
                                    
                                    <label class="fw-bold mb-2">2. اختر الطالب</label>
                                    <select id="p-student" class="form-select form-select-lg mb-4" disabled required></select>
                                    
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-6">
                                            <label class="fw-bold mb-2">3. الوجهة</label>
                                            <select id="p-dest" class="form-select form-select-lg" required>
                                                <option value="">اختر...</option>
                                                <option>دورة مياه</option><option>المقصف</option>
                                                <option>الإدارة</option><option>الموجه</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="fw-bold mb-2">4. المدة (دقيقة)</label>
                                            <input type="number" id="p-time" class="form-control form-control-lg" value="5" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-check form-switch mb-4 bg-light p-2 rounded">
                                        <input class="form-check-input ms-2" type="checkbox" id="p-spec">
                                        <label class="form-check-label text-danger fw-bold">حالة طارئة (تجاوز النظام)</label>
                                    </div>
                                    
                                    <button class="btn btn-success w-100 py-3 fw-bold fs-5">تسجيل خروج</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-guard" class="view-sec hidden">
                <div class="row">
                    <div class="col-md-5">
                        <div class="card-custom p-4">
                            <h4 class="mb-4 fw-bold">تسجيل زائر</h4>
                            <input id="v-name" class="form-control mb-3" placeholder="الاسم" required>
                            <input id="v-id" type="number" class="form-control mb-3" placeholder="الهوية" required>
                            <input id="v-reason" class="form-control mb-3" placeholder="السبب" required>
                            <button class="btn btn-dark w-100 py-3 fw-bold" onclick="sendVisitor()">إرسال الطلب</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card-custom">
                            <div class="card-head">الحالة</div>
                            <div id="g-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-agent" class="view-sec hidden">
                <h3 class="mb-4 fw-bold">لوحة الوكيل</h3>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card-custom h-100">
                            <div class="card-head bg-warning bg-opacity-10 text-dark">طلبات الزوار</div>
                            <div id="ag-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-custom h-100">
                            <div class="card-head bg-danger text-white">أمر انصراف</div>
                            <div class="p-4">
                                <input id="dep-n" class="form-control mb-3" placeholder="اسم الطالب">
                                <input id="dep-r" class="form-control mb-3" placeholder="السبب">
                                <button class="btn btn-danger w-100 py-2" onclick="sendDep()">سماح بالخروج</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <audio id="snd" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // ================= FIREBASE CONFIG (ضع بياناتك هنا) =================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ================= STATE =================
        let role = '', data = { code:'2026', guard:'1111', students:{}, teachers:{}, permits:{}, visitors:{}, departures:{}, classes:[] };
        let muted=false, lastSound=0;

        // ================= INIT & SYNC =================
        window.onload = () => {
            db.ref('/').on('value', snap => {
                if(snap.val()) {
                    data = snap.val();
                    if(!data.classes) data.classes = [];
                    renderUI();
                }
            });
            setInterval(monitorLoop, 2000);
        };

        function renderUI() {
            // Datalist Update
            const dl = document.getElementById('dl-classes'); dl.innerHTML='';
            (data.classes||[]).forEach(c=>dl.innerHTML+=`<option value="${c}">`);
            
            document.getElementById('sys-code').innerText = data.code;
            document.getElementById('sys-guard').innerText = data.guard;

            // Render Active Screen
            if(role==='admin' && isActive('data')) renderManage();
            if(role==='admin' && isActive('agent')) renderAgent();
            if(role==='guard') renderGuard();
            if(isActive('monitor')) renderMonitor();
        }
        function isActive(s) { return !document.getElementById('sec-'+s).classList.contains('hidden'); }

        // ================= AUTH =================
        function openPin(r) { role=r; document.getElementById('pin-screen').classList.remove('hidden'); }
        function closePin() { document.getElementById('pin-screen').classList.add('hidden'); }
        function login() {
            const p = document.getElementById('pin-input').value;
            let ok = (role==='admin' && p==='admin') || (role==='guard' && p==data.guard) || (role==='teacher' && p==data.code);
            if(ok) {
                document.getElementById('auth-overlay').style.display='none';
                document.getElementById('app-interface').classList.remove('hidden');
                buildMenu(); navigate(role==='guard'?'guard':(role==='admin'?'monitor':'permit'));
            } else Swal.fire('خطأ','الرمز غير صحيح','error');
        }

        // ================= MENU =================
        function buildMenu() {
            const m = document.getElementById('menu-items'); m.innerHTML='';
            document.getElementById('role-disp').innerText = role==='admin'?'الإدارة':(role==='teacher'?'المعلم':'الزوار');
            const items = role==='teacher' ? [['monitor','المتابعة','desktop'],['permit','إصدار إذن','file-signature']] :
                          role==='admin' ? [['monitor','المتابعة','desktop'],['data','البيانات','database'],['agent','الوكيل','user-check'],['reports','التقارير','chart-bar']] :
                          [['guard','بوابة الزوار','id-card']];
            items.forEach(([id,t,i]) => m.innerHTML+=`<div class="nav-link" onclick="navigate('${id}')"><i class="fas fa-${i}"></i> ${t}</div>`);
        }
        function navigate(id) {
            document.querySelectorAll('.view-sec').forEach(e=>e.classList.add('hidden'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            if(window.innerWidth < 992) document.querySelector('.sidebar').classList.remove('active');
            if(id==='reports') repView('all');
        }

        // ================= TEACHER =================
        function loadStudents(cls) {
            const sel = document.getElementById('p-student'); sel.innerHTML='<option value="">اختر الطالب</option>'; sel.disabled=false;
            Object.values(data.students||{}).filter(s=>s.class===cls).forEach(s=>sel.innerHTML+=`<option value="${s.name}">${s.name}</option>`);
        }
        function issuePermit(e) {
            e.preventDefault();
            const s=document.getElementById('p-student').value, c=document.getElementById('p-class').value, d=document.getElementById('p-dest').value, t=document.getElementById('p-time').value;
            // Strict Validation
            if(!s || !c || !d || !t) return Swal.fire('بيانات ناقصة','يرجى تعبئة جميع الحقول','warning');
            
            // Check Active
            if(Object.values(data.permits||{}).find(p=>p.student===s && p.active)) return Swal.fire('خطأ','الطالب خارج الفصل حالياً','error');

            db.ref('permits').push({student:s, class:c, dest:d, limit:parseInt(t), start:new Date().toISOString(), active:true});
            Swal.fire({icon:'success', title:'تم الخروج', timer:1000, showConfirmButton:false});
            navigate('monitor'); e.target.reset();
        }

        // ================= MONITOR =================
        function monitorLoop() { if(isActive('monitor')) renderMonitor(); }
        function renderMonitor() {
            const g = document.getElementById('live-grid'), active=Object.entries(data.permits||{}).filter(([k,v])=>v.active);
            if(!active.length) { document.getElementById('no-active').classList.remove('hidden'); g.innerHTML=''; return; }
            document.getElementById('no-active').classList.add('hidden');
            
            let alert=false;
            g.innerHTML = active.map(([k,p]) => {
                const m = Math.floor((new Date()-new Date(p.start))/60000);
                if(m >= p.limit) alert=true;
                return `<div class="col-md-3"><div class="monitor-card ${m>=p.limit?'danger':'safe'}"><h4>${p.student}</h4><span class="badge bg-light text-dark border">${p.class}</span><br><small class="text-muted">${p.dest}</small><div class="display-4 fw-bold my-2 ${m>=p.limit?'text-danger':'text-success'}">${m}</div><small>دقيقة</small><button class="btn btn-dark w-100 mt-2" onclick="db.ref('permits/${k}').update({active:false, end:new Date().toISOString()})">عودة</button></div></div>`;
            }).join('');
            if(alert && !muted && Date.now()-lastSound > 10000) { document.getElementById('snd').play().catch(()=>{}); lastSound=Date.now(); }
        }
        function toggleMute() { muted=!muted; document.getElementById('mute-btn').classList.toggle('text-danger'); }

        // ================= DATA =================
        function tabData(t, btn) {
            document.querySelectorAll('.data-tab').forEach(e=>e.classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            if(btn) { document.querySelectorAll('.nav-pills .nav-link').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
            renderManage();
        }
        function renderManage() {
            document.getElementById('body-stu').innerHTML = Object.entries(data.students||{}).reverse().map(([k,s])=>`<tr><td>${s.name}</td><td>${s.class}</td><td><button class="action-btn move" onclick="moveStu('${k}')"><i class="fas fa-exchange-alt"></i></button> <button class="action-btn btn-del" onclick="del('students/${k}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            document.getElementById('body-tea').innerHTML = Object.entries(data.teachers||{}).map(([k,t])=>`<tr><td>${t.name}</td><td><button class="action-btn btn-del" onclick="del('teachers/${k}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        }
        function addStudent() {
            const cls = document.getElementById('imp-cls').value;
            if(!cls) return Swal.fire('تنبيه','حدد الفصل','warning');
            Swal.fire({input:'text', title:'اسم الطالب'}).then(r=>{if(r.value){db.ref('students').push({name:r.value, class:cls}); checkCls(cls);}});
        }
        function addTeacher() { Swal.fire({input:'text', title:'اسم المعلم'}).then(r=>{if(r.value)db.ref('teachers').push({name:r.value})}); }
        function moveStu(k) { Swal.fire({input:'text', title:'الفصل الجديد'}).then(r=>{if(r.value){db.ref('students/'+k).update({class:r.value}); checkCls(r.value);}}); }
        function del(p) { Swal.fire({title:'حذف؟', showCancelButton:true}).then(r=>{if(r.isConfirmed)db.ref(p).remove()}); }
        function delAll(p) { Swal.fire({title:'حذف الكل؟', showCancelButton:true}).then(r=>{if(r.isConfirmed)db.ref(p).remove()}); }
        function checkCls(c) { if(!data.classes.includes(c)) { let n=data.classes; n.push(c); db.ref('classes').set(n); } }
        function importData(inp, t) {
            const f=inp.files[0], cls=document.getElementById('imp-cls').value;
            if(t==='students' && !cls) return Swal.fire('تنبيه','حدد الفصل','warning');
            const r=new FileReader();
            r.onload=e=>{
                const w=XLSX.read(e.target.result,{type:'array'});
                const j=XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]],{header:1});
                j.forEach(r=>{if(r[0]) db.ref(t).push({name:r[0], class:cls||''})});
                if(t==='students') checkCls(cls);
                Swal.fire('تم الاستيراد');
            }; r.readAsArrayBuffer(f);
        }
        function filterTable(id,v) { document.querySelectorAll(`#${id} tbody tr`).forEach(r=>r.style.display=r.innerText.includes(v)?'':'none'); }
        function newCode() { db.ref('code').set(Math.floor(1000+Math.random()*9000)); }
        function newGuard() { Swal.fire({input:'text'}).then(r=>{if(r.value)db.ref('guard').set(r.value)}); }

        // ================= GUARD & AGENT =================
        function sendVisitor() {
            const v={name:document.getElementById('v-name').value, id:document.getElementById('v-id').value, reason:document.getElementById('v-reason').value, status:'wait', time:new Date().toLocaleString()};
            if(v.name) { db.ref('visitors').push(v); Swal.fire('تم الإرسال'); document.querySelectorAll('#sec-guard input').forEach(i=>i.value=''); }
        }
        function renderGuard() {
            document.getElementById('g-list').innerHTML = Object.values(data.visitors||{}).reverse().map(v=>`<div class="list-group-item d-flex justify-content-between"><span>${v.name}</span><span class="badge ${v.status==='ok'?'bg-success':(v.status==='no'?'bg-danger':'bg-warning')}">${v.status==='wait'?'انتظار':(v.status==='ok'?'مسموح':'مرفوض')}</span></div>`).join('');
        }
        function renderAgent() {
            document.getElementById('ag-list').innerHTML = Object.entries(data.visitors||{}).filter(([k,v])=>v.status==='wait').map(([k,v])=>`<div class="list-group-item"><div><strong>${v.name}</strong><br>${v.reason}</div><div class="mt-2"><button class="btn btn-success btn-sm" onclick="db.ref('visitors/${k}').update({status:'ok'})">موافقة</button> <button class="btn btn-danger btn-sm" onclick="db.ref('visitors/${k}').update({status:'no'})">رفض</button></div></div>`).join('');
        }
        function sendDep() {
            const n=document.getElementById('dep-n').value, r=document.getElementById('dep-r').value;
            if(n) { db.ref('departures').push({name:n, reason:r, time:new Date().toLocaleString()}); Swal.fire('تم'); }
        }

        // ================= REPORTS =================
        function repView(t, btn) {
            if(btn) { document.querySelectorAll('#sec-reports button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
            const th=document.getElementById('rep-th'), tb=document.getElementById('rep-tb');
            document.getElementById('rep-title').innerText = t==='all'?'سجل الأذونات':(t==='vis'?'سجل الزوار':(t==='dep'?'سجل الانصراف':'الإحصائيات'));
            
            if(t==='all') {
                th.innerHTML='<tr><th>الطالب</th><th>الوجهة</th><th>الوقت</th></tr>';
                tb.innerHTML=Object.values(data.permits||{}).reverse().map(p=>`<tr><td>${p.student}</td><td>${p.dest}</td><td>${new Date(p.start).toLocaleString()}</td></tr>`).join('');
            } else if(t==='vis') {
                th.innerHTML='<tr><th>الزائر</th><th>السبب</th><th>الحالة</th></tr>';
                tb.innerHTML=Object.values(data.visitors||{}).reverse().map(v=>`<tr><td>${v.name}</td><td>${v.reason}</td><td>${v.status}</td></tr>`).join('');
            } else if(t==='dep') {
                th.innerHTML='<tr><th>الطالب</th><th>السبب</th><th>الوقت</th></tr>';
                tb.innerHTML=Object.values(data.departures||{}).reverse().map(d=>`<tr><td>${d.name}</td><td>${d.reason}</td><td>${d.time}</td></tr>`).join('');
            } else {
                th.innerHTML='<tr><th>الطالب</th><th>العدد</th></tr>';
                const c={}; Object.values(data.permits||{}).forEach(p=>{c[p.student]=(c[p.student]||0)+1});
                tb.innerHTML=Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,20).map(([n,k])=>`<tr><td>${n}</td><td>${k}</td></tr>`).join('');
            }
        }
    </script>
</body>
</html>