<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#006C35">
    <meta name="format-detection" content="telephone=no">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø°Ù† (V126.0 Mobile Pro)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* ================= Core Styles ================= */
        :root { --primary: #006C35; --gold: #C69C6D; --bg: #F0F2F5; --card: #ffffff; --text: #1E293B; --border: #E2E8F0; --distinct: #6f42c1; }
        
        /* Reset & Mobile Optimization */
        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; touch-action: manipulation; }
        
        body { 
            font-family: 'Tajawal', sans-serif; background-color: var(--bg); color: var(--text); 
            overflow-x: hidden; visibility: hidden; padding-bottom: 100px;
            overscroll-behavior-y: none; /* ÙŠÙ…Ù†Ø¹ Ø³Ø­Ø¨ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„Ø£Ø³ÙÙ„ */
            -webkit-user-select: none; user-select: none;
        }

        /* Input Fixes for Mobile (No Zoom) */
        input, textarea, select, .form-control, .form-select { 
            -webkit-user-select: text; user-select: text; 
            font-size: 16px !important; /* Ø­Ø¬Ù… 16 ÙŠÙ…Ù†Ø¹ Ø²ÙˆÙ… Ø§Ù„Ø§ÙŠÙÙˆÙ† */
            border-radius: 12px !important;
            padding: 12px !important;
            height: auto !important;
        }
        
        /* Larger Buttons for Touch */
        .btn { 
            border-radius: 12px; font-weight: 800; padding: 12px 20px; 
            transition: transform 0.1s; display: flex; align-items: center; justify-content: center;
        }
        .btn:active { transform: scale(0.96); } /* ØªØ£Ø«ÙŠØ± Ø¶ØºØ· Ø§Ù„Ø²Ø± */
        
        /* Cards */
        .page-card { 
            background: var(--card); border-radius: 20px; border: none; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 15px; padding: 20px; 
        }

        /* Top Bar - Sticky & Frosted */
        #top-bar { 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; 
            position: fixed; top: 0; left:0; width: 100%; z-index: 900; 
            border-bottom: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            padding-top: calc(10px + env(safe-area-inset-top)); height: calc(75px + env(safe-area-inset-top));
        }

        /* Layout & Sidebar */
        .main-content { margin-right: 0; padding: 15px; padding-top: calc(95px + env(safe-area-inset-top)); min-height: 100vh; transition: all 0.3s ease; }
        
        .sidebar { 
            width: 85%; max-width: 320px; height: 100vh; background: var(--primary); color: white; 
            position: fixed; right: 0; top: 0; z-index: 2000; 
            box-shadow: -10px 0 30px rgba(0,0,0,0.2); 
            display: flex; flex-direction: column; padding-top: env(safe-area-inset-top); 
            transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .sidebar.active { transform: translateX(0); }
        .sidebar-backdrop { 
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); 
            z-index: 1999; display: none; backdrop-filter: blur(3px);
        }
        .sidebar-backdrop.active { display: block; }

        .nav-link { padding: 18px 25px; border-bottom: 1px solid rgba(255,255,255,0.1); color: white; cursor: pointer; font-weight: 700; font-size: 1.1rem; }
        .nav-link:active { background: rgba(255,255,255,0.1); }

        /* Dashboard Items */
        .stat-box { background: #fff; padding: 15px; border-radius: 16px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .monitor-card { background: white; border-radius: 20px; padding: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative; }
        .monitor-card.danger { border-bottom: 5px solid #dc3545; background: #fff5f5; }
        .monitor-card.safe { border-bottom: 5px solid #198754; }

        /* Overlays (Smart Board) */
        .full-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%); z-index: 10000; display: none; overflow: hidden; color: white; }
        .overlay-close { position: absolute; top: calc(30px + env(safe-area-inset-top)); left: 30px; z-index: 10001; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 10px 25px; border-radius: 50px; font-weight: bold; backdrop-filter: blur(5px); }
        
        .smart-board-container { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .board-slide { display: none; width: 100%; height: 100%; animation: fadeIn 0.8s ease; flex-direction: column; align-items: center; justify-content: center; }
        .board-slide.active { display: flex; }
        
        .discipline-list { width: 100%; max-width: 600px; }
        .discipline-item { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 15px; margin-bottom: 12px; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #FFD700; }
        
        .showcase-frame { max-height: 60vh; max-width: 100%; border: 5px solid #fff; border-radius: 20px; overflow: hidden; background: #000; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .showcase-frame img { width: 100%; height: 100%; object-fit: contain; }

        /* Back Button */
        #global-back-btn {
            position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px;
            background: var(--distinct); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 25px rgba(111, 66, 193, 0.5); z-index: 800;
            border: 3px solid white; transition: transform 0.2s;
        }
        #global-back-btn:active { transform: scale(0.9); }

        /* Login */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #004d26, #006C35); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: white; padding: 40px 30px; border-radius: 30px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }

        /* Print */
        #final-print-container { display: none; }
        @media print {
            body > * { display: none !important; }
            #final-print-container { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: white; z-index: 999999; padding: 20px; }
            #final-print-container * { visibility: visible; }
            .no-print { display: none !important; }
            @page { size: A4; margin: 5mm; }
        }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Mobile Specific Tweaks */
        @media (max-width: 768px) {
            .stat-box h3 { font-size: 1.5rem; margin-bottom: 0; }
            .col-6 { padding-left: 5px; padding-right: 5px; } /* Tighten grid */
            h5 { font-size: 1.1rem; }
        }
    </style>
</head>
<body>
    <div class="sidebar-backdrop" onclick="document.querySelector('.sidebar').classList.remove('active'); this.classList.remove('active');"></div>
    <div class="custom-toast" id="system-toast" style="display:none; position:fixed; top:80px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:12px 30px; border-radius:50px; z-index:11000; font-weight:bold; box-shadow:0 5px 15px rgba(0,0,0,0.2);">ØªÙ†Ø¨ÙŠÙ‡</div>

    <div id="smart-board-overlay" class="full-overlay">
        <button class="overlay-close" onclick="closeSmartBoard()"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
        <div class="smart-board-container">
            <div id="slide-showcase" class="board-slide active">
                <div class="showcase-frame"><img id="disp-showcase-img" src=""></div>
                <h2 class="mt-4 text-warning fw-bold" id="disp-showcase-title"></h2>
            </div>
            <div id="slide-discipline" class="board-slide">
                <h2 class="mb-4 text-warning fw-bold" style="font-size:2rem">ğŸ’ Ù†Ø¬ÙˆÙ… Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· ğŸ’</h2>
                <div id="discipline-list-container" class="discipline-list"></div>
            </div>
        </div>
    </div>

    <div id="top-bar" class="no-print">
        <div class="d-flex align-items-center">
            <div style="width:12px; height:12px; background:#22c55e; border-radius:50%; margin-left:10px; box-shadow:0 0 5px #22c55e;" id="status-dot"></div>
            <h5 class="m-0 fw-bold text-dark">Ù†Ø¸Ø§Ù… Ø¥Ø°Ù†</h5>
        </div>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-light rounded-circle shadow-sm border" style="width:45px;height:45px;" onclick="toggleSidebar()"><i class="fas fa-bars text-dark"></i></button>
        </div>
    </div>

    <div id="global-back-btn" class="d-none animate__animated animate__fadeInUp" onclick="navigate('services')">
        <i class="fas fa-th-large fa-lg"></i>
    </div>

    <div id="auth-overlay">
        <div class="login-card fade-in">
            <div class="mb-4 text-success"><i class="fas fa-school fa-4x"></i></div>
            <h3 class="fw-bold mb-4">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
            <div id="role-selection">
                <button class="btn btn-outline-dark w-100 mb-3" onclick="selectRole('admin', 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©')">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
                <button class="btn btn-outline-success w-100 mb-3" onclick="selectRole('teacher', 'Ø§Ù„Ù…Ø¹Ù„Ù…')">Ø§Ù„Ù…Ø¹Ù„Ù…</button>
                <button class="btn btn-outline-secondary w-100 mb-3" onclick="selectRole('guard', 'Ø§Ù„Ø­Ø§Ø±Ø³')">Ø§Ù„Ø­Ø§Ø±Ø³</button>
                <button class="btn btn-outline-info w-100 mb-3" onclick="selectRole('counselor', 'Ø§Ù„Ù…ÙˆØ¬Ù‡')">Ø§Ù„Ù…ÙˆØ¬Ù‡</button>
            </div>
            <div id="pin-area" class="hidden">
                <h6 id="role-label" class="text-muted mb-3"></h6>
                <input type="tel" id="pin-input" class="form-control text-center fs-2 mb-3 fw-bold" placeholder="â€¢â€¢â€¢â€¢" maxlength="4">
                <button class="btn btn-success w-100 btn-lg rounded-pill shadow" onclick="doLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
                <button class="btn btn-link text-muted mt-3" onclick="backToRoles()">Ø±Ø¬ÙˆØ¹</button>
            </div>
        </div>
    </div>

    <div id="app-body" class="d-none">
        <aside class="sidebar no-print">
            <div class="text-center py-5 px-3">
                <div class="bg-white p-3 rounded-circle d-inline-block shadow-sm mb-3"><i class="fas fa-user-graduate fa-2x text-success"></i></div>
                <h6 class="fw-bold text-white mt-1" id="disp-school">...</h6>
            </div>
            <div id="nav-items" class="flex-grow-1 px-0 overflow-auto"></div>
            <div class="p-4"><button class="btn btn-outline-light w-100 rounded-pill" onclick="logOut()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button></div>
        </aside>

        <main class="main-content">
            <section id="sec-services" class="view-section fade-in">
                <div class="page-card bg-white border-start border-success border-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <label class="fw-bold text-dark small"><i class="fas fa-user-check me-1"></i> Ø§Ù„Ù…Ø¹Ù„Ù…:</label>
                        <select id="global-teacher-name" class="form-select border-0 bg-light fw-bold w-50" onchange="rememberTeacher(this.value)"><option value="">-- Ø§Ø®ØªØ± --</option></select>
                    </div>
                </div>

                <div id="admin-panel-content" class="d-none">
                     <div class="row g-2 mb-3">
                        <div class="col-6"><button class="btn btn-dark w-100 py-3 shadow-sm text-white" style="background:#2c3e50" onclick="openSmartBoard()"><i class="fas fa-desktop d-block mb-1 fa-lg"></i>Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø°ÙƒÙŠØ©</button></div>
                        <div class="col-6"><button class="btn btn-dark w-100 py-3 shadow-sm" style="background:#34495e" onclick="navigate('monitor')"><i class="fas fa-tv d-block mb-1 fa-lg"></i>Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button></div>
                        <div class="col-6"><button class="btn btn-warning w-100 py-3 shadow-sm text-dark" onclick="showReportModal('stars')"><i class="fas fa-star d-block mb-1 fa-lg"></i>Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</button></div>
                        <div class="col-6"><button class="btn btn-secondary w-100 py-3 shadow-sm" onclick="navigate('sec-data')"><i class="fas fa-cog d-block mb-1 fa-lg"></i>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button></div>
                    </div>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-4"><div class="stat-box"><h3 class="text-primary fw-bold" id="stat-exit">0</h3><small class="text-muted">Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬</small></div></div>
                        <div class="col-4"><div class="stat-box"><h3 class="text-success fw-bold" id="stat-visit">0</h3><small class="text-muted">Ø²ÙˆØ§Ø±</small></div></div>
                        <div class="col-4"><div class="stat-box"><h3 class="text-danger fw-bold" id="stat-vio">0</h3><small class="text-muted">Ù…Ø®Ø§Ù„ÙØ§Øª</small></div></div>
                    </div>

                    <div class="page-card p-0 overflow-hidden mb-3">
                        <div class="p-3 bg-light border-bottom fw-bold text-primary">Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù…Ø¹Ù„Ù‚ÙŠÙ†</div>
                        <div id="adm-vis-list" class="list-group list-group-flush"></div>
                    </div>
                    <div class="page-card p-0 overflow-hidden mb-3">
                        <div class="p-3 bg-light border-bottom fw-bold text-danger">Ù…Ø®Ø§Ù„ÙØ§Øª Ø­Ø¯ÙŠØ«Ø©</div>
                        <div id="adm-vio-list" class="p-3"></div>
                    </div>
                     <div class="page-card">
                        <h6 class="fw-bold mb-3 text-dark">Ø£Ù…Ø± Ø§Ù†ØµØ±Ø§Ù</h6>
                        <div class="input-group"><input id="adm-dep-name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"><button class="btn btn-primary" onclick="sendDeparture()"><i class="fas fa-paper-plane"></i></button></div>
                    </div>
                </div>

                <div class="d-flex bg-white p-2 rounded-4 shadow-sm mb-3 w-100 overflow-auto text-nowrap gap-2">
                    <button class="btn btn-success rounded-4 px-3 flex-fill" onclick="tabService('permit')">Ø®Ø±ÙˆØ¬</button>
                    <button class="btn btn-outline-primary rounded-4 px-3 flex-fill" onclick="tabService('attendance')">ØªØ­Ø¶ÙŠØ±</button>
                    <button class="btn btn-outline-warning rounded-4 px-3 flex-fill" onclick="tabService('behavior')">ØªÙ…ÙŠØ²</button>
                    <button class="btn btn-outline-danger rounded-4 px-3 flex-fill" onclick="tabService('violation')">Ù…Ø®Ø§Ù„ÙØ©</button>
                    <button class="btn btn-outline-dark rounded-4 px-3 admin-only d-none flex-fill" onclick="tabService('late')">ØªØ£Ø®Ø±</button>
                </div>
                
                <div id="srv-permit-box" class="page-card">
                    <h6 class="fw-bold mb-3 text-success"><i class="fas fa-clock me-2"></i> Ø¥Ø°Ù† Ù…Ø¤Ù‚Øª</h6>
                    <div class="row g-2">
                        <div class="col-12"><select id="t-class" class="form-select" onchange="loadStudentsForRole(this.value, 't-stu')"><option>Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option></select></div>
                        <div class="col-12"><select id="t-stu" class="form-select" disabled><option>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</option></select></div>
                        <div class="col-12"><select id="t-dest" class="form-select"><option>Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡</option><option>Ø§Ù„ÙˆÙƒÙŠÙ„</option><option>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</option><option>Ø§Ù„Ù…Ù‚ØµÙ</option></select></div>
                        <div class="col-7"><input type="tel" id="t-time" class="form-control text-center" placeholder="Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)"></div>
                        <div class="col-5"><div class="form-check bg-light rounded p-2 ps-5 h-100 d-flex align-items-center"><input class="form-check-input" type="checkbox" id="t-special"><label class="small fw-bold ms-2">Ø®Ø§Øµ</label></div></div>
                        <div class="col-12 mt-3"><button class="btn btn-success w-100 py-3 shadow-sm" onclick="sendPermit()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button></div>
                    </div>
                </div>

                <div id="srv-attendance-box" class="page-card d-none">
                    <h6 class="fw-bold mb-3 text-primary">Ø§Ù„ØªØ­Ø¶ÙŠØ±</h6>
                    <div class="d-flex justify-content-center mb-3 bg-light p-1 rounded-pill">
                        <button class="btn btn-sm btn-primary w-50 rounded-pill" id="btn-mode-period" onclick="setAttMode('period')">Ø¨Ø§Ù„Ø­ØµØ©</button>
                        <button class="btn btn-sm btn-outline-primary w-50 rounded-pill" id="btn-mode-day" onclick="setAttMode('day')">ÙŠÙˆÙ… ÙƒØ§Ù…Ù„</button>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><select id="att-class" class="form-select" onchange="loadAttendanceList()"><option>Ø§Ù„ÙØµÙ„</option></select></div>
                        <div class="col-6" id="div-att-period"><select id="att-period" class="form-select" onchange="loadAttendanceList()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option></select></div>
                        <div class="col-12"><button class="btn btn-outline-primary w-100 btn-sm" onclick="loadAttendanceList()">ØªØ­Ø¯ÙŠØ«</button></div>
                    </div>
                    <div id="att-list-body" class="d-grid gap-2" style="max-height:300px; overflow-y:auto;"></div>
                </div>

                <div id="srv-behavior-box" class="page-card d-none">
                    <h6 class="fw-bold mb-3 text-warning">Ù†Ù‚Ø§Ø· Ø§Ù„ØªÙ…ÙŠØ²</h6>
                    <div class="row g-2">
                        <div class="col-12"><select id="b-class" class="form-select" onchange="loadStudentsForRole(this.value, 'b-stu')"><option>Ø§Ù„ÙØµÙ„</option></select></div>
                        <div class="col-12"><select id="b-stu" class="form-select" disabled><option>Ø§Ù„Ø·Ø§Ù„Ø¨</option></select></div>
                        <div class="col-12"><select id="b-reason" class="form-select"><option>Ø§Ù†Ø¶Ø¨Ø§Ø· Ù…Ø¯Ø±Ø³ÙŠ</option><option>Ù…Ø´Ø§Ø±ÙƒØ© ØµÙÙŠØ©</option><option>ÙˆØ§Ø¬Ø¨Ø§Øª</option><option>Ù†Ø¸Ø§ÙØ©</option><option>Ù…Ø¨Ø§Ø¯Ø±Ø©</option></select></div>
                        <div class="col-6 mt-3"><button class="btn btn-warning w-100 py-3" onclick="sendStar()">Ù…Ù†Ø­ (+)</button></div>
                        <div class="col-6 mt-3"><button class="btn btn-outline-danger w-100 py-3" onclick="deductStar()">Ø®ØµÙ… (-)</button></div>
                    </div>
                </div>

                <div id="srv-violation-box" class="page-card d-none">
                    <h6 class="fw-bold mb-3 text-danger">Ù…Ø®Ø§Ù„ÙØ© Ø³Ù„ÙˆÙƒÙŠØ©</h6>
                    <div class="row g-2">
                        <div class="col-12"><select id="v-class" class="form-select" onchange="loadStudentsForRole(this.value, 'v-stu')"><option>Ø§Ù„ÙØµÙ„</option></select></div>
                        <div class="col-12"><select id="v-stu" class="form-select" disabled><option>Ø§Ù„Ø·Ø§Ù„Ø¨</option></select></div>
                        <div class="col-12"><input id="v-type" class="form-control" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©"></div>
                        <div class="col-12"><textarea id="v-desc" class="form-control" rows="2" placeholder="ØªÙØ§ØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea></div>
                        <div class="col-12 mt-3"><button class="btn btn-danger w-100 py-3 shadow-sm" onclick="sendViolation()">Ø±ÙØ¹ Ù„Ù„ÙˆÙƒÙŠÙ„</button></div>
                    </div>
                </div>

                 <div id="srv-late-box" class="page-card d-none">
                    <h6 class="fw-bold mb-3 text-dark">Ø±ØµØ¯ Ø§Ù„ØªØ£Ø®Ø±</h6>
                    <div class="row g-2">
                        <div class="col-12"><select id="late-class" class="form-select" onchange="loadStudentsForRole(this.value, 'late-stu')"><option>Ø§Ù„ÙØµÙ„</option></select></div>
                        <div class="col-12"><select id="late-stu" class="form-select" disabled><option>Ø§Ù„Ø·Ø§Ù„Ø¨</option></select></div>
                        <div class="col-12 mt-3"><button class="btn btn-warning w-100 py-3" onclick="registerLate()">ØªØ³Ø¬ÙŠÙ„</button></div>
                    </div>
                </div>
                
                <div class="row g-2 mt-2">
                    <div class="col-12"><button class="btn btn-outline-dark w-100 py-3 rounded-4 admin-only d-none" onclick="navigate('reports')">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button></div>
                </div>
            </section>

            <section id="sec-monitor" class="view-section d-none fade-in">
                <div class="d-flex justify-content-between mb-3"><h5 class="fw-bold">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­ÙŠØ©</h5></div>
                <div id="monitor-grid" class="row g-2"></div>
                <div id="no-students" class="text-center py-5 d-none"><i class="fas fa-check-circle fa-4x text-success opacity-25"></i><h5 class="mt-3 text-muted">Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¨Ø§Ù„ÙØµÙˆÙ„</h5></div>
            </section>

            <section id="sec-reports" class="view-section d-none fade-in">
                <h5 class="fw-bold mb-3">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h5>
                <div class="row g-2">
                    <div class="col-6"><div class="report-grid-item" onclick="showReportModal('permits')"><i class="fas fa-file-invoice text-primary fa-lg mb-2"></i><h6 class="small m-0">Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª</h6></div></div>
                    <div class="col-6"><div class="report-grid-item" onclick="showReportModal('visitors')"><i class="fas fa-user-shield text-dark fa-lg mb-2"></i><h6 class="small m-0">Ø§Ù„Ø²ÙˆØ§Ø±</h6></div></div>
                    <div class="col-6"><div class="report-grid-item" onclick="showReportModal('violations')"><i class="fas fa-exclamation-triangle text-danger fa-lg mb-2"></i><h6 class="small m-0">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h6></div></div>
                    <div class="col-6"><div class="report-grid-item" onclick="showReportModal('attendance')"><i class="fas fa-calendar-check text-success fa-lg mb-2"></i><h6 class="small m-0">Ø§Ù„ØºÙŠØ§Ø¨</h6></div></div>
                    <div class="col-12"><div class="report-grid-item d-flex align-items-center justify-content-center gap-2" onclick="showReportModal('top_class')"><i class="fas fa-medal text-warning m-0"></i><h6 class="m-0 fw-bold">Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ</h6></div></div>
                </div>
            </section>

            <section id="sec-guard" class="view-section d-none fade-in">
                <div class="page-card mb-3">
                    <h5 class="fw-bold mb-3 text-center">ØªØ³Ø¬ÙŠÙ„ Ø²Ø§Ø¦Ø±</h5>
                    <input id="g-v-name" class="form-control mb-2" placeholder="Ø§Ù„Ø§Ø³Ù…">
                    <input type="tel" id="g-v-id" class="form-control mb-2" placeholder="Ø§Ù„Ù‡ÙˆÙŠØ©">
                    <input id="g-v-reason" class="form-control mb-3" placeholder="Ø§Ù„Ø³Ø¨Ø¨">
                    <button class="btn btn-dark w-100 py-3 rounded-pill" onclick="sendVisitorReq()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨</button>
                </div>
                <div class="page-card border-danger border-top border-4">
                    <h6 class="fw-bold text-danger mb-3">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø®Ø±ÙˆØ¬</h6>
                    <div id="g-dep-list"></div>
                </div>
            </section>

            <section id="sec-counselor" class="view-section d-none fade-in">
                <div class="page-card p-3">
                    <h6 class="fw-bold mb-2">Ø¨Ø­Ø« Ø·Ø§Ù„Ø¨</h6>
                    <div class="input-group"><input type="text" id="stu-search-name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..."><button class="btn btn-success" onclick="searchStudentHistory()"><i class="fas fa-search"></i></button></div>
                    <div id="stu-history-res" class="d-none bg-light p-3 rounded mt-3"></div>
                </div>
            </section>

            <section id="sec-data" class="view-section d-none fade-in">
                <h5 class="fw-bold mb-3 text-primary">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h5>
                
                <div class="page-card mb-3">
                    <h6 class="fw-bold mb-3"><i class="fas fa-desktop me-2"></i> Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø°ÙƒÙŠØ©</h6>
                    <label class="small text-muted mb-1">ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø±Ø¶</label>
                    <input type="file" id="set-showcase-img" class="form-control mb-2">
                    <label class="small text-muted mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                    <input id="set-showcase-title" class="form-control mb-2" placeholder="Ù…Ø«Ø§Ù„: Ø±Ø³ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨">
                    <button class="btn btn-dark w-100 mt-2" onclick="saveBroadcastSettings()">Ø­ÙØ¸</button>
                </div>

                <div class="page-card mb-3">
                    <h6 class="fw-bold text-danger mb-3"><i class="fas fa-lock me-2"></i> Ø§Ù„Ø±Ù…ÙˆØ²</h6>
                    <div class="row g-2">
                        <div class="col-6"><input type="tel" id="pin-admin" class="form-control" placeholder="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©"></div>
                        <div class="col-6"><input type="tel" id="pin-teacher" class="form-control" placeholder="Ø§Ù„Ù…Ø¹Ù„Ù…"></div>
                        <div class="col-6"><input type="tel" id="pin-guard" class="form-control" placeholder="Ø§Ù„Ø­Ø§Ø±Ø³"></div>
                        <div class="col-12"><button class="btn btn-danger w-100 mt-2" onclick="savePasswords()">ØªØ­Ø¯ÙŠØ«</button></div>
                    </div>
                </div>

                <div class="page-card">
                    <h6 class="fw-bold text-success mb-3"><i class="fas fa-database me-2"></i> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h6>
                    <button class="btn btn-outline-success w-100 mb-2" onclick="document.getElementById('f-tea-excel').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø¹Ù„Ù…ÙŠÙ† (Excel)</button>
                    <input type="file" id="f-tea-excel" hidden onchange="importTeachers(this)">
                    
                    <div class="input-group mb-3">
                        <input id="imp-cls-name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØµÙ„">
                        <button class="btn btn-primary" onclick="document.getElementById('f-excel').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø·Ù„Ø§Ø¨</button>
                    </div>
                    <input type="file" id="f-excel" hidden onchange="importData(this)">

                    <div class="d-grid gap-2">
                        <button class="btn btn-light border" onclick="exportData()">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                        <button class="btn btn-light border text-danger" onclick="secureReset('reports')">ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal fade" id="printModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content"><div class="modal-header border-0"><h5 class="modal-title fw-bold">Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body bg-white" id="modal-print-content"></div><div class="modal-footer border-0"><button type="button" class="btn btn-primary w-100 fw-bold py-3 rounded-pill" onclick="executePrint()">Ø·Ø¨Ø§Ø¹Ø© PDF</button></div></div></div></div>
    <div id="final-print-container"></div>
    
    <script>
        const firebaseConfig = { apiKey: "AIzaSyD0IJONOe7Ef4a0XG8L1Cgbc1qVSSck0xE", authDomain: "ethn-63848.firebaseapp.com", databaseURL: "https://ethn-63848-default-rtdb.firebaseio.com", projectId: "ethn-63848", storageBucket: "ethn-63848.appspot.com", messagingSenderId: "747489913596", appId: "1:747489913596:web:d98d88447e4a25cc808579" };
        firebase.initializeApp(firebaseConfig); const db = firebase.database();
        let userRole='', attMode='period', smartBoardInterval;
        let data = { settings: {admin_pin:'2026', teacher_pin:'2026', guard_pin:'1111', counselor_pin:'2026', broadcast:{}}, classes:[], students:{}, teachers:{}, permits:{}, visitors:{}, violations:{}, departures:{}, attendance:{}, stars:{}, tardiness:{} };

        // --- Init & Auth ---
        window.onload = () => {
            const savedRole = localStorage.getItem('userRole');
            db.ref('/').on('value', snap => {
                const val = snap.val();
                if(val) {
                    data = { ...data, ...val };
                    document.body.style.visibility = 'visible';
                    document.getElementById('disp-school').innerText = data.settings.school || 'Ù…Ø¯Ø±Ø³ØªÙŠ';
                    
                    if(savedRole && !userRole) {
                        userRole = savedRole;
                        document.getElementById('auth-overlay').style.display='none';
                        document.getElementById('app-body').classList.remove('d-none');
                        buildMenu();
                        navigate('services'); 
                    } else if(userRole) { refreshScreens(); renderAdmin(); }
                }
            });
            setInterval(monitorLoop, 10000);
        };

        function selectRole(r, t) { userRole=r; document.getElementById('role-selection').classList.add('hidden'); document.getElementById('pin-area').classList.remove('hidden'); document.getElementById('role-label').innerText='ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„: '+t; }
        function backToRoles() { document.getElementById('pin-area').classList.add('hidden'); document.getElementById('role-selection').classList.remove('hidden'); userRole=''; }
        function doLogin() { 
            if(document.getElementById('pin-input').value === String(data.settings[`${userRole}_pin`])) { 
                localStorage.setItem('userRole', userRole); document.getElementById('auth-overlay').style.display='none'; document.getElementById('app-body').classList.remove('d-none'); 
                buildMenu(); navigate(userRole==='guard'?'guard':(userRole==='admin'?'services':'services')); 
            } else { showToast('Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­'); } 
        }

        // --- Navigation ---
        function toggleSidebar() { 
            const sb = document.querySelector('.sidebar'); const bd = document.querySelector('.sidebar-backdrop');
            sb.classList.toggle('active'); bd.classList.toggle('active');
        }

        function buildMenu() {
            const m = document.getElementById('nav-items');
            let links = [['services','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©']];
            if(userRole==='admin' || userRole==='teacher') links.push(['reports','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±']);
            if(userRole==='admin') links.push(['sec-data','Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª']);
            
            m.innerHTML = links.map(l => `<div class="nav-link" onclick="navigate('${l[0]}'); toggleSidebar()">${l[1]}</div>`).join('');
        }

        function navigate(id) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.add('d-none'));
            const target = document.getElementById('sec-'+id);
            if(target) target.classList.remove('d-none');

            // Manage Back Button
            const btn = document.getElementById('global-back-btn');
            if(id === 'services') btn.classList.add('d-none');
            else btn.classList.remove('d-none');

            // Admin Logic
            if(id === 'services') {
                if(userRole === 'admin') {
                    document.getElementById('admin-panel-content').classList.remove('d-none');
                    document.querySelectorAll('.admin-only').forEach(e=>e.classList.remove('d-none'));
                } else {
                    document.getElementById('admin-panel-content').classList.add('d-none');
                    document.querySelectorAll('.admin-only').forEach(e=>e.classList.add('d-none'));
                }
            }
            
            if(id==='monitor') renderMonitor();
            if(id==='sec-data') populateSettingsUI();
            refreshScreens();
        }

        function tabService(tab) {
            document.querySelectorAll('#sec-services .page-card').forEach(c => { if(c.id.includes('srv-')) c.classList.add('d-none'); });
            const target = document.getElementById('srv-' + tab + '-box'); if(target) target.classList.remove('d-none');
        }

        // --- Smart Board ---
        function openSmartBoard() {
            document.getElementById('smart-board-overlay').style.display = 'block';
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            
            if(data.settings.broadcast?.showcaseImg) {
                document.getElementById('disp-showcase-img').src = data.settings.broadcast.showcaseImg;
                document.getElementById('disp-showcase-title').innerText = data.settings.broadcast.showcaseTitle || '';
            }

            const scores = {};
            Object.values(data.students || {}).forEach(s => { scores[s.name] = 100; }); 
            Object.values(data.attendance || {}).forEach(day => { if(day.full_day) Object.keys(day.full_day).forEach(name => { if(scores[name]) scores[name] -= 1; }); });
            Object.values(data.tardiness || {}).forEach(t => { if(scores[t.student]) scores[t.student] -= 0.5; });

            const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]).slice(0, 10);
            document.getElementById('discipline-list-container').innerHTML = sorted.map((s, i) => 
                `<div class="discipline-item"><div class="fw-bold fs-4 text-white">${i+1}. ${s[0]}</div><div class="badge bg-warning text-dark fs-5">${s[1]}%</div></div>`
            ).join('');

            let showSlide1 = true;
            smartBoardInterval = setInterval(() => {
                document.getElementById('slide-showcase').classList.toggle('active', showSlide1);
                document.getElementById('slide-discipline').classList.toggle('active', !showSlide1);
                showSlide1 = !showSlide1;
            }, 6000);
        }

        function closeSmartBoard() {
            document.getElementById('smart-board-overlay').style.display = 'none';
            clearInterval(smartBoardInterval);
            if (document.exitFullscreen) document.exitFullscreen();
        }

        // --- Core Logic ---
        function showToast(msg) { const t=document.getElementById('system-toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }

        function refreshScreens() {
            ['t-class','v-class','b-class','att-class','late-class'].forEach(id=>{ 
                const e=document.getElementById(id); if(e) {
                    const val = e.value;
                    e.innerHTML='<option value="">Ø§Ù„ÙØµÙ„</option>'+(data.classes||[]).map(c=>`<option value="${c}">${c}</option>`).join('');
                    if(val) e.value = val;
                }
            });
            const te = document.getElementById('global-teacher-name');
            if(te) {
                const val = te.value;
                te.innerHTML='<option value="">-- Ø§Ø®ØªØ± --</option>'+Object.values(data.teachers||{}).map(t=>`<option value="${t.name}">${t.name}</option>`).join('');
                if(val) te.value = val; else { const s=localStorage.getItem('teacher'); if(s) te.value=s; }
            }
        }

        function loadStudentsForRole(c, id) { 
            const e=document.getElementById(id); e.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</option>'; e.disabled=false; 
            Object.values(data.students||{}).filter(s=>s.class===c).forEach(s=>e.innerHTML+=`<option value="${s.name}">${s.name}</option>`); 
        }

        function sendPermit() { 
            if(!document.getElementById('t-stu').value) return showToast('Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨');
            db.ref('permits').push({
                student:document.getElementById('t-stu').value, teacher:document.getElementById('global-teacher-name').value, 
                class:document.getElementById('t-class').value, dest:document.getElementById('t-dest').value, 
                limit:document.getElementById('t-time').value || 10, start:new Date().toISOString(), active:true
            });
            showToast('ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬'); navigate('monitor');
        }

        function renderMonitor() { 
            const g = document.getElementById('monitor-grid'); 
            const l = Object.entries(data.permits||{}).filter(x=>x[1].active); 
            document.getElementById('no-students').classList.toggle('d-none', l.length>0); 
            g.innerHTML = l.map(([k,p])=>{ 
                const m = Math.floor((new Date()-new Date(p.start))/60000); 
                return `<div class="col-6 col-md-4"><div class="monitor-card ${m>=p.limit?'danger':'safe'}"><h6 class="fw-bold mb-1">${p.student}</h6><small class="d-block mb-2 text-muted">${p.dest}</small><h3 class="mb-2">${m} Ø¯</h3><button class="btn btn-dark btn-sm w-100 rounded-pill" onclick="db.ref('permits/${k}').update({active:false})">Ø¹ÙˆØ¯Ø©</button></div></div>`; 
            }).join(''); 
        }

        function setAttMode(mode) { attMode = mode; document.getElementById('btn-mode-period').className = mode === 'period' ? 'btn btn-primary w-50 rounded-pill' : 'btn btn-outline-primary w-50 rounded-pill'; document.getElementById('btn-mode-day').className = mode === 'day' ? 'btn btn-primary w-50 rounded-pill' : 'btn btn-outline-primary w-50 rounded-pill'; document.getElementById('div-att-period').style.visibility = mode === 'period' ? 'visible' : 'hidden'; loadAttendanceList(); }
        
        function loadAttendanceList() {
            const cls = document.getElementById('att-class').value;
            const period = document.getElementById('att-period').value;
            const body = document.getElementById('att-list-body');
            const today = new Date().toLocaleDateString('en-CA');
            if(!cls) return;
            const students = Object.values(data.students || {}).filter(s => s.class === cls);
            body.innerHTML = students.map(s => {
                let isAbsent = attMode === 'day' ? data.attendance?.[today]?.['full_day']?.[s.name] === true : data.attendance?.[today]?.['periods']?.[period]?.[s.name] === 'absent';
                return `<div class="d-flex justify-content-between align-items-center bg-light p-3 rounded-4 mb-2 shadow-sm border" onclick="toggleAtt('${today}', '${s.name}', ${isAbsent})">
                    <span class="fw-bold">${s.name}</span>
                    <span class="badge rounded-pill ${isAbsent ? 'bg-danger' : 'bg-success'} p-2 px-3">${isAbsent ? 'ØºØ§Ø¦Ø¨' : 'Ø­Ø§Ø¶Ø±'}</span>
                </div>`;
            }).join('');
        }
        
        function toggleAtt(date, name, currentlyAbsent) {
            const period = document.getElementById('att-period').value;
            if (attMode === 'day') {
                if (currentlyAbsent) db.ref(`attendance/${date}/full_day/${name}`).remove(); else db.ref(`attendance/${date}/full_day/${name}`).set(true);
            } else {
                if (currentlyAbsent) db.ref(`attendance/${date}/periods/${period}/${name}`).remove(); else db.ref(`attendance/${date}/periods/${period}/${name}`).set('absent');
            }
            setTimeout(() => loadAttendanceList(), 100);
        }

        // Actions
        function sendStar() { db.ref('stars').push({student:document.getElementById('b-stu').value, reason:document.getElementById('b-reason').value, teacher:document.getElementById('global-teacher-name').value, value:1, date:new Date().toISOString()}); showToast('ØªÙ… Ø§Ù„Ù…Ù†Ø­'); }
        function deductStar() { db.ref('stars').push({student:document.getElementById('b-stu').value, reason:'Ø®ØµÙ…', teacher:document.getElementById('global-teacher-name').value, value:-1, date:new Date().toISOString()}); showToast('ØªÙ… Ø§Ù„Ø®ØµÙ…'); }
        function sendViolation() { db.ref('violations').push({student:document.getElementById('v-stu').value, type:document.getElementById('v-type').value, desc:document.getElementById('v-desc').value, status:'pending_admin', date:new Date().toLocaleDateString('ar-SA')}); showToast('ØªÙ… Ø§Ù„Ø±ÙØ¹'); }
        function registerLate() { db.ref('tardiness').push({student:document.getElementById('late-stu').value, date:new Date().toISOString()}); showToast('ØªÙ… Ø§Ù„Ø±ØµØ¯'); }
        function sendVisitorReq() { db.ref('visitors').push({name:document.getElementById('g-v-name').value, id:document.getElementById('g-v-id').value, reason:document.getElementById('g-v-reason').value, status:'pending', time:new Date().toISOString()}); document.getElementById('g-v-name').value=''; showToast('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); }
        function sendDeparture() { db.ref('departures').push({name:document.getElementById('adm-dep-name').value, status:'pending'}); document.getElementById('adm-dep-name').value=''; showToast('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); }

        // Admin & Stats
        function renderAdmin() {
            document.getElementById('adm-vis-list').innerHTML = Object.entries(data.visitors||{}).filter(x=>x[1].status==='pending').map(([k,v])=>`<div class="list-group-item d-flex justify-content-between align-items-center p-3 bg-white mb-1"><small class="fw-bold">${v.name}</small><div class="btn-group"><button class="btn btn-success btn-sm" onclick="db.ref('visitors/${k}').update({status:'approved'})">âœ”</button><button class="btn btn-danger btn-sm" onclick="db.ref('visitors/${k}').update({status:'rejected'})">âœ˜</button></div></div>`).join(''); 
            document.getElementById('adm-vio-list').innerHTML = Object.entries(data.violations||{}).filter(x=>x[1].status==='pending_admin').map(([k,v])=>`<div class="alert alert-danger p-2 small mb-2 d-flex justify-content-between align-items-center"><div><strong>${v.student}</strong><br>${v.type}</div><button class="btn btn-dark btn-sm" onclick="db.ref('violations/${k}').update({status:'pending_counselor'})">ØªØ­ÙˆÙŠÙ„</button></div>`).join('');
            document.getElementById('g-dep-list').innerHTML = Object.entries(data.departures||{}).filter(x=>x[1].status==='pending').map(([k,d])=>`<div class="alert alert-danger d-flex justify-content-between align-items-center p-2 mb-2"><strong>${d.name}</strong><button class="btn btn-success btn-sm" onclick="db.ref('departures/${k}').update({status:'exited'})">Ø®Ø±Ø¬</button></div>`).join('');
            
            document.getElementById('stat-exit').innerText = Object.values(data.permits||{}).filter(p=>p.active).length;
            document.getElementById('stat-visit').innerText = Object.values(data.visitors||{}).filter(v=>v.status==='pending').length;
            document.getElementById('stat-vio').innerText = Object.values(data.violations||{}).filter(v=>v.status==='pending_admin').length;
        }
        
        function monitorLoop() { if(!document.getElementById('sec-monitor').classList.contains('d-none')) renderMonitor(); }
        function rememberTeacher(v) { localStorage.setItem('teacher', v); }
        function logOut() { localStorage.removeItem('userRole'); location.reload(); }
        
        function showReportModal(type) { 
             const modal = new bootstrap.Modal(document.getElementById('printModal')); 
             const titles = { 'permits': 'Ø³Ø¬Ù„ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª', 'visitors': 'Ø³Ø¬Ù„ Ø§Ù„Ø²ÙˆØ§Ø±', 'violations': 'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª', 'attendance': 'Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ', 'stars': 'Ù†Ø¬ÙˆÙ… Ø§Ù„ØªÙ…ÙŠØ²', 'late': 'ØªØ£Ø®Ø± Ø§Ù„ØµØ¨Ø§Ø­', 'top_class': 'Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ' };
            
            let h = `<div class="text-center mb-4"><h4 class="fw-bold">${titles[type]}</h4><small class="text-muted">${new Date().toLocaleDateString('ar-SA')}</small></div>`;
            
            if(type==='permits') {
                h += `<table class="table table-striped text-center"><thead><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead><tbody>${Object.values(data.permits||{}).reverse().map(p=>`<tr><td>${p.student}<br><small class="text-muted">${p.dest}</small></td><td>${new Date(p.start).toLocaleTimeString('ar-SA', {hour:'2-digit',minute:'2-digit'})}</td></tr>`).join('')}</tbody></table>`;
            } else if(type==='attendance') {
                const t = new Date().toLocaleDateString('en-CA');
                h += `<table class="table table-striped text-center"><thead><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>`;
                Object.values(data.students||{}).forEach(s => { if(data.attendance?.[t]?.['full_day']?.[s.name]) h+=`<tr><td>${s.name}</td><td class="text-danger fw-bold">ØºÙŠØ§Ø¨</td></tr>`; });
                h+=`</tbody></table>`;
            } else if(type==='stars') { 
                 let s = {}; Object.values(data.stars||{}).forEach(st=>{ const val = st.value !== undefined ? st.value : 1; s[st.student] = (s[st.student]||0)+val; });
                 h+=`<table class="table table-striped text-center"><thead><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th></tr></thead><tbody>`;
                 Object.entries(s).filter(e=>e[1]>0).sort((a,b)=>b[1]-a[1]).forEach(x=> { h+=`<tr><td>${x[0]}</td><td><span class="badge bg-warning text-dark">${x[1]}</span></td></tr>`; });
                 h+=`</tbody></table>`;
            }

            document.getElementById('modal-print-content').innerHTML = h; modal.show();
        }
        
        function executePrint() { window.print(); }
        
        function saveBroadcastSettings() {
            const updates = { showcaseTitle: document.getElementById('set-showcase-title').value };
            const file = document.getElementById('set-showcase-img').files[0];
            if(file) { const r = new FileReader(); r.onload = e => { updates.showcaseImg = e.target.result; db.ref('settings/broadcast').update(updates).then(()=>showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸')); }; r.readAsDataURL(file); } else { db.ref('settings/broadcast').update(updates).then(()=>showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸')); }
        }
        function populateSettingsUI() {
             if(document.getElementById('pin-admin')) {
                 document.getElementById('pin-admin').value = data.settings.admin_pin || '';
                 document.getElementById('pin-teacher').value = data.settings.teacher_pin || '';
                 document.getElementById('pin-guard').value = data.settings.guard_pin || '';
                 document.getElementById('set-showcase-title').value = data.settings.broadcast?.showcaseTitle || '';
             }
        }
        function savePasswords() { db.ref('settings').update({admin_pin:document.getElementById('pin-admin').value, teacher_pin:document.getElementById('pin-teacher').value, guard_pin:document.getElementById('pin-guard').value}); showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«'); }
        function importData(inp) { const r=new FileReader(); r.onload=e=>{ const j=XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:'array'}).Sheets[XLSX.read(e.target.result,{type:'array'}).SheetNames[0]],{header:1}); const c=document.getElementById('imp-cls-name').value; j.forEach(r=>{if(r[0]) db.ref('students').push({name:r[0],class:c})}); let cl=data.classes||[]; if(!cl.includes(c)) {cl.push(c); db.ref('classes').set(cl);} showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); }; r.readAsArrayBuffer(inp.files[0]); }
        function importTeachers(inp) { const r=new FileReader(); r.onload=e=>{ const j=XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:'array'}).Sheets[XLSX.read(e.target.result,{type:'array'}).SheetNames[0]],{header:1}); j.forEach(r=>{if(r[0]) db.ref('teachers').push({name:r[0]})}); showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); }; r.readAsArrayBuffer(inp.files[0]); }
        function secureReset(type) { if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) { if(type==='reports') ['permits','visitors','violations','attendance','stars','tardiness'].forEach(p=>db.ref(p).remove()); location.reload(); } }
    </script>
</body>
</html>
