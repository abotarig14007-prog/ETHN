<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام إذن الرقمي (V38 Portal)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #0f4c3a; 
            --gold: #d4af37;
            --light-bg: #ffffff;
            --gray-bg: #f8f9fa;
        }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--light-bg); margin: 0; overflow-x: hidden; }

        /* ================= WAJHA: التصميم الجديد للشاشة الرئيسية ================= */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #ffffff 0%, #f1f1f1 100%);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .portal-header { text-align: center; margin-bottom: 50px; animation: fadeInDown 0.8s; }
        .portal-logo { width: 120px; margin-bottom: 20px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); }
        .portal-title { font-weight: 900; font-size: 2.5rem; color: var(--primary); margin: 0; letter-spacing: -1px; }
        .portal-subtitle { color: var(--gold); font-size: 1.2rem; font-weight: bold; }

        .roles-container {
            display: flex; gap: 30px; justify-content: center; flex-wrap: wrap; width: 100%; max-width: 1200px;
            animation: fadeInUp 1s;
        }

        .role-card {
            background: white; width: 280px; padding: 40px 20px; border-radius: 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.05); text-align: center; cursor: pointer;
            border: 2px solid transparent; transition: all 0.4s ease; position: relative; overflow: hidden;
        }
        
        /* الترتيب والتمييز */
        .role-card:hover { transform: translateY(-15px); box-shadow: 0 25px 50px rgba(15, 76, 58, 0.15); border-color: var(--primary); }
        
        .role-icon { font-size: 4rem; margin-bottom: 20px; display: block; transition: 0.4s; }
        .role-name { font-size: 1.8rem; font-weight: 800; color: #333; margin: 0; }
        .role-desc { font-size: 0.9rem; color: #888; margin-top: 10px; }

        /* ألوان خاصة لكل دور */
        .role-admin .role-icon { color: var(--primary); }
        .role-teacher .role-icon { color: var(--gold); }
        .role-visitor .role-icon { color: #555; }

        /* شاشة الرمز السري */
        #pin-screen {
            position: absolute; width: 100%; height: 100%; background: rgba(255,255,255,0.98);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            top: 0; left: 0; transition: 0.3s; backdrop-filter: blur(10px);
        }
        .pin-input { font-size: 3rem; letter-spacing: 20px; text-align: center; border: none; border-bottom: 4px solid var(--primary); width: 300px; background: transparent; outline: none; color: var(--primary); font-weight: bold; margin: 30px 0; }

        /* ================= DASHBOARD LAYOUT ================= */
        .sidebar { width: 280px; height: 100vh; background: var(--primary); color: white; position: fixed; right: 0; top: 0; z-index: 1000; overflow-y: auto; box-shadow: -5px 0 20px rgba(0,0,0,0.1); }
        .main-content { margin-right: 280px; padding: 40px; background: var(--gray-bg); min-height: 100vh; }
        
        .nav-link { color: rgba(255,255,255,0.7); padding: 18px 30px; font-size: 1.1rem; display: flex; align-items: center; border-right: 5px solid transparent; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; border-right-color: var(--gold); padding-right: 40px; }
        .nav-link i { width: 40px; font-size: 1.3rem; }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); width: 100%; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; padding: 20px; }
            .mobile-top { display: flex !important; }
            .roles-container { flex-direction: column; align-items: center; }
            .role-card { width: 80%; padding: 30px; }
        }
        .mobile-top { display: none; justify-content: space-between; align-items: center; background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border-radius: 15px; }

        /* ================= CARDS & TABLES ================= */
        .card-custom { background: white; border-radius: 20px; padding: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.04); border: none; overflow: hidden; margin-bottom: 30px; }
        .card-head { padding: 25px; border-bottom: 1px solid #f0f0f0; background: #fff; display: flex; justify-content: space-between; align-items: center; }
        .card-head h4 { margin: 0; font-weight: 800; color: var(--primary); }
        
        /* Monitor Grid */
        .monitor-card { background: white; padding: 25px; border-radius: 15px; border-right: 6px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.03); position: relative; }
        .monitor-card.safe { border-right-color: #2ecc71; }
        .monitor-card.danger { border-right-color: #e74c3c; animation: pulse 2s infinite; }
        
        .action-icon { width: 40px; height: 40px; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; margin: 0 5px; cursor: pointer; transition: 0.2s; }
        .action-icon:hover { transform: scale(1.1); }
        .bg-del { background: #fee2e2; color: #e74c3c; }
        .bg-edit { background: #e0f2fe; color: #3498db; }

        /* Animations */
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231,76,60,0.4); } 70% { box-shadow: 0 0 0 15px rgba(231,76,60,0); } }
        
        .hidden { display: none !important; }
        @media print { .no-print, .sidebar { display: none !important; } .main-content { margin: 0; padding: 0; } }
    </style>
</head>
<body>

    <div id="auth-overlay">
        
        <div class="portal-header">
            <img src="https://cdn-icons-png.flaticon.com/512/3209/3209265.png" class="portal-logo">
            <h1 class="portal-title">نظام إذن الرقمي</h1>
            <div class="portal-subtitle">متوسطة الإمام النووي</div>
        </div>

        <div class="roles-container">
            <div class="role-card role-admin" onclick="openPin('admin')">
                <i class="fas fa-user-tie role-icon"></i>
                <h3 class="role-name">الإدارة</h3>
                <p class="role-desc">التحكم الكامل والتقارير</p>
            </div>

            <div class="role-card role-teacher" onclick="openPin('teacher')">
                <i class="fas fa-chalkboard-teacher role-icon"></i>
                <h3 class="role-name">المعلم</h3>
                <p class="role-desc">إصدار أذونات الطلاب</p>
            </div>

            <div class="role-card role-visitor" onclick="openPin('guard')">
                <i class="fas fa-id-card-alt role-icon"></i>
                <h3 class="role-name">الزوار</h3>
                <p class="role-desc">بوابة التسجيل والدخول</p>
            </div>
        </div>

        <div id="pin-screen" class="hidden">
            <h2 class="mb-4 fw-bold text-dark" id="pin-title">أدخل الرمز</h2>
            <input type="password" id="pin-input" class="pin-input" placeholder="****" inputmode="numeric" maxlength="8">
            <div class="d-flex gap-3 mt-4">
                <button class="btn btn-lg btn-success px-5 rounded-pill fw-bold" onclick="login()">دخول</button>
                <button class="btn btn-lg btn-light px-5 rounded-pill" onclick="closePin()">عودة</button>
            </div>
        </div>
    </div>

    <div id="app-content" class="hidden">
        
        <div class="mobile-top">
            <h4 class="m-0 fw-bold text-primary">نظام إذن</h4>
            <button class="btn btn-light" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i class="fas fa-bars"></i></button>
        </div>

        <aside class="sidebar">
            <div class="text-center p-5 border-bottom border-secondary mb-3">
                <img src="https://cdn-icons-png.flaticon.com/512/3209/3209265.png" width="80" class="mb-3">
                <h5 class="fw-bold m-0">الإمام النووي</h5>
                <small class="text-white-50" id="current-role-txt">--</small>
            </div>
            <div id="menu-items"></div>
            <div class="p-4 mt-auto">
                <button class="btn btn-outline-danger w-100 py-2 rounded-pill fw-bold" onclick="location.reload()">
                    <i class="fas fa-sign-out-alt me-2"></i> خروج
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <section id="sec-monitor" class="view-sec">
                <div class="d-flex justify-content-between align-items-center mb-4 no-print">
                    <h2 class="fw-bold m-0 text-dark">المتابعة الحية</h2>
                    <div>
                        <button class="btn btn-light rounded-circle shadow-sm" id="mute-btn" onclick="toggleMute()"><i class="fas fa-volume-up text-primary"></i></button>
                    </div>
                </div>
                <div id="live-grid" class="row g-3"></div>
                <div id="no-active" class="text-center py-5 hidden text-muted">
                    <i class="fas fa-check-circle fa-4x mb-3 text-success opacity-50"></i>
                    <h3>جميع الطلاب في الفصول</h3>
                </div>
            </section>

            <section id="sec-data" class="view-sec hidden">
                <ul class="nav nav-pills mb-4 gap-3 bg-white p-2 rounded-4 shadow-sm d-inline-flex">
                    <li class="nav-item"><button class="nav-link text-dark active rounded-pill" onclick="tabData('students')">الطلاب</button></li>
                    <li class="nav-item"><button class="nav-link text-dark rounded-pill" onclick="tabData('teachers')">المعلمون</button></li>
                    <li class="nav-item"><button class="nav-link text-dark rounded-pill" onclick="tabData('system')">النظام</button></li>
                </ul>

                <div id="data-students" class="data-tab">
                    <div class="card-custom p-4">
                        <div class="row g-3 align-items-end mb-4">
                            <div class="col-md-3">
                                <label class="fw-bold mb-2">اسم الفصل (للاستيراد):</label>
                                <input list="dl-classes" id="inp-class" class="form-control" placeholder="مثلاً: 1/1">
                                <datalist id="dl-classes"></datalist>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-success w-100" onclick="document.getElementById('f-stu').click()">استيراد Excel</button>
                                <input type="file" id="f-stu" hidden onchange="importXLS(this, 'students')">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100" onclick="addOneStudent()">إضافة طالب</button>
                            </div>
                            <div class="col-md-3">
                                <input class="form-control" placeholder="بحث..." onkeyup="filterTbl('tbl-stu', this.value)">
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle" id="tbl-stu">
                                <thead class="table-light"><tr><th>الاسم</th><th>الفصل</th><th>تحكم</th></tr></thead>
                                <tbody id="body-stu"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="data-teachers" class="data-tab hidden">
                    <div class="card-custom p-4">
                        <div class="d-flex gap-3 mb-4">
                            <button class="btn btn-success" onclick="document.getElementById('f-tea').click()">استيراد معلمين</button>
                            <input type="file" id="f-tea" hidden onchange="importXLS(this, 'teachers')">
                            <button class="btn btn-primary" onclick="addOneTeacher()">إضافة معلم</button>
                        </div>
                        <table class="table table-hover" id="tbl-tea">
                            <tbody id="body-tea"></tbody>
                        </table>
                    </div>
                </div>

                <div id="data-system" class="data-tab hidden">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card-custom p-5 text-center bg-warning bg-opacity-10">
                                <h5>كود المعلم</h5>
                                <h1 class="display-4 fw-bold text-primary my-3" id="sys-code">----</h1>
                                <button class="btn btn-dark" onclick="updateSys('code')">تحديث</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card-custom p-5 text-center bg-dark text-white">
                                <h5>كلمة مرور الزوار</h5>
                                <h1 class="display-4 fw-bold text-warning my-3" id="sys-guard">----</h1>
                                <button class="btn btn-outline-light" onclick="updateSys('guard')">تغيير</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-reports" class="view-sec hidden">
                <div class="d-flex justify-content-between mb-4 no-print">
                    <h2 class="fw-bold">التقارير</h2>
                    <button class="btn btn-dark" onclick="window.print()">طباعة</button>
                </div>
                
                <div class="d-flex gap-2 mb-4 overflow-auto no-print">
                    <button class="btn btn-outline-primary active rounded-pill px-4" onclick="repView('all', this)">الأذونات</button>
                    <button class="btn btn-outline-primary rounded-pill px-4" onclick="repView('stats', this)">الإحصائيات</button>
                    <button class="btn btn-outline-primary rounded-pill px-4" onclick="repView('vis', this)">الزوار</button>
                    <button class="btn btn-outline-primary rounded-pill px-4" onclick="repView('dep', this)">الانصراف</button>
                </div>

                <div class="card-custom">
                    <div class="card-head"><h4 id="rep-title">سجل الأذونات</h4></div>
                    <div class="table-responsive">
                        <table class="table table-bordered text-center mb-0">
                            <thead class="table-light" id="rep-th"></thead>
                            <tbody id="rep-tb"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sec-permit" class="view-sec hidden">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card-custom">
                            <div class="card-head"><h4>إصدار إذن خروج</h4></div>
                            <div class="p-5">
                                <label class="fw-bold mb-2">الفصل</label>
                                <input list="dl-classes" id="p-class" class="form-control form-control-lg mb-4" onchange="fillStudents(this.value)" placeholder="اختر الفصل">
                                
                                <label class="fw-bold mb-2">الطالب</label>
                                <select id="p-student" class="form-select form-select-lg mb-4" disabled></select>
                                
                                <label class="fw-bold mb-2">الوجهة</label>
                                <div class="d-flex gap-2 mb-4">
                                    <button class="btn btn-outline-dark flex-grow-1" onclick="setDest('دورة مياه', 5)">دورة مياه</button>
                                    <button class="btn btn-outline-dark flex-grow-1" onclick="setDest('المقصف', 10)">المقصف</button>
                                    <button class="btn btn-outline-dark flex-grow-1" onclick="setDest('الإدارة', 15)">الإدارة</button>
                                </div>
                                <input type="hidden" id="p-dest">
                                <input type="number" id="p-time" class="form-control mb-4" placeholder="المدة (دقيقة)">
                                
                                <button class="btn btn-success w-100 py-3 fw-bold fs-5" onclick="sendPermit()">تسجيل خروج</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-visitor" class="view-sec hidden">
                <div class="row">
                    <div class="col-md-5">
                        <div class="card-custom p-4">
                            <h4 class="mb-4">تسجيل دخول</h4>
                            <input id="v-name" class="form-control mb-3" placeholder="الاسم">
                            <input id="v-id" type="number" class="form-control mb-3" placeholder="الهوية">
                            <input id="v-reason" class="form-control mb-3" placeholder="السبب">
                            <button class="btn btn-dark w-100 py-3 fw-bold" onclick="addVisitor()">تسجيل</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card-custom">
                            <div class="card-head"><h4>المتواجدون / الطلبات</h4></div>
                            <div id="visitor-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-agent" class="view-sec hidden">
                <h2 class="fw-bold mb-4">لوحة الوكيل</h2>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card-custom h-100">
                            <div class="card-head bg-warning bg-opacity-10"><h4>طلبات الزوار</h4></div>
                            <div id="agent-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-custom h-100">
                            <div class="card-head bg-danger text-white"><h4>أمر انصراف</h4></div>
                            <div class="p-4">
                                <input id="dep-name" class="form-control mb-3" placeholder="اسم الطالب">
                                <input id="dep-reason" class="form-control mb-3" placeholder="السبب">
                                <button class="btn btn-danger w-100 py-2" onclick="addDeparture()">السماح بالانصراف</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <audio id="snd" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // ================= FIREBASE CONFIG (ضع بياناتك هنا) =================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        
        // Initialize Firebase
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ================= GLOBAL STATE =================
        let role = '', data = { code: '2026', guard: '1111', students:{}, teachers:{}, permits:{}, visitors:{}, departures:{}, classes:[] };
        let muted = false;

        // ================= SYNC & INIT =================
        window.onload = () => {
            db.ref('/').on('value', snap => {
                if(snap.val()) {
                    data = snap.val();
                    if(!data.classes) data.classes = [];
                    renderUI();
                }
            });
            setInterval(checkMonitor, 2000);
        };

        function renderUI() {
            // Update Datalist
            const dl = document.getElementById('dl-classes');
            dl.innerHTML = '';
            (data.classes || []).forEach(c => dl.innerHTML += `<option value="${c}">`);

            // Update Active Screens
            if(role === 'admin' && isActive('data')) renderManage();
            if(role === 'admin' && isActive('agent')) renderAgent();
            if(role === 'guard') renderGuard();
            if(isActive('monitor')) renderMonitor();
            
            // System tab
            document.getElementById('sys-code').innerText = data.code;
            document.getElementById('sys-guard').innerText = data.guard;
        }

        function isActive(sec) { return !document.getElementById('sec-'+sec).classList.contains('hidden'); }

        // ================= AUTH =================
        function showPin(r) {
            role = r;
            document.getElementById('auth-overlay').querySelector('.portal-header').style.display = 'none';
            document.querySelector('.roles-container').style.display = 'none';
            document.getElementById('pin-screen').classList.remove('hidden');
            document.getElementById('pin-title').innerText = role==='teacher'?'كود المعلم':'الرمز السري';
        }
        function closePin() {
            document.getElementById('pin-screen').classList.add('hidden');
            document.getElementById('auth-overlay').querySelector('.portal-header').style.display = 'block';
            document.querySelector('.roles-container').style.display = 'flex';
            document.getElementById('pin-input').value = '';
        }
        function login() {
            const p = document.getElementById('pin-input').value;
            let ok = (role==='admin' && p==='admin') || (role==='guard' && p==data.guard) || (role==='teacher' && p==data.code);
            
            if(ok) {
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('app-interface').classList.remove('hidden');
                buildMenu();
                navigate(role==='guard'?'visitor':(role==='admin'?'monitor':'permit'));
            } else {
                Swal.fire('خطأ', 'الرمز غير صحيح', 'error');
            }
        }

        // ================= MENU =================
        function buildMenu() {
            const m = document.getElementById('menu-items'); m.innerHTML='';
            document.getElementById('current-role-txt').innerText = role==='admin'?'الإدارة':(role==='teacher'?'المعلم':'الزوار');
            
            const links = role==='teacher' ? [['monitor','المتابعة','desktop'],['permit','إصدار إذن','file-signature']] :
                          role==='admin' ? [['monitor','المتابعة','desktop'],['data','البيانات','database'],['agent','الوكيل','user-check'],['reports','التقارير','chart-bar']] :
                          [['visitor','بوابة الزوار','id-card']];
            
            links.forEach(([id, txt, icon]) => {
                m.innerHTML += `<div class="nav-link" onclick="navigate('${id}')"><i class="fas fa-${icon}"></i> ${txt}</div>`;
            });
        }
        function navigate(id) {
            document.querySelectorAll('.view-sec').forEach(e => e.classList.add('hidden'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            if(id==='reports') repView('all');
        }

        // ================= FEATURES =================
        
        // 1. Monitor
        function renderMonitor() {
            const grid = document.getElementById('live-grid');
            const active = Object.entries(data.permits||{}).filter(([k,v]) => v.active);
            
            if(active.length === 0) {
                document.getElementById('no-active').classList.remove('hidden');
                grid.innerHTML = '';
            } else {
                document.getElementById('no-active').classList.add('hidden');
                grid.innerHTML = active.map(([k,p]) => {
                    const min = Math.floor((new Date() - new Date(p.start))/60000);
                    const late = min >= p.limit;
                    return `<div class="col-md-3"><div class="monitor-card ${late?'danger':'safe'}"><h3>${p.student}</h3><span>${p.class}</span><div class="mt-3 display-4 fw-bold ${late?'text-danger':'text-success'}">${min}</div><small>دقيقة</small><button class="btn btn-dark w-100 mt-3" onclick="db.ref('permits/${k}').update({active:false, end:new Date().toISOString()})">عودة</button></div></div>`;
                }).join('');
            }
        }
        function checkMonitor() {
            if(isActive('monitor') && !muted) {
                const hasLate = Object.values(data.permits||{}).some(p => p.active && (new Date()-new Date(p.start))/60000 >= p.limit);
                if(hasLate) document.getElementById('snd').play().catch(()=>{});
            }
        }
        function toggleMute() { muted=!muted; document.getElementById('mute-btn').classList.toggle('text-danger'); }

        // 2. Data Manage
        function tabData(t) {
            document.querySelectorAll('.data-tab').forEach(e=>e.classList.add('hidden'));
            document.getElementById('data-'+t).classList.remove('hidden');
            renderManage();
        }
        function renderManage() {
            // Students
            const sl = Object.entries(data.students||{});
            document.getElementById('body-stu').innerHTML = sl.reverse().map(([k,s]) => `<tr><td>${s.name}</td><td><span class="badge bg-light text-dark border">${s.class}</span></td><td><span class="action-icon bg-edit" onclick="moveStu('${k}')"><i class="fas fa-exchange-alt"></i></span><span class="action-icon bg-del" onclick="del('students/${k}')"><i class="fas fa-trash"></i></span></td></tr>`).join('');
            // Teachers
            const tl = Object.entries(data.teachers||{});
            document.getElementById('body-tea').innerHTML = tl.map(([k,t]) => `<tr><td>${t.name}</td><td><span class="action-icon bg-del" onclick="del('teachers/${k}')"><i class="fas fa-trash"></i></span></td></tr>`).join('');
        }
        
        function addOneStudent() {
            const cls = document.getElementById('inp-class').value;
            if(!cls) return Swal.fire('تنبيه','اكتب الفصل','warning');
            Swal.fire({input:'text', title:'اسم الطالب'}).then(r=>{
                if(r.value) { db.ref('students').push({name:r.value, class:cls}); addClass(cls); }
            });
        }
        function addOneTeacher() {
            Swal.fire({input:'text', title:'اسم المعلم'}).then(r=>{if(r.value) db.ref('teachers').push({name:r.value})});
        }
        function moveStu(k) {
            Swal.fire({input:'text', title:'الفصل الجديد'}).then(r=>{
                if(r.value) { db.ref('students/'+k).update({class:r.value}); addClass(r.value); }
            });
        }
        function del(path) { Swal.fire({title:'حذف؟', showCancelButton:true}).then(r=>{if(r.isConfirmed) db.ref(path).remove()}); }
        function addClass(c) { if(!data.classes.includes(c)) { let n = data.classes; n.push(c); db.ref('classes').set(n); } }
        
        function importXLS(inp, type) {
            const f=inp.files[0], r=new FileReader(), cls=document.getElementById('inp-class').value;
            if(type==='students' && !cls) return Swal.fire('تنبيه','حدد الفصل','warning');
            r.onload=e=>{
                const wb=XLSX.read(e.target.result,{type:'array'});
                const d=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
                d.forEach(row=>{ if(row[0]) db.ref(type).push({name:row[0], class:cls||''}); });
                if(cls) addClass(cls);
                Swal.fire('تم','','success');
            }; r.readAsArrayBuffer(f);
        }
        function filterTbl(id, q) { document.querySelectorAll(`#${id} tbody tr`).forEach(r => r.style.display = r.innerText.includes(q)?'':'none'); }
        function updateSys(key) { 
            if(key==='code') db.ref('code').set(Math.floor(1000+Math.random()*9000));
            else Swal.fire({input:'text'}).then(r=>{if(r.value) db.ref('guard').set(r.value)});
        }

        // 3. Teacher Permit
        function fillStudents(cls) {
            const sel = document.getElementById('p-student'); sel.innerHTML='<option>-- اختر --</option>'; sel.disabled=false;
            Object.values(data.students||{}).filter(s=>s.class===cls).forEach(s=>sel.innerHTML+=`<option value="${s.name}">${s.name}</option>`);
        }
        function setDest(d,t) { document.getElementById('p-dest').value=d; document.getElementById('p-time').value=t; }
        function sendPermit() {
            const s=document.getElementById('p-student').value, c=document.getElementById('p-class').value, d=document.getElementById('p-dest').value, t=document.getElementById('p-time').value;
            if(!s) return;
            // Active check
            if(Object.values(data.permits||{}).find(p=>p.student===s && p.active)) return Swal.fire('الطالب بالخارج','','error');
            
            db.ref('permits').push({
                student:s, class:c, dest:d, limit:t, start:new Date().toISOString(), active:true
            });
            navigate('monitor');
        }

        // 4. Guard & Agent
        function addVisitor() {
            const v = {name:document.getElementById('v-name').value, id:document.getElementById('v-id').value, reason:document.getElementById('v-reason').value, time:new Date().toLocaleString(), status:'wait'};
            if(v.name) { db.ref('visitors').push(v); Swal.fire('تم الإرسال'); }
        }
        function renderGuard() {
            document.getElementById('visitor-list').innerHTML = Object.values(data.visitors||{}).reverse().map(v=>`<div class="list-group-item d-flex justify-content-between"><span>${v.name}</span><span class="badge ${v.status==='ok'?'bg-success':(v.status==='no'?'bg-danger':'bg-warning')}">${v.status==='wait'?'انتظار':(v.status==='ok'?'مسموح':'مرفوض')}</span></div>`).join('');
        }
        function renderAgent() {
            const p = Object.entries(data.visitors||{}).filter(([k,v])=>v.status==='wait');
            document.getElementById('agent-list').innerHTML = p.map(([k,v])=>`<div class="list-group-item"><div><strong>${v.name}</strong><br>${v.reason}</div><div class="mt-2"><button class="btn btn-success btn-sm" onclick="db.ref('visitors/${k}').update({status:'ok'})">موافقة</button> <button class="btn btn-danger btn-sm" onclick="db.ref('visitors/${k}').update({status:'no'})">رفض</button></div></div>`).join('');
        }
        function addDeparture() {
            const n=document.getElementById('dep-name').value, r=document.getElementById('dep-reason').value;
            if(n) { db.ref('departures').push({name:n, reason:r, time:new Date().toLocaleString()}); Swal.fire('تم'); }
        }

        // 5. Reports
        function repView(t, btn) {
            if(btn) { document.querySelectorAll('#sec-reports button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
            const th=document.getElementById('rep-th'), tb=document.getElementById('rep-tb');
            document.getElementById('rep-title').innerText = t==='all'?'سجل الأذونات':(t==='vis'?'الزوار':'الإحصائيات');
            
            if(t==='all') {
                th.innerHTML='<tr><th>الطالب</th><th>الوجهة</th><th>الوقت</th></tr>';
                tb.innerHTML=Object.values(data.permits||{}).reverse().map(p=>`<tr><td>${p.student}</td><td>${p.dest}</td><td>${new Date(p.start).toLocaleString()}</td></tr>`).join('');
            } else if(t==='vis') {
                th.innerHTML='<tr><th>الزائر</th><th>السبب</th><th>الوقت</th></tr>';
                tb.innerHTML=Object.values(data.visitors||{}).reverse().map(v=>`<tr><td>${v.name}</td><td>${v.reason}</td><td>${v.time}</td></tr>`).join('');
            } else if(t==='dep') {
                th.innerHTML='<tr><th>الطالب</th><th>السبب</th><th>الوقت</th></tr>';
                tb.innerHTML=Object.values(data.departures||{}).reverse().map(d=>`<tr><td>${d.name}</td><td>${d.reason}</td><td>${d.time}</td></tr>`).join('');
            } else {
                th.innerHTML='<tr><th>الطالب</th><th>العدد</th></tr>';
                const c={}; Object.values(data.permits||{}).forEach(p=>{c[p.student]=(c[p.student]||0)+1});
                tb.innerHTML=Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,20).map(([n,k])=>`<tr><td>${n}</td><td>${k}</td></tr>`).join('');
            }
        }

    </script>
</body>
</html>