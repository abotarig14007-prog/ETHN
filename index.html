<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#006C35">
    <title>ูุธุงู ุฅุฐู (V127.0 Big View)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* ================= ููุท ุงูุฎุท ุงููุจูุฑ ูุงููุงุถุญ ================= */
        :root { --primary: #006C35; --gold: #C69C6D; --bg: #f4f6f9; --card: #ffffff; --text: #000000; --distinct: #6f42c1; }
        
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            padding-bottom: 120px; /* ูุณุงุญุฉ ุฅุถุงููุฉ ูู ุงูุฃุณูู */
            font-size: 18px; /* ุชูุจูุฑ ุงูุฎุท ุงูุฃุณุงุณู */
        }

        /* ุชูุจูุฑ ุงูุนูุงููู ูุงูุฃุฒุฑุงุฑ ูุงูุฎุงูุงุช */
        h1, h2, h3, h4, h5, h6 { font-weight: 900 !important; color: #004d26; }
        
        .form-control, .form-select { 
            font-size: 1.3rem !important; /* ุฎุท ูุจูุฑ ุฌุฏุงู ูููุชุงุจุฉ */
            padding: 15px !important; 
            border-radius: 15px !important;
            border: 2px solid #ccc;
            background-color: #fff;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .btn { 
            font-size: 1.2rem !important; 
            padding: 15px 20px !important; 
            border-radius: 15px !important;
            font-weight: 800 !important;
            margin-bottom: 10px;
        }

        /* Top Bar */
        #top-bar { 
            background: #fff; 
            padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            position: fixed; top: 0; left:0; width: 100%; z-index: 900; 
            border-bottom: 2px solid #ddd;
            height: 80px;
        }

        /* Sidebar */
        .sidebar { width: 300px; height: 100vh; background: var(--primary); color: white; position: fixed; right: 0; top: 0; z-index: 2000; box-shadow: -10px 0 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: translateX(100%); transition: 0.3s; }
        .sidebar.active { transform: translateX(0); }
        .sidebar-backdrop { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1999; display: none; }
        .sidebar-backdrop.active { display: block; }
        .nav-link { padding: 20px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); color: white; cursor: pointer; font-size: 1.3rem; font-weight: bold; }

        .main-content { margin-right: 0; padding: 20px; padding-top: 100px; min-height: 100vh; }

        /* Cards */
        .page-card { 
            background: var(--card); border-radius: 25px; border: 1px solid #ddd; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; padding: 25px; 
        }

        /* Dashboard Items */
        .stat-box { background: #fff; padding: 20px; border-radius: 20px; text-align: center; border: 2px solid #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .stat-box h3 { font-size: 2.5rem; margin: 0; }
        
        .monitor-card { background: white; border-radius: 20px; padding: 20px; text-align: center; border: 2px solid #ddd; position: relative; margin-bottom: 15px; }
        .monitor-card h6 { font-size: 1.5rem; }
        .monitor-card h3 { font-size: 2rem; font-weight: 900; }
        .monitor-card.danger { border-color: #dc3545; background: #fff0f0; }

        /* Smart Board Overlay */
        .full-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: none; overflow: hidden; color: white; }
        .overlay-close { position: absolute; top: 30px; left: 30px; z-index: 10001; background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; font-size: 1.2rem; cursor: pointer; }
        
        .smart-board-container { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .board-slide { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .board-slide.active { display: flex; }
        
        .discipline-item { background: rgba(255,255,255,0.15); border-radius: 20px; margin-bottom: 15px; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-left: 8px solid #FFD700; width: 95%; max-width: 700px; }
        .showcase-frame { max-height: 70vh; max-width: 100%; border: 5px solid #fff; border-radius: 20px; overflow: hidden; }
        .showcase-frame img { width: 100%; height: 100%; object-fit: contain; }

        /* Back Button (Purple) */
        #global-back-btn {
            position: fixed; bottom: 30px; right: 30px; width: 70px; height: 70px;
            background: var(--distinct); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 900;
            border: 4px solid white; font-size: 1.5rem;
        }

        /* Login */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #004d26, #006C35); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: white; padding: 40px; border-radius: 30px; width: 100%; max-width: 500px; text-align: center; }

        /* Print */
        #final-print-container { display: none; }
        @media print {
            body > * { display: none !important; }
            #final-print-container { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: white; z-index: 999999; padding: 20px; }
            #final-print-container * { visibility: visible; }
            .no-print { display: none !important; }
            @page { size: A4; margin: 5mm; }
        }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="sidebar-backdrop" onclick="toggleSidebar()"></div>

    <div id="smart-board-overlay" class="full-overlay">
        <button class="overlay-close" onclick="closeSmartBoard()">โ ุฅุบูุงู</button>
        <div class="smart-board-container">
            <div id="slide-showcase" class="board-slide active">
                <div class="showcase-frame"><img id="disp-showcase-img" src=""></div>
                <h1 class="mt-4 text-warning fw-bold" id="disp-showcase-title" style="font-size:3rem; text-shadow:2px 2px 10px black"></h1>
            </div>
            <div id="slide-discipline" class="board-slide">
                <h1 class="mb-5 text-warning fw-bold" style="font-size:3.5rem; text-shadow:2px 2px 10px black">๐ ูุฌูู ุงูุงูุถุจุงุท ๐</h1>
                <div id="discipline-list-container" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
            </div>
        </div>
    </div>

    <div id="top-bar" class="no-print">
        <div class="d-flex align-items-center">
            <div style="width:15px; height:15px; background:#22c55e; border-radius:50%; margin-left:15px;" id="status-dot"></div>
            <h3 class="m-0 fw-bold text-dark">ูุธุงู ุฅุฐู</h3>
        </div>
        <button class="btn btn-light border" style="font-size:1.5rem !important;" onclick="toggleSidebar()"><i class="fas fa-bars"></i> ุงููุงุฆูุฉ</button>
    </div>

    <div id="global-back-btn" class="d-none" onclick="navigate('services')">
        <i class="fas fa-th-large"></i>
    </div>

    <div id="auth-overlay">
        <div class="login-card fade-in">
            <i class="fas fa-school fa-5x text-success mb-4"></i>
            <h2 class="fw-bold mb-4">ุจูุงุจุฉ ุงูุฏุฎูู</h2>
            <div id="role-selection">
                <button class="btn btn-outline-dark w-100 mb-3" onclick="selectRole('admin', 'ุงูุฅุฏุงุฑุฉ')">ุงูุฅุฏุงุฑุฉ</button>
                <button class="btn btn-outline-success w-100 mb-3" onclick="selectRole('teacher', 'ุงููุนูู')">ุงููุนูู</button>
                <button class="btn btn-outline-secondary w-100 mb-3" onclick="selectRole('guard', 'ุงูุญุงุฑุณ')">ุงูุญุงุฑุณ</button>
                <button class="btn btn-outline-info w-100 mb-3" onclick="selectRole('counselor', 'ุงูููุฌู')">ุงูููุฌู</button>
            </div>
            <div id="pin-area" class="hidden">
                <h4 id="role-label" class="text-primary mb-3"></h4>
                <input type="tel" id="pin-input" class="form-control text-center fw-bold" style="font-size: 2rem !important; letter-spacing: 10px;" placeholder="โขโขโขโข" maxlength="4">
                <button class="btn btn-success w-100 btn-lg rounded-pill shadow mt-3" onclick="doLogin()">ุชุณุฌูู ุงูุฏุฎูู</button>
                <button class="btn btn-link text-muted mt-3 fs-5" onclick="backToRoles()">ุฑุฌูุน ูููุงุฆูุฉ</button>
            </div>
        </div>
    </div>

    <div id="app-body" class="d-none">
        <aside class="sidebar no-print">
            <div class="text-center py-5 px-3 border-bottom border-white">
                <i class="fas fa-user-circle fa-4x text-white mb-3"></i>
                <h4 class="fw-bold text-white" id="disp-school">...</h4>
            </div>
            <div id="nav-items" class="flex-grow-1 overflow-auto"></div>
            <div class="p-4"><button class="btn btn-outline-light w-100 rounded-pill" onclick="logOut()">ุฎุฑูุฌ</button></div>
        </aside>

        <main class="main-content">
            <section id="sec-services" class="view-section fade-in">
                <div class="page-card bg-white border-start border-success border-5">
                    <label class="fw-bold text-dark d-block mb-2">ุงุณู ุงููุนูู ุงูููุงูุจ:</label>
                    <select id="global-teacher-name" class="form-select border-success" onchange="rememberTeacher(this.value)"><option value="">-- ุงุฎุชุฑ ุงุณูู --</option></select>
                </div>

                <div id="admin-panel-content" class="d-none">
                     <div class="row g-3 mb-4">
                        <div class="col-6"><button class="btn btn-dark w-100 py-4 shadow" style="background:#2c3e50" onclick="openSmartBoard()"><i class="fas fa-desktop d-block mb-2 fa-2x"></i>ุงูุดุงุดุฉ ุงูุฐููุฉ</button></div>
                        <div class="col-6"><button class="btn btn-dark w-100 py-4 shadow" style="background:#34495e" onclick="navigate('monitor')"><i class="fas fa-tv d-block mb-2 fa-2x"></i>ุงููุชุงุจุนุฉ</button></div>
                        <div class="col-6"><button class="btn btn-warning w-100 py-4 shadow text-dark" onclick="showReportModal('stars')"><i class="fas fa-star d-block mb-2 fa-2x"></i>ุงูุดูุงุฏุงุช</button></div>
                        <div class="col-6"><button class="btn btn-secondary w-100 py-4 shadow" onclick="navigate('sec-data')"><i class="fas fa-cog d-block mb-2 fa-2x"></i>ุงูุฅุนุฏุงุฏุงุช</button></div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-4"><div class="stat-box"><h3 class="text-primary" id="stat-exit">0</h3><small class="text-muted fw-bold">ุจุงูุฎุงุฑุฌ</small></div></div>
                        <div class="col-4"><div class="stat-box"><h3 class="text-success" id="stat-visit">0</h3><small class="text-muted fw-bold">ุฒูุงุฑ</small></div></div>
                        <div class="col-4"><div class="stat-box"><h3 class="text-danger" id="stat-vio">0</h3><small class="text-muted fw-bold">ูุฎุงููุงุช</small></div></div>
                    </div>

                    <div class="page-card mb-3">
                        <h4 class="fw-bold mb-3 text-dark">ุฃูุฑ ุงูุตุฑุงู ุทุงูุจ</h4>
                        <div class="input-group">
                            <input id="adm-dep-name" class="form-control mb-0" placeholder="ุงุณู ุงูุทุงูุจ ุงูุซูุงุซู">
                            <button class="btn btn-primary mb-0" onclick="sendDeparture()">ุฅุฑุณุงู</button>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-3">
                    <button class="btn btn-success w-100 py-3 shadow-sm" onclick="tabService('permit')"><i class="fas fa-door-open me-2"></i> ุฅุฐู ุฎุฑูุฌ ุทุงูุจ</button>
                    <div class="row g-3">
                        <div class="col-6"><button class="btn btn-outline-primary w-100 py-3" onclick="tabService('attendance')">ุชุญุถูุฑ</button></div>
                        <div class="col-6"><button class="btn btn-outline-warning w-100 py-3 text-dark" onclick="tabService('behavior')">ุชููุฒ</button></div>
                        <div class="col-6"><button class="btn btn-outline-danger w-100 py-3" onclick="tabService('violation')">ูุฎุงููุฉ</button></div>
                        <div class="col-6"><button class="btn btn-outline-dark w-100 py-3 admin-only d-none" onclick="tabService('late')">ุชุฃุฎุฑ</button></div>
                    </div>
                </div>
                
                <hr class="my-4">

                <div id="srv-permit-box" class="page-card border-success border-2">
                    <h3 class="fw-bold mb-4 text-success text-center">ุจูุงูุงุช ุงูุฅุฐู</h3>
                    <select id="t-class" class="form-select" onchange="loadStudentsForRole(this.value, 't-stu')"><option>1. ุงุฎุชุฑ ุงููุตู</option></select>
                    <select id="t-stu" class="form-select" disabled><option>2. ุงุฎุชุฑ ุงูุทุงูุจ</option></select>
                    <select id="t-dest" class="form-select"><option>3. ุงุฎุชุฑ ุงููุฌูุฉ</option><option>ุฏูุฑุฉ ููุงู</option><option>ุงููููู</option><option>ุงูุฅุฏุงุฑุฉ</option><option>ุงูููุตู</option></select>
                    <div class="row g-2">
                        <div class="col-7"><input type="tel" id="t-time" class="form-control text-center" placeholder="ุงููุฏุฉ (ุฏ)"></div>
                        <div class="col-5"><div class="form-check bg-light rounded p-3 h-100 d-flex align-items-center justify-content-center border"><input class="form-check-input" type="checkbox" id="t-special" style="width:25px; height:25px;"><label class="fw-bold ms-2 fs-5">ุฎุงุต</label></div></div>
                    </div>
                    <button class="btn btn-success w-100 py-3 mt-3 shadow" onclick="sendPermit()">โ ุชุณุฌูู ุฎุฑูุฌ</button>
                </div>

                <div id="srv-attendance-box" class="page-card d-none">
                    <h3 class="fw-bold mb-4 text-primary text-center">ุงูุชุญุถูุฑ</h3>
                    <div class="d-flex justify-content-center mb-4 gap-2">
                        <button class="btn btn-primary w-50" id="btn-mode-period" onclick="setAttMode('period')">ุจุงูุญุตุฉ</button>
                        <button class="btn btn-outline-primary w-50" id="btn-mode-day" onclick="setAttMode('day')">ููู ูุงูู</button>
                    </div>
                    <select id="att-class" class="form-select" onchange="loadAttendanceList()"><option>ุงุฎุชุฑ ุงููุตู</option></select>
                    <div id="div-att-period" class="mb-3"><select id="att-period" class="form-select" onchange="loadAttendanceList()"><option value="1">ุงูุญุตุฉ 1</option><option value="2">ุงูุญุตุฉ 2</option><option value="3">ุงูุญุตุฉ 3</option><option value="4">ุงูุญุตุฉ 4</option><option value="5">ุงูุญุตุฉ 5</option><option value="6">ุงูุญุตุฉ 6</option><option value="7">ุงูุญุตุฉ 7</option></select></div>
                    <button class="btn btn-outline-dark w-100 mb-3" onclick="loadAttendanceList()">ุนุฑุถ ุงููุงุฆูุฉ</button>
                    <div id="att-list-body" class="d-grid gap-2"></div>
                </div>

                <div id="srv-behavior-box" class="page-card d-none">
                    <h3 class="fw-bold mb-4 text-warning text-center">ููุงุท ุงูุชููุฒ</h3>
                    <select id="b-class" class="form-select" onchange="loadStudentsForRole(this.value, 'b-stu')"><option>ุงููุตู</option></select>
                    <select id="b-stu" class="form-select" disabled><option>ุงูุทุงูุจ</option></select>
                    <select id="b-reason" class="form-select"><option>ุณุจุจ ุงูุชููุฒ</option><option>ุงูุถุจุงุท ูุฏุฑุณู</option><option>ูุดุงุฑูุฉ ุตููุฉ</option><option>ูุงุฌุจุงุช</option><option>ูุธุงูุฉ</option><option>ูุจุงุฏุฑุฉ</option></select>
                    <div class="row g-3 mt-2">
                        <div class="col-6"><button class="btn btn-warning w-100 py-3" onclick="sendStar()">ููุญ (+)</button></div>
                        <div class="col-6"><button class="btn btn-outline-danger w-100 py-3" onclick="deductStar()">ุฎุตู (-)</button></div>
                    </div>
                </div>

                <div id="srv-violation-box" class="page-card d-none">
                    <h3 class="fw-bold mb-4 text-danger text-center">ูุฎุงููุฉ ุณููููุฉ</h3>
                    <select id="v-class" class="form-select" onchange="loadStudentsForRole(this.value, 'v-stu')"><option>ุงููุตู</option></select>
                    <select id="v-stu" class="form-select" disabled><option>ุงูุทุงูุจ</option></select>
                    <input id="v-type" class="form-control" placeholder="ููุน ุงููุฎุงููุฉ">
                    <textarea id="v-desc" class="form-control" rows="3" placeholder="ุชูุงุตูู (ุงุฎุชูุงุฑู)"></textarea>
                    <button class="btn btn-danger w-100 py-3 mt-3 shadow" onclick="sendViolation()">ุฑูุน ูููููู</button>
                </div>

                 <div id="srv-late-box" class="page-card d-none">
                    <h3 class="fw-bold mb-4 text-dark text-center">ุฑุตุฏ ุงูุชุฃุฎุฑ</h3>
                    <select id="late-class" class="form-select" onchange="loadStudentsForRole(this.value, 'late-stu')"><option>ุงููุตู</option></select>
                    <select id="late-stu" class="form-select" disabled><option>ุงูุทุงูุจ</option></select>
                    <button class="btn btn-warning w-100 py-3 mt-3" onclick="registerLate()">ุชุณุฌูู</button>
                </div>
                
                <div class="mt-4">
                    <button class="btn btn-outline-dark w-100 py-3 rounded-pill admin-only d-none" onclick="navigate('reports')">ุนุฑุถ ูุงูุฉ ุงูุชูุงุฑูุฑ</button>
                </div>
            </section>

            <section id="sec-monitor" class="view-section d-none fade-in">
                <div class="d-flex justify-content-between mb-4"><h2 class="fw-bold">ุงููุชุงุจุนุฉ ุงูุญูุฉ</h2></div>
                <div id="monitor-grid" class="row g-3"></div>
                <div id="no-students" class="text-center py-5 d-none"><h3 class="text-muted mt-3">ุงูุฌููุน ุจุงููุตูู โ</h3></div>
            </section>

            <section id="sec-reports" class="view-section d-none fade-in">
                <h2 class="fw-bold mb-4">ุงูุชูุงุฑูุฑ</h2>
                <div class="row g-3">
                    <div class="col-6"><div class="report-grid-item" onclick="showReportModal('permits')"><i class="fas fa-file-invoice text-primary fa-2x mb-2"></i><h5>ุงูุฃุฐููุงุช</h5></div></div>
                    <div class="col-6"><div class="report-grid-item" onclick="showReportModal('visitors')"><i class="fas fa-user-shield text-dark fa-2x mb-2"></i><h5>ุงูุฒูุงุฑ</h5></div></div>
                    <div class="col-6"><div class="report-grid-item" onclick="showReportModal('violations')"><i class="fas fa-exclamation-triangle text-danger fa-2x mb-2"></i><h5>ุงููุฎุงููุงุช</h5></div></div>
                    <div class="col-6"><div class="report-grid-item" onclick="showReportModal('attendance')"><i class="fas fa-calendar-check text-success fa-2x mb-2"></i><h5>ุงูุบูุงุจ</h5></div></div>
                    <div class="col-12"><div class="report-grid-item d-flex align-items-center justify-content-center gap-3" onclick="showReportModal('top_class')"><i class="fas fa-medal text-warning fa-2x"></i><h4 class="m-0 fw-bold">ุงููุตู ุงููุซุงูู</h4></div></div>
                </div>
            </section>

            <section id="sec-guard" class="view-section d-none fade-in">
                <div class="page-card mb-4 border-dark border-top border-5">
                    <h3 class="fw-bold mb-4 text-center">ุชุณุฌูู ุฒุงุฆุฑ</h3>
                    <input id="g-v-name" class="form-control" placeholder="ุงูุงุณู">
                    <input type="tel" id="g-v-id" class="form-control" placeholder="ุงููููุฉ">
                    <input id="g-v-reason" class="form-control" placeholder="ุงูุณุจุจ">
                    <button class="btn btn-dark w-100 py-3 mt-3 rounded-pill" onclick="sendVisitorReq()">ุฅุฑุณุงู ุทูุจ</button>
                </div>
                <div class="page-card border-danger border-top border-5">
                    <h4 class="fw-bold text-danger mb-3">ุฃูุงูุฑ ุงูุฎุฑูุฌ (ููุทูุงุจ)</h4>
                    <div id="g-dep-list"></div>
                </div>
            </section>

            <section id="sec-counselor" class="view-section d-none fade-in">
                <div class="page-card p-4">
                    <h3 class="fw-bold mb-3">ุจุญุซ ูู ุงูุณุฌู</h3>
                    <div class="input-group mb-3"><input type="text" id="stu-search-name" class="form-control mb-0" placeholder="ุงุณู ุงูุทุงูุจ..."><button class="btn btn-success mb-0" onclick="searchStudentHistory()"><i class="fas fa-search"></i></button></div>
                    <div id="stu-history-res" class="d-none bg-light p-3 rounded mt-3 border fs-5"></div>
                </div>
            </section>

            <section id="sec-data" class="view-section d-none fade-in">
                <h2 class="fw-bold mb-4 text-primary">ุงูุฅุนุฏุงุฏุงุช</h2>
                
                <div class="page-card mb-4">
                    <h4 class="fw-bold mb-3"><i class="fas fa-desktop me-2"></i> ุงูุดุงุดุฉ ุงูุฐููุฉ</h4>
                    <label class="fw-bold mb-2">ุตูุฑุฉ ุงููุนุฑุถ</label>
                    <input type="file" id="set-showcase-img" class="form-control">
                    <label class="fw-bold mb-2">ุงูุนููุงู</label>
                    <input id="set-showcase-title" class="form-control" placeholder="ูุซุงู: ุฑุณููุงุช ุงูุทูุงุจ">
                    <button class="btn btn-dark w-100 mt-3" onclick="saveBroadcastSettings()">ุญูุธ ุงูุนุฑุถ</button>
                </div>

                <div class="page-card mb-4">
                    <h4 class="fw-bold text-danger mb-3"><i class="fas fa-lock me-2"></i> ูููุงุช ุงููุฑูุฑ</h4>
                    <input type="tel" id="pin-admin" class="form-control" placeholder="ุฑูุฒ ุงูุฅุฏุงุฑุฉ">
                    <input type="tel" id="pin-teacher" class="form-control" placeholder="ุฑูุฒ ุงููุนูู">
                    <input type="tel" id="pin-guard" class="form-control" placeholder="ุฑูุฒ ุงูุญุงุฑุณ">
                    <button class="btn btn-danger w-100 mt-3" onclick="savePasswords()">ุชุญุฏูุซ ุงูุฑููุฒ</button>
                </div>

                <div class="page-card">
                    <h4 class="fw-bold text-success mb-3"><i class="fas fa-database me-2"></i> ุงูุจูุงูุงุช</h4>
                    <button class="btn btn-outline-success w-100 mb-3" onclick="document.getElementById('f-tea-excel').click()">ุงุณุชูุฑุงุฏ ูุนูููู (Excel)</button>
                    <input type="file" id="f-tea-excel" hidden onchange="importTeachers(this)">
                    
                    <div class="input-group mb-4">
                        <input id="imp-cls-name" class="form-control mb-0" placeholder="ุงุณู ุงููุตู (ูุซุงู: 1/1)">
                        <button class="btn btn-primary mb-0" onclick="document.getElementById('f-excel').click()">ุงุณุชูุฑุงุฏ ุทูุงุจ</button>
                    </div>
                    <input type="file" id="f-excel" hidden onchange="importData(this)">

                    <div class="d-grid gap-3">
                        <button class="btn btn-light border py-3" onclick="exportData()">ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button>
                        <button class="btn btn-light border text-danger py-3" onclick="secureReset('reports')">ุชุตููุฑ ุงูุณุฌูุงุช ููุท</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal fade" id="printModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content"><div class="modal-header border-0"><h3 class="modal-title fw-bold">ูุนุงููุฉ ุงูุชูุฑูุฑ</h3><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body bg-white p-4" id="modal-print-content"></div><div class="modal-footer border-0"><button type="button" class="btn btn-primary w-100 fw-bold py-4 rounded-pill fs-4" onclick="executePrint()">ุทุจุงุนุฉ PDF</button></div></div></div></div>
    
    <script>
        const firebaseConfig = { apiKey: "AIzaSyD0IJONOe7Ef4a0XG8L1Cgbc1qVSSck0xE", authDomain: "ethn-63848.firebaseapp.com", databaseURL: "https://ethn-63848-default-rtdb.firebaseio.com", projectId: "ethn-63848", storageBucket: "ethn-63848.appspot.com", messagingSenderId: "747489913596", appId: "1:747489913596:web:d98d88447e4a25cc808579" };
        firebase.initializeApp(firebaseConfig); const db = firebase.database();
        let userRole='', attMode='period', smartBoardInterval;
        let data = { settings: {admin_pin:'2026', teacher_pin:'2026', guard_pin:'1111', counselor_pin:'2026', broadcast:{}}, classes:[], students:{}, teachers:{}, permits:{}, visitors:{}, violations:{}, departures:{}, attendance:{}, stars:{}, tardiness:{} };

        window.onload = () => {
            const savedRole = localStorage.getItem('userRole');
            db.ref('/').on('value', snap => {
                const val = snap.val();
                if(val) {
                    data = { ...data, ...val };
                    document.body.style.visibility = 'visible';
                    document.getElementById('disp-school').innerText = data.settings.school || 'ูุฏุฑุณุชู';
                    
                    if(savedRole && !userRole) {
                        userRole = savedRole;
                        document.getElementById('auth-overlay').style.display='none';
                        document.getElementById('app-body').classList.remove('d-none');
                        buildMenu();
                        navigate('services'); 
                    } else if(userRole) { refreshScreens(); renderAdmin(); }
                }
            });
            setInterval(monitorLoop, 10000);
        };

        function selectRole(r, t) { userRole=r; document.getElementById('role-selection').classList.add('hidden'); document.getElementById('pin-area').classList.remove('hidden'); document.getElementById('role-label').innerText='ูุฑุญุจุงู: '+t; }
        function backToRoles() { document.getElementById('pin-area').classList.add('hidden'); document.getElementById('role-selection').classList.remove('hidden'); userRole=''; }
        function doLogin() { 
            if(document.getElementById('pin-input').value === String(data.settings[`${userRole}_pin`])) { 
                localStorage.setItem('userRole', userRole); document.getElementById('auth-overlay').style.display='none'; document.getElementById('app-body').classList.remove('d-none'); 
                buildMenu(); navigate(userRole==='guard'?'guard':(userRole==='admin'?'services':'services')); 
            } else { Swal.fire('ุงูุฑูุฒ ุฎุทุฃ', '', 'error'); } 
        }

        function toggleSidebar() { 
            const sb = document.querySelector('.sidebar'); const bd = document.querySelector('.sidebar-backdrop');
            sb.classList.toggle('active'); bd.classList.toggle('active');
        }

        function buildMenu() {
            const m = document.getElementById('nav-items');
            let links = [['services','ุงูุฑุฆูุณูุฉ']];
            if(userRole==='admin' || userRole==='teacher') links.push(['reports','ุงูุชูุงุฑูุฑ']);
            if(userRole==='admin') links.push(['sec-data','ุงูุฅุนุฏุงุฏุงุช']);
            m.innerHTML = links.map(l => `<div class="nav-link" onclick="navigate('${l[0]}'); toggleSidebar()">${l[1]}</div>`).join('');
        }

        function navigate(id) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.add('d-none'));
            const target = document.getElementById('sec-'+id);
            if(target) target.classList.remove('d-none');

            const btn = document.getElementById('global-back-btn');
            if(id === 'services') btn.classList.add('d-none');
            else btn.classList.remove('d-none');

            if(id === 'services') {
                if(userRole === 'admin') {
                    document.getElementById('admin-panel-content').classList.remove('d-none');
                    document.querySelectorAll('.admin-only').forEach(e=>e.classList.remove('d-none'));
                } else {
                    document.getElementById('admin-panel-content').classList.add('d-none');
                    document.querySelectorAll('.admin-only').forEach(e=>e.classList.add('d-none'));
                }
            }
            if(id==='monitor') renderMonitor();
            if(id==='sec-data') populateSettingsUI();
            refreshScreens();
        }

        function tabService(tab) {
            document.querySelectorAll('#sec-services .page-card').forEach(c => { if(c.id.includes('srv-')) c.classList.add('d-none'); });
            const target = document.getElementById('srv-' + tab + '-box'); if(target) target.classList.remove('d-none');
        }

        function openSmartBoard() {
            document.getElementById('smart-board-overlay').style.display = 'block';
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            
            if(data.settings.broadcast?.showcaseImg) {
                document.getElementById('disp-showcase-img').src = data.settings.broadcast.showcaseImg;
                document.getElementById('disp-showcase-title').innerText = data.settings.broadcast.showcaseTitle || '';
            }

            const scores = {};
            Object.values(data.students || {}).forEach(s => { scores[s.name] = 100; }); 
            Object.values(data.attendance || {}).forEach(day => { if(day.full_day) Object.keys(day.full_day).forEach(name => { if(scores[name]) scores[name] -= 1; }); });
            Object.values(data.tardiness || {}).forEach(t => { if(scores[t.student]) scores[t.student] -= 0.5; });

            const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]).slice(0, 10);
            document.getElementById('discipline-list-container').innerHTML = sorted.map((s, i) => 
                `<div class="discipline-item"><div class="fw-bold fs-3 text-white">${i+1}. ${s[0]}</div><div class="badge bg-warning text-dark fs-3">${s[1]}%</div></div>`
            ).join('');

            let showSlide1 = true;
            smartBoardInterval = setInterval(() => {
                document.getElementById('slide-showcase').classList.toggle('active', showSlide1);
                document.getElementById('slide-discipline').classList.toggle('active', !showSlide1);
                showSlide1 = !showSlide1;
            }, 6000);
        }

        function closeSmartBoard() {
            document.getElementById('smart-board-overlay').style.display = 'none';
            clearInterval(smartBoardInterval);
            if (document.exitFullscreen) document.exitFullscreen();
        }

        function refreshScreens() {
            ['t-class','v-class','b-class','att-class','late-class'].forEach(id=>{ 
                const e=document.getElementById(id); if(e) {
                    const val = e.value;
                    e.innerHTML='<option value="">ุงุฎุชุฑ ุงููุตู</option>'+(data.classes||[]).map(c=>`<option value="${c}">${c}</option>`).join('');
                    if(val) e.value = val;
                }
            });
            const te = document.getElementById('global-teacher-name');
            if(te) {
                const val = te.value;
                te.innerHTML='<option value="">-- ุงุฎุชุฑ ุงุณูู --</option>'+Object.values(data.teachers||{}).map(t=>`<option value="${t.name}">${t.name}</option>`).join('');
                if(val) te.value = val; else { const s=localStorage.getItem('teacher'); if(s) te.value=s; }
            }
        }

        function loadStudentsForRole(c, id) { 
            const e=document.getElementById(id); e.innerHTML='<option value="">ุงุฎุชุฑ ุงูุทุงูุจ</option>'; e.disabled=false; 
            Object.values(data.students||{}).filter(s=>s.class===c).forEach(s=>e.innerHTML+=`<option value="${s.name}">${s.name}</option>`); 
        }

        function sendPermit() { 
            if(!document.getElementById('t-stu').value) return Swal.fire('ุงุฎุชุฑ ุงูุทุงูุจ');
            db.ref('permits').push({
                student:document.getElementById('t-stu').value, teacher:document.getElementById('global-teacher-name').value, 
                class:document.getElementById('t-class').value, dest:document.getElementById('t-dest').value, 
                limit:document.getElementById('t-time').value || 10, start:new Date().toISOString(), active:true
            });
            Swal.fire('ุชู ุงูุฎุฑูุฌ', '', 'success'); navigate('monitor');
        }

        function renderMonitor() { 
            const g = document.getElementById('monitor-grid'); 
            const l = Object.entries(data.permits||{}).filter(x=>x[1].active); 
            document.getElementById('no-students').classList.toggle('d-none', l.length>0); 
            g.innerHTML = l.map(([k,p])=>{ 
                const m = Math.floor((new Date()-new Date(p.start))/60000); 
                return `<div class="col-12 col-md-4"><div class="monitor-card ${m>=p.limit?'danger':'safe'}"><h6 class="fw-bold mb-2">${p.student}</h6><h5 class="d-block mb-3 text-muted">${p.dest}</h5><h3 class="mb-3">${m} ุฏูููุฉ</h3><button class="btn btn-dark w-100 rounded-pill py-3 fw-bold" onclick="db.ref('permits/${k}').update({active:false})">ุนูุฏุฉ ูููุตู</button></div></div>`; 
            }).join(''); 
        }

        function setAttMode(mode) { attMode = mode; document.getElementById('btn-mode-period').className = mode === 'period' ? 'btn btn-primary w-50' : 'btn btn-outline-primary w-50'; document.getElementById('btn-mode-day').className = mode === 'day' ? 'btn btn-primary w-50' : 'btn btn-outline-primary w-50'; document.getElementById('div-att-period').style.visibility = mode === 'period' ? 'visible' : 'hidden'; loadAttendanceList(); }
        
        function loadAttendanceList() {
            const cls = document.getElementById('att-class').value;
            const period = document.getElementById('att-period').value;
            const body = document.getElementById('att-list-body');
            const today = new Date().toLocaleDateString('en-CA');
            if(!cls) return;
            const students = Object.values(data.students || {}).filter(s => s.class === cls);
            body.innerHTML = students.map(s => {
                let isAbsent = attMode === 'day' ? data.attendance?.[today]?.['full_day']?.[s.name] === true : data.attendance?.[today]?.['periods']?.[period]?.[s.name] === 'absent';
                return `<div class="d-flex justify-content-between align-items-center bg-light p-3 rounded-4 mb-2 border" onclick="toggleAtt('${today}', '${s.name}', ${isAbsent})">
                    <span class="fw-bold fs-5">${s.name}</span>
                    <span class="badge rounded-pill ${isAbsent ? 'bg-danger' : 'bg-success'} p-2 px-3 fs-6">${isAbsent ? 'ุบุงุฆุจ' : 'ุญุงุถุฑ'}</span>
                </div>`;
            }).join('');
        }
        
        function toggleAtt(date, name, currentlyAbsent) {
            const period = document.getElementById('att-period').value;
            if (attMode === 'day') { if (currentlyAbsent) db.ref(`attendance/${date}/full_day/${name}`).remove(); else db.ref(`attendance/${date}/full_day/${name}`).set(true); } else { if (currentlyAbsent) db.ref(`attendance/${date}/periods/${period}/${name}`).remove(); else db.ref(`attendance/${date}/periods/${period}/${name}`).set('absent'); }
            setTimeout(() => loadAttendanceList(), 100);
        }

        function sendStar() { db.ref('stars').push({student:document.getElementById('b-stu').value, reason:document.getElementById('b-reason').value, teacher:document.getElementById('global-teacher-name').value, value:1, date:new Date().toISOString()}); Swal.fire('ุชู ุงูููุญ'); }
        function deductStar() { db.ref('stars').push({student:document.getElementById('b-stu').value, reason:'ุฎุตู', teacher:document.getElementById('global-teacher-name').value, value:-1, date:new Date().toISOString()}); Swal.fire('ุชู ุงูุฎุตู'); }
        function sendViolation() { db.ref('violations').push({student:document.getElementById('v-stu').value, type:document.getElementById('v-type').value, desc:document.getElementById('v-desc').value, status:'pending_admin', date:new Date().toLocaleDateString('ar-SA')}); Swal.fire('ุชู ุงูุฑูุน'); }
        function registerLate() { db.ref('tardiness').push({student:document.getElementById('late-stu').value, date:new Date().toISOString()}); Swal.fire('ุชู ุงูุฑุตุฏ'); }
        function sendVisitorReq() { db.ref('visitors').push({name:document.getElementById('g-v-name').value, id:document.getElementById('g-v-id').value, reason:document.getElementById('g-v-reason').value, status:'pending', time:new Date().toISOString()}); document.getElementById('g-v-name').value=''; Swal.fire('ุชู ุงูุฅุฑุณุงู'); }
        function sendDeparture() { db.ref('departures').push({name:document.getElementById('adm-dep-name').value, status:'pending'}); document.getElementById('adm-dep-name').value=''; Swal.fire('ุชู ุงูุฅุฑุณุงู'); }

        function renderAdmin() {
            document.getElementById('adm-vis-list')?.remove(); document.getElementById('adm-vio-list')?.remove(); // Clean old refs if exist
            
            // Re-render lists inside the admin panel manually if needed or just rely on stats
            document.getElementById('stat-exit').innerText = Object.values(data.permits||{}).filter(p=>p.active).length;
            document.getElementById('stat-visit').innerText = Object.values(data.visitors||{}).filter(v=>v.status==='pending').length;
            document.getElementById('stat-vio').innerText = Object.values(data.violations||{}).filter(v=>v.status==='pending_admin').length;
            
            // Add pending items to lists dynamically if you want them shown
            // For now, lists are removed from view to simplify, as per user request for "Big & Clear" buttons. 
            // We can add them back if requested.
        }
        
        function monitorLoop() { if(!document.getElementById('sec-monitor').classList.contains('d-none')) renderMonitor(); }
        function rememberTeacher(v) { localStorage.setItem('teacher', v); }
        function logOut() { localStorage.removeItem('userRole'); location.reload(); }
        
        function showReportModal(type) { 
             const modal = new bootstrap.Modal(document.getElementById('printModal')); 
             const titles = { 'permits': 'ุณุฌู ุงูุฃุฐููุงุช', 'visitors': 'ุณุฌู ุงูุฒูุงุฑ', 'violations': 'ุงููุฎุงููุงุช', 'attendance': 'ุงูุบูุงุจ ุงููููู', 'stars': 'ูุฌูู ุงูุชููุฒ', 'late': 'ุชุฃุฎุฑ ุงูุตุจุงุญ', 'top_class': 'ุงููุตู ุงููุซุงูู' };
            let h = `<div class="text-center mb-5"><h2 class="fw-bold">${titles[type]}</h2><h5 class="text-muted">${new Date().toLocaleDateString('ar-SA')}</h5></div>`;
            if(type==='permits') h += `<table class="table table-striped text-center fs-5"><thead><tr><th>ุงูุทุงูุจ</th><th>ุงูููุช</th></tr></thead><tbody>${Object.values(data.permits||{}).reverse().map(p=>`<tr><td class="py-3">${p.student}<br><small class="text-muted">${p.dest}</small></td><td class="py-3">${new Date(p.start).toLocaleTimeString('ar-SA', {hour:'2-digit',minute:'2-digit'})}</td></tr>`).join('')}</tbody></table>`;
            else if(type==='attendance') { const t = new Date().toLocaleDateString('en-CA'); h += `<table class="table table-striped text-center fs-5"><thead><tr><th>ุงูุทุงูุจ</th><th>ุงูุญุงูุฉ</th></tr></thead><tbody>${Object.values(data.students||{}).map(s=> data.attendance?.[t]?.['full_day']?.[s.name] ? `<tr><td class="py-3">${s.name}</td><td class="text-danger fw-bold py-3">ุบูุงุจ</td></tr>` : '').join('')}</tbody></table>`; }
            else if(type==='stars') { let s={}; Object.values(data.stars||{}).forEach(st=>{s[st.student]=(s[st.student]||0)+(st.value||1)}); h+=`<table class="table table-striped text-center fs-5"><thead><tr><th>ุงูุทุงูุจ</th><th>ุงูุฑุตูุฏ</th></tr></thead><tbody>${Object.entries(s).sort((a,b)=>b[1]-a[1]).map(x=>`<tr><td class="py-3">${x[0]}</td><td class="py-3"><span class="badge bg-warning text-dark fs-5">${x[1]}</span></td></tr>`).join('')}</tbody></table>`; }

            document.getElementById('modal-print-content').innerHTML = h; modal.show();
        }
        
        function executePrint() { window.print(); }
        function saveBroadcastSettings() { const u={showcaseTitle:document.getElementById('set-showcase-title').value}; const f=document.getElementById('set-showcase-img').files[0]; if(f){const r=new FileReader();r.onload=e=>{u.showcaseImg=e.target.result;db.ref('settings/broadcast').update(u).then(()=>Swal.fire('ุชู'))};r.readAsDataURL(f);}else{db.ref('settings/broadcast').update(u).then(()=>Swal.fire('ุชู'))} }
        function populateSettingsUI() { if(document.getElementById('pin-admin')) { document.getElementById('pin-admin').value=data.settings.admin_pin||''; document.getElementById('pin-teacher').value=data.settings.teacher_pin||''; document.getElementById('pin-guard').value=data.settings.guard_pin||''; document.getElementById('set-showcase-title').value=data.settings.broadcast?.showcaseTitle||''; } }
        function savePasswords() { db.ref('settings').update({admin_pin:document.getElementById('pin-admin').value, teacher_pin:document.getElementById('pin-teacher').value, guard_pin:document.getElementById('pin-guard').value}); Swal.fire('ุชู ุงูุชุญุฏูุซ'); }
        function importData(inp) { const r=new FileReader(); r.onload=e=>{ const j=XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:'array'}).Sheets[XLSX.read(e.target.result,{type:'array'}).SheetNames[0]],{header:1}); const c=document.getElementById('imp-cls-name').value; j.forEach(r=>{if(r[0]) db.ref('students').push({name:r[0],class:c})}); let cl=data.classes||[]; if(!cl.includes(c)) {cl.push(c); db.ref('classes').set(cl);} Swal.fire('ุชู ุงูุงุณุชูุฑุงุฏ'); }; r.readAsArrayBuffer(inp.files[0]); }
        function importTeachers(inp) { const r=new FileReader(); r.onload=e=>{ const j=XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:'array'}).Sheets[XLSX.read(e.target.result,{type:'array'}).SheetNames[0]],{header:1}); j.forEach(r=>{if(r[0]) db.ref('teachers').push({name:r[0]})}); Swal.fire('ุชู ุงูุงุณุชูุฑุงุฏ'); }; r.readAsArrayBuffer(inp.files[0]); }
        function secureReset(type) { if(confirm('ูุชุฃูุฏุ')) { if(type==='reports') ['permits','visitors','violations','attendance','stars','tardiness'].forEach(p=>db.ref(p).remove()); location.reload(); } }
        function searchStudentHistory() { const n=document.getElementById('stu-search-name').value; if(!n) return; const h=Object.values(data.violations||{}).filter(v=>v.student.includes(n)); const s=Object.values(data.stars||{}).filter(v=>v.student.includes(n)); document.getElementById('stu-history-res').innerHTML=`<strong>${n}</strong><br>ุงููุฎุงููุงุช: ${h.length}<br>ุงููุฌูู: ${s.length}`; document.getElementById('stu-history-res').classList.remove('d-none'); }
    </script>
</body>
</html>
