<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>نظام الإدارة المدرسية (V60)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary: #006C35; --gold: #C69C6D; --bg: #F5F7FA; --dark: #1a1a1a; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg); margin: 0; padding-bottom: 60px; }

        /* شاشة الدخول المحسنة */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #004d25, #006C35); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 40px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transition: 0.3s; }
        .role-btn { border: 2px solid #f0f0f0; padding: 18px; border-radius: 15px; margin-bottom: 12px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: space-between; font-weight: 800; color: #444; }
        .role-btn:hover { border-color: var(--primary); background: #e8f5e9; transform: scale(1.02); color: var(--primary); }
        .role-btn i { font-size: 1.4rem; }
        
        /* التخطيط */
        .sidebar { width: 280px; height: 100vh; background: var(--primary); color: white; position: fixed; right: 0; top: 0; z-index: 1000; padding-top: 20px; display: flex; flex-direction: column; transition: 0.3s; }
        .main-content { margin-right: 280px; padding: 25px; transition: 0.3s; }
        @media (max-width: 991px) { .sidebar { transform: translateX(100%); } .sidebar.active { transform: translateX(0); } .main-content { margin-right: 0; } }
        
        .nav-link { padding: 15px 25px; color: rgba(255,255,255,0.85); cursor: pointer; border-right: 5px solid transparent; display: flex; align-items: center; font-weight: 600; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.15); color: white; border-right-color: var(--gold); }
        
        .page-card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); margin-bottom: 25px; border: 1px solid #eee; overflow: hidden; }
        .card-header-custom { padding: 20px; background: #fff; border-bottom: 1px solid #f0f0f0; font-weight: 800; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }

        /* شاشة المتابعة */
        .monitor-card { background: white; padding: 20px; border-radius: 15px; border-right: 6px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.03); position: relative; }
        .monitor-card.safe { border-right-color: #27ae60; }
        .monitor-card.danger { border-right-color: #c0392b; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); } }

        /* الطباعة */
        @media print {
            .no-print { display: none !important; }
            #print-area { display: block !important; padding: 40px; }
            body { background: white; }
        }
        
        #top-bar { background: white; padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 900; }
        #status-dot { width: 12px; height: 12px; background: red; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="top-bar" class="no-print">
        <div class="d-flex align-items-center">
            <div id="status-dot" title="حالة الاتصال"></div>
            <h5 class="m-0 fw-bold text-success">نظام إذن</h5>
        </div>
        <div class="d-flex align-items-center gap-3">
            <span id="alert-msg" class="badge bg-danger d-none animate__animated animate__shakeX">تنبيه طلب جديد!</span>
            <button class="btn btn-light rounded-circle shadow-sm" onclick="toggleMute()" id="mute-btn"><i class="fas fa-volume-up text-primary"></i></button>
            <button class="btn btn-outline-dark d-lg-none" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i class="fas fa-bars"></i></button>
        </div>
    </div>

    <div id="auth-overlay">
        <div class="login-card">
            <img src="https://upload.wikimedia.org/wikipedia/ar/b/bb/Logo_of_the_Ministry_of_Education_%28Saudi_Arabia%29.svg" width="120" class="mb-4">
            
            <div id="role-selection">
                <h4 class="fw-bold mb-4 text-dark">اختر نوع الدخول</h4>
                <div class="role-btn" onclick="selectRole('admin', 'المدير/ الوكيل')">
                    <span>الوكيل / المدير</span><i class="fas fa-user-tie text-primary"></i>
                </div>
                <div class="role-btn" onclick="selectRole('teacher', 'المعلم')">
                    <span>المعلم</span><i class="fas fa-chalkboard-teacher text-success"></i>
                </div>
                <div class="role-btn" onclick="selectRole('guard', 'الحارس')">
                    <span>الحارس (الزوار)</span><i class="fas fa-shield-alt text-dark"></i>
                </div>
                <div class="role-btn" onclick="selectRole('counselor', 'الموجه الطلابي')">
                    <span>الموجه الطلابي</span><i class="fas fa-user-md text-info"></i>
                </div>
            </div>

            <div id="pin-area" class="hidden">
                <h5 class="fw-bold mb-3 text-primary" id="selected-role-title">تسجيل دخول</h5>
                <input type="password" id="pin-input" class="form-control form-control-lg text-center fw-bold mb-4 fs-1" placeholder="****" style="letter-spacing: 8px;" inputmode="numeric">
                <div class="d-grid gap-2">
                    <button class="btn btn-success btn-lg rounded-pill fw-bold" onclick="doLogin()">تسجيل دخول</button>
                    <button class="btn btn-outline-secondary rounded-pill" onclick="backToRoles()">رجوع</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-body" class="d-none">
        <aside class="sidebar no-print">
            <div class="text-center mb-4 px-3">
                <i class="fas fa-school fa-3x text-warning mb-2"></i>
                <h6 class="fw-bold text-white mb-0" id="disp-school">اسم المدرسة</h6>
                <small class="text-white-50" id="disp-role">الدور</small>
            </div>
            <div id="nav-items" class="flex-grow-1"></div>
            <div class="p-3"><button class="btn btn-outline-light w-100 rounded-pill" onclick="location.reload()">تسجيل خروج</button></div>
        </aside>

        <main class="main-content">
            <section id="sec-monitor" class="view-section">
                <h4 class="fw-bold mb-4"><i class="fas fa-desktop text-success me-2"></i> متابعة حركة الطلاب</h4>
                <div id="monitor-grid" class="row g-3"></div>
                <div id="no-students" class="text-center py-5 d-none">
                    <i class="fas fa-check-circle fa-5x text-success opacity-25 mb-3"></i>
                    <h4>لا يوجد طلاب خارج الفصول حالياً</h4>
                </div>
            </section>

            <section id="sec-teacher" class="view-section d-none">
                <div class="btn-group bg-white p-2 rounded-pill shadow-sm mb-4">
                    <button class="btn btn-success rounded-pill px-4" onclick="tabTeacher('permit')">إصدار إذن خروج</button>
                    <button class="btn btn-outline-danger rounded-pill px-4 ms-2" onclick="tabTeacher('violation')">تحويل سلوكي</button>
                </div>
                <div id="t-permit-box" class="page-card p-4">
                    <div class="row g-3">
                        <div class="col-md-6"><label class="fw-bold">الفصل</label><select id="t-class" class="form-select form-select-lg" onchange="loadStudentsForRole(this.value, 't-stu')"></select></div>
                        <div class="col-md-6"><label class="fw-bold">الطالب</label><select id="t-stu" class="form-select form-select-lg" disabled><option>حدد الفصل</option></select></div>
                        <div class="col-md-6"><label class="fw-bold">الوجهة</label><select id="t-dest" class="form-select form-select-lg"><option>دورة مياه</option><option>المقصف</option><option>الإدارة</option><option>أخرى</option></select></div>
                        <div class="col-md-6"><label class="fw-bold">المدة المتوقعة (دقائق)</label><input type="number" id="t-time" class="form-control form-control-lg" value="5"></div>
                        <button class="btn btn-success py-3 mt-4 rounded-pill fw-bold" onclick="sendPermit()">إرسال الطلب </button>
                    </div>
                </div>
                <div id="t-vio-box" class="page-card p-4 d-none">
                    <div class="row g-3">
                        <div class="col-md-6"><label class="fw-bold">الطالب</label><select id="v-stu" class="form-select form-select-lg"></select></div>
                        <div class="col-md-6"><label class="fw-bold">نوع المخالفة</label><input id="v-type" class="form-control form-control-lg" placeholder="مثلاً: جوال، تأخر.."></div>
                        <div class="col-12"><label class="fw-bold">التفاصيل</label><textarea id="v-desc" class="form-control" rows="3"></textarea></div>
                        <button class="btn btn-danger py-3 rounded-pill fw-bold" onclick="sendViolation()">إحالة للوكيل</button>
                    </div>
                </div>
            </section>

            <section id="sec-admin" class="view-section d-none">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="page-card h-100 border-top border-warning border-5">
                            <div class="card-header-custom">طلبات الزوار</div>
                            <div id="adm-vis-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="page-card h-100 border-top border-danger border-5">
                            <div class="card-header-custom">المخالفات السلوكية</div>
                            <div id="adm-vio-list" class="p-3"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="page-card h-100 border-top border-primary border-5">
                            <div class="card-header-custom">أمر انصراف سريع</div>
                            <div class="p-3">
                                <input id="adm-dep-name" class="form-control mb-2" placeholder="اسم الطالب">
                                <button class="btn btn-primary w-100" onclick="sendDeparture()">إرسال للحارس</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-guard" class="view-section d-none">
                <div class="row g-4">
                    <div class="col-md-5">
                        <div class="page-card p-4 border-top border-dark border-5">
                            <h5 class="fw-bold mb-4">تسجيل دخول زائر</h5>
                            <input id="g-v-name" class="form-control mb-3" placeholder="اسم الزائر">
                            <input id="g-v-id" class="form-control mb-3" placeholder="رقم الهوية / السجل">
                            <input id="g-v-reason" class="form-control mb-3" placeholder="سبب الزيارة">
                            <button class="btn btn-dark w-100 py-3" onclick="sendVisitorReq()">طلب موافقة الوكيل</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="page-card mb-3"><div class="card-header-custom">أذونات الخروج المصدرة</div><div id="g-permit-list" class="list-group list-group-flush"></div></div>
                        <div class="page-card border-danger border-top border-4"><div class="card-header-custom text-danger">أوامر الانصراف المستعجلة</div><div id="g-dep-list" class="list-group list-group-flush"></div></div>
                    </div>
                </div>
            </section>

            <section id="sec-reports" class="view-section d-none">
                <div class="row g-3 mb-4 no-print">
                    <div class="col-md-3"><button class="btn btn-white border w-100 py-3" onclick="buildReport('permits')">تقرير الأذونات</button></div>
                    <div class="col-md-3"><button class="btn btn-white border w-100 py-3" onclick="buildReport('visitors')">تقرير الزوار</button></div>
                    <div class="col-md-3"><button class="btn btn-white border w-100 py-3" onclick="buildReport('most_out')">الأكثر خروجاً</button></div>
                    <div class="col-md-3"><button class="btn btn-white border w-100 py-3" onclick="buildReport('violations')">سجل المخالفات</button></div>
                </div>
                <div id="report-viewer" class="bg-white p-5 rounded-4 shadow-sm border d-none">
                    <div id="print-area"></div>
                    <button class="btn btn-dark w-100 mt-4 no-print" onclick="window.print()"><i class="fas fa-print me-2"></i> طباعة التقرير الرسمي</button>
                </div>
            </section>

            <section id="sec-data" class="view-section d-none">
                <div class="page-card p-4">
                    <h5 class="fw-bold mb-4 text-primary"><i class="fas fa-lock me-2"></i> إعدادات الأمان والنظام</h5>
                    
                    <div class="row g-3 mb-4 border p-3 rounded bg-light">
                        <div class="col-12"><h6 class="fw-bold border-bottom pb-2">كلمات المرور (تعديل مباشر)</h6></div>
                        <div class="col-md-3"><label class="small fw-bold">كلمة مرور الوكيل/المدير</label><input id="set-admin-pass" class="form-control text-center fw-bold" onchange="saveSettings()"></div>
                        <div class="col-md-3"><label class="small fw-bold">كلمة مرور الموجه</label><input id="set-counselor-pass" class="form-control text-center fw-bold" onchange="saveSettings()"></div>
                        <div class="col-md-3"><label class="small fw-bold">كود المعلم</label><input id="set-code" class="form-control text-center fw-bold" onchange="saveSettings()"></div>
                        <div class="col-md-3"><label class="small fw-bold">كلمة مرور الحارس</label><input id="set-guard" class="form-control text-center fw-bold" onchange="saveSettings()"></div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6"><label>اسم المدرسة (للتقارير)</label><input id="s-school" class="form-control" onchange="saveSettings()"></div>
                        <div class="col-md-6"><label>اسم مدير المدرسة</label><input id="s-manager" class="form-control" onchange="saveSettings()"></div>
                    </div>
                    
                    <hr>
                    <h5 class="fw-bold mb-3">إدارة الطلاب</h5>
                    <div class="row g-3">
                        <div class="col-md-4"><input id="imp-cls-name" class="form-control" placeholder="اسم الفصل (مثلاً: 1/1)"></div>
                        <div class="col-md-4"><button class="btn btn-success w-100" onclick="document.getElementById('f-excel').click()">استيراد طلاب من Excel</button><input type="file" id="f-excel" hidden onchange="importData(this)"></div>
                        <div class="col-md-4"><button class="btn btn-outline-danger w-100" onclick="clearData('students')">حذف جميع الطلاب</button></div>
                    </div>
                    <div class="table-responsive mt-4" style="max-height: 300px;">
                        <table class="table table-sm align-middle"><thead class="table-light"><tr><th>الاسم</th><th>الفصل</th><th>حذف</th></tr></thead><tbody id="data-stu-body"></tbody></table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <audio id="bell" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // --- 1. FIREBASE CONFIG (بياناتك) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD0IJONOe7Ef4a0XG8L1Cgbc1qVSSck0xE",
            authDomain: "ethn-63848.firebaseapp.com",
            databaseURL: "https://ethn-63848-default-rtdb.firebaseio.com",
            projectId: "ethn-63848",
            storageBucket: "ethn-63848.appspot.com",
            messagingSenderId: "747489913596",
            appId: "1:747489913596:web:d98d88447e4a25cc808579"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. GLOBAL STATE ---
        let userRole = '', isMuted = false, alertActive = false;
        // القيم الافتراضية إذا كانت القاعدة فارغة
        let data = { 
            settings: {
                school:'مدرستنا', manager:'', 
                admin: '2026', counselor: 'admin', code:'2026', guard:'1111' 
            }, 
            classes:[], students:{}, teachers:{}, permits:{}, visitors:{}, departures:{}, violations:{} 
        };

        // --- 3. CORE SYNC ---
        window.onload = () => {
            db.ref('.info/connected').on('value', s => document.getElementById('status-dot').style.background = s.val()? '#00ff00' : 'red');
            db.ref('/').on('value', snap => {
                const val = snap.val();
                if(val) {
                    // دمج البيانات القادمة مع الهيكل الأساسي لتجنب الأخطاء
                    data = { ...data, ...val };
                    data.settings = { ...{school:'مدرستنا', manager:'', admin:'2026', counselor:'admin', code:'2026', guard:'1111'}, ...(val.settings || {}) };
                    
                    if(!data.classes) data.classes = [];
                    if(typeof data.classes === 'object' && !Array.isArray(data.classes)) data.classes = Object.values(data.classes);
                    
                    document.getElementById('disp-school').innerText = data.settings.school;
                    syncSettingsInputs();
                    checkSecurityAlerts();
                    refreshScreens();
                }
            });
            setInterval(updateTimers, 30000);
        };

        // --- 4. AUTH & NAVIGATION (SECURE & IMPROVED) ---
        function selectRole(roleId, roleTitle) { 
            userRole = roleId; 
            document.getElementById('role-selection').classList.add('hidden'); 
            document.getElementById('pin-area').classList.remove('hidden'); 
            document.getElementById('selected-role-title').innerText = 'تسجيل دخول: ' + roleTitle;
            document.getElementById('pin-input').value = '';
            document.getElementById('pin-input').focus();
        }

        function backToRoles() {
            document.getElementById('pin-area').classList.add('hidden');
            document.getElementById('role-selection').classList.remove('hidden');
        }

        function doLogin() {
            const pin = document.getElementById('pin-input').value.trim();
            // التحقق من كلمات المرور (مع دعم النوع string/number)
            let ok = false;
            
            if (userRole === 'admin' && String(pin) === String(data.settings.admin)) ok = true;
            else if (userRole === 'teacher' && String(pin) === String(data.settings.code)) ok = true;
            else if (userRole === 'guard' && String(pin) === String(data.settings.guard)) ok = true;
            else if (userRole === 'counselor' && String(pin) === String(data.settings.counselor)) ok = true;
            
            if(ok) {
                document.getElementById('auth-overlay').style.display='none';
                document.getElementById('app-body').classList.remove('d-none');
                buildMenu();
                navigate(userRole==='guard'?'guard':(userRole==='counselor'?'counselor':(userRole==='admin'?'monitor':'teacher')));
            } else {
                Swal.fire({ icon: 'error', title: 'خطأ', text: 'رمز الدخول غير صحيح، حاول مرة أخرى.' });
            }
        }

        function buildMenu() {
            const m = document.getElementById('nav-items');
            document.getElementById('disp-role').innerText = {'admin':'الوكيل','teacher':'المعلم','guard':'الحارس','counselor':'الموجه'}[userRole];
            let links = [['monitor','المتابعة','desktop']];
            if(userRole==='teacher') links.push(['teacher','الأذونات','paper-plane']);
            if(userRole==='admin') links.push(['admin','لوحة التحكم','tasks'], ['reports','التقارير','file-alt'], ['data','الإعدادات والبيانات','cogs']);
            if(userRole==='guard') links = [['guard','البوابة الأمنية','id-badge']];
            if(userRole==='counselor') links.push(['reports','سجل الطلاب','user-graduate']);
            
            m.innerHTML = links.map(l => `<div class="nav-link" onclick="navigate('${l[0]}')"><i class="fas fa-${l[2]} me-2"></i> ${l[1]}</div>`).join('');
        }

        function navigate(id) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.add('d-none'));
            document.getElementById('sec-'+id).classList.remove('d-none');
            if(window.innerWidth < 992) document.querySelector('.sidebar').classList.remove('active');
            refreshScreens();
        }

        // --- 5. ALERT SYSTEM ---
        function checkSecurityAlerts() {
            let shouldRing = false;
            if(userRole === 'guard') {
                const hasNewPermit = Object.values(data.permits || {}).some(p => p.active && !p.guardSeen);
                const hasNewDep = Object.values(data.departures || {}).some(d => d.status === 'pending' && !d.guardSeen);
                if(hasNewPermit || hasNewDep) shouldRing = true;
            }
            if(userRole === 'admin') {
                const hasNewVisitor = Object.values(data.visitors || {}).some(v => v.status === 'pending');
                if(hasNewVisitor) shouldRing = true;
            }
            if(shouldRing && !isMuted) startRinging(); else stopRinging();
        }

        function startRinging() { alertActive = true; document.getElementById('bell').play().catch(()=>{}); document.getElementById('alert-msg').classList.remove('d-none'); }
        function stopRinging() { alertActive = false; document.getElementById('bell').pause(); document.getElementById('alert-msg').classList.add('d-none'); }
        function toggleMute() { isMuted = !isMuted; document.getElementById('mute-btn').innerHTML = isMuted ? '<i class="fas fa-volume-mute text-danger"></i>' : '<i class="fas fa-volume-up text-primary"></i>'; if(isMuted) stopRinging(); }

        // --- 6. SCREEN REFRESHERS ---
        function refreshScreens() {
            if(!document.getElementById('sec-monitor').classList.contains('d-none')) renderMonitor();
            if(!document.getElementById('sec-admin').classList.contains('d-none')) renderAdmin();
            if(!document.getElementById('sec-guard').classList.contains('d-none')) renderGuard();
            if(!document.getElementById('sec-data').classList.contains('d-none')) renderDataTable();
            
            const clsSel = document.getElementById('t-class');
            if(clsSel) {
                const cur = clsSel.value;
                clsSel.innerHTML = '<option value="">اختر الفصل</option>' + (data.classes || []).map(c => `<option value="${c}">${c}</option>`).join('');
                clsSel.value = cur;
            }
        }

        function renderMonitor() {
            const grid = document.getElementById('monitor-grid');
            const active = Object.entries(data.permits || {}).filter(([k,v]) => v.active);
            document.getElementById('no-students').classList.toggle('d-none', active.length > 0);
            grid.innerHTML = active.map(([k,p]) => {
                const mins = Math.floor((new Date() - new Date(p.start))/60000);
                return `<div class="col-md-3"><div class="monitor-card ${mins>=p.limit?'danger':'safe'}">
                    <h5 class="fw-bold">${p.student}</h5><small class="text-muted">${p.class} -> ${p.dest}</small>
                    <h2 class="my-2 ${mins>=p.limit?'text-danger':'text-success'}">${mins} د</h2>
                    <button class="btn btn-dark btn-sm w-100 rounded-pill" onclick="db.ref('permits/${k}').update({active:false, end:new Date().toISOString()})">عودة للفصل</button>
                </div></div>`;
            }).join('');
        }

        function renderAdmin() {
            document.getElementById('adm-vis-list').innerHTML = Object.entries(data.visitors || {}).filter(([k,v])=>v.status==='pending').map(([k,v])=>`
                <div class="list-group-item p-3">
                    <strong>${v.name}</strong><br><small>${v.reason}</small>
                    <div class="mt-2 d-flex gap-2">
                        <button class="btn btn-sm btn-success w-100" onclick="approveVisitor('${k}', 'approved')">موافقة</button>
                        <button class="btn btn-sm btn-danger w-100" onclick="approveVisitor('${k}', 'rejected')">رفض</button>
                    </div>
                </div>`).join('') || '<div class="p-4 text-center text-muted">لا توجد طلبات</div>';
            
            document.getElementById('adm-vio-list').innerHTML = Object.entries(data.violations || {}).filter(([k,v])=>v.status==='pending_admin').map(([k,v])=>`
                <div class="alert alert-danger p-2 mb-2">
                    <small>${v.student} (${v.class})</small><br><strong>${v.type}</strong>
                    <button class="btn btn-sm btn-dark w-100 mt-2" onclick="forwardToCounselor('${k}')">تحويل للموجه</button>
                </div>`).join('') || '<div class="text-center text-muted">سجل نظيف</div>';
        }

        function renderGuard() {
            document.getElementById('g-permit-list').innerHTML = Object.entries(data.permits || {}).filter(([k,v])=>v.active).reverse().map(([k,p])=>`
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div><strong>${p.student}</strong><br><small>${p.class} - ${p.dest}</small></div>
                    <button class="btn btn-success btn-sm" onclick="db.ref('permits/${k}').update({guardSeen:true})">تأكيد المشاهدة</button>
                </div>`).join('');
            
            document.getElementById('g-dep-list').innerHTML = Object.entries(data.departures || {}).filter(([k,d])=>d.status==='pending').map(([k,d])=>`
                <div class="alert alert-danger d-flex justify-content-between align-items-center">
                    <strong>${d.name}</strong>
                    <button class="btn btn-sm btn-success" onclick="db.ref('departures/${k}').update({status:'exited', guardSeen:true})">تم الخروج</button>
                </div>`).join('');
        }

        function renderCounselor() {
            document.getElementById('counselor-list').innerHTML = Object.entries(data.referrals||{}).filter(([k,r])=>r.status==='pending_counselor').map(([k,r])=>`
                <tr><td>${r.student}</td><td>${r.type}</td><td>${r.admin_action||'تحويل'}</td><td>${r.date}</td><td><button class="btn btn-success btn-sm" onclick="db.ref('referrals/${k}').update({status:'closed'})">إغلاق</button></td></tr>`).join('');
        }

        // --- 7. DATA ACTIONS ---
        function loadStudentsForRole(cls, targetId) {
            const list = Object.values(data.students || {}).filter(s => s.class === cls);
            const el = document.getElementById(targetId);
            el.innerHTML = list.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            el.disabled = false;
        }

        function sendPermit() {
            const p = { student: document.getElementById('t-stu').value, class: document.getElementById('t-class').value, dest: document.getElementById('t-dest').value, limit: parseInt(document.getElementById('t-time').value), start: new Date().toISOString(), active: true, guardSeen: false };
            db.ref('permits').push(p).then(() => { Swal.fire('تم الإرسال','سيظهر الطلب عند الحارس الآن','success'); navigate('monitor'); });
        }

        function sendVisitorReq() {
            const v = { name: document.getElementById('g-v-name').value, id: document.getElementById('g-v-id').value, reason: document.getElementById('g-v-reason').value, status: 'pending', time: new Date().toLocaleString() };
            if(v.name) db.ref('visitors').push(v).then(() => { Swal.fire('تم الإرسال','انتظر موافقة الوكيل','info'); document.querySelectorAll('#sec-guard input').forEach(i=>i.value=''); });
        }

        function approveVisitor(id, stat) { db.ref(`visitors/${id}`).update({status: stat}); }
        function sendDeparture() { const n = document.getElementById('adm-dep-name').value; if(n) db.ref('departures').push({name:n, status:'pending', guardSeen:false, time:new Date().toLocaleString()}); }

        // --- 8. SETTINGS & DATA MGMT (القلب الجديد) ---
        function syncSettingsInputs() {
            const s = data.settings;
            document.getElementById('s-school').value = s.school;
            document.getElementById('s-manager').value = s.manager;
            document.getElementById('set-code').value = s.code;
            document.getElementById('set-guard').value = s.guard;
            document.getElementById('set-admin-pass').value = s.admin;
            document.getElementById('set-counselor-pass').value = s.counselor || 'admin';
        }
        function saveSettings() {
            db.ref('settings').set({ 
                school: document.getElementById('s-school').value, 
                manager: document.getElementById('s-manager').value, 
                code: document.getElementById('set-code').value, 
                guard: document.getElementById('set-guard').value,
                admin: document.getElementById('set-admin-pass').value,
                counselor: document.getElementById('set-counselor-pass').value
            });
            Swal.fire('تم التحديث','تم حفظ جميع الإعدادات وكلمات المرور','success');
        }
        function importData(inp) {
            const f = inp.files[0], cls = document.getElementById('imp-cls-name').value;
            if(!cls) return Swal.fire('تنبيه','اكتب اسم الفصل أولاً','warning');
            const r = new FileReader();
            r.onload = e => {
                const j = XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:'array'}).Sheets[XLSX.read(e.target.result,{type:'array'}).SheetNames[0]],{header:1});
                j.forEach(row => { if(row[0]) db.ref('students').push({name:row[0], class:cls}); });
                let n = data.classes || []; if(!n.includes(cls)) { n.push(cls); db.ref('classes').set(n); }
                Swal.fire('تم الاستيراد');
            }; r.readAsArrayBuffer(f);
        }
        function renderDataTable() {
            document.getElementById('data-stu-body').innerHTML = Object.entries(data.students || {}).reverse().slice(0,50).map(([k,s]) => `<tr><td>${s.name}</td><td>${s.class}</td><td><button class="btn btn-sm btn-danger" onclick="db.ref('students/${k}').remove()"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        }
        function clearData(p) { if(confirm('متأكد؟ سيتم حذف كل الطلاب!')) db.ref(p).remove(); }
        function tabTeacher(t) {
            document.getElementById('t-permit-box').classList.toggle('hidden', t!=='permit');
            document.getElementById('t-vio-box').classList.toggle('hidden', t!=='violation');
            if(t==='violation') document.getElementById('v-stu').innerHTML = Object.values(data.students || {}).map(s=>`<option>${s.name} (${s.class})</option>`).join('');
        }
        function updateTimers() { if(!document.getElementById('sec-monitor').classList.contains('hidden')) renderMonitor(); }
        function sendReferral() { const r = { student: document.getElementById('v-stu').value, type: document.getElementById('v-type').value, desc: document.getElementById('v-desc').value, status: 'pending_admin', date: new Date().toLocaleDateString('ar-SA') }; db.ref('violations').push(r); Swal.fire('تم الرفع'); }
        function forwardToCounselor(k) { db.ref('violations/'+k).update({status:'pending_counselor', admin_action:'تحويل للموجه'}); }
        
        // --- 9. REPORTS ---
        function buildReport(type) {
            const viewer = document.getElementById('report-viewer');
            const area = document.getElementById('print-area');
            viewer.classList.remove('hidden');
            let html = `
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid var(--primary); padding-bottom:15px; margin-bottom:30px;">
                    <div style="text-align:right;">المملكة العربية السعودية<br>وزارة التعليم<br>${data.settings.school}</div>
                    <img src="https://upload.wikimedia.org/wikipedia/ar/b/bb/Logo_of_the_Ministry_of_Education_%28Saudi_Arabia%29.svg" width="120">
                    <div style="text-align:left;">التاريخ: ${new Date().toLocaleDateString('ar-SA')}<br>تقرير الكتروني نظام إذن</div>
                </div>`;

            if(type === 'permits') {
                html += '<h4 class="text-center fw-bold mb-4">سجل أذونات خروج الطلاب</h4><table class="table table-bordered text-center"><thead><tr><th>الطالب</th><th>الفصل</th><th>الوجهة</th><th>الوقت</th></tr></thead><tbody>';
                html += Object.values(data.permits || {}).reverse().map(p => `<tr><td>${p.student}</td><td>${p.class}</td><td>${p.dest}</td><td>${new Date(p.start).toLocaleTimeString('ar-SA')}</td></tr>`).join('');
                html += '</tbody></table>';
            } else if(type === 'most_out') {
                let stats = {}; Object.values(data.permits || {}).forEach(p => stats[p.student] = (stats[p.student] || 0) + 1);
                let sorted = Object.entries(stats).sort((a,b) => b[1]-a[1]);
                html += '<h4 class="text-center fw-bold mb-4">الطلاب الأكثر خروجاً (متابعة سلوكية)</h4><table class="table table-bordered text-center"><thead><tr><th>اسم الطالب</th><th>عدد مرات الخروج</th></tr></thead><tbody>';
                html += sorted.map(s => `<tr><td>${s[0]}</td><td>${s[1]} مرّة</td></tr>`).join('');
                html += '</tbody></table>';
            } else if(type === 'visitors') {
                html += '<h4 class="text-center fw-bold mb-4">سجل زوار المدرسة</h4><table class="table table-bordered text-center"><thead><tr><th>اسم الزائر</th><th>السبب</th><th>الوقت</th><th>الحالة</th></tr></thead><tbody>';
                html += Object.values(data.visitors || {}).reverse().map(v => `<tr><td>${v.name}</td><td>${v.reason}</td><td>${v.time}</td><td>${v.status}</td></tr>`).join('');
                html += '</tbody></table>';
            }

            html += `
                <div style="margin-top:60px; display:flex; justify-content:space-around; text-align:center;">
                    <div><strong>وكيل شؤون الطلاب</strong><br><br>..............................</div>
                    <div><strong>مدير المدرسة</strong><br>${data.settings.manager}<br><br>..............................</div>
                </div>`;
            area.innerHTML = html;
        }
    </script>
</body>
</html>