<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f4c3a">
    <title>نظام إذن الشامل (V36 Final)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary: #0f4c3a; --gold: #d4af37; --bg: #f4f7f6; --danger: #dc3545; --info: #0dcaf0; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg); padding-bottom: 80px; }

        /* Login */
        #auth-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, var(--primary), #000); z-index:9999; display:flex; align-items:center; justify-content:center; }
        .auth-card { background:white; padding:40px; border-radius:20px; width:400px; text-align:center; border-top:5px solid var(--gold); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Sidebar & Layout */
        .sidebar { width:260px; height:100vh; background:#072b21; color:white; position:fixed; right:0; top:0; padding-top:20px; z-index:1000; overflow-y:auto; transition:0.3s; }
        .main-content { margin-right:260px; padding:25px; transition:0.3s; }
        @media (max-width: 768px) { 
            .sidebar { transform: translateX(100%); width:100%; } 
            .sidebar.active { transform: translateX(0); } 
            .main-content { margin-right:0; padding:15px; } 
            .mobile-header { display:flex !important; } 
        }
        .mobile-header { display:none; background:var(--primary); color:white; padding:15px; justify-content:space-between; margin:-15px -15px 15px -15px; align-items: center; }

        /* Custom UI */
        .nav-link { color:rgba(255,255,255,0.8); padding:12px 20px; border-right:4px solid transparent; cursor:pointer; display:flex; align-items:center; margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { background:rgba(255,255,255,0.1); color:white; border-right-color:var(--gold); }
        
        .card-custom { border:none; border-radius:15px; background:white; box-shadow:0 5px 15px rgba(0,0,0,0.05); overflow:hidden; margin-bottom:20px; }
        .card-header-c { background:var(--primary); color:white; padding:15px; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
        
        /* Icons Buttons */
        .action-btn { cursor:pointer; padding:5px 8px; border-radius:5px; transition:0.2s; margin: 0 2px; }
        .action-btn.delete { color: var(--danger); background: #fee2e2; }
        .action-btn.transfer { color: var(--primary); background: #d1fae5; }
        .action-btn:hover { transform: scale(1.1); }

        /* Monitor Cards */
        .monitor-card { background:white; padding:15px; border-radius:12px; border-right:5px solid #ccc; box-shadow:0 3px 10px rgba(0,0,0,0.05); margin-bottom:10px; position: relative; }
        .monitor-card.safe { border-right-color:#198754; }
        .monitor-card.danger { border-right-color:var(--danger); animation:pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow:0 0 0 0 rgba(220,53,69,0.4); } 70% { box-shadow:0 0 0 10px rgba(220,53,69,0); } 100% { box-shadow:0 0 0 0 rgba(220,53,69,0); } }

        .hidden { display:none !important; }
        @media print { .no-print, .sidebar { display:none !important; } .main-content { margin:0; } }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div id="role-selection" class="auth-card">
            <h3 class="fw-bold mb-4 text-dark">نظام إذن (V36)</h3>
            <div class="d-grid gap-3">
                <button class="btn btn-outline-success py-2 fw-bold" onclick="showPin('teacher')"><i class="fas fa-chalkboard-teacher me-2"></i> المعلم</button>
                <button class="btn btn-outline-primary py-2 fw-bold" onclick="showPin('admin')"><i class="fas fa-user-tie me-2"></i> الإدارة</button>
                <button class="btn btn-outline-dark py-2 fw-bold" onclick="showPin('guard')"><i class="fas fa-user-shield me-2"></i> الحارس</button>
            </div>
        </div>
        <div id="pin-entry" class="auth-card hidden">
            <div class="d-flex justify-content-between mb-3"><h5 class="m-0">الرمز السري</h5><button class="btn btn-sm btn-light" onclick="resetLogin()">&times;</button></div>
            <input type="password" id="pin-input" class="form-control text-center mb-3 fs-3" placeholder="****" inputmode="numeric">
            <button class="btn btn-success w-100" onclick="attemptLogin()">دخول</button>
        </div>
    </div>

    <div id="app-interface" class="hidden">
        
        <div class="mobile-header">
            <h5 class="m-0 fw-bold">نظام إذن</h5>
            <button class="btn text-white" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i class="fas fa-bars"></i></button>
        </div>

        <aside class="sidebar">
            <div class="text-center p-3 border-bottom border-secondary mb-3">
                <i class="fas fa-school fa-3x mb-2 text-white"></i>
                <h6 class="m-0 text-white">الإمام النووي</h6>
                <small class="text-warning" id="role-disp">--</small>
            </div>
            <nav id="nav-menu"></nav>
            <div class="p-3 mt-auto"><button class="btn btn-outline-danger w-100 btn-sm" onclick="location.reload()">خروج</button></div>
        </aside>

        <main class="main-content">
            
            <section id="sec-monitor" class="app-section">
                <div class="d-flex justify-content-between mb-3 align-items-center no-print">
                    <h4 class="fw-bold m-0"><i class="fas fa-desktop text-warning me-2"></i>المتابعة</h4>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm" id="mute-btn" onclick="toggleMute()"><i class="fas fa-volume-up"></i></button>
                        <button class="btn btn-dark btn-sm" onclick="forceUpdate()"><i class="fas fa-sync"></i></button>
                    </div>
                </div>
                <div id="monitor-grid" class="row g-2"></div>
                <div id="empty-state" class="text-center text-muted py-5 hidden"><h5>الجميع في الفصول</h5></div>
            </section>

            <section id="sec-management" class="app-section hidden">
                <ul class="nav nav-tabs mb-4" id="manage-tabs">
                    <li class="nav-item"><button class="nav-link active text-dark fw-bold" onclick="showManageTab('students')">إدارة الطلاب</button></li>
                    <li class="nav-item"><button class="nav-link text-dark fw-bold" onclick="showManageTab('teachers')">إدارة المعلمين</button></li>
                    <li class="nav-item"><button class="nav-link text-dark fw-bold" onclick="showManageTab('system')">إعدادات النظام</button></li>
                </ul>

                <div id="tab-students" class="manage-content">
                    
                    <div class="card-custom p-3 bg-light border">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-3">
                                <label class="fw-bold small">1. حدد الفصل (مهم للاستيراد)</label>
                                <input list="class-list-dl" id="stu-class-input" class="form-control" placeholder="اكتب اسم الفصل">
                            </div>
                            <div class="col-md-3">
                                <label class="fw-bold small">2. إجراءات</label>
                                <button class="btn btn-success w-100" onclick="document.getElementById('file-stu').click()">
                                    <i class="fas fa-file-excel me-1"></i> استيراد من Excel
                                </button>
                                <input type="file" id="file-stu" hidden onchange="importData(this, 'students')">
                            </div>
                            <div class="col-md-3">
                                <label class="fw-bold small">أو</label>
                                <button class="btn btn-primary w-100" onclick="addSingleStudent()">
                                    <i class="fas fa-plus me-1"></i> إضافة طالب يدوياً
                                </button>
                            </div>
                            <div class="col-md-3">
                                <label class="fw-bold small">بحث</label>
                                <input type="text" class="form-control" placeholder="ابحث بالاسم..." onkeyup="filterTable('stu-table', this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="card-custom">
                        <div class="card-header-c">
                            <span>قائمة الطلاب</span>
                            <button class="btn btn-sm btn-outline-light" onclick="deleteAll('students')">حذف الجميع</button>
                        </div>
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-hover align-middle mb-0" id="stu-table">
                                <thead class="table-light"><tr><th>الاسم</th><th>الفصل</th><th>إجراءات (نقل / حذف)</th></tr></thead>
                                <tbody id="stu-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-teachers" class="manage-content hidden">
                    <div class="card-custom p-3 bg-light border mb-3">
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="document.getElementById('file-tea').click()">
                                <i class="fas fa-file-excel me-2"></i> استيراد قائمة المعلمين
                            </button>
                            <input type="file" id="file-tea" hidden onchange="importData(this, 'teachers')">
                            
                            <button class="btn btn-primary" onclick="addSingleTeacher()">
                                <i class="fas fa-plus me-2"></i> إضافة معلم
                            </button>
                        </div>
                    </div>
                    
                    <div class="card-custom">
                        <div class="card-header-c">
                            <span>قائمة المعلمين</span>
                            <button class="btn btn-sm btn-outline-light" onclick="deleteAll('teachers')">حذف الجميع</button>
                        </div>
                        <table class="table table-hover mb-0">
                            <tbody id="tea-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-system" class="manage-content hidden">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card-custom p-4 text-center border-warning">
                                <h6 class="text-muted">كود دخول المعلمين</h6>
                                <h2 class="text-primary fw-bold my-3" id="disp-code">----</h2>
                                <button class="btn btn-sm btn-dark" onclick="newCode()">تحديث الكود</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card-custom p-4 text-center border-dark">
                                <h6 class="text-muted">كلمة مرور الحارس</h6>
                                <h2 class="text-dark fw-bold my-3" id="disp-guard">----</h2>
                                <button class="btn btn-sm btn-outline-dark" onclick="newGuardPass()">تغيير الكلمة</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-reports" class="app-section hidden">
                <div class="d-flex justify-content-between mb-3 no-print">
                    <h4 class="fw-bold">التقارير</h4>
                    <button class="btn btn-dark btn-sm" onclick="window.print()">طباعة</button>
                </div>
                <div class="card-custom p-2 mb-3 no-print overflow-auto">
                    <div class="d-flex gap-2" style="min-width: max-content;">
                        <button class="btn btn-outline-primary active" onclick="showReport('all', this)">1. سجل الأذونات</button>
                        <button class="btn btn-outline-primary" onclick="showReport('least', this)">2. الأقل استئذاناً</button>
                        <button class="btn btn-outline-primary" onclick="showReport('most', this)">3. الأكثر استئذاناً</button>
                        <button class="btn btn-outline-primary" onclick="showReport('visitors', this)">4. سجل الزوار</button>
                        <button class="btn btn-outline-primary" onclick="showReport('departures', this)">5. الانصراف المبكر</button>
                    </div>
                </div>
                <div class="card-custom p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered text-center mb-0 table-sm" id="rep-table">
                            <thead class="table-light" id="rep-head"></thead>
                            <tbody id="rep-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sec-permit" class="app-section hidden">
                <div class="card-custom">
                    <div class="card-header-c">إصدار إذن</div>
                    <div class="card-body p-4">
                        <form onsubmit="issuePermit(event)">
                            <label class="fw-bold">الفصل</label>
                            <input list="class-list-dl" id="t-class" class="form-control mb-3" placeholder="اختر الفصل" onchange="loadClassStudents(this.value)" required>
                            <datalist id="class-list-dl"></datalist>
                            
                            <label class="fw-bold">الطالب</label>
                            <select id="t-student" class="form-select mb-3" disabled></select>
                            
                            <div class="row">
                                <div class="col-6">
                                    <label class="fw-bold">الوجهة</label>
                                    <select id="t-dest" class="form-select mb-3">
                                        <option>دورة مياه</option><option>المقصف</option>
                                        <option>الإدارة</option><option>الموجه</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="fw-bold">الوقت (دقيقة)</label>
                                    <input type="number" id="t-time" class="form-control mb-3" value="5">
                                </div>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="t-special">
                                <label class="form-check-label text-danger fw-bold" for="t-special">تجاهل النظام (حالة خاصة)</label>
                            </div>
                            <button class="btn btn-success w-100 fw-bold">تسجيل خروج</button>
                        </form>
                    </div>
                </div>
            </section>

            <section id="sec-guard" class="app-section hidden">
                <ul class="nav nav-pills nav-fill mb-3 gap-2">
                    <li class="nav-item"><a class="nav-link active bg-white border" onclick="toggleGuardView('visit')">زوار</a></li>
                    <li class="nav-item"><a class="nav-link bg-white border" onclick="toggleGuardView('exit')">مغادرة</a></li>
                </ul>
                <div id="view-visit">
                    <div class="card-custom p-3">
                        <h6 class="fw-bold">تسجيل زائر</h6>
                        <input id="g-name" class="form-control mb-2" placeholder="الاسم">
                        <input id="g-id" type="number" class="form-control mb-2" placeholder="الهوية">
                        <input id="g-reason" class="form-control mb-2" placeholder="السبب">
                        <input id="g-student" class="form-control mb-2" placeholder="الطالب المزار">
                        <button class="btn btn-dark w-100" onclick="sendVisitor()">إرسال</button>
                    </div>
                    <div id="g-visit-list" class="list-group"></div>
                </div>
                <div id="view-exit" class="hidden">
                    <div id="g-exit-list" class="list-group"></div>
                </div>
            </section>

            <section id="sec-agent" class="app-section hidden">
                <h4 class="fw-bold mb-3">لوحة الوكيل</h4>
                <div class="row g-3">
                    <div class="col-md-6"><div class="card-custom"><div class="card-header-c bg-warning text-dark">طلبات الزوار</div><div id="agent-vis-list" class="list-group list-group-flush"></div></div></div>
                    <div class="col-md-6">
                        <div class="card-custom">
                            <div class="card-header-c bg-danger">أمر انصراف</div>
                            <div class="card-body p-3">
                                <input id="dep-name" class="form-control mb-2" placeholder="اسم الطالب">
                                <input id="dep-reason" class="form-control mb-2" placeholder="السبب">
                                <button class="btn btn-danger w-100" onclick="sendDeparture()">السماح بالخروج</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // --- FIREBASE CONFIG (تأكد من وضع بياناتك هنا) ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- STATE ---
        let role = '', localData = { code:'2026', guardPass:'1111', students:{}, teachers:{}, permits:{}, visitors:{}, departures:{}, classes:[] };
        let isMuted=false, lastSound=0;

        // --- INIT ---
        window.onload = () => {
            db.ref('/').on('value', snap => {
                const val = snap.val();
                if(val) {
                    localData = val;
                    if(!localData.classes) localData.classes = [];
                    updateUI();
                }
            });
            setInterval(monitorLoop, 2000);
        };

        function updateUI() {
            document.getElementById('disp-code').innerText = localData.code;
            document.getElementById('disp-guard').innerText = localData.guardPass;
            
            const dl = document.getElementById('class-list-dl');
            dl.innerHTML = '';
            (localData.classes || []).forEach(c => dl.innerHTML += `<option value="${c}">`);

            if(role === 'admin' && !document.getElementById('sec-management').classList.contains('hidden')) renderManageTables();
            if(role === 'admin' && !document.getElementById('sec-agent').classList.contains('hidden')) renderAgent();
            if(role === 'guard') renderGuard();
            if(!document.getElementById('sec-monitor').classList.contains('hidden')) renderMonitor();
        }

        // --- AUTH ---
        function showPin(r) { role=r; document.getElementById('role-selection').style.display='none'; document.getElementById('pin-entry').classList.remove('hidden'); }
        function resetLogin() { document.getElementById('pin-entry').classList.add('hidden'); document.getElementById('role-selection').style.display='block'; }
        function attemptLogin() {
            const p = document.getElementById('pin-input').value;
            let ok = false;
            if(role==='admin' && p==='admin') ok=true;
            else if(role==='guard' && p==localData.guardPass) ok=true;
            else if(role==='teacher' && p==localData.code) ok=true;

            if(ok) {
                document.getElementById('auth-overlay').style.display='none';
                document.getElementById('app-interface').classList.remove('hidden');
                buildMenu();
                navigate(role==='guard'?'guard':(role==='admin'?'management':'monitor'));
            } else Swal.fire('خطأ','الرمز غير صحيح','error');
        }

        // --- DATA MANAGEMENT ---
        function showManageTab(tab) {
            document.querySelectorAll('.manage-content').forEach(e => e.classList.add('hidden'));
            document.getElementById('tab-'+tab).classList.remove('hidden');
            document.querySelectorAll('#manage-tabs button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderManageTables();
        }

        function renderManageTables() {
            // Students Table
            const sBody = document.getElementById('stu-tbody');
            const sList = Object.entries(localData.students || {});
            sBody.innerHTML = sList.reverse().map(([key, s]) => `
                <tr>
                    <td>${s.name}</td>
                    <td><span class="badge bg-secondary">${s.class}</span></td>
                    <td>
                        <button class="action-btn transfer" onclick="transferStudent('${key}', '${s.name}')" title="نقل"><i class="fas fa-exchange-alt"></i></button>
                        <button class="action-btn delete" onclick="deleteItem('students', '${key}')" title="حذف"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            // Teachers Table
            const tBody = document.getElementById('tea-tbody');
            const tList = Object.entries(localData.teachers || {});
            tBody.innerHTML = tList.map(([key, t]) => `
                <tr>
                    <td>${t.name}</td>
                    <td><button class="action-btn delete" onclick="deleteItem('teachers', '${key}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        function addSingleStudent() {
            Swal.fire({
                title: 'إضافة طالب',
                html: '<input id="swal-name" class="swal2-input" placeholder="الاسم">' +
                      '<input id="swal-class" class="swal2-input" placeholder="الفصل">',
                preConfirm: () => [document.getElementById('swal-name').value, document.getElementById('swal-class').value]
            }).then((res) => {
                if(res.value && res.value[0] && res.value[1]) {
                    db.ref('students').push({name: res.value[0], class: res.value[1]});
                    checkAddClass(res.value[1]);
                    Swal.fire('تم','','success');
                }
            });
        }

        function addSingleTeacher() {
            Swal.fire({input:'text', title:'اسم المعلم'}).then(r => {
                if(r.value) { db.ref('teachers').push({name: r.value}); Swal.fire('تم','','success'); }
            });
        }

        function transferStudent(key, name) {
            Swal.fire({
                title: `نقل الطالب: ${name}`,
                input: 'text',
                inputLabel: 'اكتب الفصل الجديد',
                showCancelButton: true
            }).then(r => {
                if(r.value) {
                    db.ref(`students/${key}`).update({class: r.value});
                    checkAddClass(r.value);
                    Swal.fire('تم النقل','','success');
                }
            });
        }

        function deleteItem(path, key) {
            Swal.fire({title:'تأكيد الحذف؟', icon:'warning', showCancelButton:true}).then(r => {
                if(r.isConfirmed) db.ref(`${path}/${key}`).remove();
            });
        }
        
        function deleteAll(path) {
            Swal.fire({title:'حذف الجميع؟', text:'لا يمكن التراجع', icon:'warning', showCancelButton:true}).then(r => {
                if(r.isConfirmed) db.ref(path).remove();
            });
        }

        function checkAddClass(cls) {
            let classes = localData.classes || [];
            if(!classes.includes(cls)) {
                classes.push(cls);
                db.ref('classes').set(classes);
            }
        }

        function importData(inp, type) {
            const f = inp.files[0];
            const cls = document.getElementById('stu-class-input').value;
            if(type === 'students' && !cls) return Swal.fire('تنبيه', 'يجب كتابة الفصل أولاً', 'warning');
            
            const r = new FileReader();
            r.onload = e => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                json.forEach(row => {
                    if(row[0]) {
                        if(type==='students') db.ref('students').push({name: row[0], class: cls});
                        if(type==='teachers') db.ref('teachers').push({name: row[0]});
                    }
                });
                if(type==='students') checkAddClass(cls);
                Swal.fire('تم الاستيراد','','success');
            };
            r.readAsArrayBuffer(f);
        }

        function newCode() { db.ref('code').set(Math.floor(1000+Math.random()*9000)); }
        function newGuardPass() { Swal.fire({input:'text', title:'جديد'}).then(r=>{if(r.value) db.ref('guardPass').set(r.value)}); }
        function filterTable(tid,q) { document.querySelectorAll(`#${tid} tbody tr`).forEach(r=>{r.style.display=r.innerText.toLowerCase().includes(q.toLowerCase())?'':'none'}); }

        // --- TEACHER ---
        function loadClassStudents(cls) {
            const sel = document.getElementById('t-student');
            sel.innerHTML = '<option>-- اختر --</option>'; sel.disabled=false;
            Object.values(localData.students || {}).filter(s => s.class === cls).forEach(s => {
                sel.innerHTML += `<option value="${s.name}">${s.name}</option>`;
            });
        }

        function issuePermit(e) {
            e.preventDefault();
            const s=document.getElementById('t-student').value, c=document.getElementById('t-class').value;
            if(!s) return;
            const active = Object.values(localData.permits||{}).find(p => p.student===s && p.active);
            if(active) return Swal.fire('الطالب بالخارج','','error');
            
            db.ref('permits').push({
                student:s, class:c, dest:document.getElementById('t-dest').value,
                limit: parseInt(document.getElementById('t-time').value),
                start: new Date().toISOString(), active:true
            });
            navigate('monitor'); e.target.reset();
        }

        // --- MONITOR ---
        function monitorLoop() { if(!document.getElementById('sec-monitor').classList.contains('hidden')) renderMonitor(); }
        function renderMonitor() {
            const grid = document.getElementById('monitor-grid');
            const active = Object.entries(localData.permits||{}).filter(([k,v]) => v.active);
            if(active.length===0) { document.getElementById('empty-state').classList.remove('hidden'); grid.innerHTML=''; return; }
            document.getElementById('empty-state').classList.add('hidden');
            
            let alert=false;
            grid.innerHTML = active.map(([k,p]) => {
                const min = Math.floor((new Date()-new Date(p.start))/60000);
                const late = min >= p.limit; if(late) alert=true;
                return `<div class="col-6 col-md-4"><div class="monitor-card ${late?'danger':'safe'}"><strong>${p.student}</strong><br><small>${p.dest}</small><h3>${min}د</h3><button class="btn btn-dark btn-sm w-100" onclick="db.ref('permits/${k}').update({active:false, endTime:new Date().toISOString()})">عودة</button></div></div>`;
            }).join('');
            
            if(alert && !isMuted && Date.now()-lastSound > 10000) { document.getElementById('alert-sound').play().catch(()=>{}); lastSound=Date.now(); }
        }
        function toggleMute() { isMuted=!isMuted; document.getElementById('mute-btn').classList.toggle('btn-danger'); }

        // --- GUARD & AGENT ---
        function sendVisitor() {
            const v = {name:document.getElementById('g-name').value, id:document.getElementById('g-id').value, reason:document.getElementById('g-reason').value, student:document.getElementById('g-student').value, status:'pending', time:new Date().toLocaleString()};
            if(v.name) { db.ref('visitors').push(v); Swal.fire('تم الإرسال'); document.querySelectorAll('#sec-guard input').forEach(i=>i.value=''); }
        }
        function renderGuard() {
            const vList = document.getElementById('g-visit-list');
            vList.innerHTML = Object.values(localData.visitors||{}).slice(-5).reverse().map(v=>`<div class="list-group-item d-flex justify-content-between"><span>${v.name}</span><span class="badge ${v.status==='approved'?'bg-success':(v.status==='rejected'?'bg-danger':'bg-warning')}">${v.status==='pending'?'انتظار':v.status}</span></div>`).join('');
            
            const dList = document.getElementById('g-exit-list');
            const deps = Object.entries(localData.departures||{}).filter(([k,v]) => v.status==='pending');
            dList.innerHTML = deps.map(([k,d]) => `<div class="alert alert-warning d-flex justify-content-between align-items-center"><div><strong>${d.name}</strong><br>${d.reason}</div><button class="btn btn-success btn-sm" onclick="db.ref('departures/${k}').update({status:'exited'})">تأكيد خروج</button></div>`).join('');
        }
        function toggleGuardView(v) {
            document.getElementById('view-visit').classList.toggle('hidden', v!=='visit');
            document.getElementById('view-exit').classList.toggle('hidden', v!=='exit');
        }
        function sendDeparture() {
            const n=document.getElementById('dep-name').value, r=document.getElementById('dep-reason').value;
            if(n) { db.ref('departures').push({name:n, reason:r, status:'pending', time:new Date().toLocaleString()}); Swal.fire('تم'); document.getElementById('dep-name').value=''; }
        }
        function renderAgent() {
            const list = document.getElementById('agent-vis-list');
            const pending = Object.entries(localData.visitors||{}).filter(([k,v]) => v.status==='pending');
            list.innerHTML = pending.map(([k,v]) => `<div class="list-group-item"><div class="d-flex justify-content-between"><strong>${v.name}</strong><small>${v.time.split(',')[1]}</small></div><p class="mb-1 small">${v.reason}</p><div class="d-flex gap-2"><button class="btn btn-success btn-sm w-50" onclick="db.ref('visitors/${k}').update({status:'approved'})">موافقة</button><button class="btn btn-danger btn-sm w-50" onclick="db.ref('visitors/${k}').update({status:'rejected'})">رفض</button></div></div>`).join('');
        }

        // --- REPORTS ---
        function showReport(type, btn) {
            document.querySelectorAll('#sec-reports button').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            const head = document.getElementById('rep-head'), body = document.getElementById('rep-body');
            
            if(type === 'all') {
                head.innerHTML = '<tr><th>التاريخ</th><th>الطالب</th><th>الوجهة</th><th>الوقت</th></tr>';
                body.innerHTML = Object.values(localData.permits||{}).map(p=>`<tr><td>${new Date(p.start).toLocaleDateString()}</td><td>${p.student}</td><td>${p.dest}</td><td>${Math.floor((new Date()-new Date(p.start))/60000)}د</td></tr>`).reverse().join('');
            } else if(type === 'visitors') {
                head.innerHTML = '<tr><th>التاريخ</th><th>الزائر</th><th>السبب</th><th>الحالة</th></tr>';
                body.innerHTML = Object.values(localData.visitors||{}).map(v=>`<tr><td>${v.time}</td><td>${v.name}</td><td>${v.reason}</td><td>${v.status}</td></tr>`).reverse().join('');
            } else if(type === 'departures') {
                head.innerHTML = '<tr><th>الوقت</th><th>الطالب</th><th>السبب</th></tr>';
                body.innerHTML = Object.values(localData.departures||{}).map(d=>`<tr><td>${d.time}</td><td>${d.name}</td><td>${d.reason}</td></tr>`).reverse().join('');
            } else {
                const c={}; Object.values(localData.permits||{}).forEach(p=>{c[p.student]=(c[p.student]||0)+1});
                Object.values(localData.students||{}).forEach(s=>{if(!c[s.name])c[s.name]=0});
                const s = Object.entries(c).sort((a,b) => type==='most'?b[1]-a[1]:a[1]-b[1]);
                head.innerHTML = '<tr><th>الطالب</th><th>العدد</th></tr>';
                body.innerHTML = s.slice(0,50).map(([n,k])=>`<tr><td>${n}</td><td>${k}</td></tr>`).join('');
            }
        }

        // --- MENU ---
        function buildMenu() {
            const nav = document.getElementById('nav-menu'); nav.innerHTML='';
            document.getElementById('role-disp').innerText = role;
            const items = role==='teacher' ? [{id:'monitor',t:'المتابعة'},{id:'permit',t:'إصدار إذن'}] :
                          role==='admin' ? [{id:'monitor',t:'المتابعة'},{id:'management',t:'إدارة البيانات'},{id:'agent',t:'الوكيل'},{id:'reports',t:'التقارير'}] :
                          [{id:'guard',t:'بوابة الحارس'}];
            items.forEach(i => nav.innerHTML+=`<div class="nav-link" onclick="navigate('${i.id}')"><i class="fas fa-circle ms-2 small"></i> ${i.t}</div>`);
        }
        function navigate(id) { document.querySelectorAll('.app-section').forEach(e=>e.classList.add('hidden')); document.getElementById('sec-'+id).classList.remove('hidden'); if(id==='reports') showReport('all'); }
        function forceUpdate() { updateUI(); }
    </script>
</body>
</html>