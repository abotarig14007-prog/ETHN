<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø°Ù† Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ (V69)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root { --primary: #006C35; --gold: #C69C6D; --bg: #F5F7FA; --dark: #1a1a1a; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg); margin: 0; padding-bottom: 60px; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #004d25, #006C35); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 40px; border-radius: 25px; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.4); }
        .app-logo { width: 100px; margin-bottom: 15px; border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .role-btn { border: 2px solid #f0f0f0; padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: space-between; font-weight: bold; color: #444; }
        .role-btn:hover { border-color: var(--primary); background: #e8f5e9; color: var(--primary); transform: translateX(-5px); }
        
        /* Ø§Ù„ØªØ®Ø·ÙŠØ· */
        .sidebar { width: 280px; height: 100vh; background: var(--primary); color: white; position: fixed; right: 0; top: 0; z-index: 1000; padding-top: 20px; display: flex; flex-direction: column; transition: 0.3s; }
        .main-content { margin-right: 280px; padding: 25px; transition: 0.3s; }
        @media (max-width: 991px) { .sidebar { transform: translateX(100%); } .sidebar.active { transform: translateX(0); } .main-content { margin-right: 0; } }
        
        .nav-link { padding: 15px 25px; color: rgba(255,255,255,0.85); cursor: pointer; border-right: 5px solid transparent; display: flex; align-items: center; font-weight: 600; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.15); color: white; border-right-color: var(--gold); }
        
        .page-card { background: white; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); margin-bottom: 25px; border: 1px solid #eee; overflow: hidden; }
        .card-header-custom { padding: 15px 20px; background: #fff; border-bottom: 1px solid #f0f0f0; font-weight: 800; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }

        .monitor-card { background: white; padding: 20px; border-radius: 15px; border-right: 6px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.03); position: relative; }
        .monitor-card.safe { border-right-color: #27ae60; }
        .monitor-card.danger { border-right-color: #c0392b; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); } }

        #top-bar { background: white; padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 900; }
        #status-dot { width: 12px; height: 12px; background: red; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .hidden { display: none !important; }

        /* --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ (V69 Fix) --- */
        @media print {
            body * { visibility: hidden; }
            #printModal, #printModal * { visibility: visible; }
            #printModal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; }
            .modal-footer, .modal-header .btn-close { display: none !important; }
            #print-content { padding: 20px; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="top-bar" class="no-print">
        <div class="d-flex align-items-center">
            <div id="status-dot" title="Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„"></div>
            <i class="fas fa-graduation-cap text-success fs-3 ms-2"></i>
            <h5 class="m-0 fw-bold text-dark">Ù†Ø¸Ø§Ù… Ø¥Ø°Ù† <span class="text-success">Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ</span></h5>
        </div>
        <div class="d-flex align-items-center gap-3">
            <span id="alert-msg" class="badge bg-danger d-none animate__animated animate__shakeX">ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯!</span>
            <button class="btn btn-light rounded-circle shadow-sm" onclick="toggleMute()" id="mute-btn"><i class="fas fa-volume-up text-primary"></i></button>
            <button class="btn btn-outline-dark d-lg-none" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i class="fas fa-bars"></i></button>
        </div>
    </div>

    <div id="auth-overlay">
        <div class="login-card">
            <img src="https://cdn-icons-png.flaticon.com/512/3209/3209265.png" class="app-logo">
            <h3 class="fw-bold text-dark mb-1">Ù…Ù†ØµØ© Ø¥Ø°Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h3>
            <p class="text-muted mb-4 small">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¶Ø¨Ø· ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</p>
            
            <div id="role-selection">
                <div class="role-btn" onclick="selectRole('admin', 'Ø§Ù„ÙˆÙƒÙŠÙ„ / Ø§Ù„Ù…Ø¯ÙŠØ±')"><span>Ø§Ù„ÙˆÙƒÙŠÙ„ / Ø§Ù„Ù…Ø¯ÙŠØ±</span><i class="fas fa-user-tie text-primary"></i></div>
                <div class="role-btn" onclick="selectRole('teacher', 'Ø§Ù„Ù…Ø¹Ù„Ù…')"><span>Ø§Ù„Ù…Ø¹Ù„Ù…</span><i class="fas fa-chalkboard-teacher text-success"></i></div>
                <div class="role-btn" onclick="selectRole('guard', 'Ø§Ù„Ø­Ø§Ø±Ø³')"><span>Ø§Ù„Ø­Ø§Ø±Ø³ (Ø§Ù„Ø²ÙˆØ§Ø±)</span><i class="fas fa-shield-alt text-dark"></i></div>
                <div class="role-btn" onclick="selectRole('counselor', 'Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ')"><span>Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</span><i class="fas fa-user-md text-info"></i></div>
            </div>

            <div id="pin-area" class="hidden">
                <h5 class="fw-bold mb-3 text-primary" id="selected-role-title">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h5>
                <input type="password" id="pin-input" class="form-control form-control-lg text-center fw-bold mb-4 fs-1" placeholder="****" style="letter-spacing: 8px;" inputmode="numeric">
                <div class="d-grid gap-2">
                    <button class="btn btn-success btn-lg rounded-pill fw-bold" onclick="doLogin()">Ø¯Ø®ÙˆÙ„</button>
                    <button class="btn btn-outline-secondary rounded-pill" onclick="backToRoles()">Ø±Ø¬ÙˆØ¹</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-body" class="d-none">
        <aside class="sidebar no-print">
            <div class="text-center mb-4 px-3">
                <i class="fas fa-school fa-3x text-warning mb-2"></i>
                <h6 class="fw-bold text-white mb-0 mt-3" id="disp-school">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h6>
            </div>
            <div id="nav-items" class="flex-grow-1 mt-4"></div>
            <div class="p-3"><button class="btn btn-outline-light w-100 rounded-pill" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button></div>
        </aside>

        <main class="main-content">
            <section id="sec-monitor" class="view-section">
                <h4 class="fw-bold mb-4"><i class="fas fa-desktop text-success me-2"></i> Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­ÙŠØ©</h4>
                <div id="monitor-grid" class="row g-3"></div>
                <div id="no-students" class="text-center py-5 d-none">
                    <i class="fas fa-check-circle fa-5x text-success opacity-25 mb-3"></i>
                    <h4>Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØµÙˆÙ„</h4>
                </div>
            </section>

            <section id="sec-teacher" class="view-section d-none">
                <div class="btn-group bg-white p-2 rounded-pill shadow-sm mb-4 w-100 justify-content-center">
                    <button class="btn btn-success rounded-pill px-5" onclick="tabTeacher('permit')">Ø¥Ø°Ù† Ø®Ø±ÙˆØ¬</button>
                    <button class="btn btn-outline-danger rounded-pill px-5 ms-2" onclick="tabTeacher('violation')">ØªØ­ÙˆÙŠÙ„ Ø³Ù„ÙˆÙƒÙŠ</button>
                </div>
                <div id="t-permit-box" class="page-card p-4">
                    <h5 class="fw-bold border-bottom pb-3 mb-3 text-success">Ø¥ØµØ¯Ø§Ø± Ø¥Ø°Ù† Ø®Ø±ÙˆØ¬ (Ù…Ø¤Ù‚Øª)</h5>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="fw-bold">Ø§Ù„ÙØµÙ„</label><select id="t-class" class="form-select form-select-lg" onchange="loadStudentsForRole(this.value, 't-stu')"></select></div>
                        <div class="col-md-6"><label class="fw-bold">Ø§Ù„Ø·Ø§Ù„Ø¨</label><select id="t-stu" class="form-select form-select-lg" disabled><option>Ø­Ø¯Ø¯ Ø§Ù„ÙØµÙ„</option></select></div>
                        <div class="col-md-6"><label class="fw-bold">Ø§Ù„ÙˆØ¬Ù‡Ø©</label><select id="t-dest" class="form-select form-select-lg"><option>Ø¯ÙˆØ±Ø© Ù…ÙŠØ§Ù‡</option><option>Ø§Ù„Ù…Ù‚ØµÙ</option><option>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</option><option>Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</option></select></div>
                        <div class="col-md-6"><label class="fw-bold">Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)</label><input type="number" id="t-time" class="form-control form-control-lg" value="5"></div>
                        <div class="col-12 mt-4"><button class="btn btn-success w-100 py-3 fw-bold rounded-pill shadow" onclick="sendPermit()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ (Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª)</button></div>
                    </div>
                </div>
                <div id="t-vio-box" class="page-card p-4 d-none border-top border-danger border-5">
                    <h5 class="fw-bold mb-3 text-danger">ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ© Ø³Ù„ÙˆÙƒÙŠØ©</h5>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="fw-bold">Ø§Ù„ÙØµÙ„</label><select id="r-class" class="form-select form-select-lg" onchange="loadStudentsForRole(this.value, 'r-stu')"><option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option></select></div>
                        <div class="col-md-6"><label class="fw-bold">Ø§Ù„Ø·Ø§Ù„Ø¨</label><select id="r-stu" class="form-select form-select-lg" disabled><option>Ø­Ø¯Ø¯ Ø§Ù„ÙØµÙ„</option></select></div>
                        <div class="col-md-6"><label class="fw-bold">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</label><input id="v-type" class="form-control form-control-lg" placeholder="Ù…Ø´Ø§ØºØ¨Ø©ØŒ ØªØ£Ø®Ø±..."></div>
                        <div class="col-12"><label class="fw-bold">Ø§Ù„ØªÙØ§ØµÙŠÙ„</label><textarea id="v-desc" class="form-control" rows="3"></textarea></div>
                        <div class="col-12 mt-4"><button class="btn btn-danger w-100 py-3 fw-bold rounded-pill shadow" onclick="sendViolation()">Ø±ÙØ¹ Ù„Ù„ÙˆÙƒÙŠÙ„</button></div>
                    </div>
                </div>
            </section>

            <section id="sec-admin" class="view-section d-none">
                <div class="row g-4">
                    <div class="col-md-4"><div class="page-card h-100 border-top border-warning border-5"><div class="card-header-custom">Ø§Ù„Ø²ÙˆØ§Ø±</div><div id="adm-vis-list" class="list-group list-group-flush"></div></div></div>
                    <div class="col-md-4"><div class="page-card h-100 border-top border-danger border-5"><div class="card-header-custom">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</div><div id="adm-vio-list" class="p-3"></div></div></div>
                    <div class="col-md-4"><div class="page-card h-100 border-top border-primary border-5"><div class="card-header-custom">Ø£Ù…Ø± Ø§Ù†ØµØ±Ø§Ù Ù†Ù‡Ø§Ø¦ÙŠ</div><div class="p-3"><input id="adm-dep-name" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"><button class="btn btn-primary w-100" onclick="sendDeparture()">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø­Ø§Ø±Ø³ (Ø®Ø±ÙˆØ¬)</button></div></div></div>
                </div>
            </section>

            <section id="sec-guard" class="view-section d-none">
                <div class="row g-4">
                    <div class="col-md-5">
                        <div class="page-card p-4 border-top border-dark border-5">
                            <h5 class="fw-bold mb-4">ØªØ³Ø¬ÙŠÙ„ Ø²Ø§Ø¦Ø± Ø¬Ø¯ÙŠØ¯</h5>
                            <input id="g-v-name" class="form-control mb-3" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±">
                            <input id="g-v-id" class="form-control mb-3" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©">
                            <input id="g-v-reason" class="form-control mb-3" placeholder="Ø§Ù„Ø³Ø¨Ø¨">
                            <button class="btn btn-dark w-100 py-3" onclick="sendVisitorReq()">Ø·Ù„Ø¨ Ø¯Ø®ÙˆÙ„</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="page-card border-danger border-top border-4">
                            <div class="card-header-custom text-danger">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø§Ù†ØµØ±Ø§Ù (Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)</div>
                            <div id="g-dep-list" class="list-group list-group-flush"></div>
                        </div>
                        <div class="page-card mt-3">
                            <div class="card-header-custom">Ø­Ø§Ù„Ø© Ø§Ù„Ø²ÙˆØ§Ø±</div>
                            <div id="g-vis-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-counselor" class="view-section d-none">
                <div class="row g-3">
                    <div class="col-md-8">
                        <div class="page-card">
                            <div class="card-header-custom bg-info text-white">Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­ÙˆÙ„Ø© Ù…Ù† Ø§Ù„ÙˆÙƒÙŠÙ„</div>
                            <div class="table-responsive">
                                <table class="table table-hover text-center align-middle mb-0">
                                    <thead class="table-light"><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th><th>Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ÙˆÙƒÙŠÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡</th></tr></thead>
                                    <tbody id="counselor-list"></tbody>
                                </table>
                                <div id="counselor-empty" class="text-center p-4 text-muted d-none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ù…Ø­ÙˆÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="page-card p-4 border-top border-success border-5">
                            <h6 class="fw-bold mb-3"><i class="fas fa-search me-2"></i>Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø·Ø§Ù„Ø¨ (Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±)</h6>
                            <input type="text" id="stu-search-name" class="form-control mb-3" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨...">
                            <button class="btn btn-success w-100 mb-3" onclick="searchStudentHistory()">Ø¨Ø­Ø« Ø´Ø§Ù…Ù„</button>
                            <div id="stu-history-res" class="d-none"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-reports" class="view-section d-none no-print">
                <h4 class="fw-bold mb-4">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h4>
                <div class="row g-3 mb-4">
                    <div class="col-md-3"><button class="btn btn-white border w-100 py-3 shadow-sm fw-bold" onclick="showReportModal('permits')">ğŸ“‹ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</button></div>
                    <div class="col-md-3"><button class="btn btn-white border w-100 py-3 shadow-sm fw-bold" onclick="showReportModal('visitors')">ğŸ‘¥ Ø³Ø¬Ù„ Ø§Ù„Ø²ÙˆØ§Ø±</button></div>
                    <div class="col-md-3"><button class="btn btn-white border w-100 py-3 shadow-sm fw-bold" onclick="showReportModal('most_out')">ğŸ“‰ Ø§Ù„Ø£ÙƒØ«Ø± Ø®Ø±ÙˆØ¬Ø§Ù‹</button></div>
                    <div class="col-md-3"><button class="btn btn-white border w-100 py-3 shadow-sm fw-bold" onclick="showReportModal('violations')">âš ï¸ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</button></div>
                </div>
            </section>

            <section id="sec-data" class="view-section d-none">
                <div class="page-card p-4">
                    <h5 class="fw-bold mb-4 text-primary">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h5>
                    
                    <div class="row g-3 mb-4 p-3 bg-light rounded border">
                        <div class="col-md-6">
                            <label class="fw-bold mb-2">Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©/Ø§Ù„ÙˆØ²Ø§Ø±Ø©</label>
                            <input type="file" id="logo-upload" class="form-control" accept="image/*" onchange="uploadLogo()">
                        </div>
                        <div class="col-md-6 text-center">
                            <img id="logo-preview" src="" style="max-height: 80px; display: none; margin: 0 auto;">
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-4"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input id="s-school" class="form-control" onchange="saveSettings()"></div>
                        <div class="col-md-4"><label>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input id="s-manager" class="form-control" onchange="saveSettings()"></div>
                        <div class="col-md-4"><label>ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input id="s-deputy" class="form-control" onchange="saveSettings()"></div>
                    </div>
                    <hr>
                    <div class="row g-3 mb-4">
                        <div class="col-md-3"><label class="small fw-bold">Ø§Ù„ÙˆÙƒÙŠÙ„/Ø§Ù„Ù…Ø¯ÙŠØ±</label><input id="set-admin-pass" class="form-control text-center" onchange="saveSettings()"></div>
                        <div class="col-md-3"><label class="small fw-bold">Ø§Ù„Ù…ÙˆØ¬Ù‡</label><input id="set-counselor-pass" class="form-control text-center" onchange="saveSettings()"></div>
                        <div class="col-md-3"><label class="small fw-bold">Ø§Ù„Ù…Ø¹Ù„Ù…</label><input id="set-code" class="form-control text-center" onchange="saveSettings()"></div>
                        <div class="col-md-3"><label class="small fw-bold">Ø§Ù„Ø­Ø§Ø±Ø³</label><input id="set-guard" class="form-control text-center" onchange="saveSettings()"></div>
                    </div>
                    <hr>
                    <h5 class="fw-bold mb-3">Ø§Ù„Ø·Ù„Ø§Ø¨</h5>
                    <div class="row g-3"><div class="col-md-4"><input id="imp-cls-name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØµÙ„"></div><div class="col-md-4"><button class="btn btn-success w-100" onclick="document.getElementById('f-excel').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button><input type="file" id="f-excel" hidden onchange="importData(this)"></div><div class="col-md-4"><button class="btn btn-outline-danger w-100" onclick="clearData('students')">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button></div></div>
                    <div class="table-responsive mt-4" style="max-height: 300px;"><table class="table table-sm"><thead class="table-light"><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="data-stu-body"></tbody></table></div>
                </div>
            </section>
        </main>
    </div>

    <div class="modal fade" id="printModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-white" id="print-content">
                    </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" class="btn btn-primary px-5 fw-bold" onclick="window.print()"><i class="fas fa-print me-2"></i> ØªØ£ÙƒÙŠØ¯ ÙˆØ·Ø¨Ø§Ø¹Ø©</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="bell" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD0IJONOe7Ef4a0XG8L1Cgbc1qVSSck0xE",
            authDomain: "ethn-63848.firebaseapp.com",
            databaseURL: "https://ethn-63848-default-rtdb.firebaseio.com",
            projectId: "ethn-63848",
            storageBucket: "ethn-63848.appspot.com",
            messagingSenderId: "747489913596",
            appId: "1:747489913596:web:d98d88447e4a25cc808579"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let userRole = '', isMuted = false, alertActive = false;
        let data = { settings: {school:'Ù…Ø¯Ø±Ø³ØªÙ†Ø§', manager:'', deputy:'', admin:'2026', counselor:'admin', code:'2026', guard:'1111', logo:''}, classes:[], students:{}, teachers:{}, permits:{}, visitors:{}, departures:{}, violations:{} };

        window.onload = () => {
            db.ref('.info/connected').on('value', s => document.getElementById('status-dot').style.background = s.val()? '#00ff00' : 'red');
            db.ref('/').on('value', snap => {
                const val = snap.val();
                if(val) {
                    data = { ...data, ...val };
                    data.settings = { ...{school:'Ù…Ø¯Ø±Ø³ØªÙ†Ø§', manager:'', deputy:'', admin:'2026', counselor:'admin', code:'2026', guard:'1111', logo:''}, ...(val.settings || {}) };
                    if(typeof data.classes === 'object') data.classes = Object.values(data.classes);
                    
                    document.getElementById('disp-school').innerText = data.settings.school;
                    syncSettingsInputs();
                    checkSecurityAlerts();
                    refreshScreens();
                }
            });
            setInterval(updateTimers, 30000);
        };

        // --- AUTH ---
        function selectRole(id, title) { userRole=id; document.getElementById('role-selection').classList.add('hidden'); document.getElementById('pin-area').classList.remove('hidden'); document.getElementById('selected-role-title').innerText='Ø¯Ø®ÙˆÙ„: '+title; document.getElementById('pin-input').focus(); }
        function backToRoles() { document.getElementById('pin-area').classList.add('hidden'); document.getElementById('role-selection').classList.remove('hidden'); }
        function doLogin() {
            const pin = document.getElementById('pin-input').value.trim();
            let ok = false;
            if(userRole==='admin' && pin===String(data.settings.admin)) ok=true;
            if(userRole==='teacher' && pin===String(data.settings.code)) ok=true;
            if(userRole==='guard' && pin===String(data.settings.guard)) ok=true;
            if(userRole==='counselor' && pin===String(data.settings.counselor)) ok=true;
            
            if(ok) {
                document.getElementById('auth-overlay').style.display='none';
                document.getElementById('app-body').classList.remove('d-none');
                buildMenu(); navigate(userRole==='guard'?'guard':(userRole==='counselor'?'counselor':(userRole==='admin'?'monitor':'teacher')));
            } else Swal.fire('Ø®Ø·Ø£','Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­','error');
        }

        function buildMenu() {
            const m = document.getElementById('nav-items');
            let links = [['monitor','Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©','desktop']];
            if(userRole==='teacher') links.push(['teacher','Ø§Ù„Ø®Ø¯Ù…Ø§Øª','user-edit']);
            if(userRole==='admin') links.push(['admin','Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…','tasks'], ['reports','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±','file-alt'], ['data','Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª','cogs']);
            if(userRole==='guard') links = [['guard','Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©','shield-alt']];
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ (V69 Update)
            if(userRole==='counselor') links.push(['counselor','Ø§Ù„ØªÙˆØ¬ÙŠÙ‡','user-graduate'], ['reports','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„Ø©','file-contract']);
            
            m.innerHTML = links.map(l => `<div class="nav-link" onclick="navigate('${l[0]}')"><i class="fas fa-${l[2]} me-2"></i> ${l[1]}</div>`).join('');
        }
        function navigate(id) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.add('d-none'));
            document.getElementById('sec-'+id).classList.remove('d-none');
            refreshScreens();
        }

        // --- ALERTS ---
        function checkSecurityAlerts() {
            let shouldRing = false;
            if(userRole === 'guard') {
                const newDep = Object.values(data.departures || {}).some(d => d.status === 'pending' && !d.guardSeen);
                if(newDep) shouldRing = true;
            }
            if(userRole === 'admin') {
                const newVis = Object.values(data.visitors || {}).some(v => v.status === 'pending');
                if(newVis) shouldRing = true;
            }
            if(shouldRing && !isMuted) startRinging(); else stopRinging();
        }
        function startRinging() { alertActive=true; document.getElementById('bell').play().catch(()=>{}); document.getElementById('alert-msg').classList.remove('d-none'); }
        function stopRinging() { alertActive=false; document.getElementById('bell').pause(); document.getElementById('alert-msg').classList.add('d-none'); }
        function toggleMute() { isMuted=!isMuted; document.getElementById('mute-btn').className = isMuted ? 'btn btn-danger rounded-circle' : 'btn btn-light rounded-circle'; if(isMuted) stopRinging(); }

        // --- RENDER ---
        function refreshScreens() {
            if(!document.getElementById('sec-monitor').classList.contains('d-none')) renderMonitor();
            if(userRole==='admin' && !document.getElementById('sec-admin').classList.contains('d-none')) renderAdmin();
            if(userRole==='guard' && !document.getElementById('sec-guard').classList.contains('d-none')) renderGuard();
            if(userRole==='counselor' && !document.getElementById('sec-counselor').classList.contains('d-none')) renderCounselor();
            if(!document.getElementById('sec-data').classList.contains('d-none')) renderDataTable();
            
            const dropdowns = ['t-class', 'r-class'];
            dropdowns.forEach(id => {
                const el = document.getElementById(id);
                if(el && el.options.length <= 1) {
                    const cur = el.value;
                    el.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>' + (data.classes||[]).map(c=>`<option value="${c}">${c}</option>`).join('');
                    el.value = cur;
                }
            });
        }

        function renderMonitor() {
            const grid = document.getElementById('monitor-grid');
            const active = Object.entries(data.permits||{}).filter(([k,v]) => v.active);
            document.getElementById('no-students').classList.toggle('d-none', active.length > 0);
            grid.innerHTML = active.map(([k,p]) => {
                const mins = Math.floor((new Date() - new Date(p.start)) / 60000);
                return `<div class="col-md-3"><div class="monitor-card ${mins>=p.limit?'danger':'safe'}">
                    <h5 class="fw-bold">${p.student}</h5><div class="d-flex justify-content-between small text-muted"><span>${p.class}</span><span>${p.dest}</span></div>
                    <h2 class="text-center my-2 ${mins>=p.limit?'text-danger':'text-success'}">${mins} Ø¯</h2>
                    <button class="btn btn-dark btn-sm w-100 rounded-pill" onclick="db.ref('permits/${k}').update({active:false, end:new Date().toISOString()})">Ø¹ÙˆØ¯Ø© Ù„Ù„ÙØµÙ„</button>
                </div></div>`;
            }).join('');
        }

        function renderAdmin() {
            document.getElementById('adm-vis-list').innerHTML = Object.entries(data.visitors||{}).filter(([k,v])=>v.status==='pending').map(([k,v])=>`
                <div class="list-group-item"><strong>${v.name}</strong><br><small>${v.reason}</small><div class="btn-group w-100 mt-2"><button class="btn btn-success btn-sm" onclick="db.ref('visitors/${k}').update({status:'approved'})">Ù…ÙˆØ§ÙÙ‚Ø©</button><button class="btn btn-danger btn-sm" onclick="db.ref('visitors/${k}').update({status:'rejected'})">Ø±ÙØ¶</button></div></div>`).join('');
            document.getElementById('adm-vio-list').innerHTML = Object.entries(data.violations||{}).filter(([k,v])=>v.status==='pending_admin').map(([k,v])=>`
                <div class="alert alert-danger p-2 mb-2">
                    <small>${v.student} (${v.class})</small><br><strong>${v.type}</strong><br><small class="text-muted">${v.desc || ''}</small>
                    <div class="mt-2"><button class="btn btn-sm btn-dark w-100" onclick="referToCounselor('${k}')">Ø§ØªØ®Ø§Ø° Ø¥Ø¬Ø±Ø§Ø¡ ÙˆØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…ÙˆØ¬Ù‡</button></div>
                </div>`).join('') || '<div class="text-center p-3 text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>';
        }

        function renderGuard() {
            document.getElementById('g-dep-list').innerHTML = Object.entries(data.departures||{}).filter(([k,d])=>d.status==='pending').map(([k,d])=>`
                <div class="alert alert-danger d-flex justify-content-between align-items-center"><strong>${d.name}</strong><button class="btn btn-sm btn-success" onclick="db.ref('departures/${k}').update({status:'exited', guardSeen:true})">ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬</button></div>`).join('');
            document.getElementById('g-vis-list').innerHTML = Object.entries(data.visitors||{}).reverse().slice(0,5).map(([k,v])=>`
                <div class="list-group-item d-flex justify-content-between"><div>${v.name}</div><span class="badge ${v.status==='approved'?'bg-success':(v.status==='pending'?'bg-warning text-dark':'bg-danger')}">${v.status==='pending'?'Ø§Ù†ØªØ¸Ø§Ø±':(v.status==='approved'?'Ù…Ø³Ù…ÙˆØ­':'Ù…Ø±ÙÙˆØ¶')}</span></div>`).join('');
        }

        function renderCounselor() {
            const list = Object.entries(data.violations||{}).filter(([k,v])=>v.status==='pending_counselor');
            document.getElementById('counselor-empty').classList.toggle('d-none', list.length > 0);
            document.getElementById('counselor-list').innerHTML = list.map(([k,v])=>`
                <tr><td>${v.student}<br><small class="text-muted">${v.class}</small></td><td>${v.type}</td><td>${v.admin_action || '-'}</td><td>${v.date}</td><td><button class="btn btn-success btn-sm" onclick="closeCase('${k}')">Ø¥ØºÙ„Ø§Ù‚ ÙˆØªÙˆØ«ÙŠÙ‚</button></td></tr>`).join('');
        }

        // --- ACTIONS ---
        function loadStudentsForRole(cls, tid) {
            const list = Object.values(data.students||{}).filter(s=>s.class===cls);
            const el = document.getElementById(tid); el.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</option>'; el.disabled=false;
            list.forEach(s=>el.innerHTML+=`<option value="${s.name}">${s.name}</option>`);
        }
        function sendPermit() {
            const p={student:document.getElementById('t-stu').value, class:document.getElementById('t-class').value, dest:document.getElementById('t-dest').value, limit:parseInt(document.getElementById('t-time').value), start:new Date().toISOString(), active:true};
            if(!p.student) return; db.ref('permits').push(p); 
            Swal.fire('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„','Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ù†Ø¬Ø§Ø­','success'); navigate('monitor');
        }
        function sendViolation() {
            const v={student:document.getElementById('r-stu').value, class:document.getElementById('r-class').value, type:document.getElementById('v-type').value, desc:document.getElementById('v-desc').value, status:'pending_admin', date:new Date().toLocaleDateString('ar-SA')};
            if(!v.student) return; 
            db.ref('violations').push(v); 
            Swal.fire({ title: 'Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ', text: 'ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ù„Ù„ÙˆÙƒÙŠÙ„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„ÙØµÙ„.', icon: 'info', confirmButtonColor: '#006C35' });
        }

        function referToCounselor(k) {
            Swal.fire({ title: 'Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ÙˆÙƒÙŠÙ„', input: 'text', inputLabel: 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°:', showCancelButton: true, confirmButtonText: 'ØªØ­ÙˆÙŠÙ„' }).then((r) => {
                if (r.isConfirmed && r.value) { db.ref('violations/'+k).update({ status: 'pending_counselor', admin_action: r.value }); Swal.fire('ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„'); }
            });
        }

        function closeCase(k) {
            Swal.fire({ title: 'Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¬Ù‡', input: 'text', inputLabel: 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ:', showCancelButton: true, confirmButtonText: 'Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù„Ù' }).then((r) => {
                if (r.isConfirmed && r.value) { db.ref('violations/'+k).update({ status: 'closed', counselor_action: r.value }); Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸'); }
            });
        }

        // --- Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ù…ÙˆØ¬Ù‡ (V69 Update) ---
        function searchStudentHistory() {
            const name = document.getElementById('stu-search-name').value;
            const box = document.getElementById('stu-history-res');
            if(!name) return;
            box.classList.remove('d-none');
            
            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª ÙˆØ§Ù„Ø£Ø°ÙˆÙ†Ø§Øª
            const viols = Object.values(data.violations || {}).filter(v => v.student.includes(name));
            const perms = Object.values(data.permits || {}).filter(p => p.student.includes(name)).length;
            
            if(viols.length === 0) {
                box.className = 'alert alert-success mt-3';
                box.innerHTML = `<i class="fas fa-check-circle me-2"></i> <strong>${name}</strong> Ø·Ø§Ù„Ø¨ Ù…ØªÙ…ÙŠØ²ØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù„ÙŠÙ‡ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ù„ÙˆÙƒÙŠØ©.<br>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø®Ø±ÙˆØ¬ (Ø£Ø°ÙˆÙ†Ø§Øª): ${perms}`;
            } else {
                box.className = 'alert alert-warning mt-3';
                let html = `<strong>Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø·Ø§Ù„Ø¨: ${name}</strong><ul class="mb-0 mt-2">`;
                viols.forEach(v => {
                    html += `<li>${v.date}: ${v.type} <span class="badge bg-secondary">${v.status==='closed'?'Ù…ØºÙ„Ù‚':'Ù†Ø´Ø·'}</span></li>`;
                });
                html += `</ul><div class="mt-2 small text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª: ${perms}</div>`;
                box.innerHTML = html;
            }
        }

        function sendVisitorReq() {
            const v={name:document.getElementById('g-v-name').value, id:document.getElementById('g-v-id').value, reason:document.getElementById('g-v-reason').value, status:'pending', time:new Date().toLocaleString()};
            if(v.name) db.ref('visitors').push(v).then(()=>{Swal.fire('ØªÙ… Ø§Ù„Ø·Ù„Ø¨');document.getElementById('g-v-name').value=''});
        }
        function sendDeparture() { const n=document.getElementById('adm-dep-name').value; if(n) db.ref('departures').push({name:n, status:'pending', guardSeen:false}); Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø­Ø§Ø±Ø³'); }

        // --- DATA ---
        function syncSettingsInputs() {
            const s=data.settings; document.getElementById('s-school').value=s.school; document.getElementById('s-manager').value=s.manager; document.getElementById('s-deputy').value=s.deputy || '';
            document.getElementById('set-code').value=s.code; document.getElementById('set-guard').value=s.guard; document.getElementById('set-admin-pass').value=s.admin; document.getElementById('set-counselor-pass').value=s.counselor;
            if(s.logo) document.getElementById('logo-preview').src = s.logo;
            if(s.logo) document.getElementById('logo-preview').style.display = 'block';
        }
        
        function uploadLogo() {
            const file = document.getElementById('logo-upload').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    db.ref('settings/logo').set(e.target.result);
                    document.getElementById('logo-preview').src = e.target.result;
                    document.getElementById('logo-preview').style.display = 'block';
                    Swal.fire('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±');
                };
                reader.readAsDataURL(file);
            }
        }

        function saveSettings() {
            db.ref('settings').update({
                school:document.getElementById('s-school').value, 
                manager:document.getElementById('s-manager').value,
                deputy:document.getElementById('s-deputy').value,
                code:document.getElementById('set-code').value, 
                guard:document.getElementById('set-guard').value, 
                admin:document.getElementById('set-admin-pass').value, 
                counselor:document.getElementById('set-counselor-pass').value
            });
            Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸');
        }
        function importData(inp) {
            const f=inp.files[0], cls=document.getElementById('imp-cls-name').value;
            if(!cls) return Swal.fire('Ø®Ø·Ø£','Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„','warning');
            const r=new FileReader(); r.onload=e=>{
                const j=XLSX.utils.sheet_to_json(XLSX.read(e.target.result,{type:'array'}).Sheets[XLSX.read(e.target.result,{type:'array'}).SheetNames[0]],{header:1});
                j.forEach(row=>{if(row[0]) db.ref('students').push({name:row[0], class:cls})});
                let c=data.classes||[]; if(!c.includes(cls)){c.push(cls); db.ref('classes').set(c);}
                Swal.fire('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
            }; r.readAsArrayBuffer(f);
        }
        function renderDataTable() { document.getElementById('data-stu-body').innerHTML = Object.entries(data.students||{}).reverse().slice(0,50).map(([k,s])=>`<tr><td>${s.name}</td><td>${s.class}</td><td><button class="btn btn-sm text-danger" onclick="db.ref('students/${k}').remove()"><i class="fas fa-trash"></i></button></td></tr>`).join(''); }
        function clearData(p) { if(confirm('Ù…ØªØ£ÙƒØ¯ØŸ')) db.ref(p).remove(); }
        function tabTeacher(t) { 
            document.getElementById('t-permit-box').classList.toggle('d-none', t!=='permit'); 
            document.getElementById('t-vio-box').classList.toggle('d-none', t!=='violation'); 
            if(t==='violation') {
                const el = document.getElementById('r-class');
                if(el && el.options.length<=1) {
                    el.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>' + (data.classes||[]).map(c=>`<option value="${c}">${c}</option>`).join('');
                }
            }
        }
        function updateTimers() { if(!document.getElementById('sec-monitor').classList.contains('d-none')) renderMonitor(); }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (V69 Fix) ---
        function showReportModal(type) {
            const modal = new bootstrap.Modal(document.getElementById('printModal'));
            const content = document.getElementById('print-content');
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø±ÙÙˆØ¹ Ø£Ùˆ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            const logoSrc = data.settings.logo || "https://upload.wikimedia.org/wikipedia/ar/b/bb/Logo_of_the_Ministry_of_Education_%28Saudi_Arabia%29.svg";
            
            let h = `
                <div style="display:flex; justify-content:space-between; border-bottom:3px solid var(--primary); padding-bottom:20px; margin-bottom:30px;">
                    <div style="text-align:right;">Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©<br>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…<br>${data.settings.school}</div>
                    <img src="${logoSrc}" width="120" style="max-height:100px;">
                    <div style="text-align:left;">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}<br>Ù†Ø¸Ø§Ù… Ø¥Ø°Ù†</div>
                </div>`;
            
            // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            if(type==='permits') {
                const d = Object.values(data.permits||{});
                h+=`<h4 class="text-center fw-bold mb-4">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª</h4>`;
                if(!d.length) h+=`<p class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>`;
                else h+=`<table class="table table-bordered text-center"><thead><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„ÙˆØ¬Ù‡Ø©</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead><tbody>${d.reverse().map(p=>`<tr><td>${p.student}</td><td>${p.class}</td><td>${p.dest}</td><td>${new Date(p.start).toLocaleTimeString('ar-SA')}</td></tr>`).join('')}</tbody></table>`;
            } else if(type==='visitors') {
                const d = Object.values(data.visitors||{});
                h+=`<h4 class="text-center fw-bold mb-4">Ø³Ø¬Ù„ Ø§Ù„Ø²ÙˆØ§Ø±</h4>`;
                if(!d.length) h+=`<p class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>`;
                else h+=`<table class="table table-bordered text-center"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>${d.reverse().map(v=>`<tr><td>${v.name}</td><td>${v.reason}</td><td>${v.time}</td><td>${v.status}</td></tr>`).join('')}</tbody></table>`;
            } else if(type==='violations') {
                const d = Object.values(data.violations||{});
                h+=`<h4 class="text-center fw-bold mb-4">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ©</h4>`;
                if(!d.length) h+=`<p class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>`;
                else h+=`<table class="table table-bordered text-center"><thead><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th><th>Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ÙˆÙƒÙŠÙ„</th><th>Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¬Ù‡</th></tr></thead><tbody>${d.reverse().map(v=>`<tr><td>${v.student}</td><td>${v.type}</td><td>${v.admin_action||'-'}</td><td>${v.counselor_action||'-'}</td></tr>`).join('')}</tbody></table>`;
            } else if(type==='most_out') {
                let stats = {}; Object.values(data.permits||{}).forEach(p=>stats[p.student]=(stats[p.student]||0)+1);
                let sorted = Object.entries(stats).sort((a,b)=>b[1]-a[1]);
                h+=`<h4 class="text-center fw-bold mb-4">Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ø®Ø±ÙˆØ¬Ø§Ù‹</h4>`;
                if(!sorted.length) h+=`<p class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>`;
                else h+=`<table class="table table-bordered text-center"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ù…Ø±Ø§Øª Ø§Ù„Ø®Ø±ÙˆØ¬</th></tr></thead><tbody>${sorted.map(s=>`<tr><td>${s[0]}</td><td>${s[1]}</td></tr>`).join('')}</tbody></table>`;
            }

            h+=`<div style="margin-top:60px; display:flex; justify-content:space-between; padding:0 50px; text-align:center;">
                    <div><strong>ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</strong><br>${data.settings.deputy || ''}<br><br>....................</div>
                    <div><strong>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</strong><br>${data.settings.manager}<br><br>....................</div>
                </div>`;
            
            content.innerHTML = h;
            modal.show();
        }
    </script>
</body>
</html>