<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام إذن (V42 Fixed)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary: #0f4c3a; --gold: #d4af37; --bg: #f4f6f8; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg); padding-bottom: 80px; margin: 0; }

        /* Login */
        #auth-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, #fff, #f0f0f0); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .role-btn { width: 90%; max-width: 400px; padding: 25px; margin: 10px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; justify-content: space-between; border: 1px solid #eee; transition: 0.3s; }
        .role-btn:hover { transform: translateY(-5px); border-color: var(--primary); }
        
        #pin-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .pin-input { font-size: 3rem; text-align: center; width: 250px; border: none; border-bottom: 4px solid var(--primary); outline: none; letter-spacing: 15px; margin: 30px 0; background: transparent; }

        /* App Layout */
        .sidebar { width: 260px; height: 100vh; background: var(--primary); color: white; position: fixed; right: 0; top: 0; z-index: 1000; padding-top: 20px; transition: 0.3s; }
        .main-content { margin-right: 260px; padding: 30px; transition: 0.3s; }
        
        @media (max-width: 991px) {
            .sidebar { transform: translateX(100%); } .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; padding: 15px; } .mobile-header { display: flex !important; }
        }
        .mobile-header { display: none; justify-content: space-between; align-items: center; background: var(--primary); color: white; padding: 15px; margin: -15px -15px 20px -15px; position: sticky; top: 0; z-index: 500; }

        /* Elements */
        .nav-link { color: rgba(255,255,255,0.8); padding: 15px 20px; cursor: pointer; display: flex; align-items: center; border-right: 4px solid transparent; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; border-right-color: var(--gold); }
        
        .card-custom { background: white; border-radius: 15px; border: none; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; }
        .card-head { padding: 20px; border-bottom: 1px solid #f0f0f0; font-weight: bold; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; }
        
        .monitor-card { background: white; padding: 20px; border-radius: 12px; border-right: 5px solid #ccc; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 10px; }
        .monitor-card.safe { border-right-color: #198754; }
        .monitor-card.danger { border-right-color: #dc3545; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220,53,69,0.4); } 70% { box-shadow: 0 0 0 10px rgba(220,53,69,0); } }

        .hidden { display: none !important; }
        .d-none { display: none !important; } /* Bootstrap util override just in case */
    </style>
</head>
<body>

    <div id="auth-overlay">
        <img src="https://cdn-icons-png.flaticon.com/512/3209/3209265.png" width="100" class="mb-4">
        <h2 class="mb-5 fw-bold text-dark">نظام إذن</h2>
        <div class="role-btn" onclick="openPin('admin')"><div><h4 class="m-0 fw-bold">الإدارة</h4><small>التحكم والتقارير</small></div><i class="fas fa-user-tie fa-2x text-primary"></i></div>
        <div class="role-btn" onclick="openPin('teacher')"><div><h4 class="m-0 fw-bold">المعلم</h4><small>إصدار الأذونات</small></div><i class="fas fa-chalkboard-teacher fa-2x text-warning"></i></div>
        <div class="role-btn" onclick="openPin('guard')"><div><h4 class="m-0 fw-bold">الزوار</h4><small>البوابة الأمنية</small></div><i class="fas fa-id-card-alt fa-2x text-secondary"></i></div>
        
        <div id="pin-screen" class="hidden">
            <h3 class="fw-bold">الرمز السري</h3>
            <input type="password" id="pin-input" class="pin-input" inputmode="numeric">
            <div class="d-flex gap-3">
                <button class="btn btn-success px-5 rounded-pill" onclick="login()">دخول</button>
                <button class="btn btn-light px-5 rounded-pill border" onclick="closePin()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="app-interface" class="hidden">
        <div class="mobile-header">
            <h5 class="m-0 fw-bold">نظام إذن</h5>
            <button class="btn text-white" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i class="fas fa-bars fa-lg"></i></button>
        </div>

        <aside class="sidebar">
            <div class="text-center p-4 border-bottom border-white border-opacity-10 mb-2">
                <i class="fas fa-school fa-4x mb-3 text-warning"></i>
                <h5 class="fw-bold m-0">الإمام النووي</h5>
                <small class="text-white-50" id="role-disp">--</small>
            </div>
            <nav id="menu-items"></nav>
            <div class="p-3 mt-auto"><button class="btn btn-outline-light w-100 py-2 rounded-pill" onclick="location.reload()">خروج</button></div>
        </aside>

        <main class="main-content">
            
            <section id="sec-monitor" class="view-sec">
                <div class="d-flex justify-content-between mb-4 align-items-center">
                    <h3 class="fw-bold m-0 text-dark">المتابعة الحية</h3>
                    <button class="btn btn-white border shadow-sm rounded-circle" id="mute-btn" onclick="toggleMute()"><i class="fas fa-volume-up text-success"></i></button>
                </div>
                <div id="live-grid" class="row g-3"></div>
                <div id="no-active" class="text-center py-5 hidden"><i class="fas fa-check-circle fa-5x text-success opacity-25 mb-3"></i><h4>الجميع في الفصول</h4></div>
            </section>

            <section id="sec-data" class="view-sec hidden">
                <ul class="nav nav-pills mb-4 gap-2 bg-white p-2 rounded-4 shadow-sm d-inline-flex">
                    <li class="nav-item"><button class="nav-link text-dark active rounded-pill" onclick="tabData('stu', this)">الطلاب</button></li>
                    <li class="nav-item"><button class="nav-link text-dark rounded-pill" onclick="tabData('tea', this)">المعلمون</button></li>
                    <li class="nav-item"><button class="nav-link text-dark rounded-pill" onclick="tabData('sys', this)">النظام</button></li>
                </ul>

                <div id="tab-stu">
                    <div class="card-custom p-4">
                        <div class="row g-3 align-items-end mb-4">
                            <div class="col-md-3">
                                <label class="fw-bold small mb-1">الفصل (مهم للاستيراد)</label>
                                <input list="dl-classes" id="imp-cls" class="form-control" placeholder="اكتب اسم الفصل">
                                <datalist id="dl-classes"></datalist>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-success w-100" onclick="document.getElementById('f-stu').click()"><i class="fas fa-file-excel me-2"></i>استيراد Excel</button>
                                <input type="file" id="f-stu" hidden onchange="importData(this, 'students')">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100" onclick="addStudent()">+ طالب فردي</button>
                            </div>
                            <div class="col-md-3">
                                <input class="form-control" placeholder="بحث..." onkeyup="filterTable('tbl-stu', this.value)">
                            </div>
                        </div>
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-hover align-middle" id="tbl-stu">
                                <thead class="table-light"><tr><th>الاسم</th><th>الفصل</th><th>إجراءات</th></tr></thead>
                                <tbody id="body-stu"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-tea" class="hidden">
                    <div class="card-custom p-4">
                        <div class="d-flex gap-3 mb-4">
                            <button class="btn btn-success" onclick="document.getElementById('f-tea').click()"><i class="fas fa-file-excel me-2"></i>استيراد معلمين</button>
                            <input type="file" id="f-tea" hidden onchange="importData(this, 'teachers')">
                            <button class="btn btn-primary" onclick="addTeacher()">+ معلم جديد</button>
                        </div>
                        <button class="btn btn-outline-danger btn-sm mb-3" onclick="delAll('teachers')">حذف جميع المعلمين</button>
                        <table class="table table-hover" id="tbl-tea"><tbody id="body-tea"></tbody></table>
                    </div>
                </div>

                <div id="tab-sys" class="hidden">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card-custom p-5 text-center bg-light border">
                                <h6 class="text-muted">كود المعلم الحالي</h6>
                                <h1 class="text-primary fw-bold my-3" id="sys-code">----</h1>
                                <button class="btn btn-dark" onclick="newCode()">تغيير كلمة المرور</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card-custom p-5 text-center bg-light border">
                                <h6 class="text-muted">كلمة مرور الزوار الحالية</h6>
                                <h1 class="text-dark fw-bold my-3" id="sys-guard">----</h1>
                                <button class="btn btn-outline-dark" onclick="newGuard()">تغيير كلمة المرور</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-agent" class="view-sec hidden">
                <h3 class="mb-4 fw-bold">لوحة الوكيل</h3>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card-custom h-100 border-warning border-top border-4">
                            <div class="card-head bg-light">طلبات الزوار المعلقة</div>
                            <div id="agent-vis-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-custom h-100 border-danger border-top border-4">
                            <div class="card-head bg-light">إصدار أمر انصراف</div>
                            <div class="p-4">
                                <input id="dep-name" class="form-control mb-3" placeholder="اسم الطالب">
                                <input id="dep-reason" class="form-control mb-3" placeholder="سبب الانصراف">
                                <button class="btn btn-danger w-100 py-2 fw-bold" onclick="sendDeparture()">إرسال للحارس</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-guard" class="view-sec hidden">
                <div class="row">
                    <div class="col-md-5">
                        <div class="card-custom p-4 border-primary border-top border-4">
                            <h4 class="mb-4 fw-bold">تسجيل زائر جديد</h4>
                            <input id="g-name" class="form-control mb-3" placeholder="اسم الزائر" required>
                            <input id="g-id" type="number" class="form-control mb-3" placeholder="رقم الهوية" required>
                            <input id="g-reason" class="form-control mb-3" placeholder="سبب الزيارة" required>
                            <button class="btn btn-primary w-100 py-3 fw-bold" onclick="sendVisitor()">إرسال للوكيل</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card-custom mb-3">
                            <div class="card-head">حالة طلبات الزيارة</div>
                            <div id="guard-list" class="list-group list-group-flush"></div>
                        </div>
                        <div class="card-custom border-danger border-top border-4">
                            <div class="card-head text-danger">أوامر الانصراف (من الوكيل)</div>
                            <div id="guard-dep-list" class="list-group list-group-flush"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-reports" class="view-sec hidden">
                <div class="d-flex justify-content-between mb-4 no-print">
                    <h3 class="fw-bold">التقارير</h3>
                    <button class="btn btn-dark" onclick="window.print()">طباعة</button>
                </div>
                <div class="d-flex gap-2 mb-3 overflow-auto no-print">
                    <button class="btn btn-outline-success active rounded-pill px-4" onclick="showRep('all', this)">الأذونات</button>
                    <button class="btn btn-outline-success rounded-pill px-4" onclick="showRep('vis', this)">الزوار</button>
                    <button class="btn btn-outline-success rounded-pill px-4" onclick="showRep('dep', this)">الانصراف</button>
                </div>
                <div class="card-custom"><div class="table-responsive"><table class="table table-bordered text-center mb-0"><thead class="table-light" id="rep-th"></thead><tbody id="rep-tb"></tbody></table></div></div>
            </section>

            <section id="sec-permit" class="view-sec hidden">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card-custom">
                            <div class="card-head">إصدار إذن</div>
                            <div class="p-4">
                                <form onsubmit="issuePermit(event)">
                                    <label class="fw-bold mb-2">الفصل</label>
                                    <input list="dl-classes" id="p-class" class="form-control form-control-lg mb-3" onchange="filterStudents(this.value)" placeholder="اختر الفصل" required>
                                    <label class="fw-bold mb-2">الطالب</label>
                                    <select id="p-student" class="form-select form-select-lg mb-3" disabled required></select>
                                    <div class="row mb-3"><div class="col-6"><label class="fw-bold mb-2">الوجهة</label><select id="p-dest" class="form-select form-select-lg" required><option value="">اختر...</option><option>دورة مياه</option><option>المقصف</option><option>الإدارة</option><option>الموجه</option></select></div><div class="col-6"><label class="fw-bold mb-2">المدة</label><input type="number" id="p-time" class="form-control form-control-lg" value="5" required></div></div>
                                    <div class="form-check form-switch mb-4"><input class="form-check-input" type="checkbox" id="p-spec"><label class="form-check-label text-danger fw-bold">حالة طارئة</label></div>
                                    <button class="btn btn-success w-100 py-3 fw-bold fs-5">تسجيل خروج</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <audio id="snd" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // ================= FIREBASE CONFIG =================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ================= STATE =================
        let role = '', muted = false, lastSound = 0;
        let dbData = { classes: [], code: '2026', guard: '1111', visitors: {}, departures: {} };

        // ================= REAL-TIME SYNC =================
        window.onload = () => {
            db.ref('/').on('value', (snap) => {
                const val = snap.val();
                if (val) {
                    dbData = val;
                    if (!dbData.classes) dbData.classes = [];
                    updateAllUI();
                }
            });
            setInterval(checkMonitorSound, 5000);
        };

        function updateAllUI() {
            // Update UI elements based on real-time data
            const dl = document.getElementById('dl-classes');
            if (dl) { dl.innerHTML = ''; (dbData.classes || []).forEach(c => dl.innerHTML += `<option value="${c}">`); }

            document.getElementById('sys-code').innerText = dbData.code;
            document.getElementById('sys-guard').innerText = dbData.guard;

            // Trigger re-render of active screen to show new data immediately
            if(role === 'guard') renderGuardScreen(); 
            if(role === 'admin') {
                renderAgentScreen(); 
                if(!document.getElementById('sec-data').classList.contains('hidden')) renderManage();
            }
            if(!document.getElementById('sec-monitor').classList.contains('hidden')) renderMonitor();
        }

        // ================= LOGIC & ACTIONS =================
        function openPin(r) { role=r; document.getElementById('pin-screen').classList.remove('hidden'); }
        function closePin() { document.getElementById('pin-screen').classList.add('hidden'); }
        function login() {
            const p = document.getElementById('pin-input').value;
            let ok = (role==='admin' && p==='admin') || (role==='guard' && p==dbData.guard) || (role==='teacher' && p==dbData.code);
            if(ok) {
                document.getElementById('auth-overlay').style.display='none';
                document.getElementById('app-interface').classList.remove('hidden');
                buildMenu(); navigate(role==='guard'?'guard':(role==='admin'?'monitor':'permit'));
            } else Swal.fire('خطأ','الرمز غير صحيح','error');
        }

        function buildMenu() {
            const m = document.getElementById('menu-items'); m.innerHTML='';
            document.getElementById('role-disp').innerText = role==='admin'?'الإدارة':(role==='teacher'?'المعلم':'الزوار');
            const items = role==='teacher' ? [['monitor','المتابعة','desktop'],['permit','إصدار إذن','file-signature']] :
                          role==='admin' ? [['monitor','المتابعة','desktop'],['data','البيانات','database'],['agent','الوكيل','user-check'],['reports','التقارير','chart-bar']] :
                          [['guard','بوابة الزوار','id-card']];
            items.forEach(([id,t,i]) => m.innerHTML+=`<div class="nav-link" onclick="navigate('${id}')"><i class="fas fa-${i} ms-2"></i> ${t}</div>`);
        }
        function navigate(id) {
            document.querySelectorAll('.view-sec').forEach(e=>e.classList.add('hidden'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            if(window.innerWidth < 992) document.querySelector('.sidebar').classList.remove('active');
            updateAllUI(); // Refresh Views
        }

        // --- DATA TABS ---
        function tabData(t, btn) {
            document.getElementById('tab-stu').classList.add('hidden');
            document.getElementById('tab-tea').classList.add('hidden');
            document.getElementById('tab-sys').classList.add('hidden');
            document.getElementById('tab-'+t).classList.remove('hidden');
            if(btn) { document.querySelectorAll('.nav-pills .nav-link').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
            renderManage();
        }
        function renderManage() {
            // Students
            document.getElementById('body-stu').innerHTML = Object.entries(dbData.students||{}).reverse().map(([k,s])=>`<tr><td>${s.name}</td><td>${s.class}</td><td><button class="btn btn-sm btn-danger" onclick="db.ref('students/'+k).remove()"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            // Teachers
            document.getElementById('body-tea').innerHTML = Object.entries(dbData.teachers||{}).map(([k,t])=>`<tr><td>${t.name}</td><td><button class="btn btn-sm btn-danger" onclick="db.ref('teachers/'+k).remove()"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        }

        // --- TEACHER ---
        function filterStudents(cls) {
            const list = document.getElementById('p-student'); list.innerHTML='<option value="">اختر الطالب</option>'; list.disabled=false;
            Object.values(dbData.students||{}).filter(s=>s.class===cls).forEach(s=>list.innerHTML+=`<option value="${s.name}">${s.name}</option>`);
        }
        function issuePermit(e) {
            e.preventDefault();
            const s=document.getElementById('p-student').value, c=document.getElementById('p-class').value, d=document.getElementById('p-dest').value;
            if(!s||!c||!d) return Swal.fire('نقص','أكمل البيانات','warning');
            if(Object.values(dbData.permits||{}).find(p=>p.student===s && p.active)) return Swal.fire('خطأ','الطالب بالخارج','error');
            db.ref('permits').push({student:s, class:c, dest:d, limit:parseInt(document.getElementById('p-time').value), start:new Date().toISOString(), active:true});
            Swal.fire({icon:'success', title:'تم', timer:1000, showConfirmButton:false}); navigate('monitor'); e.target.reset();
        }

        // --- MONITOR ---
        function renderMonitor() {
            const g = document.getElementById('live-grid');
            const active = Object.entries(dbData.permits||{}).filter(([k,v])=>v.active);
            if(!active.length) { document.getElementById('no-active').classList.remove('hidden'); g.innerHTML=''; return; }
            document.getElementById('no-active').classList.add('hidden');
            let alert=false;
            g.innerHTML = active.map(([k,p]) => {
                const m = Math.floor((new Date()-new Date(p.start))/60000);
                if(m >= p.limit) alert=true;
                return `<div class="col-md-3"><div class="monitor-card ${m>=p.limit?'danger':'safe'}"><h4>${p.student}</h4><span class="badge bg-light text-dark border">${p.class}</span><br><small>${p.dest}</small><h2 class="my-2 ${m>=p.limit?'text-danger':'text-success'}">${m} د</h2><button class="btn btn-dark w-100 btn-sm" onclick="db.ref('permits/${k}').update({active:false, end:new Date().toISOString()})">عودة</button></div></div>`;
            }).join('');
            if(alert && !muted && Date.now()-lastSound > 10000) { document.getElementById('snd').play().catch(()=>{}); lastSound=Date.now(); }
        }
        function checkMonitorSound() { if(!document.getElementById('sec-monitor').classList.contains('hidden')) renderMonitor(); }
        function toggleMute() { muted=!muted; document.getElementById('mute-btn').classList.toggle('text-danger'); }

        // --- GUARD & AGENT SYNC FIX ---
        // 1. Guard sends Visitor -> Agent receives
        function sendVisitor() {
            const v={name:document.getElementById('g-name').value, id:document.getElementById('g-id').value, reason:document.getElementById('g-reason').value, status:'pending', time:new Date().toLocaleString()};
            if(!v.name) return;
            db.ref('visitors').push(v);
            Swal.fire('تم الإرسال'); document.querySelectorAll('#sec-guard input').forEach(i=>i.value='');
        }
        // 2. Agent sends Departure -> Guard receives
        function sendDeparture() {
            const d={name:document.getElementById('dep-name').value, reason:document.getElementById('dep-reason').value, status:'pending', time:new Date().toLocaleString()};
            if(!d.name) return;
            db.ref('departures').push(d);
            Swal.fire('تم السماح'); document.querySelectorAll('#sec-agent input').forEach(i=>i.value='');
        }

        // Render Functions (Corrected Filter)
        function renderAgentScreen() {
            // Agent sees 'pending' visitors
            document.getElementById('agent-vis-list').innerHTML = Object.entries(dbData.visitors||{}).filter(([k,v])=>v.status==='pending').map(([k,v])=>`
                <div class="list-group-item">
                    <div class="d-flex justify-content-between fw-bold"><span>${v.name}</span><small>${v.time.split(',')[1]}</small></div>
                    <small class="text-muted">${v.reason}</small>
                    <div class="mt-2"><button class="btn btn-success btn-sm w-50" onclick="db.ref('visitors/${k}').update({status:'approved'})">موافقة</button><button class="btn btn-danger btn-sm w-50" onclick="db.ref('visitors/${k}').update({status:'rejected'})">رفض</button></div>
                </div>`).join('');
        }

        function renderGuardScreen() {
            // Guard sees visitor status history
            document.getElementById('guard-list').innerHTML = Object.values(dbData.visitors||{}).reverse().slice(0,5).map(v=>`
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div><strong>${v.name}</strong><br><small>${v.reason}</small></div>
                    <span class="badge ${v.status==='approved'?'bg-success':(v.status==='rejected'?'bg-danger':'bg-warning text-dark')}">${v.status==='pending'?'انتظار':(v.status==='approved'?'مقبول':'مرفوض')}</span>
                </div>`).join('');
            
            // Guard sees 'pending' departures to confirm exit
            document.getElementById('guard-dep-list').innerHTML = Object.entries(dbData.departures||{}).filter(([k,d])=>d.status==='pending').map(([k,d])=>`
                <div class="alert alert-danger d-flex justify-content-between align-items-center mb-2">
                    <div><strong>${d.name}</strong><br>السبب: ${d.reason}</div>
                    <button class="btn btn-success btn-sm" onclick="db.ref('departures/${k}').update({status:'exited'})">تأكيد الخروج</button>
                </div>`).join('') || '<div class="text-center text-muted small">لا توجد أوامر انصراف</div>';
        }

        // --- IMPORTS & SYS ---
        function importData(inp, t) {
            const f=inp.files[0], cls=document.getElementById('imp-cls').value;
            if(t==='students' && !cls) return Swal.fire('تنبيه','اكتب الفصل','warning');
            const r=new FileReader();
            r.onload=e=>{
                const w=XLSX.read(e.target.result,{type:'array'});
                const j=XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]],{header:1});
                j.forEach(r=>{if(r[0]) db.ref(t).push({name:r[0], class:cls||''})});
                if(t==='students') { let n=dbData.classes||[]; if(!n.includes(cls)) { n.push(cls); db.ref('classes').set(n); } }
                Swal.fire('تم');
            }; r.readAsArrayBuffer(f);
        }
        function addStudent() {
            const cls = document.getElementById('imp-cls').value;
            if(!cls) return Swal.fire('تنبيه','اكتب الفصل','warning');
            Swal.fire({input:'text', title:'الاسم'}).then(r=>{if(r.value){db.ref('students').push({name:r.value, class:cls}); let n=dbData.classes||[]; if(!n.includes(cls)){n.push(cls); db.ref('classes').set(n);}}});
        }
        function addTeacher() { Swal.fire({input:'text', title:'المعلم'}).then(r=>{if(r.value)db.ref('teachers').push({name:r.value})}); }
        function delAll(p) { Swal.fire({title:'حذف الكل؟', showCancelButton:true}).then(r=>{if(r.isConfirmed)db.ref(p).remove()}); }
        function newCode() { db.ref('code').set(Math.floor(1000+Math.random()*9000)); }
        function newGuard() { Swal.fire({input:'text'}).then(r=>{if(r.value)db.ref('guard').set(r.value)}); }
        function filterTable(id,v) { document.querySelectorAll(`#${id} tbody tr`).forEach(r=>r.style.display=r.innerText.includes(v)?'':'none'); }

        // --- REPORTS ---
        function showRep(t, btn) {
            if(btn) { document.querySelectorAll('#sec-reports button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
            const th=document.getElementById('rep-th'), tb=document.getElementById('rep-tb');
            if(t==='all') {
                th.innerHTML='<tr><th>الطالب</th><th>الوجهة</th><th>الوقت</th></tr>';
                tb.innerHTML=Object.values(dbData.permits||{}).reverse().map(p=>`<tr><td>${p.student}</td><td>${p.dest}</td><td>${new Date(p.start).toLocaleTimeString()}</td></tr>`).join('');
            } else if(t==='vis') {
                th.innerHTML='<tr><th>الزائر</th><th>السبب</th><th>الحالة</th></tr>';
                tb.innerHTML=Object.values(dbData.visitors||{}).reverse().map(v=>`<tr><td>${v.name}</td><td>${v.reason}</td><td>${v.status}</td></tr>`).join('');
            } else if(t==='dep') {
                th.innerHTML='<tr><th>الطالب</th><th>السبب</th><th>الوقت</th></tr>';
                tb.innerHTML=Object.values(dbData.departures||{}).reverse().map(d=>`<tr><td>${d.name}</td><td>${d.reason}</td><td>${d.time}</td></tr>`).join('');
            }
        }
    </script>
</body>
</html>