<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام إذن الرقمي - متوسطة الإمام النووي (النسخة الاحترافية الكاملة)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* تعريف متغيرات الألوان الرئيسية للنظام 
           (هوية بصرية متناسقة: أخضر ملكي + ذهبي)
        */
        :root {
            --primary-color: #145A32;       /* أخضر غامق رسمي */
            --primary-light: #1E8449;       /* أخضر فاتح */
            --primary-dark: #0B3B24;        /* أخضر داكن جداً */
            
            --secondary-color: #D4AC0D;     /* ذهبي للتكريم والتميز */
            --secondary-light: #F1C40F;     /* أصفر مشرق */
            
            --accent-color: #2874A6;        /* أزرق للأزرار الثانوية */
            --danger-color: #C0392B;        /* أحمر للتنبيهات والخطر */
            --success-color: #27AE60;       /* أخضر للعمليات الناجحة */
            
            --bg-color: #F4F6F7;            /* لون خلفية الصفحة */
            --card-bg: #FFFFFF;             /* لون خلفية البطاقات */
            --text-main: #2C3E50;           /* لون النص الرئيسي */
            --text-light: #7F8C8D;          /* لون النص الفرعي */
            
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.05);
            --shadow-medium: 0 15px 35px rgba(0,0,0,0.1);
            --shadow-hard: 0 20px 50px rgba(0,0,0,0.15);
            
            --main-gradient: linear-gradient(135deg, #145A32 0%, #0B3B24 100%);
            --glass-effect: rgba(255, 255, 255, 0.95);
        }

        /* --- التنسيقات العامة (Global Resets) --- */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Tajawal', sans-serif; 
            outline: none;
            -webkit-tap-highlight-color: transparent; /* تحسين تجربة اللمس في الجوال */
        }

        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            min-height: 100vh; 
            overflow-x: hidden;
            padding-bottom: 120px; /* مساحة إضافية في الأسفل للتمرير المريح */
            line-height: 1.6;
        }

        /* --- تحسينات التمرير (Scrollbar) --- */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-light); 
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color); 
        }

        /* --- نظام الإشعارات العائم (Toast Notifications) --- */
        #notification-area {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }

        .toast-message {
            background: #333;
            color: #fff;
            padding: 18px 25px;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            animation: slideDownFade 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55), fadeOut 0.5s 3.5s forwards;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 700;
            font-size: 1.05rem;
            justify-content: flex-start;
            border-left: 5px solid transparent;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }

        .toast-success { 
            background: rgba(20, 90, 50, 0.95); 
            border-left-color: #2ecc71;
        }
        .toast-error { 
            background: rgba(192, 57, 43, 0.95); 
            border-left-color: #e74c3c;
        }
        .toast-info { 
            background: rgba(41, 128, 185, 0.95); 
            border-left-color: #3498db;
        }

        @keyframes slideDownFade { 
            from { transform: translateY(-100px) scale(0.9); opacity: 0; } 
            to { transform: translateY(0) scale(1); opacity: 1; } 
        }
        @keyframes fadeOut { 
            to { opacity: 0; visibility: hidden; transform: translateY(-20px); } 
        }

        /* --- شاشة الدخول (Login Screen Overlay) --- */
        #loginOverlay {
            position: fixed; 
            inset: 0; 
            background: var(--main-gradient);
            z-index: 10000; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(20px); /* تأثير ضبابي قوي */
        }

        .login-card {
            background: var(--glass-effect); 
            width: 90%; 
            max-width: 500px; 
            padding: 3.5rem 2.5rem;
            border-radius: 40px; 
            text-align: center; 
            box-shadow: 0 50px 100px rgba(0,0,0,0.5);
            border-top: 10px solid var(--secondary-color);
            animation: zoomEntrance 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* زخرفة خلفية للكارت */
        .login-card::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: var(--secondary-color);
            opacity: 0.1;
            border-radius: 50%;
        }

        @keyframes zoomEntrance { 
            from { transform: scale(0.8) translateY(50px); opacity: 0; } 
            to { transform: scale(1) translateY(0); opacity: 1; } 
        }

        .school-logo-icon { 
            font-size: 5rem; 
            color: var(--primary-color); 
            margin-bottom: 20px; 
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.15)); 
            animation: floatLogo 3s ease-in-out infinite;
        }

        @keyframes floatLogo {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* --- الهيدر العلوي (Top Header) --- */
        header { 
            background: var(--main-gradient); 
            color: white; 
            padding: 1rem 5%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 5000; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            height: 90px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-content h1 { 
            font-family: 'Amiri'; 
            font-size: 2rem; 
            font-weight: 700; 
            margin: 0; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); 
            line-height: 1.2;
        }

        .header-content small {
            display: block;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
            font-weight: 300;
        }
        
        .live-counter-badge { 
            background: var(--danger-color); 
            padding: 8px 20px; 
            border-radius: 50px; 
            font-weight: 800; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 1rem;
            box-shadow: 0 0 20px rgba(192, 57, 43, 0.6); 
            animation: pulseEffect 2s infinite;
            white-space: nowrap;
        }

        @keyframes pulseEffect { 
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); } 
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); } 
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); } 
        }

        /* --- شريط التنقل (Horizontal Navigation) --- */
        .nav-container-scroll { 
            display: flex; 
            gap: 15px; 
            overflow-x: auto; 
            padding: 20px 5%; 
            margin: 0 auto; 
            max-width: 1400px; 
            background: transparent;
            scrollbar-width: none; /* إخفاء شريط التمرير في فيرفوكس */
        }
        
        .nav-container-scroll::-webkit-scrollbar {
            display: none; /* إخفاء شريط التمرير في كروم */
        }

        .nav-btn {
            background: white; 
            border: none; 
            padding: 15px 25px; 
            border-radius: 20px;
            font-size: 1.1rem; 
            color: #555; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 8px;
            min-width: 110px;
            flex-shrink: 0; /* منع التقلص */
        }

        .nav-btn:hover { 
            transform: translateY(-5px); 
            color: var(--primary-color); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .nav-btn.active { 
            background: #e8f5e9; 
            color: var(--primary-color); 
            border-bottom: 4px solid var(--primary-color); 
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(20, 90, 50, 0.15);
        }

        .nav-btn i { font-size: 1.8rem; margin-bottom: 3px; }

        /* --- الأزرار التفاعلية (Interactive Buttons) --- */
        .btn-action {
            width: 100%; 
            padding: 16px; 
            border: none; 
            border-radius: 18px;
            font-size: 1.2rem; 
            font-weight: 800; 
            cursor: pointer; 
            transition: all 0.2s ease;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 12px;
            margin-top: 15px;
            position: relative;
            top: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-action:active { 
            top: 4px; 
            box-shadow: none !important; 
            transform: scale(0.98);
        }

        .btn-primary { 
            background: var(--primary-color); 
            color: white; 
            box-shadow: 0 6px 0 #0e3e23; 
        }

        .btn-secondary { 
            background: var(--secondary-color); 
            color: #222; 
            box-shadow: 0 6px 0 #9a7d0a; 
        }

        .btn-danger { 
            background: var(--danger-color); 
            color: white; 
            box-shadow: 0 6px 0 #7b241c; 
        }

        /* --- الحاويات الرئيسية (Main Layout) --- */
        .main-container { 
            max-width: 1300px; 
            margin: 0 auto; 
            padding: 0 5%; 
        }

        .view-section { 
            display: none; 
            opacity: 0; 
            transform: translateY(30px); 
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1); 
        }

        .view-section.active { 
            display: block; 
            opacity: 1; 
            transform: translateY(0); 
        }

        /* --- البطاقات (Cards) --- */
        .card { 
            background: white; 
            border-radius: 35px; 
            padding: 2.5rem; 
            margin-bottom: 2rem;
            box-shadow: var(--shadow-soft); 
            border: 1px solid #f0f0f0;
            position: relative;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px dashed #f0f0f0;
        }

        .card h2, .card h3, .card h4 { 
            color: var(--primary-color); 
            margin: 0;
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        
        /* --- حقول الإدخال (Inputs & Selects) --- */
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--text-main);
            font-size: 1.1rem;
        }

        .form-input { 
            width: 100%; 
            padding: 18px 20px; 
            margin-bottom: 20px; 
            border: 2px solid #e0e0e0; 
            border-radius: 18px; 
            font-size: 1.1rem; 
            transition: 0.3s; 
            background: #fafafa;
            color: #333;
            -webkit-appearance: none; /* إزالة الستايل الافتراضي للجوال */
            -moz-appearance: none;
            appearance: none;
        }

        /* سهم القائمة المنسدلة المخصص */
        select.form-input {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23145A32' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 20px center;
            background-size: 20px;
        }

        .form-input:focus { 
            border-color: var(--secondary-color); 
            background: white; 
            box-shadow: 0 0 0 5px rgba(212, 172, 13, 0.1); 
        }

        /* --- شبكة المراقبة (Monitor Grid System) --- */
        .monitor-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 25px; 
        }

        .student-card {
            background: white; 
            padding: 25px; 
            border-radius: 25px; 
            border-right: 15px solid var(--success-color); 
            box-shadow: var(--shadow-soft);
            transition: 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .student-card:hover { 
            transform: translateY(-5px); 
            box-shadow: var(--shadow-hard); 
        }

        .student-card.late { 
            border-right-color: var(--danger-color); 
            background: #fff8f8; 
            animation: shake 0.5s infinite; 
        }
        
        .student-info h3 { font-size: 1.5rem; margin-bottom: 5px; color: var(--primary-color); }
        .student-info p { color: #666; font-size: 0.95rem; }

        .time-badge {
            background: #f0f0f0;
            padding: 8px 15px;
            border-radius: 12px;
            font-weight: bold;
            display: inline-block;
            margin-top: 15px;
            width: fit-content;
        }

        @keyframes shake { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(5px); } 
            75% { transform: translateX(-5px); } 
        }

        /* --- تبويبات الإعدادات (Settings Tabs) --- */
        .settings-tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 30px; 
            background: #f0f0f0;
            padding: 8px;
            border-radius: 20px;
        }

        .tab-btn { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            background: transparent; 
            cursor: pointer; 
            border-radius: 15px; 
            font-weight: 800; 
            font-size: 1rem; 
            transition: 0.3s; 
            color: #777;
        }

        .tab-btn.active { 
            background: white; 
            color: var(--primary-color); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
        }

        /* --- قوائم البيانات للحذف (Data Lists) --- */
        .data-list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #f5f5f5;
            border-radius: 20px;
            padding: 10px;
            background: #fff;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f9f9f9;
            transition: 0.2s;
        }

        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: #fdfdfd; }
        
        .list-info { display: flex; align-items: center; gap: 10px; }
        .list-icon { color: var(--accent-color); font-size: 1.2rem; }

        .del-icon-btn {
            color: var(--danger-color);
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: 0.2s;
            background: #fff5f5;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .del-icon-btn:hover { 
            background: var(--danger-color); 
            color: white; 
            transform: rotate(90deg); 
        }

        /* --- شهادة التقدير (Certificate Styling) --- */
        .cert-print-wrapper {
            width: 1123px; height: 794px; /* A4 Landscape Dimensions */
            background: white; 
            padding: 60px; 
            margin: 0 auto;
            border: 40px double var(--secondary-color); 
            text-align: center; 
            display: none; /* مخفي في العرض العادي */
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            position: fixed; 
            top: 0; 
            left: 0; 
            z-index: 10000;
        }

        .cert-content {
            border: 2px solid var(--primary-color);
            height: 100%;
            padding: 40px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .cert-title { 
            font-family: 'Amiri'; 
            font-size: 5.5rem; 
            color: var(--primary-color); 
            margin-bottom: 30px; 
            text-shadow: 2px 2px 0px #eee; 
        }

        .cert-subtitle {
            font-size: 2.2rem;
            color: #555;
            margin-bottom: 20px;
        }

        .cert-name { 
            font-family: 'Amiri'; 
            font-size: 5rem; 
            color: var(--secondary-color); 
            text-decoration: underline; 
            margin: 30px 0; 
            font-weight: bold; 
            text-shadow: 1px 1px 0px rgba(0,0,0,0.1);
        }

        .cert-text { 
            font-size: 2.5rem; 
            line-height: 1.8; 
            margin-bottom: 60px; 
            color: #333; 
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        .cert-footer { 
            display: flex; 
            justify-content: space-around; 
            margin-top: 80px; 
        }

        .cert-sign h3 { font-size: 2rem; margin-bottom: 10px; color: #777; }
        .cert-sign p { font-size: 2.5rem; font-family: 'Amiri'; font-weight: bold; color: var(--primary-color); }

        /* --- تحسينات للجوال (Mobile Optimizations) --- */
        @media (max-width: 768px) {
            header { padding: 1rem 1.5rem; }
            .header-content h1 { font-size: 1.5rem; }
            .live-counter-badge { padding: 5px 15px; font-size: 0.9rem; }
            #digitalClock { font-size: 1.2rem !important; }
            .card { padding: 1.5rem; border-radius: 25px; }
            .nav-scroll { justify-content: flex-start; } /* سكرول أفقي في الجوال */
            .monitor-grid { grid-template-columns: 1fr; } /* عمود واحد */
            .settings-tabs { flex-direction: column; }
            #dailyCodeDisplay { font-size: 4rem !important; letter-spacing: 10px !important; }
        }

        /* --- إعدادات الطباعة (Print Media Query) --- */
        @media print {
            body * { visibility: hidden; }
            .cert-print-wrapper, .cert-print-wrapper * { visibility: visible; }
            .cert-print-wrapper { 
                display: block !important; 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%;
                height: 100%;
                transform: scale(0.95); /* تصغير قليلاً لتناسب الصفحة */
                transform-origin: top left;
                border: none;
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="notification-area"></div>
    
    <audio id="soundAlert" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="loginOverlay">
        
        <div class="login-card" id="roleSelectionPanel">
            <i class="fas fa-school school-logo-icon"></i>
            <h1 style="font-family:'Amiri'; color:var(--primary-color); font-size:3rem; margin-bottom:10px">متوسطة الإمام النووي</h1>
            <p style="color:#666; font-size:1.2rem; margin-bottom:3rem; font-weight:700">نظام إدارة الانضباط المدرسي (الإصدار الشامل)</p>
            
            <button class="btn-action btn-primary" onclick="initiateLogin('admin')">
                <i class="fas fa-user-shield"></i> لوحة الإدارة
            </button>
            <button class="btn-action btn-secondary" onclick="initiateLogin('teacher')">
                <i class="fas fa-chalkboard-user"></i> دخول المعلم
            </button>
        </div>

        <div class="login-card" id="passwordInputPanel" style="display:none">
            <h2 style="color:var(--primary-color); margin-bottom:20px; font-size:2rem">التحقق الأمني</h2>
            <p style="margin-bottom:25px; color:#777">يرجى إدخال كود الدخول الخاص بك</p>
            
            <input type="password" id="accessCodeInput" class="form-input" placeholder="****" style="text-align:center; font-size:2.5rem; letter-spacing:15px">
            
            <div style="display:flex; gap:15px; margin-top:10px">
                <button class="btn-action btn-primary" onclick="validateLogin()" id="confirmLoginBtn">
                    تأكيد الدخول
                </button>
                <button class="btn-action btn-danger" onclick="location.reload()">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <header class="no-print">
        <div class="header-content">
            <i class="fas fa-graduation-cap" style="font-size:3rem; color:var(--secondary-color)"></i>
            <div>
                <h1>إذن الرقمي</h1>
                <small>بوابة المتابعة السحابية 2026</small>
            </div>
        </div>
        
        <div style="display:flex; align-items:center; gap:20px">
            <div class="live-counter-badge">
                <i class="fas fa-circle" style="font-size:0.7rem; color:#fff"></i>
                <span id="activeStudentCount">0</span> بالخارج
            </div>
            <div id="clockDisplay" style="font-family:'Courier New'; font-weight:bold; font-size:1.5rem">00:00</div>
        </div>
    </header>

    <div id="navigationBar" class="nav-container-scroll no-print" style="display:none"></div>

    <div class="main-container no-print" id="applicationMain" style="display:none">

        <div id="sectionHome" class="view-section">
            <div class="card" style="text-align:center; background: linear-gradient(to bottom, #ffffff, #f0f7f4)">
                <h3 style="color:#777; justify-content:center"><i class="fas fa-key"></i> كود المعلم المتزامن اليومي</h3>
                <div id="dailyTeacherCode" style="font-size:7rem; font-weight:900; color:var(--primary-color); letter-spacing:20px; margin:25px 0; font-family:monospace; text-shadow: 3px 3px 0 #eee">----</div>
                
                <button class="btn-action btn-secondary" style="width:auto; margin:0 auto; padding:15px 50px" onclick="refreshDailyCode()">
                    <i class="fas fa-sync fa-spin-hover"></i> تحديث الكود
                </button>
                <p style="margin-top:20px; color:#999; font-size:0.9rem">هذا الكود يظهر تلقائياً في أجهزة جميع المعلمين</p>
            </div>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:25px">
                <div class="card" style="text-align:center; background:#e8f8f5; border:none">
                    <i class="fas fa-clipboard-list" style="font-size:3.5rem; color:var(--primary-color); margin-bottom:15px"></i>
                    <h1 id="statTotalPermits" style="font-size:4rem; margin:10px 0; color:var(--primary-color)">0</h1>
                    <p style="font-size:1.2rem; font-weight:bold; color:#555">إجمالي أذونات اليوم</p>
                </div>
                <div class="card" style="text-align:center; background:#fdedec; border:none">
                    <i class="fas fa-person-walking-arrow-right" style="font-size:3.5rem; color:var(--danger-color); margin-bottom:15px"></i>
                    <h1 id="statActiveStudents" style="font-size:4rem; margin:10px 0; color:var(--danger-color)">0</h1>
                    <p style="font-size:1.2rem; font-weight:bold; color:#555">طلاب خارج الفصول الآن</p>
                </div>
            </div>
        </div>

        <div id="sectionTeacher" class="view-section">
            <div class="card">
                <h2><i class="fas fa-file-pen"></i> إصدار إذن خروج طالب</h2>
                
                <div style="margin-bottom:25px; background:#fcfcfc; padding:20px; border-radius:20px; border:1px solid #eee">
                    <label class="form-label">اسم المعلم المصدر للإذن:</label>
                    <select id="teacherNameSelect" class="form-input" style="margin:0"><option value="">جاري تحميل القائمة...</option></select>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 2fr; gap:25px; margin-bottom:10px">
                    <div>
                        <label class="form-label">الشعبة / الصف:</label>
                        <select id="classNameSelect" class="form-input" onchange="filterStudentsByClass()"><option value="">اختر...</option></select>
                    </div>
                    <div>
                        <label class="form-label">اسم الطالب:</label>
                        <select id="studentNameSelect" class="form-input"><option value="">اختر الطالب...</option></select>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:25px">
                    <div>
                        <label class="form-label">الوجهة:</label>
                        <select id="destinationSelect" class="form-input">
                            <option>دورة المياه</option>
                            <option>المقصف</option>
                            <option>مكتب الإدارة</option>
                            <option>المرشد الطلابي</option>
                            <option>وكيل شؤون الطلاب</option>
                            <option>أخرى</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">المدة (دقيقة):</label>
                        <input type="number" id="durationInput" class="form-input" value="5" min="1" max="60">
                    </div>
                </div>

                <button class="btn-action btn-primary" onclick="submitNewPermit()">
                    <i class="fas fa-paper-plane"></i> اعتماد وطباعة الإذن
                </button>
            </div>
        </div>

        <div id="sectionMonitor" class="view-section">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px; border-bottom:3px solid #eee; padding-bottom:15px">
                <i class="fas fa-desktop" style="font-size:2.5rem; color:var(--primary-color)"></i>
                <h2 style="margin:0; color:var(--primary-color)">المتابعة الميدانية الحية</h2>
            </div>
            
            <div id="liveMonitorGrid" class="monitor-grid">
                </div>
        </div>

        <div id="sectionReports" class="view-section">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-pie"></i> التحليل البياني الشهري</h2>
                    <div style="display:flex; align-items:center; gap:10px">
                        <label style="font-weight:bold; color:#555">اختر الشهر:</label>
                        <input type="month" id="reportMonthFilter" class="form-input" style="width:auto; margin:0; padding:10px" onchange="refreshReports()">
                    </div>
                </div>
                <div style="height:400px; position:relative">
                    <canvas id="reportChartCanvas"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-clipboard-list"></i> سجل الحركات التفصيلي للشهر المحدد</h3>
                <div style="max-height:400px; overflow-y:auto; padding:15px; background:#f9f9f9; border-radius:20px; border:1px solid #eee">
                    <ul id="reportLogsList" style="list-style:none; padding:0; font-size:1.1rem; line-height:2">
                        </ul>
                </div>
            </div>
        </div>

        <div id="sectionSettings" class="view-section">
            <div class="card">
                <h2><i class="fas fa-cogs"></i> مركز إدارة البيانات والنظام</h2>
                
                <div class="settings-tabs">
                    <button class="tab-btn active" onclick="changeSettingsTab('teachers')">
                        <i class="fas fa-chalkboard-user"></i> إدارة المعلمين
                    </button>
                    <button class="tab-btn" onclick="changeSettingsTab('classes')">
                        <i class="fas fa-users-rectangle"></i> الفصول والطلاب
                    </button>
                    <button class="tab-btn" onclick="changeSettingsTab('system')">
                        <i class="fas fa-server"></i> صيانة النظام
                    </button>
                </div>

                <div id="setting-tab-teachers">
                    <div style="background:#fcfcfc; padding:30px; border-radius:25px; margin-bottom:25px; border:2px solid #f0f0f0;">
                        <h4 style="color:var(--primary-color); margin-bottom:20px"><i class="fas fa-user-plus"></i> إضافة معلم جديد (يدوي)</h4>
                        <div style="display:flex; gap:15px;">
                            <input type="text" id="manualTeacherInput" class="form-input" placeholder="اكتب اسم المعلم الرباعي" style="margin:0">
                            <button class="btn-action btn-primary" style="width:180px; margin:0" onclick="addTeacherManual()">
                                <i class="fas fa-save"></i> حفظ
                            </button>
                        </div>
                        
                        <div style="display:flex; align-items:center; gap:15px; margin-top:30px; padding-top:20px; border-top:2px dashed #ddd">
                            <i class="fas fa-file-excel" style="font-size:2rem; color:green"></i>
                            <div style="flex:1">
                                <h5 style="margin-bottom:5px; color:var(--text-main)">استيراد قائمة معلمين (Excel)</h5>
                                <p style="color:#888; font-size:0.9rem">يجب أن يحتوي الملف على عمود باسم (المعلم) أو (الاسم)</p>
                            </div>
                            <input type="file" id="teacherExcelInput" style="display:none" onchange="processTeacherExcel(this)">
                            <button class="btn-action btn-secondary" style="width:auto; margin:0; padding:12px 30px" onclick="document.getElementById('teacherExcelInput').click()">
                                اختيار ملف ورفع
                            </button>
                        </div>
                    </div>

                    <h4 style="margin-bottom:15px"><i class="fas fa-list-ul"></i> قائمة المعلمين المسجلين</h4>
                    <div id="teachersListContainer" class="data-list-container">
                        </div>
                </div>

                <div id="setting-tab-classes" style="display:none">
                    
                    <div style="background:#e8f5e9; padding:30px; border-radius:25px; margin-bottom:30px; border:2px solid var(--primary-color);">
                        <h4 style="color:var(--primary-color); margin-bottom:15px"><i class="fas fa-layer-group"></i> الخطوة الأولى: إنشاء أو تحديد الشعبة</h4>
                        <p style="color:#555; margin-bottom:15px">اكتب اسم الفصل أو الشعبة (مثال: أول متوسط / أ) لإضافته للنظام أولاً.</p>
                        <div style="display:flex; gap:15px;">
                            <input type="text" id="newClassNameInput" class="form-input" placeholder="اكتب اسم الشعبة هنا..." style="margin:0; font-weight:bold; color:var(--primary-color)">
                            <button class="btn-action btn-primary" style="width:200px; margin:0" onclick="addNewClass()">
                                <i class="fas fa-plus"></i> إضافة للقائمة
                            </button>
                        </div>
                    </div>

                    <div style="background:#fff; padding:30px; border-radius:25px; border:2px solid #eee; display:grid; grid-template-columns: 1fr 1fr; gap:40px">
                        
                        <div>
                            <h4 style="color:var(--accent-color); margin-bottom:15px"><i class="fas fa-user-graduate"></i> أ- إضافة طالب يدوياً</h4>
                            <p style="font-size:0.9rem; color:#777; margin-bottom:15px">سيتم ربط الطالب بالشعبة المكتوبة في الأعلى</p>
                            <input type="text" id="newStudentNameInput" class="form-input" placeholder="اسم الطالب" style="margin-bottom:15px">
                            <button class="btn-action btn-secondary" style="width:100%; margin:0" onclick="addStudentManual()">
                                <i class="fas fa-save"></i> حفظ الطالب
                            </button>
                        </div>

                        <div style="border-right:2px dashed #eee; padding-right:40px">
                            <h4 style="color:green; margin-bottom:15px"><i class="fas fa-file-import"></i> ب- استيراد طلاب من Excel</h4>
                            <p style="font-size:0.9rem; color:#777; margin-bottom:15px">ارفع ملفاً يحتوي أسماء الطلاب فقط، وسيقوم النظام بربطهم بالشعبة أعلاه.</p>
                            <input type="file" id="studentExcelInput" style="display:none" onchange="processStudentExcel(this)">
                            <button class="btn-action" style="width:100%; margin:0; background:#f0fff0; color:green; border:2px solid green" onclick="triggerStudentImport()">
                                <i class="fas fa-upload"></i> اختيار ملف وربط
                            </button>
                        </div>
                    </div>

                    <h4 style="margin-top:40px; margin-bottom:20px"><i class="fas fa-users-viewfinder"></i> الفصول والطلاب المسجلين</h4>
                    <div id="classesListContainer" class="data-list-container">
                        </div>
                </div>

                <div id="setting-tab-system" style="display:none; text-align:center">
                    <div style="padding:60px; border:3px dashed var(--danger-color); border-radius:40px; background:#fff5f5; margin-top:20px">
                        <i class="fas fa-triangle-exclamation" style="font-size:6rem; color:var(--danger-color); margin-bottom:25px"></i>
                        <h3 style="color:var(--danger-color); font-size:2.5rem; margin-bottom:20px">إعادة ضبط المصنع</h3>
                        <p style="margin-bottom:30px; font-size:1.3rem; color:#555; line-height:1.6">
                            تحذير هام: هذا الإجراء لا يمكن التراجع عنه.<br>
                            سيتم مسح كافة سجلات الأذونات، أسماء الطلاب، المعلمين، والفصول نهائياً من قاعدة البيانات.
                        </p>
                        <button class="btn-action btn-danger" style="max-width:450px; margin:0 auto" onclick="performFactoryReset()">
                            <i class="fas fa-trash-can"></i> تصفير النظام بالكامل وحذف البيانات
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="sectionCertificates" class="view-section">
            <div class="card" style="text-align:center">
                <i class="fas fa-award" style="font-size:7rem; color:var(--secondary-color); margin-bottom:30px"></i>
                <h2>إصدار شهادات التقدير والشكر</h2>
                <div style="max-width:600px; margin:40px auto">
                    <label style="display:block; text-align:right; font-weight:bold; margin-bottom:10px">اختر الطالب المكرم:</label>
                    <select id="certStudentSelector" class="form-input"><option>اختر الطالب...</option></select>
                    <button class="btn-action btn-secondary" onclick="generateAndPrintCert()">
                        <i class="fas fa-print"></i> معاينة وطباعة الشهادة
                    </button>
                </div>
            </div>
        </div>

    </div>

    <div id="printCertTemplate" class="cert-print-wrapper">
        <div class="cert-content">
            <h1 class="cert-title">شهادة شكر وتقدير</h1>
            <p class="cert-text" style="margin-top:40px">
                تتقدم إدارة متوسطة الإمام النووي بخالص الشكر والتقدير للطالب:
            </p>
            <h2 id="printStudentName" class="cert-name">................................</h2>
            <p class="cert-text">
                وذلك نظير انضباطه المدرسي المتميز، ومحافظته على الوقت، وحسن سلوكه داخل أروقة المدرسة.
            </p>
            
            <div class="cert-footer">
                <div class="cert-sign">
                    <h3>وكيل شؤون الطلاب</h3>
                    <p>....................</p>
                </div>
                <div class="cert-sign">
                    <h3>مدير المدرسة</h3>
                    <p>إبراهيم بن يحيى جابر اللغبي</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // استيراد مكتبات Firebase الرسمية
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, query, orderBy, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // إعدادات الاتصال بمشروعك
        const firebaseConfig = { projectId: "edin-377b2", authDomain: "edin-377b2.firebaseapp.com" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // متغيرات النظام العامة
        let currentRole = null;
        let cachedStudents = [];
        let cachedTeachers = [];
        let cachedClasses = [];
        let cachedPerms = [];
        let reportChartInstance = null;

        // --- نظام التنبيهات (Toast Notifications) ---
        window.notify = (message, type = 'success') => {
            const container = document.getElementById('notification-area');
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            
            let icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : 
                       type === 'error' ? '<i class="fas fa-circle-xmark"></i>' : 
                       '<i class="fas fa-info-circle"></i>';
            
            toast.innerHTML = `${icon} <span>${message}</span>`;
            container.appendChild(toast);
            
            // إزالة الإشعار تلقائياً بعد 3.5 ثانية
            setTimeout(() => {
                toast.remove();
            }, 3500);
        };

        // --- إدارة تسجيل الدخول (Authentication) ---
        window.initiateLogin = (role) => {
            currentRole = role;
            document.getElementById('roleSelectionPanel').style.display = 'none';
            document.getElementById('passwordInputPanel').style.display = 'block';
        };

        window.validateLogin = async () => {
            const codeInput = document.getElementById('accessCodeInput').value;
            const loginBtn = document.getElementById('confirmLoginBtn');
            
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحقق...';

            // 1. تجاوز المدير (Bypass) لحل مشكلة الاتصال الأولية
            if (currentRole === 'admin' && codeInput === '2025') {
                launchApplication();
                return;
            }

            // 2. التحقق من السحابة للمعلم
            try {
                const docRef = doc(db, "settings", "dailyCode");
                const docSnap = await getDoc(docRef);
                const serverCode = docSnap.exists() ? docSnap.data().value : "1234";

                if (currentRole === 'teacher' && codeInput === serverCode) {
                    launchApplication();
                } else {
                    notify("عذراً، الكود المدخل غير صحيح", "error");
                    loginBtn.innerHTML = 'تأكيد الدخول';
                }
            } catch (error) {
                console.error("Login Error:", error);
                // الدخول الافتراضي في حالة تعذر الاتصال لأول مرة
                if (currentRole === 'teacher' && codeInput === '1234') {
                    launchApplication();
                } else {
                    notify("فشل الاتصال بالسيرفر. تأكد من الإنترنت", "error");
                    loginBtn.innerHTML = 'تأكيد الدخول';
                }
            }
        };

        function launchApplication() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('applicationMain').style.display = 'block';
            document.getElementById('navigationBar').style.display = 'flex';
            
            // ضبط الشهر الحالي للتقارير
            const today = new Date();
            const currentMonth = today.toISOString().slice(0, 7); // YYYY-MM
            document.getElementById('reportMonthFilter').value = currentMonth;

            buildNavigationMenu();
            startRealtimeListeners();
            notify("تم تسجيل الدخول بنجاح. مرحباً بك!", "success");
        }

        // --- بناء القوائم والتنقل (Navigation) ---
        function buildNavigationMenu() {
            const nav = document.getElementById('navigationBar');
            
            if (currentRole === 'admin') {
                nav.innerHTML = `
                    <button class="nav-btn active" onclick="switchView('sectionHome', this)">
                        <i class="fas fa-home"></i> الرئيسية
                    </button>
                    <button class="nav-btn" onclick="switchView('sectionMonitor', this)">
                        <i class="fas fa-desktop"></i> المتابعة
                    </button>
                    <button class="nav-btn" onclick="switchView('sectionReports', this)">
                        <i class="fas fa-chart-pie"></i> التقارير
                    </button>
                    <button class="nav-btn" onclick="switchView('sectionCertificates', this)">
                        <i class="fas fa-award"></i> الشهادات
                    </button>
                    <button class="nav-btn" onclick="switchView('sectionSettings', this)">
                        <i class="fas fa-cogs"></i> الإعدادات
                    </button>
                `;
                switchView('sectionHome');
            } else {
                nav.innerHTML = `
                    <button class="nav-btn active" onclick="switchView('sectionTeacher', this)">
                        <i class="fas fa-pen-nib"></i> إصدار إذن
                    </button>
                    <button class="nav-btn" onclick="switchView('sectionMonitor', this)">
                        <i class="fas fa-list-check"></i> حالة طلابي
                    </button>
                `;
                switchView('sectionTeacher');
            }
        }

        window.switchView = (sectionId, btnElement) => {
            // إخفاء الكل
            document.querySelectorAll('.view-section').forEach(sec => sec.classList.remove('active'));
            // إظهار المطلوب
            document.getElementById(sectionId).classList.add('active');
            
            // تحديث زر القائمة
            if (btnElement) {
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                btnElement.classList.add('active');
            }

            // إجراءات خاصة عند فتح التقارير
            if (sectionId === 'sectionReports') {
                refreshReports();
            }
        };

        // --- المحرك السحابي (Realtime Sync) ---
        function startRealtimeListeners() {
            // 1. الاستماع لكود المعلم
            onSnapshot(doc(db, "settings", "dailyCode"), (docSnap) => {
                if (docSnap.exists()) {
                    document.getElementById('dailyTeacherCode').innerText = docSnap.data().value;
                }
            });

            // 2. الاستماع لقوائم البيانات (طلاب، معلمين، فصول)
            // هام: تم إصلاح تحميل القوائم لضمان ظهورها في الجوال
            onSnapshot(doc(db, "data", "schoolLists"), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    cachedTeachers = data.teachers || [];
                    cachedStudents = data.students || [];
                    cachedClasses = data.classes || [];
                    
                    // استدعاء دالة التعبئة فوراً
                    populateAllDropdowns();
                    renderManagementLists(); // تحديث قوائم الحذف في الإعدادات
                }
            });

            // 3. الاستماع لسجلات الأذونات (للمراقبة والتقارير)
            const q = query(collection(db, "perms"), orderBy("timestamp", "desc"));
            onSnapshot(q, (querySnapshot) => {
                cachedPerms = [];
                querySnapshot.forEach((doc) => {
                    cachedPerms.push({ id: doc.id, ...doc.data() });
                });
                
                renderMonitorGrid(cachedPerms);
                
                // تحديث التقارير إذا كانت الصفحة مفتوحة
                if (document.getElementById('sectionReports').classList.contains('active')) {
                    refreshReports();
                }
            });
        }

        // --- وظائف المساعدة للقوائم (تم إصلاحها للجوال) ---
        function populateAllDropdowns() {
            // المعلمون (تعبئة في جميع الأماكن المحتملة)
            const teacherOptions = '<option value="">اختر اسمك...</option>' + cachedTeachers.map(t => `<option value="${t}">${t}</option>`).join('');
            
            // إصلاح: تعيين نفس القائمة لأي عنصر يحمل هذا المعرف
            const teacherSelect = document.getElementById('teacherNameSelect');
            if(teacherSelect) teacherSelect.innerHTML = teacherOptions;

            // الفصول
            const classOptions = '<option value="">اختر الشعبة...</option>' + cachedClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            const classSelect = document.getElementById('classNameSelect');
            if(classSelect) classSelect.innerHTML = classOptions;
            
            // الطلاب (لشهادات التقدير)
            const studentOptions = '<option value="">اختر الطالب...</option>' + cachedStudents.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            const certSelect = document.getElementById('certStudentSelector');
            if(certSelect) certSelect.innerHTML = studentOptions;
        }

        window.filterStudentsByClass = () => {
            const selectedClass = document.getElementById('classNameSelect').value;
            const studentSelect = document.getElementById('studentNameSelect');
            
            const filtered = cachedStudents.filter(s => s.class === selectedClass);
            studentSelect.innerHTML = filtered.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        };

        // --- وظائف المراقبة (Monitor) ---
        function renderMonitorGrid(perms) {
            const activePerms = perms.filter(p => p.status === 'out');
            const gridContainer = document.getElementById('liveMonitorGrid');
            
            // تحديث العدادات العلوية
            document.getElementById('activeStudentCount').innerText = activePerms.length;
            document.getElementById('statActiveStudents').innerText = activePerms.length;
            
            // حساب إجمالي اليوم (بناءً على التاريخ)
            const todayStr = new Date().toDateString();
            const todayTotal = perms.filter(p => p.timestamp && p.timestamp.toDate().toDateString() === todayStr).length;
            document.getElementById('statTotalPermits').innerText = todayTotal;

            // رسم البطاقات
            gridContainer.innerHTML = activePerms.map(p => {
                const now = new Date();
                const outTime = p.timestamp ? p.timestamp.toDate() : new Date();
                const diffMins = Math.floor((now - outTime) / 60000);
                const isLate = diffMins > p.limit;
                
                return `
                    <div class="student-card ${isLate ? 'late' : ''}">
                        <div class="student-info">
                            <h3>${p.studentName}</h3>
                            <p>
                                <i class="fas fa-chalkboard"></i> ${p.className} <br>
                                <i class="fas fa-user-tie"></i> المعلم: ${p.teacherName}
                            </p>
                        </div>
                        
                        <div style="background:#f9f9f9; padding:12px; border-radius:15px; display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
                            <span><i class="fas fa-location-dot"></i> ${p.destination}</span>
                            <span style="font-weight:bold; color:${isLate ? 'red' : 'green'}">
                                ${diffMins} دقيقة
                            </span>
                        </div>
                        <button class="btn-action btn-primary" onclick="confirmReturn('${p.id}')" style="margin-top:15px; padding:10px; font-size:1rem">
                            <i class="fas fa-check"></i> تأكيد العودة
                        </button>
                    </div>
                `;
            }).join('') || '<div style="grid-column:1/-1; text-align:center; padding:60px; color:#aaa; font-size:1.2rem"><i class="fas fa-check-circle" style="font-size:3rem; margin-bottom:10px; display:block"></i>لا يوجد طلاب خارج الفصول حالياً</div>';
        }

        // --- وظائف التقارير (Reports Logic) ---
        window.refreshReports = () => {
            const selectedMonth = document.getElementById('reportMonthFilter').value; // YYYY-MM
            if (!selectedMonth) return;

            // فلترة البيانات للشهر المحدد
            const monthlyData = cachedPerms.filter(p => {
                if (!p.timestamp) return false;
                const date = p.timestamp.toDate();
                return date.toISOString().slice(0, 7) === selectedMonth;
            });

            // إعداد بيانات الرسم البياني (عدد الأذونات لكل فصل)
            const classStats = {};
            monthlyData.forEach(p => {
                classStats[p.className] = (classStats[p.className] || 0) + 1;
            });

            // رسم المخطط
            const ctx = document.getElementById('reportChartCanvas');
            if (reportChartInstance) reportChartInstance.destroy();

            reportChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(classStats),
                    datasets: [{
                        label: 'عدد حركات خروج الطلاب',
                        data: Object.values(classStats),
                        backgroundColor: '#145A32',
                        borderColor: '#0B3B24',
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'توزيع الأذونات حسب الفصول والشعب' }
                    }
                }
            });

            // تعبئة السجل النصي
            const logsContainer = document.getElementById('reportLogsList');
            logsContainer.innerHTML = monthlyData.slice(0, 50).map(p => {
                const dateStr = p.timestamp.toDate().toLocaleDateString('ar-SA');
                const timeStr = p.timestamp.toDate().toLocaleTimeString('ar-SA', {hour:'2-digit', minute:'2-digit'});
                return `
                    <li style="border-bottom:1px solid #eee; padding:5px 0">
                        <i class="fas fa-caret-left" style="color:var(--secondary-color)"></i> 
                        الطالب <strong>${p.studentName}</strong> (${p.className}) خرج إلى <strong>${p.destination}</strong> 
                        <span style="color:#888; font-size:0.9rem">(${dateStr} - ${timeStr})</span>
                    </li>
                `;
            }).join('') || '<li style="text-align:center; padding:20px; color:#999">لا توجد سجلات لهذا الشهر</li>';
        };

        // --- وظائف الإعدادات الجديدة (Settings Logic) ---
        window.changeSettingsTab = (tabName) => {
            // إخفاء كل التبويبات
            ['setting-tab-teachers', 'setting-tab-classes', 'setting-tab-system'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            // إظهار المطلوب
            document.getElementById('setting-tab-' + tabName).style.display = 'block';
            
            // تحديث الأزرار
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        };

        // 1. إدارة المعلمين
        window.addTeacherManual = async () => {
            const name = document.getElementById('manualTeacherInput').value.trim();
            if (!name) return notify("الرجاء كتابة اسم المعلم", "error");
            
            await setDoc(doc(db, "data", "schoolLists"), { 
                teachers: arrayUnion(name) 
            }, { merge: true });
            
            notify("تمت إضافة المعلم بنجاح");
            document.getElementById('manualTeacherInput').value = '';
        };

        window.processTeacherExcel = (inputElement) => {
            const file = inputElement.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // البحث عن عمود الاسم
                    const newTeachers = [...new Set(jsonData.map(row => row['المعلم'] || row['الاسم'] || row['Name']))].filter(Boolean);
                    
                    if (newTeachers.length > 0) {
                        await setDoc(doc(db, "data", "schoolLists"), { teachers: arrayUnion(...newTeachers) }, { merge: true });
                        notify(`تم استيراد ${newTeachers.length} معلم بنجاح`);
                    } else {
                        notify("لم يتم العثور على أسماء في الملف. تأكد من عناوين الأعمدة", "error");
                    }
                } catch (err) {
                    console.error(err);
                    notify("حدث خطأ أثناء قراءة الملف", "error");
                }
            };
            reader.readAsArrayBuffer(file);
        };

        window.removeTeacher = async (name) => {
            if (confirm(`هل أنت متأكد من حذف المعلم: ${name}؟`)) {
                await setDoc(doc(db, "data", "schoolLists"), { teachers: arrayRemove(name) }, { merge: true });
                notify("تم الحذف بنجاح");
            }
        };

        // 2. إدارة الفصول والطلاب (Smart Link)
        window.addNewClass = async () => {
            const className = document.getElementById('newClassNameInput').value.trim();
            if (!className) return notify("الرجاء كتابة اسم الشعبة", "error");
            
            await setDoc(doc(db, "data", "schoolLists"), { 
                classes: arrayUnion(className) 
            }, { merge: true });
            
            notify("تمت إضافة الشعبة للقائمة");
            // ننسخ الاسم لحقل "الهدف" ليسهل على المستخدم الخطوة التالية
            document.getElementById('targetClassName').value = className; 
        };

        window.triggerStudentImport = () => {
            const targetClass = document.getElementById('targetClassName').value.trim();
            if (!targetClass) {
                notify("تنبيه: يجب كتابة اسم الشعبة في الحقل الأعلى أولاً لربط الملف بها!", "error");
                document.getElementById('targetClassName').focus();
                return;
            }
            document.getElementById('studentExcelInput').click();
        };

        window.processStudentExcel = (inputElement) => {
            const targetClass = document.getElementById('targetClassName').value.trim();
            const file = inputElement.files[0];
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    // استخراج الأسماء وربطها بالشعبة
                    const newStudents = jsonData.map(row => ({
                        name: row['الاسم'] || row['الطالب'] || row['Student'],
                        class: targetClass
                    })).filter(s => s.name);

                    if (newStudents.length > 0) {
                        // نضيف الطلاب ونضيف الشعبة أيضاً للقائمة (لضمان وجودها)
                        await setDoc(doc(db, "data", "schoolLists"), { 
                            students: arrayUnion(...newStudents),
                            classes: arrayUnion(targetClass)
                        }, { merge: true });
                        notify(`تم ربط ${newStudents.length} طالب بالشعبة: ${targetClass}`);
                    } else {
                        notify("لم يتم العثور على أسماء طلاب في الملف", "error");
                    }
                } catch (err) {
                    console.error(err);
                    notify("ملف غير صالح", "error");
                }
            };
            reader.readAsArrayBuffer(file);
        };

        window.addStudentManual = async () => {
            const name = document.getElementById('newStudentNameInput').value.trim();
            const targetClass = document.getElementById('targetClassName').value.trim();
            
            if (!name || !targetClass) return notify("الرجاء تحديد الشعبة واسم الطالب", "error");

            await setDoc(doc(db, "data", "schoolLists"), { 
                students: arrayUnion({ name: name, class: targetClass }),
                classes: arrayUnion(targetClass)
            }, { merge: true });

            notify("تم حفظ الطالب");
            document.getElementById('newStudentNameInput').value = '';
        };

        window.removeClass = async (className) => {
            if (confirm(`تحذير: سيتم حذف الشعبة "${className}" وجميع الطلاب المرتبطين بها. هل أنت متأكد؟`)) {
                // فلترة الطلاب لحذف التابعين لهذا الفصل
                const studentsToKeep = cachedStudents.filter(s => s.class !== className);
                
                // تحديث القائمتين (الطلاب والفصول) دفعة واحدة
                await setDoc(doc(db, "data", "schoolLists"), { 
                    classes: arrayRemove(className),
                    students: studentsToKeep // نستبدل القائمة بالكامل بالقائمة المفلترة
                }, { merge: true }); // استخدام merge بحذر هنا، الأفضل إعادة كتابة الطلاب
                
                // لتصحيح الحذف الكلي للطلاب، نستخدم طريقة إعادة الكتابة للحقل students
                await updateDoc(doc(db, "data", "schoolLists"), {
                    students: studentsToKeep
                });

                notify("تم حذف الشعبة وطلابها");
            }
        };

        // عرض قوائم الإدارة (الحذف)
        function renderManagementLists() {
            // المعلمون
            const techContainer = document.getElementById('teachersListContainer');
            techContainer.innerHTML = cachedTeachers.map(t => `
                <div class="list-item">
                    <div class="list-info">
                        <i class="fas fa-user-tie list-icon"></i>
                        <span>${t}</span>
                    </div>
                    <div class="del-icon-btn" onclick="removeTeacher('${t}')" title="حذف المعلم">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                </div>
            `).join('');

            // الفصول (مع عدد الطلاب)
            const classContainer = document.getElementById('classesListContainer');
            classContainer.innerHTML = cachedClasses.map(c => {
                const count = cachedStudents.filter(s => s.class === c).length;
                return `
                    <div class="list-item">
                        <div class="list-info">
                            <i class="fas fa-layer-group list-icon" style="color:var(--accent-color)"></i>
                            <span>${c} <small style="color:#888; font-weight:normal">(${count} طالب)</small></span>
                        </div>
                        <div class="del-icon-btn" onclick="removeClass('${c}')" title="حذف الفصل والطلاب">
                            <i class="fas fa-trash-alt"></i>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- العمليات اليومية (Permits) ---
        window.refreshDailyCode = async () => {
            const newCode = Math.floor(1000 + Math.random() * 9000).toString();
            await setDoc(doc(db, "settings", "dailyCode"), { value: newCode });
            notify("تم تحديث كود المعلم بنجاح");
        };

        window.submitNewPermit = async () => {
            const studentName = document.getElementById('studentNameSelect').value;
            const className = document.getElementById('classNameSelect').value;
            const teacherName = document.getElementById('teacherNameSelect').value;
            
            // تحقق صارم من البيانات
            if (!studentName || studentName === "اختر الطالب..." || !className || !teacherName) {
                return notify("الرجاء إكمال جميع البيانات المطلوبة", "error");
            }

            try {
                await addDoc(collection(db, "perms"), {
                    studentName: studentName,
                    className: className,
                    teacherName: teacherName,
                    destination: document.getElementById('destinationSelect').value,
                    limit: parseInt(document.getElementById('durationInput').value),
                    status: 'out',
                    timestamp: serverTimestamp()
                });
                notify("تم إصدار الإذن بنجاح ✅");
                // إعادة تعيين حقل الطالب فقط
                document.getElementById('studentNameSelect').value = "";
            } catch (err) {
                console.error(err);
                notify("حدث خطأ أثناء الإصدار", "error");
            }
        };

        window.confirmReturn = async (permId) => {
            await updateDoc(doc(db, "perms", permId), { 
                status: 'returned', 
                returnTime: serverTimestamp() 
            });
            notify("تم تسجيل عودة الطالب");
        };

        window.performFactoryReset = async () => {
            if (confirm("تحذير نهائي: هل أنت متأكد تماماً من حذف جميع البيانات؟ لا يمكن التراجع عن هذا الإجراء.")) {
                // حذف الأذونات
                const q = await getDocs(collection(db, "perms"));
                q.forEach(d => deleteDoc(doc(db, "perms", d.id)));
                
                // حذف القوائم
                await setDoc(doc(db, "data", "schoolLists"), { teachers: [], students: [], classes: [] });
                
                notify("تم تصفير النظام وإعادته لضبط المصنع", "success");
                setTimeout(() => location.reload(), 2000);
            }
        };

        window.generateAndPrintCert = () => {
            const name = document.getElementById('certStudentSelector').value;
            if (!name || name.includes("اختر")) return notify("الرجاء اختيار طالب أولاً", "error");
            
            document.getElementById('printStudentName').innerText = name;
            window.print();
        };

        // الساعة الرقمية
        setInterval(() => {
            const now = new Date();
            document.getElementById('clockDisplay').innerText = now.toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute:'2-digit'});
        }, 1000);

        // تصدير الدوال المهمة للنطاق العام (لتجنب مشاكل الوحدات)
        window.returnStudent = window.confirmReturn; 
    </script>
</body>
</html>