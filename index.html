<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام إذن الرقمي - الإصدار المستقر</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #145A32;
            --secondary: #D4AC0D;
            --bg: #F3F4F6;
            --text: #1F2937;
        }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; margin: 0; padding: 0; outline: none; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 100px; }

        /* التنبيهات */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 99999; width: 90%; max-width: 400px; }
        .toast { background: #333; color: #fff; padding: 15px 25px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease-out; }
        .toast.success { background: var(--primary); border-left: 5px solid #2ecc71; }
        .toast.error { background: #c0392b; border-left: 5px solid #e74c3c; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* شاشة الدخول */
        #loginOverlay { position: fixed; inset: 0; background: #fff; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .login-box { text-align: center; width: 90%; max-width: 400px; padding: 40px 20px; }
        
        /* التصميم العام */
        header { background: linear-gradient(135deg, var(--primary) 0%, #0B3B24 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .form-control { width: 100%; padding: 15px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 1rem; margin-bottom: 15px; background: #fff; }
        .form-control:focus { border-color: var(--secondary); }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: #000; }
        .btn-danger { background: #c0392b; color: white; }

        /* القوائم والشبكة */
        .nav-bar { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 20px; scrollbar-width: none; }
        .nav-btn { padding: 10px 20px; border-radius: 50px; background: #fff; border: 1px solid #e5e7eb; cursor: pointer; white-space: nowrap; }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .monitor-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .student-card { background: white; padding: 20px; border-radius: 15px; border-right: 6px solid var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* القوائم في الإعدادات */
        .list-container { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 10px; margin-top: 15px; }
        .list-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .del-btn { color: #e74c3c; cursor: pointer; padding: 5px; }

        @media print { .no-print { display: none; } body { background: white; } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="loginOverlay">
        <div class="login-box" id="roleBox">
            <h1 style="color:var(--primary); margin-bottom:10px">متوسطة الإمام النووي</h1>
            <p style="color:#666; margin-bottom:30px">نظام إذن (الإصدار المستقر)</p>
            <button class="btn btn-primary" style="margin-bottom:10px" onclick="showLogin('admin')">الإدارة</button>
            <button class="btn btn-secondary" onclick="showLogin('teacher')">المعلم</button>
        </div>
        <div class="login-box" id="passBox" style="display:none">
            <h3>أدخل الكود</h3>
            <input type="password" id="pinInput" class="form-control" style="text-align:center; font-size:2rem; letter-spacing:5px">
            <button class="btn btn-primary" style="margin-bottom:10px" onclick="checkLogin()">دخول</button>
            <button class="btn btn-danger" onclick="location.reload()">رجوع</button>
        </div>
    </div>

    <div id="appContainer" style="display:none">
        <header class="no-print">
            <div style="font-weight:bold; font-size:1.5rem">إذن الرقمي</div>
            <div style="background:rgba(255,255,255,0.2); padding:5px 15px; border-radius:20px; font-weight:bold">
                <span id="outCount">0</span> بالخارج
            </div>
        </header>

        <div class="container no-print">
            <div class="nav-bar" id="navMenu"></div>

            <div id="view-home" class="view-section">
                <div class="card" style="text-align:center">
                    <h3>كود المعلم المتزامن</h3>
                    <div id="codeDisplay" style="font-size:5rem; font-weight:bold; color:var(--primary); margin:20px 0; font-family:monospace">----</div>
                    <button class="btn btn-secondary" onclick="updateCode()">تحديث الكود</button>
                </div>
                <div id="monitorGrid" class="monitor-grid"></div>
            </div>

            <div id="view-teacher" class="view-section">
                <div class="card">
                    <h3>إصدار إذن</h3>
                    
                    <label>المعلم المصدر:</label>
                    <select id="teacher_dropdown" class="form-control">
                        <option value="">جاري تحميل القائمة...</option>
                    </select>

                    <label>الصف / الشعبة:</label>
                    <select id="class_dropdown" class="form-control" onchange="loadStudentsForClass()">
                        <option value="">اختر الشعبة...</option>
                    </select>

                    <label>الطالب:</label>
                    <select id="student_dropdown" class="form-control">
                        <option value="">اختر الطالب...</option>
                    </select>

                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px">
                        <select id="dest_select" class="form-control">
                            <option>دورة المياه</option><option>المقصف</option><option>الإدارة</option><option>المرشد</option>
                        </select>
                        <input type="number" id="duration_input" class="form-control" value="5">
                    </div>

                    <button class="btn btn-primary" onclick="createPermit()">إصدار الإذن</button>
                </div>
            </div>

            <div id="view-settings" class="view-section">
                <div class="nav-bar">
                    <button class="nav-btn active" onclick="setTab('teachers')">المعلمون</button>
                    <button class="nav-btn" onclick="setTab('classes')">الطلاب والشعب</button>
                    <button class="nav-btn" onclick="setTab('system')">النظام</button>
                </div>

                <div id="stab-teachers">
                    <div class="card">
                        <h4>إضافة معلم جديد</h4>
                        <input type="text" id="new_teacher_name" class="form-control" placeholder="الاسم الرباعي">
                        <button class="btn btn-primary" onclick="saveTeacher()">حفظ</button>
                        
                        <hr style="margin:20px 0; border:0; border-top:1px dashed #ccc">
                        
                        <h4>أو استيراد من Excel</h4>
                        <p style="font-size:0.9rem; color:#666">ملف يحتوي عمود "الاسم" أو "المعلم"</p>
                        <input type="file" id="teacher_file" class="form-control">
                        <button class="btn btn-secondary" onclick="importTeacherExcel()">رفع الملف</button>
                    </div>
                    <div class="card">
                        <h4>قائمة المعلمين</h4>
                        <div id="teacher_list" class="list-container"></div>
                    </div>
                </div>

                <div id="stab-classes" style="display:none">
                    <div class="card" style="border:2px solid var(--primary)">
                        <h4 style="color:var(--primary)">1. اسم الشعبة المستهدفة</h4>
                        <p style="font-size:0.9rem; color:#666">اكتب اسم الفصل هنا (مثال: 1/1) لربط الطلاب به:</p>
                        <input type="text" id="target_class_name" class="form-control" style="font-weight:bold">
                        <button class="btn btn-primary" onclick="saveClassOnly()">تثبيت اسم الشعبة</button>
                    </div>

                    <div class="card">
                        <h4>2. إضافة طلاب لهذه الشعبة</h4>
                        
                        <label>أ- إضافة يدوية:</label>
                        <div style="display:flex; gap:10px; margin-bottom:20px">
                            <input type="text" id="new_student_name" class="form-control" placeholder="اسم الطالب" style="margin:0">
                            <button class="btn btn-secondary" style="width:auto" onclick="saveStudentManual()">حفظ</button>
                        </div>

                        <label>ب- استيراد Excel:</label>
                        <p style="font-size:0.9rem; color:#666">ملف يحتوي أسماء الطلاب فقط. سيتم ربطهم بالشعبة المكتوبة في الأعلى.</p>
                        <input type="file" id="student_file" class="form-control">
                        <button class="btn btn-secondary" onclick="importStudentExcel()">رفع وربط الملف</button>
                    </div>

                    <div class="card">
                        <h4>الفصول المسجلة</h4>
                        <div id="class_list" class="list-container"></div>
                    </div>
                </div>

                <div id="stab-system" style="display:none">
                    <div class="card" style="text-align:center">
                        <h4 style="color:red">منطقة الخطر</h4>
                        <button class="btn btn-danger" onclick="factoryReset()">تصفير النظام بالكامل</button>
                    </div>
                </div>
            </div>
            
            <div id="view-reports" class="view-section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between">
                        <h3>التقارير</h3>
                        <input type="month" id="rep_month" onchange="renderCharts()">
                    </div>
                    <canvas id="chartCanvas"></canvas>
                </div>
                <div class="card">
                    <ul id="rep_logs" style="list-style:none; padding:0"></ul>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, query, orderBy, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // إعدادات Firebase
        const app = initializeApp({ projectId: "edin-377b2", authDomain: "edin-377b2.firebaseapp.com" });
        const db = getFirestore(app);

        // المتغيرات العامة (Global State)
        let USER_ROLE = "";
        let DATA = { teachers: [], students: [], classes: [] };
        let PERMS = [];
        let CHART = null;

        // --- 1. التنبيهات (Toasts) ---
        window.toast = (msg, type = 'success') => {
            const d = document.createElement('div');
            d.className = `toast ${type}`;
            d.innerHTML = type === 'success' ? `<i class="fas fa-check"></i> ${msg}` : `<i class="fas fa-times"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(d);
            setTimeout(() => d.remove(), 3000);
        };

        // --- 2. الدخول (Auth) ---
        window.showLogin = (r) => { USER_ROLE = r; document.getElementById('roleBox').style.display = 'none'; document.getElementById('passBox').style.display = 'block'; };
        
        window.checkLogin = async () => {
            const pin = document.getElementById('pinInput').value;
            if(USER_ROLE === 'admin' && pin === '2025') return initApp();
            
            try {
                const s = await getDoc(doc(db, "settings", "dailyCode"));
                if(USER_ROLE === 'teacher' && (pin === (s.exists() ? s.data().value : "1234") || pin === '1234')) return initApp();
                toast("الكود خاطئ", "error");
            } catch(e) { 
                if(USER_ROLE === 'teacher' && pin === '1234') initApp();
                else toast("خطأ في الاتصال", "error"); 
            }
        };

        function initApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            buildNav();
            startListeners(); // بدء استقبال البيانات
        }

        function buildNav() {
            const m = document.getElementById('navMenu');
            if(USER_ROLE === 'admin') {
                m.innerHTML = `
                    <button class="nav-btn active" onclick="nav('view-home',this)">الرئيسية</button>
                    <button class="nav-btn" onclick="nav('view-reports',this)">التقارير</button>
                    <button class="nav-btn" onclick="nav('view-settings',this)">الإعدادات</button>
                `;
                nav('view-home');
            } else {
                m.innerHTML = `
                    <button class="nav-btn active" onclick="nav('view-teacher',this)">إصدار إذن</button>
                    <button class="nav-btn" onclick="nav('view-home',this)">المتابعة</button>
                `;
                nav('view-teacher');
            }
        }

        window.nav = (id, btn) => {
            document.querySelectorAll('.view-section').forEach(d => d.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(btn) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            if(id === 'view-reports') renderCharts();
        };

        // --- 3. مزامنة البيانات (Core Sync Logic) ---
        function startListeners() {
            // أ. استلام القوائم (أساس المشكلة السابقة)
            onSnapshot(doc(db, "data", "schoolLists"), (snap) => {
                if(snap.exists()) {
                    DATA = snap.data();
                    // تأكد من وجود المصفوفات لتجنب الأخطاء
                    if(!DATA.teachers) DATA.teachers = [];
                    if(!DATA.students) DATA.students = [];
                    if(!DATA.classes) DATA.classes = [];
                    
                    updateUILists(); // تحديث الواجهة فور وصول البيانات
                }
            });

            // ب. استلام الأذونات
            onSnapshot(query(collection(db, "perms"), orderBy("timestamp", "desc")), (snap) => {
                PERMS = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderMonitor();
                if(document.getElementById('view-reports').classList.contains('active')) renderCharts();
            });

            // ج. الكود اليومي
            onSnapshot(doc(db, "settings", "dailyCode"), (s) => {
                if(s.exists()) document.getElementById('codeDisplay').innerText = s.data().value;
            });
        }

        // تحديث القوائم المنسدلة (الحل الجذري)
        function updateUILists() {
            // 1. المعلمين
            const tDrop = document.getElementById('teacher_dropdown');
            tDrop.innerHTML = '<option value="">اختر اسمك...</option>' + 
                DATA.teachers.map(t => `<option value="${t}">${t}</option>`).join('');

            // 2. الفصول
            const cDrop = document.getElementById('class_dropdown');
            cDrop.innerHTML = '<option value="">اختر الشعبة...</option>' + 
                DATA.classes.map(c => `<option value="${c}">${c}</option>`).join('');

            // 3. قوائم الإعدادات (للحذف)
            document.getElementById('teacher_list').innerHTML = DATA.teachers.map(t => 
                `<div class="list-item"><span>${t}</span><i class="fas fa-trash del-btn" onclick="delTeacher('${t}')"></i></div>`
            ).join('');
            
            document.getElementById('class_list').innerHTML = DATA.classes.map(c => 
                `<div class="list-item"><span>${c}</span><i class="fas fa-trash del-btn" onclick="delClass('${c}')"></i></div>`
            ).join('');
        }

        // دالة تصفية الطلاب حسب الفصل المختار
        window.loadStudentsForClass = () => {
            const cls = document.getElementById('class_dropdown').value;
            const sDrop = document.getElementById('student_dropdown');
            
            if(!cls) {
                sDrop.innerHTML = '<option value="">اختر الشعبة أولاً</option>';
                return;
            }

            const filtered = DATA.students.filter(s => s.class === cls);
            sDrop.innerHTML = '<option value="">اختر الطالب...</option>' + 
                filtered.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        };

        // --- 4. وظائف الإعدادات (الاستيراد والحفظ) ---
        
        window.setTab = (t) => {
            ['teachers','classes','system'].forEach(x => document.getElementById('stab-'+x).style.display='none');
            document.getElementById('stab-'+t).style.display='block';
            document.querySelectorAll('.nav-bar .nav-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        };

        // أ. المعلمون
        window.saveTeacher = async () => {
            const n = document.getElementById('new_teacher_name').value.trim();
            if(!n) return toast("اكتب الاسم", "error");
            await setDoc(doc(db, "data", "schoolLists"), { teachers: arrayUnion(n) }, { merge: true });
            toast("تمت الإضافة"); document.getElementById('new_teacher_name').value = '';
        };

        window.importTeacherExcel = () => {
            const f = document.getElementById('teacher_file').files[0];
            if(!f) return toast("اختر ملف", "error");
            const r = new FileReader();
            r.onload = async (e) => {
                const d = XLSX.utils.sheet_to_json(XLSX.read(e.target.result, {type:'array'}).Sheets[XLSX.read(e.target.result, {type:'array'}).SheetNames[0]]);
                const t = [...new Set(d.map(x => x['الاسم'] || x['المعلم']))].filter(Boolean);
                if(t.length) {
                    await setDoc(doc(db, "data", "schoolLists"), { teachers: arrayUnion(...t) }, { merge: true });
                    toast(`تم استيراد ${t.length} معلم`);
                }
            };
            r.readAsArrayBuffer(f);
        };

        // ب. الفصول والطلاب (المنطق المصحح)
        window.saveClassOnly = async () => {
            const c = document.getElementById('target_class_name').value.trim();
            if(!c) return toast("اكتب اسم الشعبة", "error");
            await setDoc(doc(db, "data", "schoolLists"), { classes: arrayUnion(c) }, { merge: true });
            toast("تم تثبيت الشعبة");
        };

        window.saveStudentManual = async () => {
            const n = document.getElementById('new_student_name').value.trim();
            const c = document.getElementById('target_class_name').value.trim();
            
            if(!c) return toast("اكتب اسم الشعبة في الحقل الأعلى أولاً!", "error");
            if(!n) return toast("اكتب اسم الطالب", "error");

            await setDoc(doc(db, "data", "schoolLists"), { 
                students: arrayUnion({ name: n, class: c }),
                classes: arrayUnion(c) // نضمن وجود الفصل
            }, { merge: true });
            
            toast("تم حفظ الطالب");
            document.getElementById('new_student_name').value = '';
        };

        window.importStudentExcel = () => {
            const c = document.getElementById('target_class_name').value.trim();
            const f = document.getElementById('student_file').files[0];

            if(!c) return toast("اكتب اسم الشعبة في الحقل الأعلى أولاً!", "error");
            if(!f) return toast("اختر ملف الإكسل", "error");

            const r = new FileReader();
            r.onload = async (e) => {
                const d = XLSX.utils.sheet_to_json(XLSX.read(e.target.result, {type:'array'}).Sheets[XLSX.read(e.target.result, {type:'array'}).SheetNames[0]]);
                // نأخذ الأسماء ونلصق بها الشعبة المكتوبة
                const s = d.map(x => ({ name: x['الاسم'] || x['الطالب'], class: c })).filter(x => x.name);
                
                if(s.length) {
                    await setDoc(doc(db, "data", "schoolLists"), { 
                        students: arrayUnion(...s),
                        classes: arrayUnion(c)
                    }, { merge: true });
                    toast(`تم ربط ${s.length} طالب بالشعبة ${c}`);
                } else {
                    toast("الملف فارغ أو لا يحتوي عمود الاسم", "error");
                }
            };
            r.readAsArrayBuffer(f);
        };

        // حذف
        window.delTeacher = async (n) => { if(confirm("حذف؟")) await setDoc(doc(db,"data","schoolLists"), { teachers: arrayRemove(n) }, { merge: true }); };
        window.delClass = async (c) => { 
            if(confirm("حذف الشعبة وطلابها؟")) {
                const newS = DATA.students.filter(s => s.class !== c);
                await setDoc(doc(db,"data","schoolLists"), { classes: arrayRemove(c), students: newS }, { merge: true });
                toast("تم الحذف");
            }
        };

        // --- 5. العمليات ---
        window.updateCode = async () => {
            await setDoc(doc(db, "settings", "dailyCode"), { value: Math.floor(1000 + Math.random() * 9000).toString() });
            toast("تم التحديث");
        };

        window.createPermit = async () => {
            const s = document.getElementById('student_dropdown').value;
            const t = document.getElementById('teacher_dropdown').value;
            const c = document.getElementById('class_dropdown').value;
            
            if(!s || !t || !c) return toast("أكمل البيانات", "error");

            await addDoc(collection(db, "perms"), {
                studentName: s, className: c, teacherName: t,
                destination: document.getElementById('dest_select').value,
                limit: parseInt(document.getElementById('duration_input').value),
                status: 'out', timestamp: serverTimestamp()
            });
            toast("تم الإصدار");
        };

        window.ret = async (id) => {
            await updateDoc(doc(db, "perms", id), { status: 'returned', returnTime: serverTimestamp() });
            toast("تمت العودة");
        };

        function renderMonitor() {
            const active = PERMS.filter(p => p.status === 'out');
            document.getElementById('outCount').innerText = active.length;
            
            document.getElementById('monitorGrid').innerHTML = active.map(p => `
                <div class="student-card">
                    <h3>${p.studentName}</h3>
                    <p>${p.className}</p>
                    <p style="color:#666">المعلم: ${p.teacherName}</p>
                    <div style="margin:10px 0; font-weight:bold; color:var(--primary)">
                        <i class="fas fa-location-arrow"></i> ${p.destination}
                    </div>
                    <button class="btn btn-primary" onclick="ret('${p.id}')">تأكيد العودة</button>
                </div>
            `).join('') || '<p style="text-align:center; color:#999; grid-column:1/-1">لا يوجد طلاب بالخارج</p>';
        }

        window.renderCharts = () => {
            const ctx = document.getElementById('chartCanvas');
            // منطق الرسم البياني المبسط
            const counts = {};
            PERMS.forEach(p => counts[p.className] = (counts[p.className]||0)+1);
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{ label: 'الأذونات', data: Object.values(counts), backgroundColor: '#145A32' }]
                }
            });
        };

        window.factoryReset = async () => {
            if(confirm("تحذير: مسح كل شيء؟")) {
                await setDoc(doc(db, "data", "schoolLists"), { teachers: [], students: [], classes: [] });
                const q = await getDocs(collection(db, "perms"));
                q.forEach(d => deleteDoc(doc(db, "perms", d.id)));
                toast("تم التصفير");
                setTimeout(() => location.reload(), 1000);
            }
        };
    </script>
</body>
</html>