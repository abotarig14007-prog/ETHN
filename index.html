<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إذن الرقمي - متوسطة الإمام النووي (النسخة النهائية)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #145A32;       /* أخضر غامق رسمي */
            --primary-light: #1E8449; /* أخضر فاتح */
            --secondary: #D4AC0D;     /* ذهبي للتكريم */
            --accent: #2874A6;        /* أزرق للأزرار */
            --danger: #C0392B;        /* أحمر للتنبيهات */
            --bg-color: #F4F6F7;      /* خلفية عامة */
            --text-main: #2C3E50;     /* لون النص الرئيسي */
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --gradient: linear-gradient(135deg, #145A32 0%, #0B3B24 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        body { background: var(--bg-color); color: var(--text-main); min-height: 100vh; overflow-x: hidden; }

        /* شاشة الدخول */
        #loginOverlay {
            position: fixed; inset: 0; background: var(--gradient);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .login-card {
            background: white; width: 90%; max-width: 550px; padding: 3rem;
            border-radius: 40px; text-align: center; box-shadow: 0 50px 100px rgba(0,0,0,0.4);
            border-top: 15px solid var(--secondary);
        }
        .logo-icon { font-size: 5rem; color: var(--primary); margin-bottom: 20px; }
        
        /* الهيدر */
        header { 
            background: var(--gradient); color: white; padding: 1rem 2rem; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .live-badge { 
            background: var(--danger); padding: 5px 20px; border-radius: 50px; 
            font-weight: bold; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* الأزرار والقوائم */
        .nav-scroll { 
            display: flex; gap: 15px; overflow-x: auto; padding: 20px; justify-content: center;
        }
        .nav-btn {
            background: white; border: none; padding: 15px 30px; border-radius: 20px;
            font-size: 1.1rem; color: #555; cursor: pointer; transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); min-width: 120px;
        }
        .nav-btn.active { background: #e8f5e9; color: var(--primary); border-bottom: 5px solid var(--primary); }

        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 15px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: #222; }
        .btn-danger { background: var(--danger); color: white; }

        /* المحتوى */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
        .view-section { display: none; animation: fadeIn 0.5s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: white; border-radius: 30px; padding: 2.5rem; margin-bottom: 2rem;
            box-shadow: var(--shadow); position: relative; overflow: hidden; border: 1px solid #eee;
        }
        .form-input { 
            width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #eee; 
            border-radius: 15px; font-size: 1.1rem; text-align: right;
        }

        /* المراقبة */
        .monitor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .student-card {
            background: white; padding: 20px; border-radius: 20px; 
            border-right: 15px solid var(--success); box-shadow: var(--shadow);
        }
        .student-card.late { border-right-color: var(--danger); background: #fff5f5; }

        /* الشهادة */
        .cert-wrapper {
            width: 1123px; height: 794px; background: white; padding: 60px; margin: 0 auto;
            border: 40px double var(--secondary); text-align: center; display: none;
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            position: fixed; top: 0; left: 0; z-index: 10000;
        }
        .cert-title { font-family: 'Amiri'; font-size: 5rem; color: var(--primary); margin-bottom: 30px; }
        .cert-name { font-family: 'Amiri'; font-size: 4rem; color: #b7950b; text-decoration: underline; margin: 40px 0; }
        
        @media print {
            body * { visibility: hidden; }
            .cert-wrapper, .cert-wrapper * { visibility: visible; }
            .cert-wrapper { display: block !important; position: absolute; left: 0; top: 0; transform: scale(0.9); }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card" id="roleSelector">
            <i class="fas fa-school logo-icon"></i>
            <h1 style="font-family:'Amiri'; margin-bottom:10px">متوسطة الإمام النووي</h1>
            <p style="color:#666; margin-bottom:30px">نظام إذن الرقمي المطور</p>
            <button class="btn btn-primary" onclick="showPass('admin')">لوحة الإدارة</button>
            <button class="btn btn-secondary" onclick="showPass('teacher')">دخول المعلم</button>
        </div>

        <div class="login-card" id="passArea" style="display:none">
            <h2 style="color:var(--primary); margin-bottom:20px">التحقق الأمني</h2>
            <input type="password" id="passInput" class="form-input" placeholder="أدخل الكود" style="text-align:center; font-size:2rem; letter-spacing:10px">
            <button class="btn btn-primary" id="loginBtn" onclick="doLogin()">دخول</button>
            <button class="btn btn-danger" onclick="location.reload()">رجوع</button>
        </div>
    </div>

    <header class="no-print">
        <div style="display:flex; align-items:center; gap:15px">
            <i class="fas fa-graduation-cap" style="font-size:2.5rem; color:var(--secondary)"></i>
            <h2>إذن الرقمي</h2>
        </div>
        <div class="live-badge">
            <span id="liveCount">0</span> بالخارج
        </div>
    </header>

    <div id="navContainer" class="nav-scroll no-print" style="display:none"></div>

    <div class="container no-print" id="mainApp" style="display:none">
        <div id="viewHome" class="view-section">
            <div class="card" style="text-align:center">
                <h3>كود المعلم المتزامن</h3>
                <div id="codeDisplay" style="font-size:6rem; font-weight:900; color:var(--primary); margin:20px 0; font-family:monospace">----</div>
                <button class="btn btn-secondary" style="width:auto; margin:0 auto" onclick="newCode()">تحديث الكود</button>
            </div>
            <div class="monitor-grid" id="monitorGrid"></div>
        </div>

        <div id="viewTeacher" class="view-section">
            <div class="card">
                <h3>إصدار إذن</h3>
                <select id="tSelect" class="form-input"><option value="">المعلم</option></select>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                    <select id="cSelect" class="form-input" onchange="filterSt()"><option value="">الشعبة</option></select>
                    <select id="sSelect" class="form-input"><option value="">الطالب</option></select>
                </div>
                <button class="btn btn-primary" onclick="sendPermit()">إرسال</button>
            </div>
        </div>

        <div id="viewSettings" class="view-section">
            <div class="card">
                <h3>إدارة البيانات</h3>
                <input type="file" id="xlFile" class="form-input" onchange="readExcel(this)">
                <button class="btn btn-primary" onclick="document.getElementById('xlFile').click()">رفع ملف Excel</button>
                <button class="btn btn-danger" onclick="wipeData()">تصفير النظام</button>
            </div>
        </div>

        <div id="viewCert" class="view-section">
            <div class="card" style="text-align:center">
                <h3>طباعة الشهادات</h3>
                <select id="certName" class="form-input"><option>اختر الطالب</option></select>
                <button class="btn btn-secondary" onclick="printCert()">طباعة</button>
            </div>
        </div>
    </div>

    <div id="certTemplate" class="cert-wrapper">
        <h1 class="cert-title">شهادة شكر وتقدير</h1>
        <p style="font-size:2.5rem; margin-top:50px">تتقدم المدرسة بالشكر للطالب:</p>
        <h2 id="pName" class="cert-name"></h2>
        <p style="font-size:2rem">على انضباطه وتميزه السلوكي</p>
        <div style="margin-top:100px; display:flex; justify-content:space-around">
            <div><p>مدير المدرسة</p><h3>إبراهيم بن يحيى جابر اللغبي</h3></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const db = getFirestore(initializeApp({ projectId: "edin-377b2", authDomain: "edin-377b2.firebaseapp.com" }));
        let role = '', st = [], te = [];

        window.showPass = (r) => { role = r; document.getElementById('roleSelector').style.display='none'; document.getElementById('passArea').style.display='block'; };

        // نظام الدخول المعدل (يتجاوز خطأ الاتصال)
        window.doLogin = async () => {
            const pin = document.getElementById('passInput').value;
            const btn = document.getElementById('loginBtn');
            btn.innerText = "جاري الدخول...";

            // دخول مباشر للمدير 2025 لتجاوز مشاكل السيرفر الأولية
            if (role === 'admin' && pin === "2025") {
                startApp();
                return;
            }

            try {
                const s = await getDoc(doc(db, "settings", "dailyCode"));
                const c = s.exists() ? s.data().value : "1234";
                if (role === 'teacher' && pin === c) startApp();
                else { alert("الكود خطأ"); btn.innerText = "دخول"; }
            } catch (e) {
                // في حال فشل الاتصال، نسمح بالدخول الافتراضي
                if (role === 'teacher' && pin === "1234") startApp();
                else { alert("خطأ اتصال"); btn.innerText = "دخول"; }
            }
        };

        function startApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('navContainer').style.display = 'flex';
            setupNav();
            syncData();
        }

        function setupNav() {
            const n = document.getElementById('navContainer');
            if (role === 'admin') {
                n.innerHTML = `
                    <button class="nav-btn active" onclick="go('viewHome',this)">الرئيسية</button>
                    <button class="nav-btn" onclick="go('viewSettings',this)">الإعدادات</button>
                    <button class="nav-btn" onclick="go('viewCert',this)">الشهادات</button>
                `;
                go('viewHome');
            } else {
                n.innerHTML = `
                    <button class="nav-btn active" onclick="go('viewTeacher',this)">إصدار إذن</button>
                    <button class="nav-btn" onclick="go('viewHome',this)">المتابعة</button>
                `;
                go('viewTeacher');
            }
        }

        window.go = (id, btn) => {
            document.querySelectorAll('.view-section').forEach(x => x.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(btn) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
        };

        function syncData() {
            onSnapshot(doc(db, "settings", "dailyCode"), d => { if(d.exists()) document.getElementById('codeDisplay').innerText = d.data().value; });
            onSnapshot(doc(db, "data", "lists"), d => { 
                if(d.exists()) { st = d.data().s||[]; te = d.data().t||[]; fill(); } 
            });
            
            const q = query(collection(db, "perms"), orderBy("time", "desc"));
            onSnapshot(q, snap => {
                const arr = snap.docs.map(d => ({id:d.id, ...d.data()})).filter(x => x.st === 'out');
                document.getElementById('liveCount').innerText = arr.length;
                document.getElementById('monitorGrid').innerHTML = arr.map(x => `
                    <div class="student-card">
                        <h2 style="color:var(--primary)">${x.s}</h2>
                        <p>${x.c} | ${x.t}</p>
                        <button class="btn btn-primary" onclick="ret('${x.id}')">عودة</button>
                    </div>
                `).join('');
            });
        }

        window.newCode = async () => setDoc(doc(db, "settings", "dailyCode"), { value: Math.floor(1000+Math.random()*9000).toString() });
        window.sendPermit = async () => {
            const s = document.getElementById('sSelect').value;
            if(!s) return alert("اختر الطالب");
            await addDoc(collection(db, "perms"), { s, c:document.getElementById('cSelect').value, t:document.getElementById('tSelect').value, time:serverTimestamp(), st:'out' });
            alert("تم");
        };
        window.ret = async (id) => updateDoc(doc(db, "perms", id), { st:'in' });

        window.readExcel = (inp) => {
            const r = new FileReader();
            r.onload = async (e) => {
                const d = XLSX.utils.sheet_to_json(XLSX.read(e.target.result, {type:'array'}).Sheets[XLSX.read(e.target.result, {type:'array'}).SheetNames[0]]);
                const t = [...new Set(d.map(x=>x['المعلم']))].filter(Boolean);
                const s = d.map(x=>({n:x['الاسم'], c:x['الشعبة']})).filter(x=>x.n);
                await setDoc(doc(db, "data", "lists"), { t, s });
                alert("تم رفع البيانات");
            };
            r.readAsArrayBuffer(inp.files[0]);
        };

        function fill() {
            document.getElementById('tSelect').innerHTML = '<option>المعلم</option>' + te.map(x=>`<option>${x}</option>`).join('');
            const c = [...new Set(st.map(x=>x.c))].sort();
            document.getElementById('cSelect').innerHTML = '<option>الشعبة</option>' + c.map(x=>`<option>${x}</option>`).join('');
            document.getElementById('certName').innerHTML = '<option>الطالب</option>' + st.map(x=>`<option>${x.n}</option>`).join('');
        }
        window.filterSt = () => {
            const v = document.getElementById('cSelect').value;
            document.getElementById('sSelect').innerHTML = st.filter(x=>x.c===v).map(x=>`<option>${x.n}</option>`).join('');
        };
        
        window.printCert = () => {
            document.getElementById('pName').innerText = document.getElementById('certName').value;
            window.print();
        };
        window.wipeData = async () => { if(confirm("حذف الكل؟")) { const q = await getDocs(collection(db,"perms")); q.forEach(d=>deleteDoc(doc(db,"perms",d.id))); location.reload(); }};
    </script>
</body>
</html>